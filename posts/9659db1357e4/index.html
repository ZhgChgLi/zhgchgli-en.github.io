<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Quickly Build a Testable API Service Using Firebase Firestore + Functions" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="When push notification statistics meet Firebase Firestore + Functions" /><meta property="og:description" content="When push notification statistics meet Firebase Firestore + Functions" /><link rel="canonical" href="https://en.zhgchg.li/posts/9659db1357e4/" /><meta property="og:url" content="https://en.zhgchg.li/posts/9659db1357e4/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-24T01:09:34+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.jpeg" /><meta property="twitter:title" content="Quickly Build a Testable API Service Using Firebase Firestore + Functions" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2024-04-14T00:34:17+08:00","datePublished":"2021-03-24T01:09:34+08:00","description":"When push notification statistics meet Firebase Firestore + Functions","headline":"Quickly Build a Testable API Service Using Firebase Firestore + Functions","image":"https://en.zhgchg.li/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/9659db1357e4/"},"url":"https://en.zhgchg.li/posts/9659db1357e4/"}</script><title>Quickly Build a Testable API Service Using Firebase Firestore + Functions | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Quickly Build a Testable API Service Using Firebase Firestore + Functions</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Quickly Build a Testable API Service Using Firebase Firestore + Functions</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1616519374" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 24, 2021 </em> </span> <span> Updated <em class="" data-ts="1713026057" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 13, 2024 </em> </span><div class="mt-3 mb-3"> <a href="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3368 words" > <em>18 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="quickly-build-a-testable-api-service-using-firebase-firestore--functions"><span class="me-2">Quickly Build a Testable API Service Using Firebase Firestore + Functions</span><a href="#quickly-build-a-testable-api-service-using-firebase-firestore--functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>When push notification statistics meet Firebase Firestore + Functions</p><p><a href="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.jpeg" class="popup img-link "><img data-src="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.jpeg" alt="Photo by [Carlos Muza](https://unsplash.com/@kmuza?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p>Photo by <a href="https://unsplash.com/@kmuza?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Carlos Muza</a></p><h3 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="accurate-push-notification-statistics"><span class="me-2">Accurate Push Notification Statistics</span><a href="#accurate-push-notification-statistics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Recently, I wanted to introduce a feature to the APP. Before implementation, we could only use the success or failure of posting data to APNS/FCM from the backend as the base for push notifications and record the click-through rate. However, this method is very inaccurate as the base includes many invalid devices. Devices with the APP deleted (which may not immediately become invalid) or with push notifications disabled will still return success when posting from the backend.</p><p>After iOS 10, you can implement the Notification Service Extension to secretly call an API for statistics when the push notification banner appears. The advantage is that it is very accurate; it only calls when the user’s push notification banner appears. If the APP is deleted, notifications are turned off, or the banner is not displayed, there will be no action. The banner appearing equals a push notification message, and using this as the base for push notifications and then counting the clicks will give an “accurate click-through rate.”</p><blockquote><p><em>For detailed principles and implementation methods, refer to the previous article: <a href="../cb6eba52a342/">“iOS ≥ 10 Notification Service Extension Application (Swift)”</a></em></p></blockquote><blockquote><p><em>Currently, the APP’s loss rate should be 0% based on tests. A common practical application is Line’s point-to-point message encryption and decryption (the push notification message is encrypted and decrypted only when received on the phone).</em></p></blockquote><h4 id="problem"><span class="me-2">Problem</span><a href="#problem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The work on the APP side is actually not much. Both iOS/Android only need to implement similar functions (but if considering the Chinese market for Android, it becomes more complicated as you need to implement push notification frameworks for more platforms). The bigger work is on the backend and server pressure handling because when a push notification is sent out, it will simultaneously call the API to return records, which might overwhelm the server’s max connection. If using RDBMS to store records, it could be even more severe. If you find statistical losses, it often happens at this stage.</p><blockquote><p><em>You can record by writing logs to files and do statistics and display when querying.</em></p></blockquote><blockquote><p><em>Additionally, thinking about the scenario of simultaneous returns, the quantity might not be as large as imagined. Push notifications are not sent out in tens or hundreds of thousands at once but in batches. As long as you can handle the number of simultaneous returns from batch sending, it should be fine!</em></p></blockquote><h3 id="prototype"><span class="me-2">Prototype</span><a href="#prototype" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Considering the issues mentioned, the backend needs effort to research and modify, and the market may not care about the results. So, I thought of using available resources to create a prototype to test the waters.</p><p>Here, I chose Firebase services, which almost all APPs use, specifically the Functions and Firestore features.</p><h4 id="firebase-functions"><span class="me-2">Firebase Functions</span><a href="#firebase-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://developers.google.com/learn/topics/functions" target="_blank">Functions</a> is a serverless service provided by Google. You only need to write the program logic, and Google will automatically handle the server, execution environment, and you don’t have to worry about server scaling and traffic issues.</p><p><a href="https://firebase.google.com/docs/functions" target="_blank">Firebase Functions</a> are essentially Google Cloud Functions but can only be written in JavaScript (node.js). Although I haven’t tried it, if you use Google Cloud Functions and choose to write in another language while importing Firebase services, it should work as well.</p><p>For API usage, I can write a node.js file, get a real URL (e.g., my-project.cloudfunctions.net/getUser), and write the logic to obtain Request information and provide the corresponding Response.</p><blockquote><p><em>I previously wrote an article about Google Functions: <a href="../70a1409b149a/">Using Python + Google Cloud Platform + Line Bot to Automate Routine Tasks</a></em></p></blockquote><blockquote><p><em>Firebase Functions must enable the Blaze plan (pay-as-you-go) to use.</em></p></blockquote><p><a href="/assets/9659db1357e4/1*YqIJ1tr2Ay-oLVjSSU0zUg.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*YqIJ1tr2Ay-oLVjSSU0zUg.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="firebase-firestore"><span class="me-2">Firebase Firestore</span><a href="#firebase-firestore" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://firebase.google.com/docs/firestore" target="_blank">Firebase Firestore</a> is a NoSQL database used to store and manage data.</p><p>Combined with Firebase Functions, you can import Firestore during a Request to operate the database and then respond to the user, allowing you to build a simple Restful API service!</p><blockquote><p>Let’s get hands-on!</p></blockquote><h3 id="install-nodejs-environment"><span class="me-2">Install node.js Environment</span><a href="#install-nodejs-environment" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>It is recommended to use NVM, a node.js version management tool, for installation and management (similar to pyenv for Python).</p><p>Copy the installation shell script from the NVM GitHub project:</p><p><a href="https://github.com/nvm-sh/nvm#installing-and-updating" target="_blank" class="img-link shimmer" ><img data-src="https://repository-images.githubusercontent.com/612230/53a0c44a-1f6e-4f8d-918f-89762fafe369" alt="" class="lazyload" data-proofer-ignore></a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-o-</span> https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh | bash
</pre></table></code></div></div><p>If errors occur during installation, ensure you have a <code class="language-plaintext highlighter-rouge">~/.bashrc</code> or <code class="language-plaintext highlighter-rouge">~/.zshrc</code> file. If not, you can create one using <code class="language-plaintext highlighter-rouge">touch ~/.bashrc</code> or <code class="language-plaintext highlighter-rouge">touch ~/.zshrc</code> and then rerun the install script.</p><p>Next, you can use <code class="language-plaintext highlighter-rouge">nvm install node</code> to install the latest version of node.js.</p><p><a href="/assets/9659db1357e4/1*5fxz4HD9q4feAqO0zXbojg.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*5fxz4HD9q4feAqO0zXbojg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>You can check if npm is installed successfully and its version by running <code class="language-plaintext highlighter-rouge">npm --version</code>:</p><p><a href="/assets/9659db1357e4/1*VHZMRFIDzFA9AxmsDNqNlA.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*VHZMRFIDzFA9AxmsDNqNlA.png" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="deploy-firebase-functions"><span class="me-2">Deploy Firebase Functions</span><a href="#deploy-firebase-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="install-firebase-tools"><span class="me-2">Install Firebase-tools:</span><a href="#install-firebase-tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>npm <span class="nb">install</span> <span class="nt">-g</span> firebase-tools
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*POfMR0p1600iYqy8rzQkTQ.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*POfMR0p1600iYqy8rzQkTQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>After successful installation, for the first-time use, enter:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>firebase login
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*kqeECyXVPOq1cpKvcdOBeA.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*kqeECyXVPOq1cpKvcdOBeA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Complete Firebase login authentication.</p><p>Initialize the project:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>firebase init
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*Xx2grpX2PZb3wEFt9mQbNw.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*Xx2grpX2PZb3wEFt9mQbNw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Note the path where Firebase init is located:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>You're about to initialize a Firebase project in this directory:
</pre></table></code></div></div><p>Here you can choose the Firebase CLI tools to install. Use the “↑” and “↓” keys to navigate and the “spacebar” to select. You can choose to install only “Functions” or both “Functions” and “Firestore”.</p><p><strong>=== Functions Setup</strong></p><p><a href="/assets/9659db1357e4/1*2gd9pAIdLAkJRhROpJtPKA.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*2gd9pAIdLAkJRhROpJtPKA.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li>Select language: <strong>JavaScript</strong><li>For “use ESLint to catch probable bugs and enforce style” syntax style check, <strong>YES / NO both are fine</strong>.<li>Install dependencies with npm? <strong>YES</strong></ul><p><strong>=== Emulators Setup</strong></p><p><a href="/assets/9659db1357e4/1*xHWp195BZIZdXyUd-ub78g.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*xHWp195BZIZdXyUd-ub78g.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>You can test Functions and Firestore features and settings locally without it counting towards usage and without needing to deploy online to test.</p><blockquote><p><em>Install as needed. I installed it but didn’t use it… because it’s just a small feature.</em></p></blockquote><h3 id="coding"><span class="me-2">Coding!</span><a href="#coding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Go to the path noted above, find the <code class="language-plaintext highlighter-rouge">functions</code> folder, and open the <code class="language-plaintext highlighter-rouge">index.js</code> file with an editor.</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">();</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">hello</span> <span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">targetID</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">targetID</span>
    <span class="kd">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">action</span>
    <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">targetID</span><span class="dl">"</span><span class="p">:</span> <span class="nx">targetID</span><span class="p">,</span> <span class="dl">"</span><span class="s2">action</span><span class="dl">"</span><span class="p">:</span> <span class="nx">action</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="nx">name</span><span class="p">});</span>
    <span class="k">return</span>
<span class="p">})</span>
</pre></table></code></div></div><p>Paste the above content. We have defined a path interface <code class="language-plaintext highlighter-rouge">/hello</code> that will return the URL <strong>Query</strong> <code class="language-plaintext highlighter-rouge">?targetID=</code>, <strong>POST</strong> <code class="language-plaintext highlighter-rouge">action</code>, and <code class="language-plaintext highlighter-rouge">name</code> parameter information.</p><p>After modifying and saving, go back to the console and run:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>firebase deploy
</pre></table></code></div></div><blockquote><p><strong><em>Remember to run the <code class="language-plaintext highlighter-rouge">firebase deploy</code> command every time you make changes for them to take effect.</em></strong></p></blockquote><p>Start verifying &amp; deploying to Firebase…</p><p><a href="/assets/9659db1357e4/1*hUdvD4ANKD3s73mLWNZZOQ.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*hUdvD4ANKD3s73mLWNZZOQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>It may take a while. After <code class="language-plaintext highlighter-rouge">Deploy complete!</code>, your first Request &amp; Response webpage is done!</p><p>At this point, you can go back to the Firebase -&gt; Functions page:</p><p><a href="/assets/9659db1357e4/1*SY4iJZL6gDEZ5AEcepIpMA.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*SY4iJZL6gDEZ5AEcepIpMA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>You will see the interface and URL location you just wrote.</p><p>Copy the URL below and test it in PostMan:</p><p><a href="/assets/9659db1357e4/1*OMfLkdg12QHsp-yc9RkKvA.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*OMfLkdg12QHsp-yc9RkKvA.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p><em>Remember to select <code class="language-plaintext highlighter-rouge">x-www-form-urlencoded</code> for the POST Body.</em></p></blockquote><p><strong>Success!</strong></p><h3 id="log"><span class="me-2">Log</span><a href="#log" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We can use the following in the code to log records:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">functions</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">log:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
</pre></table></code></div></div><p>And view the log results in Firebase -&gt; Functions -&gt; Logs:</p><p><a href="/assets/9659db1357e4/1*Wi-4MbPh2tVJ_utdhzN4_A.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*Wi-4MbPh2tVJ_utdhzN4_A.png" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="example-goal"><span class="me-2">Example Goal</span><a href="#example-goal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>Create an API that can add, modify, delete, query articles, and like them.</p></blockquote><p>We want to achieve the functionality design of a Restful API, so we can’t use the pure Path method from the above example. Instead, we need to use the <code class="language-plaintext highlighter-rouge">Express</code> framework.</p><h4 id="post-add-article"><span class="me-2">POST Add Article</span><a href="#post-add-article" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Insert</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// This POST refers to the HTTP Method POST</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Parameter error!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">,</span> <span class="dl">"</span><span class="s2">created_at</span><span class="dl">"</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Added successfully!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span> <span class="c1">// This POST refers to the /post path</span>
</pre></table></code></div></div><p>Now we use Express to handle network requests. Here, we first add a <code class="language-plaintext highlighter-rouge">POST</code> method for the path <code class="language-plaintext highlighter-rouge">/</code>. The last line indicates that all paths are under <code class="language-plaintext highlighter-rouge">/post</code>. Next, we will add APIs for updating and deleting.</p><p>After successfully deploying with <code class="language-plaintext highlighter-rouge">firebase deploy</code>, go back to Post Man to test:</p><p><a href="/assets/9659db1357e4/1*yVAjhlr6wLdONeG7nY0VEw.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*yVAjhlr6wLdONeG7nY0VEw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>After successfully hitting Post Man, you can check in Firebase -&gt; Firestore to see if the data is correctly written:</p><p><a href="/assets/9659db1357e4/1*xYVrRdFro3bQVHx05JUaTw.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*xYVrRdFro3bQVHx05JUaTw.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="put-update-article"><span class="me-2">PUT Update Article</span><a href="#put-update-article" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Update</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Article not found!</span><span class="dl">"</span><span class="p">});</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Invalid parameters!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Update successful!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>Deployment &amp; testing method is the same as adding, remember to change the Post Man Http Method to <code class="language-plaintext highlighter-rouge">PUT</code>.</p><h4 id="delete-delete-article"><span class="me-2">DELETE Delete Article</span><a href="#delete-delete-article" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Delete</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Article not found!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">posts</span><span class="dl">"</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="k">delete</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Article deleted successfully!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">})</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>Deployment &amp; testing method is the same as adding, remember to change the Post Man Http Method to <code class="language-plaintext highlighter-rouge">DELETE</code>.</p><p>Adding, modifying, and deleting are done, let’s do the query!</p><h4 id="select-query-articles"><span class="me-2">SELECT Query Articles</span><a href="#select-query-articles" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Select List</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">posts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">data</span><span class="p">();</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">data</span><span class="p">})</span>
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:</span><span class="nx">result</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Select One</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Article not found!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">doc</span><span class="p">.</span><span class="nx">data</span><span class="p">()}});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*n_mI4l1EmhpWK8M_FbrzbQ.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*n_mI4l1EmhpWK8M_FbrzbQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Deployment &amp; testing method is the same as adding, remember to change the Post Man Http Method to <code class="language-plaintext highlighter-rouge">GET</code> and switch <code class="language-plaintext highlighter-rouge">Body</code> back to <code class="language-plaintext highlighter-rouge">none</code>.</p><h4 id="insertorupdate"><span class="me-2">InsertOrUpdate?</span><a href="#insertorupdate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Sometimes we need to update when the value exists and add when the value does not exist. In this case, we can use <code class="language-plaintext highlighter-rouge">set</code> with <code class="language-plaintext highlighter-rouge">merge: true</code>:</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// InsertOrUpdate</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tag</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Invalid parameter!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="nx">name</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span><span class="kd">set</span><span class="p">({</span><span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Added successfully!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>Here, taking adding a tag as an example, the deployment &amp; testing method is the same as adding. You can see that Firestore will not repeatedly add new data.</p><p><a href="/assets/9659db1357e4/1*qkTMGjC0EkrMO85-6pQFwg.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*qkTMGjC0EkrMO85-6pQFwg.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="article-like-counter"><span class="me-2">Article Like Counter</span><a href="#article-like-counter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Suppose our article data now has an additional <code class="language-plaintext highlighter-rouge">likeCount</code> field to record the number of likes. How should we do it?</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Article not found!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">set</span><span class="p">({</span><span class="na">likeCount</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Liked successfully!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>Using the <code class="language-plaintext highlighter-rouge">increment</code> variable allows you to directly perform the action of retrieving the value +1.</p><h4 id="high-traffic-article-like-counter"><span class="me-2">High Traffic Article Like Counter</span><a href="#high-traffic-article-like-counter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Because Firestore has <a href="https://cloud.google.com/firestore/quotas?hl=zh-tw#soft_limits" target="_blank">write speed limits</a>:</p><p><a href="/assets/9659db1357e4/1*U9ubGe3M8XEdx9XGAV8nfA.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*U9ubGe3M8XEdx9XGAV8nfA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><strong>A document can only be written once per second</strong>, so when there are many people liking it; simultaneous requests may become very slow.</p><p>The official solution “ <a href="https://cloud.google.com/firestore/docs/solutions/counters#node.js_2" target="_blank">Distributed counters</a> “ is actually not very advanced technology, it just uses several distributed likeCount fields to count, and then sums them up when reading.</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Distributed counters Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like2/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Article not found!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">//1~10</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCounter</span><span class="dl">"</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCount_</span><span class="dl">"</span><span class="o">+</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nx">toString</span><span class="p">())</span>
    <span class="p">.</span><span class="kd">set</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Like successful!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>


<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*GhNEcWUjgvYRYCMBk1DayA.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*GhNEcWUjgvYRYCMBk1DayA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>The above is to distribute the fields to record Count to avoid slow writing; but if there are too many distributed fields, it will increase the reading cost ($$), but it should still be cheaper than adding a new record for each like.</p><h4 id="using-siege-tool-for-stress-testing"><span class="me-2">Using Siege Tool for Stress Testing</span><a href="#using-siege-tool-for-stress-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Use <code class="language-plaintext highlighter-rouge">brew</code> to install <code class="language-plaintext highlighter-rouge">siege</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>brew <span class="nb">install </span>siege
</pre></table></code></div></div><p><em>p.s If you encounter brew: command not found, please install the <a href="https://brew.sh/index_zh-tw" target="_blank">brew</a> package management tool first</em>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/usr/bin/ruby <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/master/install<span class="si">)</span><span class="s2">"</span>
</pre></table></code></div></div><p>After installation, you can run:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>siege <span class="nt">-c</span> 100 <span class="nt">-r</span> 1 <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="s1">'https://us-central1-project.cloudfunctions.net/post/like/id POST {}'</span>
</pre></table></code></div></div><p>Perform stress testing:</p><ul><li><code class="language-plaintext highlighter-rouge">-c 100</code>: 100 tasks executed simultaneously<li><code class="language-plaintext highlighter-rouge">-r 1</code>: Each task executes 1 request<li><code class="language-plaintext highlighter-rouge">-H ‘Content-Type: application/json’</code>: Required if it is a POST<li><code class="language-plaintext highlighter-rouge">‘https://us-central1-project.cloudfunctions.net/post/like/id POST {}’</code>: POST URL, Post Body (ex: <code class="language-plaintext highlighter-rouge">{“name”:”1234”}</code>)</ul><p>After execution, you can see the results:</p><p><a href="/assets/9659db1357e4/1*BUcMfJJ4x_mgK0HHLc6C4g.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*BUcMfJJ4x_mgK0HHLc6C4g.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><code class="language-plaintext highlighter-rouge">successful_transactions: 100</code> indicates that all 100 transactions were successful.</p><p><strong>You can go back to Firebase -&gt; Firestore to check if there is any Loss Data:</strong></p><p><a href="/assets/9659db1357e4/1*wd5z743Zp9xtjKhhcMaVOg.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*wd5z743Zp9xtjKhhcMaVOg.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p>Success!</p></blockquote><h4 id="complete-example-code"><span class="me-2">Complete Example Code</span><a href="#complete-example-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Insert</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Parameter error!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">,</span> <span class="dl">"</span><span class="s2">created_at</span><span class="dl">"</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Successfully added!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Update</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Post not found!</span><span class="dl">"</span><span class="p">});</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Parameter error!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Successfully updated!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Delete</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Post not found!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">posts</span><span class="dl">"</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="k">delete</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Post successfully deleted!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Select List</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">posts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">data</span><span class="p">();</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">data</span><span class="p">})</span>
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:</span><span class="nx">result</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Select One</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Post not found!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">doc</span><span class="p">.</span><span class="nx">data</span><span class="p">()}});</span>
<span class="p">});</span>

<span class="c1">// InsertOrUpdate</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tag</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Parameter error!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="nx">name</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span><span class="kd">set</span><span class="p">({</span><span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Successfully added!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Post not found!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">set</span><span class="p">({</span><span class="na">likeCount</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Successfully liked!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Distributed counters Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like2/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Post not found!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">//1~10</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCounter</span><span class="dl">"</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCount_</span><span class="dl">"</span><span class="o">+</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nx">toString</span><span class="p">())</span>
    <span class="p">.</span><span class="kd">set</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Successfully liked!</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>


<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><h3 id="back-to-the-topic-push-notification-statistics"><span class="me-2">Back to the topic, push notification statistics</span><a href="#back-to-the-topic-push-notification-statistics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Back to what we initially wanted to do, the push notification statistics feature.</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nx">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="kd">const</span> <span class="nx">vaildPlatformTypes</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">ios</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">Android</span><span class="dl">"</span><span class="p">]</span>
<span class="kd">const</span> <span class="nx">vaildActionTypes</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">clicked</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">received</span><span class="dl">"</span><span class="p">]</span>

<span class="c1">// Insert Log</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">platformType</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">platformType</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">pushID</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">pushID</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">actionType</span> <span class="o">=</span>  <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">actionType</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">vaildPlatformTypes</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">platformType</span><span class="p">)</span> <span class="o">||</span> <span class="nx">pushID</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="o">!</span><span class="nx">vaildActionTypes</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">actionType</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Invalid parameters!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="nx">platformType</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="nx">actionType</span><span class="o">+</span><span class="dl">"</span><span class="s2">_</span><span class="dl">"</span><span class="o">+</span><span class="nx">pushID</span><span class="p">).</span><span class="nx">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">shards</span><span class="dl">"</span><span class="p">).</span><span class="nx">doc</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nx">toString</span><span class="p">())</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Record successful!</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// View Log</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:type/:id</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// received</span>
    <span class="kd">const</span> <span class="nx">receivedDocs</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">type</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">received_</span><span class="dl">"</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">shards</span><span class="dl">"</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">receivedDocs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">received</span> <span class="o">+=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">data</span><span class="p">().</span><span class="nx">count</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="c1">// clicked</span>
    <span class="kd">const</span> <span class="nx">clickedDocs</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">().</span><span class="nx">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">type</span><span class="p">).</span><span class="nx">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">clicked_</span><span class="dl">"</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">shards</span><span class="dl">"</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">clicked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">clickedDocs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">clicked</span> <span class="o">+=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">data</span><span class="p">().</span><span class="nx">count</span><span class="p">;</span>
    <span class="p">});</span>
    
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">received</span><span class="dl">"</span><span class="p">:</span><span class="nx">received</span><span class="p">,</span><span class="dl">"</span><span class="s2">clicked</span><span class="dl">"</span><span class="p">:</span><span class="nx">clicked</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">notification</span> <span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><h4 id="add-push-notification-record"><span class="me-2">Add Push Notification Record</span><a href="#add-push-notification-record" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/9659db1357e4/1*3koe6QBxF9oOhBDqjF5mhA.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*3koe6QBxF9oOhBDqjF5mhA.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="view-push-notification-statistics"><span class="me-2">View Push Notification Statistics</span><a href="#view-push-notification-statistics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>https://us-centra1-xxx.cloudfunctions.net/notification/iOS/1
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*SStEkNoDjiL7pffC2pHDkQ.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*SStEkNoDjiL7pffC2pHDkQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Additionally, we also created an interface to count push notification numbers.</p><h4 id="pitfalls"><span class="me-2">Pitfalls</span><a href="#pitfalls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><em>Since I am not very familiar with node.js, during the initial exploration, I did not add <code class="language-plaintext highlighter-rouge">await</code> when adding data. Coupled with the write speed limit, it led to Data Loss under high traffic conditions…</em></p></blockquote><p><a href="/assets/9659db1357e4/1*dVsBhKJQ3qqxlSvv-mCENA.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*dVsBhKJQ3qqxlSvv-mCENA.png" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="pricing"><span class="me-2">Pricing</span><a href="#pricing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Don’t forget to refer to the pricing strategy for Firebase Functions &amp; Firestore.</p><h4 id="functions"><span class="me-2">Functions</span><a href="#functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://cloud.google.com/functions/pricing?hl=zh-tw" target="_blank">https://cloud.google.com/functions/pricing?hl=zh-tw</a></ul><p><a href="/assets/9659db1357e4/1*76yRqeDyrp0kFmGHN4ZNXg.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*76yRqeDyrp0kFmGHN4ZNXg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/9659db1357e4/1*G_At8v80BQl81EUqPuUIbQ.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*G_At8v80BQl81EUqPuUIbQ.png" alt="Computation Time" class="lazyload" data-proofer-ignore></a></p><p>Computation Time</p><p><a href="/assets/9659db1357e4/1*iXk7oKFidHfzRVwrDvKX0A.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*iXk7oKFidHfzRVwrDvKX0A.png" alt="Network" class="lazyload" data-proofer-ignore></a></p><p>Network</p><blockquote><p><em>Cloud Functions offers a permanent free tier for computation time resources, which includes GB/seconds and GHz/seconds of computation time. In addition to 2 million invocations, the free tier also provides 400,000 GB/seconds and 200,000 GHz/seconds of computation time, as well as 5 GB of internet egress per month.</em></p></blockquote><h4 id="firestore"><span class="me-2">Firestore</span><a href="#firestore" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://cloud.google.com/firestore/pricing?hl=zh-tw" target="_blank">https://cloud.google.com/firestore/pricing?hl=zh-tw</a></ul><p><a href="/assets/9659db1357e4/1*ylduiqevk4WH-eNc8EOpvQ.png" class="popup img-link "><img data-src="/assets/9659db1357e4/1*ylduiqevk4WH-eNc8EOpvQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li><a href="https://cloud.google.com/firestore/docs/billing-example?hl=zh-tw" target="_blank">Billing Example</a></ul><blockquote><p><strong><em>Prices are subject to change at any time, please refer to the official website for the latest information.</em></strong></p></blockquote><h3 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As the title suggests, “for testing”, “for testing”, “for testing” it is not recommended to use the above services in a production environment or as the core of a product launch.</p><h4 id="expensive-and-hard-to-migrate"><span class="me-2">Expensive and Hard to Migrate</span><a href="#expensive-and-hard-to-migrate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>I once heard that a fairly large service was built using Firebase services, and later on, with large data and traffic, the charges became extremely expensive; it was also very difficult to migrate, the code was okay but the data was very hard to move; it can only be said that saving a little money in the early stages caused huge losses later on, not worth it.</p><h4 id="for-testing-only"><span class="me-2">For Testing Only</span><a href="#for-testing-only" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For the above reasons, I personally recommend using Firebase Functions + Firestore to build API services only for testing or prototype product demonstrations.</p><h4 id="more-features"><span class="me-2">More Features</span><a href="#more-features" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Functions can also integrate Authentication, Storage, but I haven’t researched this part.</p><h3 id="references"><span class="me-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://firebase.google.com/docs/firestore/query-data/queries" target="_blank">https://firebase.google.com/docs/firestore/query-data/queries</a><li><a href="https://coder.tw/?p=7198" target="_blank">https://coder.tw/?p=7198</a><li><a href="https://firebase.google.com/docs/firestore/solutions/counters#node.js_1" target="_blank">https://firebase.google.com/docs/firestore/solutions/counters#node.js_1</a><li><a href="https://javascript.plainenglish.io/firebase-cloud-functions-tutorial-creating-a-rest-api-8cbc51479f80" target="_blank">https://javascript.plainenglish.io/firebase-cloud-functions-tutorial-creating-a-rest-api-8cbc51479f80</a></ul><h3 id="further-reading"><span class="me-2">Further Reading</span><a href="#further-reading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="../70a1409b149a/">Using Python+Google Cloud Platform+Line Bot to Automate Routine Tasks</a><li><a href="../cb6eba52a342/">i <strong>OS ≥ 10 Notification Service Extension Application (Swift)</strong></a><li><a href="../d414bdbdb8c9/">Using Google Apps Script to Forward Gmail to Slack</a></ul><p>If you have any questions or suggestions, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>===</p><p><a href="https://zhgchg.li/posts/9659db1357e4/" target="_blank">本文中文版本</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ➡️ <a href="https://medium.com/p/9659db1357e4" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=🍺&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/zrealm/'>ZRealm</a>, <a href='/categories/dev/'>Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/firebase/" class="post-tag no-text-decoration" >firebase</a> <a href="/tags/google-cloud-platform/" class="post-tag no-text-decoration" >google-cloud-platform</a> <a href="/tags/notifications/" class="post-tag no-text-decoration" >notifications</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Quickly%20Build%20a%20Testable%20API%20Service%20Using%20Firebase%20Firestore%20+%20Functions%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F9659db1357e4%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Quickly%20Build%20a%20Testable%20API%20Service%20Using%20Firebase%20Firestore%20+%20Functions%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F9659db1357e4%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F9659db1357e4%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/e37d66ea1146/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1539454069" data-df="ll" > Oct 14, 2018 </em><h4 class="pt-0 my-2" data-toc-skip>iOS UITextView Text Wrapping Editor (Swift)</h4><div class="text-muted small"><p> iOS UITextView Text Wrapping Editor (Swift) Practical Route Target Functionality: The app has a discussion area where users can post articles. The interface for posting articles needs to support...</p></div></div></a></div><div class="col"> <a href="/posts/cb6eba52a342/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1539618241" data-df="ll" > Oct 15, 2018 </em><h4 class="pt-0 my-2" data-toc-skip>iOS ≥ 10 Notification Service Extension Application (Swift)</h4><div class="text-muted small"><p> iOS ≥ 10 Notification Service Extension Application (Swift) Image push notifications, push notification display statistics, pre-processing before push notification display Regarding the basics of...</p></div></div></a></div><div class="col"> <a href="/posts/9a9aa892f9a9/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1539705684" data-df="ll" > Oct 17, 2018 </em><h4 class="pt-0 my-2" data-toc-skip>Exploring Vision — Automatic Face Detection and Cropping for Profile Pictures (Swift)</h4><div class="text-muted small"><p> Exploring Vision — Automatic Face Detection and Cropping for Profile Pictures (Swift) Practical Application of Vision [2024/08/13 Update] Refer to the new article and API: “iOS Vision framewor...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/99a6cef90190/" class="btn btn-outline-primary" prompt="Older" ><p>Password Recovery SMS Verification Code Security Issue</p></a> <a href="/posts/cb0c68c33994/" class="btn btn-outline-primary" prompt="Newer" ><p>AppStore APP’s Reviews Bot Insights</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">中文版網站</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
