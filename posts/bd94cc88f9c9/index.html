<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Slack &amp; ChatGPT Integration" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Build your own ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)" /><meta property="og:description" content="Build your own ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)" /><link rel="canonical" href="https://en.zhgchg.li/posts/bd94cc88f9c9/" /><meta property="og:url" content="https://en.zhgchg.li/posts/bd94cc88f9c9/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-02-16T21:17:01+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.png" /><meta property="twitter:title" content="Slack &amp; ChatGPT Integration" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2024-02-18T12:09:17+08:00","datePublished":"2024-02-16T21:17:01+08:00","description":"Build your own ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)","headline":"Slack &amp; ChatGPT Integration","image":"https://en.zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/bd94cc88f9c9/"},"url":"https://en.zhgchg.li/posts/bd94cc88f9c9/"}</script><title>Slack & ChatGPT Integration | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Slack & ChatGPT Integration</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Slack & ChatGPT Integration</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1708089421" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 16, 2024 </em> </span> <span> Updated <em class="" data-ts="1708229357" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 18, 2024 </em> </span><div class="mt-3 mb-3"> <a href="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.png" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.png" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="9538 words" > <em>52 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="slack--chatgpt-integration"><span class="me-2">Slack &amp; ChatGPT Integration</span><a href="#slack--chatgpt-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Build your own ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)</p><h4 id="background"><span class="me-2">Background</span><a href="#background" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Recently, I have been promoting the use of Generative AI within the team to improve work efficiency. Initially, we only aim to achieve an AI Assistant (ChatGPT functionality) to reduce the time spent on daily data queries, organizing cumbersome data, and manual data processing, thereby improving work efficiency. We hope that engineers, designers, PMs, marketers, etc., can all use it freely.</p><p>The simplest method is to directly purchase the ChatGPT Team plan, which costs $25 per seat per year. However, since we are not yet sure about everyone’s usage frequency (volume) and hope to integrate with more collaboration and development processes in the future, we decided to use the OpenAI API method and then integrate it with other services for team members to use.</p><p>The OpenAI API Key can be generated from <a href="https://platform.openai.com/api-keys" target="_blank">this page</a>. The Key does not correspond to a specific Model version; you need to specify the Model version you want to use and generate the corresponding Token cost when using it.</p><blockquote><p>We need a service that can set the OpenAI API Key by ourselves and use that Key for ChatGPT-like usage.</p></blockquote><blockquote><p>Whether it’s a Chrome Extension or a Slack App, it’s hard to find a service that allows you to set the OpenAI API Key by yourself. Most services sell their own subscriptions, and allowing users to set their own API Key means they can’t make money and are purely doing charity.</p></blockquote><h4 id="chrome-extension-sidebargpt"><span class="me-2">[Chrome Extension] <a href="https://chromewebstore.google.com/detail/chatgpt-assistant-for-chr/mejjgaogggabifjfjdbnobinfibaamla" target="_blank">SidebarGPT</a></span><a href="#chrome-extension-sidebargpt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>After installation, go to Settings -&gt; General -&gt; Enter the OpenAI API Key.</p><p><a href="/assets/bd94cc88f9c9/1*E9SO72c7ZEBfhBMBNT-Erw.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*E9SO72c7ZEBfhBMBNT-Erw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>You can call out the chat interface directly from the browser toolbar or side icon and use it directly:</p><p><a href="/assets/bd94cc88f9c9/1*Et1rGixc8pihUiSn8kqSqA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*Et1rGixc8pihUiSn8kqSqA.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="chrome-extension-openai-translator"><span class="me-2">[Chrome Extension] <a href="https://chrome.google.com/webstore/detail/ogjibjphoadhljaoicdnjnmgokohngcc" target="_blank">OpenAI Translator</a></span><a href="#chrome-extension-openai-translator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>If you only need translation, you can use this, which allows you to set the OpenAI API Key for translation.</p><p><a href="/assets/bd94cc88f9c9/1*cMB9uuyBRPKtdE_7g6Yqiw.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*cMB9uuyBRPKtdE_7g6Yqiw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/bd94cc88f9c9/1*wKfD9BQYJuNXrUl1mr_GvA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*wKfD9BQYJuNXrUl1mr_GvA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Additionally, it is an <a href="https://github.com/openai-translator/openai-translator" target="_blank">open-source project</a> and also provides macOS/Windows desktop programs:</p><p><a href="https://github.com/openai-translator/openai-translator" target="_blank" class="img-link shimmer" ><img data-src="https://repository-images.githubusercontent.com/609416865/2fee2046-51a5-407c-9641-851e5032ec63" alt="" class="lazyload" data-proofer-ignore></a></p><p>Chrome Extension’s advantage is its speed, simplicity, and convenience—just install and use directly. The downside is that you need to provide the API Key to all members, making it difficult to control leakage issues. Additionally, using third-party services makes it hard to ensure data security.</p><h4 id="self-hosted-librechat"><span class="me-2">[Self-hosted] <a href="https://github.com/danny-avila/LibreChat" target="_blank">LibreChat</a></span><a href="#self-hosted-librechat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/danny-avila/LibreChat" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/fb9ebc74eab308e279d1a6e3640ddde61edf0b5124dfe30696b8c93f4d5671f7/danny-avila/LibreChat" alt="" class="lazyload" data-proofer-ignore></a></p><p>A colleague from the R&amp;D department recommended this OpenAI API Chat encapsulation service. It provides authentication and almost replicates the ChatGPT interface, with more powerful features than ChatGPT, as an open-source project.</p><p><a href="/assets/bd94cc88f9c9/1*8Y_GtNjjuz_FS-CDEwIQzA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*8Y_GtNjjuz_FS-CDEwIQzA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>You only need the project, install Docker, set up the .env file, and start the Docker service to use it directly through the website.</p><blockquote><p><strong>Tried it out, and it’s practically flawless, just like a local version of ChatGPT service. The only downside is that it requires server deployment. If there are no other considerations, you can directly use this open-source project.</strong></p></blockquote><h3 id="slack-app"><span class="me-2">Slack App</span><a href="#slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Actually, setting up the <a href="https://github.com/danny-avila/LibreChat" target="_blank">LibreChat</a> service on a server already achieves the desired effect. However, I had a sudden thought: wouldn’t it be more convenient if it could be integrated into daily tools? Additionally, the company’s server has strict permission settings, making it difficult to start services arbitrarily.</p><p>At the time, I didn’t think much about it and assumed there would be many OpenAI API integration services for Slack App. I thought I could just find one and set it up. Unexpectedly, it wasn’t that simple.</p><p>A Google search only found an official Slack x OpenAI 2023/03 press release, “ <a href="https://slack.com/intl/zh-tw/blog/news/why-we-built-the-chatgpt-app-for-slack" target="_blank">Why we built the ChatGPT app for Slack</a>,” and some Beta images:</p><p><a href="/assets/bd94cc88f9c9/1*M4fXzn1PIEBamjLMDckcSA.gif" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*M4fXzn1PIEBamjLMDckcSA.gif" alt="[https://www.salesforce.com/news/stories/chatgpt-app-for-slack/](https://www.salesforce.com/news/stories/chatgpt-app-for-slack/){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p><a href="https://www.salesforce.com/news/stories/chatgpt-app-for-slack/" target="_blank">https://www.salesforce.com/news/stories/chatgpt-app-for-slack/</a></p><p>It looks very comprehensive and could greatly improve work efficiency. However, as of 2024/01, there has been no release news. The <a href="http://openai.com/waitlist/slack" target="_blank">Beta registration link</a> provided at the end of the article is also invalid, with no further updates. (Is Microsoft trying to support Teams first?)</p><p><strong>[2024/02/14 Update]:</strong></p><ul><li>According to <a href="https://slack.com/intl/zh-tw/blog/news/slack-ai-has-arrived" target="_blank">Slack official news</a>, it seems that the integration with ChatGPT (OpenAI) has either been abandoned or integrated into <a href="https://slack.com/intl/zh-tw/blog/news/slack-ai-has-arrived" target="_blank">Slack AI</a>.</ul><h4 id="slack-apps"><span class="me-2">Slack Apps</span><a href="#slack-apps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*gjkHBFeFVkCQ77lhTHM_Qg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*gjkHBFeFVkCQ77lhTHM_Qg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Due to the lack of an official app, I turned to search for third-party developer apps. I searched and tried several but hit a wall. There were not many suitable apps, and none provided a custom Key feature. Each one was designed to sell services and make money.</p><h3 id="implementing-chatgpt-openai-api-for-slack-app-yourself"><span class="me-2">Implementing ChatGPT OpenAI API for Slack App Yourself</span><a href="#implementing-chatgpt-openai-api-for-slack-app-yourself" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Previously had some experience developing Slack Apps, decided to do it myself.</p><blockquote><p><strong>⚠️Disclaimer⚠️</strong></p></blockquote><blockquote><p>This article demonstrates how to create a Slack App and quickly use Google Cloud Functions to meet the requirements by integrating the OpenAI API. There are many applications for Slack Apps, feel free to explore.</p></blockquote><blockquote><p>⚠️⚠️ The advantage of Google Cloud Functions, Function as a Service (FaaS), is that it is convenient and fast, with a free quota. Once the program is written, it can be deployed and executed directly, and it scales automatically. The downside is that the service environment is controlled by GCP. If the service is not called for a long time, it will go into hibernation, and calling it again will enter <a href="https://cloud.google.com/functions/docs/configuring/recommender?hl=en" target="_blank">Cold Start</a>, requiring a longer response time. Additionally, it is more challenging to have multiple services interact with each other.</p></blockquote><blockquote><p>For more complete or high-demand usage, it is recommended to set up a VM (App Engine) to run the service.</p></blockquote><h4 id="final-result"><span class="me-2">Final Result</span><a href="#final-result" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*af90HtXO_f9qLReKZ85iDg.gif" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*af90HtXO_f9qLReKZ85iDg.gif" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p>The complete Cloud Functions Python code and Slack App settings are attached at the end of the article. Those who are too lazy to follow step by step can quickly refer to it.</p></blockquote><h3 id="step-1-create-a-slack-app"><span class="me-2">Step 1. Create a Slack App</span><a href="#step-1-create-a-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Go to <a href="https://api.slack.com/apps" target="_blank">Slack App</a>:</p><p><a href="/assets/bd94cc88f9c9/1*m4gmfX6XuNczSRAVwzvo_g.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*m4gmfX6XuNczSRAVwzvo_g.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Click “Create New App”</p><p><a href="/assets/bd94cc88f9c9/1*bORUew6Y7DEN9QMFqqqOQw.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*bORUew6Y7DEN9QMFqqqOQw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Select “From scratch”</p><p><a href="/assets/bd94cc88f9c9/1*U_kB4YxWf0X0RnSyD9ZIYw.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*U_kB4YxWf0X0RnSyD9ZIYw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Enter “App Name” and choose the Workspace to join.</p><p><a href="/assets/bd94cc88f9c9/1*RNjigMtA1XJHxq4NAv3pKg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*RNjigMtA1XJHxq4NAv3pKg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>After creation, go to “OAuth &amp; Permissions” to add the permissions needed for the Bot.</p><p><a href="/assets/bd94cc88f9c9/1*rLHaXjMXifaCvHSKGeWaOg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*rLHaXjMXifaCvHSKGeWaOg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Scroll down to find the “Scopes” section, click “Add an OAuth Scope” and add the following permissions:</p><ul><li>chat:write<li>im:history<li>im:read<li>im:write</ul><p>After adding Bot permissions, click “Install App” on the left -&gt; “Install to Workspace”</p><p><a href="/assets/bd94cc88f9c9/1*PlvdPG-pcNPtP48pGSP1Tg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*PlvdPG-pcNPtP48pGSP1Tg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>If the Slack App adds other permissions later, you need to click “Reinstall” again for them to take effect.</p><p><a href="/assets/bd94cc88f9c9/1*EZTaUMwyTsWA7WmUab8rbQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*EZTaUMwyTsWA7WmUab8rbQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p><strong>But rest assured, the Bot Token will not change due to reinstallation.</strong></p></blockquote><p>After setting up the Slack Bot Token permissions, go to “App Home”:</p><p><a href="/assets/bd94cc88f9c9/1*7mBKY188fkfTpGNOLtfByQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*7mBKY188fkfTpGNOLtfByQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Scroll down to find the “Show Tabs” section, enable “Messages Tab” and “Allow users to send Slash commands and messages from the messages tab” (if this is not checked, you cannot send messages, and it will display “Sending messages to this app has been turned off.”).</p><p><a href="/assets/bd94cc88f9c9/1*dEOSGTBN4v5AuWncYNqBEA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*dEOSGTBN4v5AuWncYNqBEA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Return to the Slack Workspace, press “Command+R” to refresh the screen, and you will see the newly created Slack App and message input box:</p><p><a href="/assets/bd94cc88f9c9/1*7tjv1snWJ1IOsEvSTt4KeQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*7tjv1snWJ1IOsEvSTt4KeQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>At this point, sending a message to the App has no functionality.</p><h4 id="enable-event-subscriptions"><span class="me-2">Enable Event Subscriptions</span><a href="#enable-event-subscriptions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*-DpIEDSaTT2yP4LXw3ZBbQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*-DpIEDSaTT2yP4LXw3ZBbQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Next, we need to enable the event subscription feature of the Slack App, which will call the API to the specified URL when a specified event occurs.</p><h4 id="add-google-cloud-functions"><span class="me-2">Add Google Cloud Functions</span><a href="#add-google-cloud-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For the Request URL part, <a href="https://console.cloud.google.com/functions/list" target="_blank">Google Cloud Functions</a> will come into play.</p><p>After setting up the project and billing information, click “Create Function”.</p><p><a href="/assets/bd94cc88f9c9/1*dBYo5ylUh9dhJF_1YG9RBg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*dBYo5ylUh9dhJF_1YG9RBg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/bd94cc88f9c9/1*p4AmWUsLvovFVjEd7JlxuA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*p4AmWUsLvovFVjEd7JlxuA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Enter the project name for Function name, and select “Allow unauthenticated invocations” for Authentication, which means that knowing the URL allows access.</p><blockquote><p>If you cannot create a Function or change Authentication, it means your GCP account does not have full Google Cloud Functions permissions. You need to ask the organization administrator to add the Cloud Functions Admin permission in addition to your original role to use it.</p></blockquote><p><a href="/assets/bd94cc88f9c9/1*LOrzMQqDFhLE3s64sS2gKQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*LOrzMQqDFhLE3s64sS2gKQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Runtime: Python 3.8 or higher</p><p><code class="language-plaintext highlighter-rouge">main.py</code>:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">functions_framework</span>

<span class="o">@</span><span class="n">functions_framework</span><span class="p">.</span><span class="n">http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># You can simply use print to record runtime logs, which can be viewed in Logs
</span>    <span class="c1"># For advanced Logging Level usage, refer to: https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="k">print</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>

    <span class="c1"># Due to the FAAS (Cloud Functions) limitation, if the service is not called for a long time, it will enter a cold start when called again, which may not respond within the 3-second limit set by Slack
</span>    <span class="c1"># Additionally, the OpenAI API request takes a certain amount of time to respond (depending on the response length, it may take nearly 1 minute to complete)
</span>    <span class="c1"># If Slack does not receive a response within the time limit, it will consider the request lost and will call again
</span>    <span class="c1"># This can cause duplicate requests and responses, so we can set X-Slack-No-Retry: 1 in the Response Headers to inform Slack not to retry even if it does not receive a response within the time limit
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'X-Slack-No-Retry'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># If it is a Slack Retry request...ignore it
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="s">'X-Slack-Retry-Num'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">'OK!'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'url_verification'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="s">""</span>
        <span class="k">if</span> <span class="s">'challenge'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'challenge'</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="s">"Access Denied!"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><p>Enter the following dependencies in <code class="language-plaintext highlighter-rouge">requirements.txt</code>:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>functions-framework==3.*
requests==2.31.0
openai==1.9.0
</pre></table></code></div></div><p>Currently, there is no functionality, it just allows the Slack App to pass the Event Subscriptions verification. You can directly click “Deploy” to complete the first deployment.</p><blockquote><p>⚠️If you are not familiar with the Cloud Functions editor, you can scroll down to the bottom of the article to see the supplementary content.</p></blockquote><p><strong>After the deployment is complete (green checkmark)</strong>, copy the Cloud Functions URL:</p><p><a href="/assets/bd94cc88f9c9/1*qZCQYGuzzL0Skz6K7RV1Ow.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*qZCQYGuzzL0Skz6K7RV1Ow.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Paste the Request URL back into the Slack App Enable Events.</p><p><a href="/assets/bd94cc88f9c9/1*NyL0Ja9yxzisMZg0QyHfoA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*NyL0Ja9yxzisMZg0QyHfoA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>If everything is correct, “Verified” will appear, completing the verification.</p><p>What happens here is that when a verification request is received from Slack:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jhj5dZrVaK7ZwHHjRyZWjbDl"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"challenge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3eZbrw1aBm2rZgRNFdxV2595E9CY3gmdALWMmHkvFXO7tYXAYM8P"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url_verification"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Respond with the content of the <code class="language-plaintext highlighter-rouge">challenge</code> field to pass the verification.</p><p><a href="/assets/bd94cc88f9c9/1*qgUQe3wIjCxDw8JAYR1dkg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*qgUQe3wIjCxDw8JAYR1dkg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>After enabling successfully, scroll down to find the “Subscribe to bot events” section, click “Add Bot User Event” to add the “message.im” permission.</p><p><a href="/assets/bd94cc88f9c9/1*T-9-xrfQvWTEJArALV3QlA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*T-9-xrfQvWTEJArALV3QlA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>After adding the full permissions, click the “reinstall your app” link at the top to reinstall the Slack App to the Workspace, and the Slack App setup is complete.</p><p>You can also go to “App Home” or “Basic Information” to customize the Slack App’s name and avatar.</p><p><a href="/assets/bd94cc88f9c9/1*9qsVF__3nSjxLJww6PN44g.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*9qsVF__3nSjxLJww6PN44g.png" alt="Basic Information" class="lazyload" data-proofer-ignore></a></p><p>Basic Information</p><h3 id="step-2-integrate-openai-api-with-slack-app-direct-messages"><span class="me-2">Step 2. Integrate OpenAI API with Slack App (Direct Messages)</span><a href="#step-2-integrate-openai-api-with-slack-app-direct-messages" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First, we need to obtain the essential <code class="language-plaintext highlighter-rouge">OPENAI API KEY</code> and <code class="language-plaintext highlighter-rouge">Bot User OAuth Token</code>.</p><ul><li><code class="language-plaintext highlighter-rouge">OPENAI API KEY</code>: <a href="https://platform.openai.com/account/api-keys" target="_blank">OpenAI API key page</a>.</ul><p><a href="/assets/bd94cc88f9c9/1*DKOm3yZVA1K_EJ3AUeCDsA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*DKOm3yZVA1K_EJ3AUeCDsA.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li><code class="language-plaintext highlighter-rouge">Bot User OAuth Token</code>: <a href="https://api.slack.com/apps/" target="_blank">OAuth Tokens for Your Workspace</a>.</ul><p><a href="/assets/bd94cc88f9c9/1*mLoxaBPpa_IUP_qOaFZhQg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*mLoxaBPpa_IUP_qOaFZhQg.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="handling-direct-message-im-event--integrating-openai-api-response"><span class="me-2">Handling Direct Message (IM) Event &amp; Integrating OpenAI API Response</span><a href="#handling-direct-message-im-event--integrating-openai-api-response" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>When a user sends a message to the Slack App, the following Event JSON Payload is received:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"context_team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"context_enterprise_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nl">"api_app_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"client_msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"你好"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1707920753.115429"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"blocks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rich_text"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"block_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"orfng"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"elements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rich_text_section"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"elements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="p">{</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"你好"</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"team"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"event_ts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1707920753.115429"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"channel_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"im"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event_callback"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1707920753</span><span class="p">,</span><span class="w">
  </span><span class="nl">"authorizations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"enterprise_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nl">"team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_bot"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_enterprise_install"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"is_ext_shared_channel"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_context"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4-XXX"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Based on the above Json Payload, we can complete the integration from Slack messages to the OpenAI API and then back to replying to Slack messages:</p><p><strong>Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ：</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">functions_framework</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="s">"OPENAI API KEY"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="s">"Bot User OAuth Token"</span>

<span class="c1"># The OPENAI API Model used
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="s">"gpt-4-1106-preview"</span>

<span class="o">@</span><span class="n">functions_framework</span><span class="p">.</span><span class="n">http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># You can simply use print to record runtime logs, which can be viewed in Logs
</span>    <span class="c1"># For advanced Logging Level usage, refer to: https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="k">print</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>

    <span class="c1"># Due to the nature of FAAS (Cloud Functions), if the service is not called for a long time, it will enter a cold start when called again, which may not respond within the 3-second limit set by Slack
</span>    <span class="c1"># Additionally, the OpenAI API request to response takes a certain amount of time (depending on the response length, it may take close to 1 minute to complete)
</span>    <span class="c1"># If Slack does not receive a response within the time limit, it will consider the request lost and will call again
</span>    <span class="c1"># This can cause duplicate requests and responses, so we can set X-Slack-No-Retry: 1 in the Response Headers to inform Slack not to retry even if it does not receive a response within the time limit
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'X-Slack-No-Retry'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># If it is a Slack Retry request...ignore it
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="s">'X-Slack-Retry-Num'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">'OK!'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'url_verification'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="s">""</span>
        <span class="k">if</span> <span class="s">'challenge'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'challenge'</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'event'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
        <span class="c1"># If the event source is the App and the App ID == Slack App ID, it means the event was triggered by the Slack App itself
</span>        <span class="c1"># Ignore and do not process, otherwise it will fall into an infinite loop Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="s">'api_app_id'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'app_id'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'api_app_id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'app_id'</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">'OK!'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Event name, for example: message (related to messages), app_mention (mentioned)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span>

        <span class="c1"># SubType, for example: message_changed (edited message), message_deleted (deleted message)...
</span>        <span class="c1"># New messages do not have a Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">'subtype'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'subtype'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="s">'message'</span><span class="p">:</span>
            <span class="c1"># Messages with Sub Type are edited, deleted, replied to...
</span>            <span class="c1"># Ignore and do not process
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Sender of the event message
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'user'</span><span class="p">]</span>
            <span class="c1"># Channel of the event message
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'channel'</span><span class="p">]</span>
            <span class="c1"># Content of the event message
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'text'</span><span class="p">]</span>
            <span class="c1"># TS (message ID) of the event message
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'event_ts'</span><span class="p">]</span>
                
            <span class="c1"># TS (message ID) of the parent message in the thread of the event message
</span>            <span class="c1"># Only new messages in the thread will have this data
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="s">'thread_ts'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'thread_ts'</span><span class="p">]</span>
                
            <span class="n">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="k">return</span> <span class="p">(</span><span class="s">"Access Denied!"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># Thanks to my colleague (https://twitter.com/je_suis_marku) for the support
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I can only understand Traditional Chinese from Taiwan and English"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I cannot understand Simplified Chinese"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If I speak Chinese, I will respond in Traditional Chinese from Taiwan, and it must conform to common Taiwanese usage."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If I speak English, I will respond in English."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"Do not respond with pleasantries."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"There should be a space between Chinese and English. There should be a space between Chinese characters and any other language characters, including numbers and emojis."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If you don't know the answer, or if your knowledge is outdated, please search online before answering."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I will tip you 200 USD, if you answer well."</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s">"role"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="n">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="s">"Generating response..."</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="s">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s">""</span>
            
            <span class="c1"># Update the message every 0.8 seconds to avoid frequent calls to the Slack Update Message API, which may fail or waste Cloud Functions request counts
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="s">"..."</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s">"...*[Error occurred]*"</span>

    <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/chat.update"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"channel"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="s">"ts"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s">'metadata'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="s">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/chat.postMessage"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"channel"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="s">"text"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s">'thread_ts'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">'ts'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s">'ts'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://slack.com/api"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"Authorization"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
        <span class="s">"Content-Type"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">"POST"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">"GET"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>Back to Slack to test:</strong></p><p><a href="/assets/bd94cc88f9c9/1*xENCHCINYpPIQKvJeycdaA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*xENCHCINYpPIQKvJeycdaA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Now you can perform Q&amp;A similar to ChatGPT and OpenAI API.</p><h4 id="add-stream-response-interruption-feature-to-save-tokens"><span class="me-2">Add Stream Response Interruption Feature to Save Tokens</span><a href="#add-stream-response-interruption-feature-to-save-tokens" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>There are many ways to implement this. For example, if a user inputs a new message in the same thread before the previous response is complete, it interrupts the previous response, or by clicking a message to add an interruption shortcut.</p><p><a href="/assets/bd94cc88f9c9/1*IT671oCwfUP3yqVbNtedSg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*IT671oCwfUP3yqVbNtedSg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>This article uses the example of adding a “Message Interruption” shortcut.</p><p>Regardless of the interruption method, the core principle is the same. Since we do not have a database to store generated messages and message status information, the implementation relies on the <a href="https://api.slack.com/metadata/using" target="_blank"><strong>metadata field</strong></a> of Slack messages (which can store custom information within specified messages).</p><p>When using the <a href="https://api.slack.com/methods/chat.update" target="_blank">chat.update</a> API Endpoint, if the call is successful, it will return the text content and metadata of the current message. Therefore, in the above OpenAI API Stream -&gt; Slack Update Message code, we add a judgment to check if the metadata in the response of the modification request has an “interruption” mark. If it does, it interrupts the OpenAI Stream Response.</p><p><strong>First, you need to add a Slack App message shortcut</strong></p><p>Go to the <a href="https://api.slack.com/apps" target="_blank">Slack App</a> management interface, find the “Interactivity &amp; Shortcuts” section, click to enable it, and use the same Cloud Functions URL.</p><p><a href="/assets/bd94cc88f9c9/1*DCUyec3HYlrcIrZoSDCoMw.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*DCUyec3HYlrcIrZoSDCoMw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Click “Create New Shortcut” to add a new message shortcut.</p><p><a href="/assets/bd94cc88f9c9/1*ybhq_ceaXLFEUsLFyW7sJg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*ybhq_ceaXLFEUsLFyW7sJg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Select “On messages”.</p><p><a href="/assets/bd94cc88f9c9/1*HDkOjV2GcJw_ETTVqV0ErQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*HDkOjV2GcJw_ETTVqV0ErQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li>Name: <code class="language-plaintext highlighter-rouge">Stop OpenAI API Response</code><li>Short Description: <code class="language-plaintext highlighter-rouge">Stop OpenAI API Response</code><li>Callback ID: <code class="language-plaintext highlighter-rouge">abort_openai_api</code> (for program identification, can be customized)</ul><p>Click “Create” to complete the creation, and finally remember to click “Save Changes” at the bottom right to save the settings.</p><p><a href="/assets/bd94cc88f9c9/1*7ti_5hZOoyY6uVp5kWDl3A.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*7ti_5hZOoyY6uVp5kWDl3A.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Click “reinstall your app” at the top again to take effect.</p><p><a href="/assets/bd94cc88f9c9/1*dUE54HgASm30xq2ILW3ioQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*dUE54HgASm30xq2ILW3ioQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Back in Slack, click the “…” at the top right of the message, and the “Stop OpenAI API Response” shortcut will appear (clicking it at this time has no effect).</p><p><a href="/assets/bd94cc88f9c9/1*HjqrkPP1op1Kz-BQuO920Q.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*HjqrkPP1op1Kz-BQuO920Q.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><strong>When the user presses the</strong> Shortcut <strong>on the message, an Event Json Payload will be sent:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="p">{</span>
  <span class="s">"type"</span><span class="p">:</span> <span class="s">"message_action"</span><span class="p">,</span>
  <span class="s">"token"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
  <span class="s">"action_ts"</span><span class="p">:</span> <span class="s">"1706188005.387646"</span><span class="p">,</span>
  <span class="s">"team"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"domain"</span><span class="p">:</span> <span class="s">"XXXXXX-XXXXXX"</span>
  <span class="p">},</span>
  <span class="s">"user"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"username"</span><span class="p">:</span> <span class="s">"zhgchgli"</span><span class="p">,</span>
    <span class="s">"team_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"zhgchgli"</span>
  <span class="p">},</span>
  <span class="s">"channel"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"directmessage"</span>
  <span class="p">},</span>
  <span class="s">"is_enterprise_install"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="s">"enterprise"</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
  <span class="s">"callback_id"</span><span class="p">:</span> <span class="s">"abort_openai_api"</span><span class="p">,</span>
  <span class="s">"trigger_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
  <span class="s">"response_url"</span><span class="p">:</span> <span class="s">"https://hooks.slack.com/app/XXXXXX/XXXXXX/XXXXXX"</span><span class="p">,</span>
  <span class="s">"message_ts"</span><span class="p">:</span> <span class="s">"1706178957.161109"</span><span class="p">,</span>
  <span class="s">"message"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"bot_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"type"</span><span class="p">:</span> <span class="s">"message"</span><span class="p">,</span>
    <span class="s">"text"</span><span class="p">:</span> <span class="s">"The English translation of 高麗菜包 is </span><span class="se">\"</span><span class="s">cabbage wrap.</span><span class="se">\"</span><span class="s"> If you are using it as a dish name, it may sometimes be named specifically according to the contents of the dish, such as </span><span class="se">\"</span><span class="s">pork cabbage wrap</span><span class="se">\"</span><span class="s"> or </span><span class="se">\"</span><span class="s">vegetable cabbage wrap.</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span>
    <span class="s">"user"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"ts"</span><span class="p">:</span> <span class="s">"1706178957.161109"</span><span class="p">,</span>
    <span class="s">"app_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"blocks"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s">"type"</span><span class="p">:</span> <span class="s">"rich_text"</span><span class="p">,</span>
        <span class="s">"block_id"</span><span class="p">:</span> <span class="s">"eKgaG"</span><span class="p">,</span>
        <span class="s">"elements"</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"rich_text_section"</span><span class="p">,</span>
            <span class="s">"elements"</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s">"type"</span><span class="p">:</span> <span class="s">"text"</span><span class="p">,</span>
                <span class="s">"text"</span><span class="p">:</span> <span class="s">"The English translation of 高麗菜包 is </span><span class="se">\"</span><span class="s">cabbage wrap.</span><span class="se">\"</span><span class="s"> If you are using it as a dish name, it may sometimes be named specifically according to the contents of the dish, such as </span><span class="se">\"</span><span class="s">pork cabbage wrap</span><span class="se">\"</span><span class="s"> or </span><span class="se">\"</span><span class="s">vegetable cabbage wrap.</span><span class="se">\"</span><span class="s">"</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"team"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"bot_profile"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"deleted"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s">"name"</span><span class="p">:</span> <span class="s">"Rick C-137"</span><span class="p">,</span>
      <span class="s">"updated"</span><span class="p">:</span> <span class="mi">1706001605</span><span class="p">,</span>
      <span class="s">"app_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"icons"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"image_36"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_36.png"</span><span class="p">,</span>
        <span class="s">"image_48"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_48.png"</span><span class="p">,</span>
        <span class="s">"image_72"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_72.png"</span>
      <span class="p">},</span>
      <span class="s">"team_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span>
    <span class="p">},</span>
    <span class="s">"edited"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"user"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"ts"</span><span class="p">:</span> <span class="s">"1706187989.000000"</span>
    <span class="p">},</span>
    <span class="s">"thread_ts"</span><span class="p">:</span> <span class="s">"1706178832.102439"</span><span class="p">,</span>
    <span class="s">"parent_user_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Complete Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code>:</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">functions_framework</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="s">"OPENAI API KEY"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="s">"Bot User OAuth Token"</span>

<span class="c1"># The OPENAI API Model used
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="s">"gpt-4-1106-preview"</span>

<span class="o">@</span><span class="n">functions_framework</span><span class="p">.</span><span class="n">http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut Event will be given from post payload field
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'payload'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># You can simply use print to record runtime logs, which can be viewed in Logs
</span>    <span class="c1"># For advanced Logging Level usage, refer to: https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="k">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># Due to the nature of FAAS (Cloud Functions), if the service is not called for a long time, it will enter a cold start when called again, which may not respond within the 3-second limit set by Slack
</span>    <span class="c1"># Additionally, the OpenAI API request takes a certain amount of time to respond (depending on the response length, it may take nearly 1 minute to complete)
</span>    <span class="c1"># If Slack does not receive a response within the time limit, it will consider the request lost and will call again
</span>    <span class="c1"># This will cause repeated requests and responses, so we can set X-Slack-No-Retry: 1 in the Response Headers to inform Slack not to retry even if it does not receive a response within the time limit
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'X-Slack-No-Retry'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

    <span class="c1"># If it is a Slack Retry request...ignore it
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="s">'X-Slack-Retry-Num'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">'OK!'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'url_verification'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="s">""</span>
        <span class="k">if</span> <span class="s">'challenge'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'challenge'</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'event'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
        <span class="c1"># If the Event source is the App and App ID == Slack App ID, it means the event was triggered by the Slack App itself
</span>        <span class="c1"># Ignore and do not process, otherwise it will fall into an infinite loop Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="s">'api_app_id'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'app_id'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'api_app_id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'app_id'</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">'OK!'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Event name, for example: message (related to messages), app_mention (mentioned)...
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span>

        <span class="c1"># SubType, for example: message_changed (edited message), message_deleted (deleted message)...
</span>        <span class="c1"># New messages do not have Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">'subtype'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'subtype'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="s">'message'</span><span class="p">:</span>
            <span class="c1"># Messages with Sub Type are edited, deleted, replied to...
</span>            <span class="c1"># Ignore and do not process
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Message sender of the Event
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'user'</span><span class="p">]</span>
            <span class="c1"># Channel of the Event message
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'channel'</span><span class="p">]</span>
            <span class="c1"># Content of the Event message
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'text'</span><span class="p">]</span>
            <span class="c1"># TS (message ID) of the Event message
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'event_ts'</span><span class="p">]</span>
                
            <span class="c1"># TS (message ID) of the parent message in the thread of the Event message
</span>            <span class="c1"># Only new messages in the thread will have this data
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="s">'thread_ts'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'thread_ts'</span><span class="p">]</span>
                
            <span class="n">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># Handle Shortcut
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span>

        <span class="c1"># If it is a message Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="s">'message_action'</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">payloadType</span><span class="p">)</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="s">'callback_id'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'callback_id'</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">'channel'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'channel'</span><span class="p">][</span><span class="s">'id'</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">'message'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'ts'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'text'</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">'trigger_id'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'trigger_id'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># If it is the Stop OpenAI API Response Generation Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="s">"abort_openai_api"</span><span class="p">:</span>
                    <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="s">"event_type"</span><span class="p">:</span> <span class="s">"aborted"</span><span class="p">,</span> <span class="s">"event_payload"</span><span class="p">:</span> <span class="p">{}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="s">"Successfully stopped OpenAI API response generation!"</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="k">return</span> <span class="p">(</span><span class="s">"Access Denied!"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># Thanks to colleague (https://twitter.com/je_suis_marku) for support
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I can only understand Traditional Chinese from Taiwan and English"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I cannot understand Simplified Chinese"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If I speak Chinese, I will respond in Traditional Chinese from Taiwan, and it must conform to common Taiwanese usage."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If I speak English, I will respond in English."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"Do not respond with pleasantries."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"There should be a space between Chinese and English. There should be a space between Chinese characters and any other language characters, including numbers and emojis."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If you don't know the answer, or your knowledge is outdated, please search online before answering."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I will tip you 200 USD, if you answer well."</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s">"role"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="n">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="s">"Generating response..."</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="s">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s">""</span>
            
            <span class="c1"># Update the message every 0.8 seconds to avoid frequent calls to the Slack Update Message API, which may fail or waste Cloud Functions request counts
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="s">"..."</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># If the message has metadata &amp; metadata event_type == aborted, it means the response has been marked as terminated by the user
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="s">'ok'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'ok'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="s">'message'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="s">'metadata'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s">'message'</span><span class="p">]</span> <span class="ow">and</span> <span class="s">'event_type'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'metadata'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'metadata'</span><span class="p">][</span><span class="s">'event_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"aborted"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="s">"...*[Terminated]*"</span>
                <span class="c1"># The message has been deleted
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="s">'ok'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'ok'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="s">'error'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'error'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"message_not_found"</span><span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s">"...*[Error occurred]*"</span>

    <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">slackRequest</span><span class="p">(</span><span class="s">"/views.open"</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">"trigger_id"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="s">"view"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"modal"</span><span class="p">,</span>
            <span class="s">"callback_id"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="s">"title"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"type"</span><span class="p">:</span> <span class="s">"plain_text"</span><span class="p">,</span>
                <span class="s">"text"</span><span class="p">:</span> <span class="s">"Prompt"</span>
            <span class="p">},</span>
            <span class="s">"blocks"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s">"type"</span><span class="p">:</span> <span class="s">"section"</span><span class="p">,</span>
                    <span class="s">"text"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">"type"</span><span class="p">:</span> <span class="s">"mrkdwn"</span><span class="p">,</span>
                        <span class="s">"text"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/chat.update"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"channel"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="s">"ts"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s">'metadata'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="s">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/chat.postMessage"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"channel"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="s">"text"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s">'thread_ts'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">'ts'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s">'ts'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://slack.com/api"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"Authorization"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
        <span class="s">"Content-Type"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">"POST"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">"GET"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>Back to Slack to test:</strong></p><p><a href="/assets/bd94cc88f9c9/1*pL343-5zxlJY44gG1qlUDA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*pL343-5zxlJY44gG1qlUDA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/bd94cc88f9c9/1*VbWl3IDpgcuT8wKIC_IzsQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*VbWl3IDpgcuT8wKIC_IzsQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Success! When we complete the <code class="language-plaintext highlighter-rouge">Stop OpenAI API</code> Shortcut, the ongoing response will be terminated, and it will respond with <strong>[Terminated]</strong>.</p><blockquote><p>Similarly, you can also create a Shortcut to delete messages, implementing the deletion of messages sent by the Slack App.</p></blockquote><h4 id="adding-context-functionality-in-the-same-thread"><span class="me-2">Adding Context Functionality in the Same Thread</span><a href="#adding-context-functionality-in-the-same-thread" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>If you send a new message in the same thread, it can be considered a follow-up question to the same issue. At this point, you can add a feature to supplement the new prompt with the previous conversation content.</p><p><strong>Add <code class="language-plaintext highlighter-rouge">slackGetReplies</code> &amp; Fill Content into OpenAI API Prompt:</strong></p><p><strong>Complete Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code>:</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">functions_framework</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="s">"OPENAI API KEY"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="s">"Bot User OAuth Token"</span>

<span class="c1"># The OPENAI API Model used
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="s">"gpt-4-1106-preview"</span>

<span class="o">@</span><span class="n">functions_framework</span><span class="p">.</span><span class="n">http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Event from Shortcut will be given in post payload field
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'payload'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># You can simply use print to record runtime logs, which can be viewed in Logs
</span>    <span class="c1"># For advanced Logging Level usage, refer to: https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="k">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># Due to the nature of FAAS (Cloud Functions), if the service is not called for a long time, it will enter a cold start when called again, which may not respond within Slack's 3-second limit
</span>    <span class="c1"># Plus, OpenAI API requests take a certain amount of time to respond (depending on the response length, it may take up to 1 minute to complete)
</span>    <span class="c1"># If Slack does not receive a response within the time limit, it will consider the request lost and will call again
</span>    <span class="c1"># This can cause duplicate requests and responses, so we can set X-Slack-No-Retry: 1 in the Response Headers to inform Slack not to retry even if it does not receive a response within the time limit
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'X-Slack-No-Retry'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># If it's a Slack Retry request...ignore it
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="s">'X-Slack-Retry-Num'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">'OK!'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'url_verification'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="s">""</span>
        <span class="k">if</span> <span class="s">'challenge'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'challenge'</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'event'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
        <span class="n">apiAppID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">'api_app_id'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">apiAppID</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'api_app_id'</span><span class="p">]</span>
        <span class="c1"># If the event source is the App and App ID == Slack App ID, it means the event was triggered by the Slack App itself
</span>        <span class="c1"># Ignore it to avoid infinite loops Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="s">'app_id'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">apiAppID</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'app_id'</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">'OK!'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Event name, e.g., message (related to messages), app_mention (mentioned)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span>

        <span class="c1"># SubType, e.g., message_changed (edited message), message_deleted (deleted message)...
</span>        <span class="c1"># New messages do not have a Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">'subtype'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'subtype'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="s">'message'</span><span class="p">:</span>
            <span class="c1"># Messages with Sub Type are edited, deleted, or replied to...
</span>            <span class="c1"># Ignore them
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Message sender of the Event
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'user'</span><span class="p">]</span>
            <span class="c1"># Channel of the Event message
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'channel'</span><span class="p">]</span>
            <span class="c1"># Content of the Event message
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'text'</span><span class="p">]</span>
            <span class="c1"># TS (message ID) of the Event message
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'event_ts'</span><span class="p">]</span>
                
            <span class="c1"># TS (message ID) of the parent message in the thread of the Event message
</span>            <span class="c1"># Only new messages in the thread will have this data
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="s">'thread_ts'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'thread_ts'</span><span class="p">]</span>
                
            <span class="n">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># Handle Shortcut (message)
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span>

        <span class="c1"># If it's a message Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="s">'message_action'</span><span class="p">:</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="s">'callback_id'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'callback_id'</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">'channel'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'channel'</span><span class="p">][</span><span class="s">'id'</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">'message'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'ts'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'text'</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">'trigger_id'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'trigger_id'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># If it's the Stop OpenAI API response Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="s">"abort_openai_api"</span><span class="p">:</span>
                    <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="s">"event_type"</span><span class="p">:</span> <span class="s">"aborted"</span><span class="p">,</span> <span class="s">"event_payload"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="s">"Successfully stopped OpenAI API response!"</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="k">return</span> <span class="p">(</span><span class="s">"Access Denied!"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># Thanks to my colleague (https://twitter.com/je_suis_marku) for the support
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I can only understand Traditional Chinese and English"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I cannot understand Simplified Chinese"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If I speak Chinese, I will respond in Traditional Chinese used in Taiwan, and it must conform to common usage in Taiwan."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If I speak English, I will respond in English."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"Do not respond with pleasantries."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"There should be a space between Chinese and English. There should be a space between Chinese characters and any other language characters, including numbers and emojis."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If you don't know the answer, or if your knowledge is outdated, please search online before answering."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I will tip you 200 USD if you answer well."</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">eventThreadTS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">threadMessages</span> <span class="o">=</span> <span class="n">slackGetReplies</span><span class="p">(</span><span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threadMessages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threadMessage</span> <span class="ow">in</span> <span class="n">threadMessages</span><span class="p">:</span>
                <span class="n">appID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="s">'app_id'</span> <span class="ow">in</span> <span class="n">threadMessage</span><span class="p">:</span>
                    <span class="n">appID</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="s">'app_id'</span><span class="p">]</span>
                <span class="n">threadMessageText</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="s">'text'</span><span class="p">]</span>
                <span class="n">threadMessageTs</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="s">'ts'</span><span class="p">]</span>
                <span class="c1"># If it's a Slack App (OpenAI API Response), mark it as assistant
</span>                <span class="k">if</span> <span class="n">appID</span> <span class="ow">and</span> <span class="n">appID</span> <span class="o">==</span> <span class="n">apiAppID</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s">"role"</span><span class="p">:</span> <span class="s">"assistant"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Mark the user's message content as user
</span>                    <span class="n">messages</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s">"role"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>

    <span class="n">messages</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s">"role"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="n">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="s">"Generating response..."</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="s">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s">""</span>
            
            <span class="c1"># Update the message every 0.8 seconds to avoid frequent calls to the Slack Update Message API, which may fail or waste Cloud Functions requests
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="s">"..."</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># If the message has metadata &amp; metadata event_type == aborted, it means the response has been marked as terminated by the user
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="s">'ok'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'ok'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="s">'message'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="s">'metadata'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s">'message'</span><span class="p">]</span> <span class="ow">and</span> <span class="s">'event_type'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'metadata'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'metadata'</span><span class="p">][</span><span class="s">'event_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"aborted"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="s">"...*[Terminated]*"</span>
                <span class="c1"># If the message has been deleted
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="s">'ok'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'ok'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="s">'error'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'error'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"message_not_found"</span><span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s">"...*[Error occurred]*"</span>

    <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/conversations.replies?channel="</span><span class="o">+</span><span class="n">channel</span><span class="o">+</span><span class="s">"&amp;ts="</span><span class="o">+</span><span class="n">ts</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"GET"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">'messages'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s">'messages'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">slackRequest</span><span class="p">(</span><span class="s">"/views.open"</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">"trigger_id"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="s">"view"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"modal"</span><span class="p">,</span>
            <span class="s">"callback_id"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="s">"title"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"type"</span><span class="p">:</span> <span class="s">"plain_text"</span><span class="p">,</span>
                <span class="s">"text"</span><span class="p">:</span> <span class="s">"Prompt"</span>
            <span class="p">},</span>
            <span class="s">"blocks"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s">"type"</span><span class="p">:</span> <span class="s">"section"</span><span class="p">,</span>
                    <span class="s">"text"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">"type"</span><span class="p">:</span> <span class="s">"mrkdwn"</span><span class="p">,</span>
                        <span class="s">"text"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/chat.update"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"channel"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="s">"ts"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s">'metadata'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="s">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/chat.postMessage"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"channel"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="s">"text"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s">'thread_ts'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">'ts'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s">'ts'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://slack.com/api"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"Authorization"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
        <span class="s">"Content-Type"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">"POST"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">"GET"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>Back to Slack to test:</strong></p><p><a href="/assets/bd94cc88f9c9/1*HCE9oGBELh7ya98ZdMUESg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*HCE9oGBELh7ya98ZdMUESg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li>The left image shows a new conversation when asking a follow-up question without adding Context.<li><strong>The right image shows that with Context added, it can understand the entire conversation context and the new question.</strong></ul><h3 id="done"><span class="me-2">Done!</span><a href="#done" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>At this point, we have built a ChatGPT (via OpenAI API) Slack App Bot.</p><blockquote><p>You can also refer to <a href="https://api.slack.com/" target="_blank">Slack API</a> and OpenAI API Custom instructions to integrate them into Cloud Functions Python programs according to your needs. For example, training a channel to answer team questions and find project documents, a channel dedicated to translation, a channel dedicated to data analysis, etc.</p></blockquote><h3 id="supplement"><span class="me-2">Supplement</span><a href="#supplement" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="marking-the-bot-to-answer-questions-outside-of-11-messages"><span class="me-2">Marking the bot to answer questions outside of 1:1 messages</span><a href="#marking-the-bot-to-answer-questions-outside-of-11-messages" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*_xg6yh7ZMCru0C1NU0-8bQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*_xg6yh7ZMCru0C1NU0-8bQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li>You can mark the bot to answer questions in any channel (the bot needs to be added to the channel).</ul><p><strong>First, you need to add the <code class="language-plaintext highlighter-rouge">app_mention</code> Event Subscription:</strong></p><p><a href="/assets/bd94cc88f9c9/1*lbJxUFn3uXz4a_x6Pw_KeQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*lbJxUFn3uXz4a_x6Pw_KeQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>After adding, click “Save Changes” to save, then “reinstall your app” to complete.</p><p>In the <code class="language-plaintext highlighter-rouge">main.py</code> program mentioned above, in the <code class="language-plaintext highlighter-rouge">#Handle Event Subscriptions Events…</code> Code Block, add a new Event Type judgment:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>        <span class="c1"># Mention Event (@SlackApp hello)
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="s">'app_mention'</span><span class="p">:</span>
            <span class="c1"># Event message sender
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'user'</span><span class="p">]</span>
            <span class="c1"># Event message channel
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'channel'</span><span class="p">]</span>
            <span class="c1"># Event message content, remove the leading tag string &lt;@SLACKAPPID&gt;
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">"&lt;@\w+&gt;\W*"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'text'</span><span class="p">])</span>
            <span class="c1"># Event message TS (message ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'event_ts'</span><span class="p">]</span>
                
            <span class="c1"># Parent message TS of the event message thread (message ID)
</span>            <span class="c1"># Only new messages in the thread will have this data
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="s">'thread_ts'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'thread_ts'</span><span class="p">]</span>
                
            <span class="n">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><p>After deployment, it will be completed.</p><h4 id="deleting-messages-sent-by-slack-app"><span class="me-2">Deleting messages sent by Slack App</span><a href="#deleting-messages-sent-by-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>You cannot directly delete messages sent by Slack App on Slack. You can refer to the above “ <code class="language-plaintext highlighter-rouge">Stop OpenAI API Response</code> “ Shortcut method, and add a “delete message” Shortcut.</p><p>And in the Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> program:</p><p>In the <code class="language-plaintext highlighter-rouge"># Handle Shortcut Code Block</code>, add a callback_id judgment. If it equals the “delete message” Shortcut Callback ID you defined, pass the parameters into the following method to delete:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/chat.delete"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"channel"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="s">"ts"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></table></code></div></div><p><a href="/assets/bd94cc88f9c9/1*0IPliUmdxXA2fNDmI0vqLw.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*0IPliUmdxXA2fNDmI0vqLw.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="slack-app-not-responding"><span class="me-2">Slack App Not Responding</span><a href="#slack-app-not-responding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Check if the Token is correct<li>Check Cloud Functions Logs for errors<li>Ensure Cloud Functions are fully deployed<li>Verify if the Slack App is in the channel you are asking questions in (if it’s not a 1:1 conversation with the Slack App, you need to add the bot to the channel for it to work)<li>Log the Slack API Response under the SlackRequest method</ul><h4 id="cloud-functions-public-url-not-secure-enough"><span class="me-2">Cloud Functions Public URL Not Secure Enough</span><a href="#cloud-functions-public-url-not-secure-enough" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>If you are concerned about the security of the Cloud Functions URL, you can add a query token for verification</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">SAFE_ACCESS_TOKEN</span> <span class="o">=</span> <span class="s">"nF4JwxfG9abqPZCJnBerwwhtodC28BuC"</span>

<span class="o">@</span><span class="n">functions_framework</span><span class="p">.</span><span class="n">http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>
    <span class="c1"># Verify if the token parameter is valid
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">request_args</span> <span class="ow">and</span> <span class="s">'token'</span> <span class="ow">in</span> <span class="n">request_args</span> <span class="ow">and</span> <span class="n">request_args</span><span class="p">[</span><span class="s">'token'</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAFE_ACCESS_TOKEN</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="cloud-functions-related-issues"><span class="me-2">Cloud Functions Related Issues</span><a href="#cloud-functions-related-issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="billing-method"><span class="me-2">Billing Method</span><a href="#billing-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Different regions, CPU, RAM, capacity, traffic… have different prices. Please refer to the <a href="https://cloud.google.com/functions/pricing?hl=zh-tw" target="_blank">official pricing</a> table.</p><p>The <a href="https://cloud.google.com/functions/pricing?hl=zh-tw#free_tier" target="_blank">free tier</a> is as follows: (2024/02/15)</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nx">Cloud</span> <span class="nx">Functions</span> <span class="nx">offers</span> <span class="nx">a</span> <span class="nx">permanent</span> <span class="nx">free</span> <span class="nx">tier</span> <span class="k">for</span> <span class="nx">compute</span> <span class="nx">time</span> <span class="nx">resources</span><span class="p">,</span>
<span class="nx">including</span> <span class="nx">allocations</span> <span class="k">of</span> <span class="nx">GB</span><span class="o">-</span><span class="nx">seconds</span> <span class="nx">and</span> <span class="nx">GHz</span><span class="o">-</span><span class="nx">seconds</span><span class="p">.</span> <span class="nx">In</span> <span class="nx">addition</span> <span class="nx">to</span> <span class="mi">2</span> <span class="nx">million</span> <span class="nx">invocations</span><span class="p">,</span>
<span class="k">this</span> <span class="nx">free</span> <span class="nx">tier</span> <span class="nx">also</span> <span class="nx">provides</span> <span class="mi">400</span><span class="p">,</span><span class="mi">000</span> <span class="nx">GB</span><span class="o">-</span><span class="nx">seconds</span> <span class="nx">and</span> <span class="mi">200</span><span class="p">,</span><span class="mi">000</span> <span class="nx">GHz</span><span class="o">-</span><span class="nx">seconds</span> <span class="k">of</span> <span class="nx">compute</span> <span class="nx">time</span><span class="p">,</span>
<span class="nx">and</span> <span class="mi">5</span> <span class="nx">GB</span> <span class="k">of</span> <span class="nx">internet</span> <span class="nx">data</span> <span class="nx">transfer</span> <span class="nx">per</span> <span class="nx">month</span><span class="p">.</span>

<span class="nx">The</span> <span class="nx">usage</span> <span class="nx">quota</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">free</span> <span class="nx">tier</span> <span class="k">is</span> <span class="nx">calculated</span> <span class="k">in</span> <span class="nx">equivalent</span> <span class="nx">USD</span> <span class="nx">amounts</span> <span class="nx">at</span> <span class="nx">the</span> <span class="nx">above</span> <span class="nx">tier</span> <span class="mi">1</span> <span class="nx">prices</span><span class="p">.</span>
<span class="nx">Regardless</span> <span class="k">of</span> <span class="nx">whether</span> <span class="nx">the</span> <span class="kd">function</span> <span class="nx">execution</span> <span class="nx">region</span> <span class="nx">uses</span> <span class="nx">tier</span> <span class="mi">1</span> <span class="nx">and</span><span class="o">/</span><span class="nx">or</span> <span class="nx">tier</span> <span class="mi">2</span> <span class="nx">prices</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">system</span> <span class="nx">will</span> <span class="nx">allocate</span> <span class="nx">the</span> <span class="nx">equivalent</span> <span class="nx">USD</span> <span class="nx">amount</span> <span class="nx">to</span> <span class="nx">you</span><span class="p">.</span>
<span class="nx">However</span><span class="p">,</span> <span class="nx">when</span> <span class="nx">deducting</span> <span class="nx">the</span> <span class="nx">free</span> <span class="nx">tier</span> <span class="nx">quota</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">system</span> <span class="nx">will</span> <span class="nx">use</span> <span class="nx">the</span> <span class="nx">tier</span> <span class="p">(</span><span class="nx">tier</span> <span class="mi">1</span> <span class="nx">or</span> <span class="nx">tier</span> <span class="mi">2</span><span class="p">)</span> <span class="k">of</span> <span class="nx">the</span> <span class="kd">function</span> <span class="nx">execution</span> <span class="nx">region</span> <span class="k">as</span> <span class="nx">the</span> <span class="nx">standard</span><span class="p">.</span>

<span class="nx">Please</span> <span class="nx">note</span> <span class="nx">that</span> <span class="nx">even</span> <span class="k">if</span> <span class="nx">you</span> <span class="nx">are</span> <span class="nx">using</span> <span class="nx">the</span> <span class="nx">free</span> <span class="nx">tier</span><span class="p">,</span> <span class="nx">you</span> <span class="nx">must</span> <span class="nx">have</span> <span class="nx">a</span> <span class="nx">valid</span> <span class="nx">billing</span> <span class="nx">account</span><span class="p">.</span>
</pre></table></code></div></div><blockquote><p>btw. Slack App is free, you don’t necessarily need Premium to use it.</p></blockquote><h4 id="slack-app-response-too-slow-timeout"><span class="me-2">Slack App Response Too Slow, Timeout</span><a href="#slack-app-response-too-slow-timeout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>(Excluding the issue of slow response during OpenAI API peak times)</strong>, if it’s a Cloud Function bottleneck, you can expand the settings on the first page of the Cloud Function editor:</p><p><a href="/assets/bd94cc88f9c9/1*l0HbCpKmA-viT1oE5ThhSg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*l0HbCpKmA-viT1oE5ThhSg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>You can adjust CPU, RAM, Timeout time, Concurrent number… to improve request processing speed.</p><blockquote><p>*But it may incur additional costs</p></blockquote><h4 id="development-stage-testing--debug"><span class="me-2">Development Stage Testing &amp; Debug</span><a href="#development-stage-testing--debug" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*cZB3VcV5Dx_aB66aKW5Rsw.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*cZB3VcV5Dx_aB66aKW5Rsw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Click “Test Function” to open a Cloud Shell window in the bottom toolbar. Wait about 3–5 minutes (the first startup takes longer), and after the build is completed and the following authorization is agreed upon:</p><p><a href="/assets/bd94cc88f9c9/1*c2siMn6ELt-APUHB3s3cXA.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*c2siMn6ELt-APUHB3s3cXA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Once you see “Function is ready to test,” you can click “Run Test” to execute the method for debugging.</p><p>You can use the “Triggering event” block on the right to input a JSON Body that will be passed into the <code class="language-plaintext highlighter-rouge">request_json</code> parameter for testing, or directly modify the program to inject a test object for testing.</p><blockquote><p>*Please note that Cloud Shell/Cloud Run may incur additional costs.</p></blockquote><blockquote><p>It is recommended to run a test before deploying (Deploy) to ensure that the build can succeed.</p></blockquote><h4 id="build-failed-what-to-do-when-code-disappears"><span class="me-2">Build Failed, What to Do When Code Disappears?</span><a href="#build-failed-what-to-do-when-code-disappears" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*JaKgL845mDbBdHeklTXg2g.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*JaKgL845mDbBdHeklTXg2g.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>If you accidentally write incorrect code causing Cloud Function Deploy Build Failed, an error message will appear. At this point, clicking “EDIT AND REDEPLOY” to return to the <strong>editor will find that the code you just changed is gone!!!</strong></p><p>No need to worry, at this point, click “Source Code” on the left and select “Last Failed Deployment” to restore the code that just Build Failed:</p><p><a href="/assets/bd94cc88f9c9/1*Slq_kBiCKZ_YsP98-CJnlw.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*Slq_kBiCKZ_YsP98-CJnlw.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="view-runtime-print-logs"><span class="me-2">View Runtime <code class="language-plaintext highlighter-rouge">print</code> Logs</span><a href="#view-runtime-print-logs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*FmAHk6jgea0HxEDi5nbU6w.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*FmAHk6jgea0HxEDi5nbU6w.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p>*Please note that Cloud Logging and Querying Logs may incur additional costs.</p></blockquote><h3 id="final-code-python-38"><span class="me-2">Final Code (Python 3.8)</span><a href="#final-code-python-38" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="cloud-functions"><span class="me-2">Cloud Functions</span><a href="#cloud-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">main.py</code>：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">functions_framework</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="s">"OPENAI API KEY"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="s">"Bot User OAuth Token"</span>

<span class="c1"># Custom defined security verification Token
# The URL must carry the ?token=SAFE_ACCESS_TOKEN parameter to accept the request  
</span><span class="n">SAFE_ACCESS_TOKEN</span> <span class="o">=</span> <span class="s">"nF4JwxfG9abqPZCJnBerwwhtodC28BuC"</span>

<span class="c1"># The OPENAI API Model used
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="s">"gpt-4-1106-preview"</span>

<span class="o">@</span><span class="n">functions_framework</span><span class="p">.</span><span class="n">http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut events will be given from the post payload field
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'payload'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># You can simply use print to record runtime logs, which can be viewed in Logs
</span>    <span class="c1"># For advanced Logging Level usage, refer to: https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="c1"># print(payload)
</span>
    <span class="c1"># Due to the nature of FAAS (Cloud Functions), if the service is not called for a long time, it will enter a cold start when called again, which may not respond within Slack's 3-second limit
</span>    <span class="c1"># Additionally, it takes a certain amount of time for the OpenAI API to respond (depending on the response length, it may take up to 1 minute to complete)
</span>    <span class="c1"># If Slack does not receive a response within the time limit, it will consider the request lost and will call again
</span>    <span class="c1"># This will cause repeated requests and responses, so we can set X-Slack-No-Retry: 1 in the Response Headers to inform Slack that even if it does not receive a response within the time limit, it does not need to retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'X-Slack-No-Retry'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># Verify if the token parameter is valid
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">request_args</span> <span class="ow">and</span> <span class="s">'token'</span> <span class="ow">in</span> <span class="n">request_args</span> <span class="ow">and</span> <span class="n">request_args</span><span class="p">[</span><span class="s">'token'</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAFE_ACCESS_TOKEN</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># If it is a Slack Retry request...ignore
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="s">'X-Slack-Retry-Num'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">'OK!'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'url_verification'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="s">""</span>
        <span class="k">if</span> <span class="s">'challenge'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'challenge'</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'event'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
        <span class="n">apiAppID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">'api_app_id'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">apiAppID</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'api_app_id'</span><span class="p">]</span>
        <span class="c1"># If the event source is the App and the App ID == Slack App ID, it means the event was triggered by its own Slack App
</span>        <span class="c1"># Ignore and do not process, otherwise it will fall into an infinite loop Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="s">'app_id'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">apiAppID</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'app_id'</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">'OK!'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Event name, for example: message (related to messages), app_mention (mentioned)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'type'</span><span class="p">]</span>

        <span class="c1"># SubType, for example: message_changed (edited message), message_deleted (deleted message)...
</span>        <span class="c1"># New messages do not have a Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">'subtype'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'subtype'</span><span class="p">]</span>
        
        <span class="c1"># Message type Event
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="s">'message'</span><span class="p">:</span>
            <span class="c1"># Messages with Sub Type are edited, deleted, replied to...
</span>            <span class="c1"># Ignore and do not process
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Event message sender
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'user'</span><span class="p">]</span>
            <span class="c1"># Event message channel
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'channel'</span><span class="p">]</span>
            <span class="c1"># Event message content
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'text'</span><span class="p">]</span>
            <span class="c1"># Event message TS (message ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'event_ts'</span><span class="p">]</span>
                
            <span class="c1"># Event message thread parent message TS (message ID)
</span>            <span class="c1"># Only new messages in the thread will have this data
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="s">'thread_ts'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'thread_ts'</span><span class="p">]</span>
                
            <span class="n">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        
        <span class="c1"># Mention type Event (@SlackApp hello)
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="s">'app_mention'</span><span class="p">:</span>
            <span class="c1"># Event message sender
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'user'</span><span class="p">]</span>
            <span class="c1"># Event message channel
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'channel'</span><span class="p">]</span>
            <span class="c1"># Event message content, remove the leading tag string &lt;@SLACKAPPID&gt; 
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">"&lt;@\w+&gt;\W*"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'text'</span><span class="p">])</span>
            <span class="c1"># Event message TS (message ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'event_ts'</span><span class="p">]</span>
                
            <span class="c1"># Event message thread parent message TS (message ID)
</span>            <span class="c1"># Only new messages in the thread will have this data
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="s">'thread_ts'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="s">'event'</span><span class="p">][</span><span class="s">'thread_ts'</span><span class="p">]</span>
                
            <span class="n">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># Handle Shortcut (message)
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="s">'type'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'type'</span><span class="p">]</span>

        <span class="c1"># If it is a message Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="s">'message_action'</span><span class="p">:</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="s">'callback_id'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'callback_id'</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">'channel'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'channel'</span><span class="p">][</span><span class="s">'id'</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">'message'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'ts'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'text'</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">'trigger_id'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s">'trigger_id'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># If it is a stop OpenAI API response Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="s">"abort_openai_api"</span><span class="p">:</span>
                    <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="s">"event_type"</span><span class="p">:</span> <span class="s">"aborted"</span><span class="p">,</span> <span class="s">"event_payload"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="s">"Successfully stopped OpenAI API response!"</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
                <span class="c1"># If it is a delete message
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="s">"delete_message"</span><span class="p">:</span>
                    <span class="n">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="s">"Successfully deleted Slack App message!"</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span><span class="s">"OK!"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="s">"Access Denied!"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># Thanks to a colleague (https://twitter.com/je_suis_marku) for support
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I can only understand Traditional Chinese and English"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I do not understand Simplified Chinese"</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If I speak Chinese, I will respond in Traditional Chinese, and it must conform to common Taiwanese usage."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If I speak English, I will respond in English."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"Do not respond with pleasantries."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"There should be a space between Chinese and English. There should be a space between Chinese characters and any other language characters, including numbers and emojis."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"If you don't know the answer, or if your knowledge is outdated, please search online before answering."</span><span class="p">},</span>
        <span class="p">{</span><span class="s">"role"</span><span class="p">:</span> <span class="s">"system"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="s">"I will tip you 200 USD, if you answer well."</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">eventThreadTS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">threadMessages</span> <span class="o">=</span> <span class="n">slackGetReplies</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threadMessages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threadMessage</span> <span class="ow">in</span> <span class="n">threadMessages</span><span class="p">:</span>
                <span class="n">appID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="s">'app_id'</span> <span class="ow">in</span> <span class="n">threadMessage</span><span class="p">:</span>
                    <span class="n">appID</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="s">'app_id'</span><span class="p">]</span>
                <span class="n">threadMessageText</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="s">'text'</span><span class="p">]</span>
                <span class="n">threadMessageTs</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="s">'ts'</span><span class="p">]</span>
                <span class="c1"># If it is a Slack App (OpenAI API Response), mark it as assistant
</span>                <span class="k">if</span> <span class="n">appID</span> <span class="ow">and</span> <span class="n">appID</span> <span class="o">==</span> <span class="n">apiAppID</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s">"role"</span><span class="p">:</span> <span class="s">"assistant"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># User's message content marked as user
</span>                    <span class="n">messages</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s">"role"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>

    <span class="n">messages</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s">"role"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"content"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="n">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="s">"Generating response..."</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="s">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s">""</span>
            
            <span class="c1"># Update the message every 0.8 seconds to avoid frequent calls to the Slack Update Message API, which may cause failures or waste Cloud Functions request counts
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="s">"..."</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># If the message has metadata &amp; metadata event_type == aborted, it means this response has been marked as terminated by the user
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="s">'ok'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'ok'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="s">'message'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="s">'metadata'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s">'message'</span><span class="p">]</span> <span class="ow">and</span> <span class="s">'event_type'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s">'message'</span><span class="p">][</span><span class="s">'metadata'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"aborted"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="s">"...*[Terminated]*"</span>
                <span class="c1"># The message has been deleted
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="s">'ok'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'ok'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="s">'error'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="s">'error'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"message_not_found"</span><span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s">"...*[Error occurred]*"</span>

    <span class="n">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/conversations.replies?channel="</span><span class="o">+</span><span class="n">channel</span><span class="o">+</span><span class="s">"&amp;ts="</span><span class="o">+</span><span class="n">ts</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"GET"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">'messages'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s">'messages'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">slackRequest</span><span class="p">(</span><span class="s">"/views.open"</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">"trigger_id"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="s">"view"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"modal"</span><span class="p">,</span>
            <span class="s">"callback_id"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="s">"title"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"type"</span><span class="p">:</span> <span class="s">"plain_text"</span><span class="p">,</span>
                <span class="s">"text"</span><span class="p">:</span> <span class="s">"Prompt"</span>
            <span class="p">},</span>
            <span class="s">"blocks"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s">"type"</span><span class="p">:</span> <span class="s">"section"</span><span class="p">,</span>
                    <span class="s">"text"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">"type"</span><span class="p">:</span> <span class="s">"mrkdwn"</span><span class="p">,</span>
                        <span class="s">"text"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/chat.delete"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"channel"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="s">"ts"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/chat.update"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"channel"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="s">"ts"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s">'metadata'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="s">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s">"/chat.postMessage"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"channel"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="s">"text"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s">'thread_ts'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">'ts'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s">'ts'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"https://slack.com/api"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"Authorization"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="s">"</span><span class="p">,</span>
        <span class="s">"Content-Type"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">"POST"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">"GET"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">requirements.txt</code>：</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="py">functions-framework</span><span class="p">=</span><span class="s">=3.*</span>
<span class="py">requests</span><span class="p">=</span><span class="s">=2.31.0</span>
<span class="py">openai</span><span class="p">=</span><span class="s">=1.9.0</span>
</pre></table></code></div></div><h4 id="slack-app-settings"><span class="me-2">Slack App Settings</span><a href="#slack-app-settings" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>OAuth &amp; Permissions</strong></p><p><a href="/assets/bd94cc88f9c9/1*kHTMERqNSC4p1dV8omuyFg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*kHTMERqNSC4p1dV8omuyFg.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li>The items with the delete button grayed out are permissions automatically added by Slack after adding the Shortcut.</ul><p><strong>Interactivity &amp; Shortcuts</strong></p><ul><li>Interactivity: Enable<li>Request URL: <code class="language-plaintext highlighter-rouge">https://us-central1-xxx-xxx.cloudfunctions.net/SlackBot-Rick-C-137?token=nF4JwxfG9abqPZCJnBerwwhtodC28BuC</code><li>Subscribe to bot events:</ul><p><a href="/assets/bd94cc88f9c9/1*7tQYZKyn2GW2tPKd2GJE6Q.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*7tQYZKyn2GW2tPKd2GJE6Q.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><strong>Interactivity &amp; Shortcuts</strong></p><ul><li>Interactivity: Enable<li>Request URL: <code class="language-plaintext highlighter-rouge">https://us-central1-xxx-xxx.cloudfunctions.net/SlackBot-Rick-C-137?token=nF4JwxfG9abqPZCJnBerwwhtodC28BuC</code><li>Shortcuts:</ul><p><a href="/assets/bd94cc88f9c9/1*6rHz_4lpdPDwbLZhWMSULg.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*6rHz_4lpdPDwbLZhWMSULg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><strong>App Home</strong></p><ul><li>Always Show My Bot as Online: Enable<li>Messages Tab: Enable<li>Allow users to send Slash commands and messages from the messages tab: ✅</ul><p><strong>Basic Information</strong></p><p><a href="/assets/bd94cc88f9c9/1*1OQMhVmkl-omm_2wvQJTvQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*1OQMhVmkl-omm_2wvQJTvQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p>Rick &amp; Morty 🤘🤘🤘</p></blockquote><p><a href="/assets/bd94cc88f9c9/1*xkH5Li8KgLzwRsVEbo1hBQ.png" class="popup img-link "><img data-src="/assets/bd94cc88f9c9/1*xkH5Li8KgLzwRsVEbo1hBQ.png" alt="[Reddit](https://www.reddit.com/r/ChatGPT/comments/154l9z1/are_you_polite_with_chatgpt/){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p><a href="https://www.reddit.com/r/ChatGPT/comments/154l9z1/are_you_polite_with_chatgpt/" target="_blank">Reddit</a></p><h3 id="commercial-time"><span class="me-2">Commercial Time</span><a href="#commercial-time" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If you and your team have automation tool and process integration needs, whether it’s Slack App development, Notion, Asana, Google Sheet, Google Form, GA data, various integration needs, feel free to <a href="https://zhgchg.li/contact/" target="_blank"><strong>contact for development</strong></a>.</p><p>If you have any questions or comments, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>===</p><p><a href="https://zhgchg.li/posts/bd94cc88f9c9/" target="_blank">本文中文版本</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ➡️ <a href="https://medium.com/p/bd94cc88f9c9" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=🍺&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/zrealm/'>ZRealm</a>, <a href='/categories/dev/'>Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/cloud-functions/" class="post-tag no-text-decoration" >cloud-functions</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/chatgpt/" class="post-tag no-text-decoration" >chatgpt</a> <a href="/tags/slack/" class="post-tag no-text-decoration" >slack</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Slack%20&%20ChatGPT%20Integration%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fbd94cc88f9c9%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Slack%20&%20ChatGPT%20Integration%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fbd94cc88f9c9%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fbd94cc88f9c9%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/70a1409b149a/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1613822151" data-df="ll" > Feb 20, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>Using Python+Google Cloud Platform+Line Bot to Automate Routine Tasks</h4><div class="text-muted small"><p> Using Python+Google Cloud Platform+Line Bot to Automate Routine Tasks Creating a daily automatic check-in script using a check-in reward app as an example Photo by Paweł Czerwiński Origin I ha...</p></div></div></a></div><div class="col"> <a href="/posts/33f6aabb744f/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1620222679" data-df="ll" > May 5, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>ZReviewsBot — Slack App Review Notification Bot</h4><div class="text-muted small"><p> ZReviewsBot — Slack App Review Notification Bot Free and open-source iOS &amp;amp; Android APP latest review tracking Slack Bot TL;DR [2022/08/10] Update: Now redesigned using the new App Store Conn...</p></div></div></a></div><div class="col"> <a href="/posts/d61062833c1a/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1623603501" data-df="ll" > Jun 14, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>Building a Fully Automated WFH Employee Health Reporting System with Slack</h4><div class="text-muted small"><p> Building a Fully Automated WFH Employee Health Reporting System with Slack Enhancing work efficiency by playing with Slack Workflow combined with Google Sheet with App Script Photo by Stephen P...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/31b9b3a63abc/" class="btn btn-outline-primary" prompt="Older" ><p>Travelogue 2023 Hiroshima Okayama 6-Day Free Trip</p></a> <a href="/posts/f6713ba3fee3/" class="btn btn-outline-primary" prompt="Newer" ><p>Implementing Google Services RPA Automation with Google Apps Script</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">中文版網站</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
