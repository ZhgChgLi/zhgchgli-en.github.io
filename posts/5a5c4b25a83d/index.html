<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="POC App End-to-End Testing Local Snapshot API Mock Server" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Verification of the feasibility of implementing E2E Testing for existing apps and existing API architecture" /><meta property="og:description" content="Verification of the feasibility of implementing E2E Testing for existing apps and existing API architecture" /><link rel="canonical" href="https://en.zhgchg.li/posts/5a5c4b25a83d/" /><meta property="og:url" content="https://en.zhgchg.li/posts/5a5c4b25a83d/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-08-28T22:53:27+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg" /><meta property="twitter:title" content="POC App End-to-End Testing Local Snapshot API Mock Server" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2023-09-04T22:32:47+08:00","datePublished":"2023-08-28T22:53:27+08:00","description":"Verification of the feasibility of implementing E2E Testing for existing apps and existing API architecture","headline":"POC App End-to-End Testing Local Snapshot API Mock Server","image":"https://en.zhgchg.li/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/5a5c4b25a83d/"},"url":"https://en.zhgchg.li/posts/5a5c4b25a83d/"}</script><title>POC App End-to-End Testing Local Snapshot API Mock Server | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>POC App End-to-End Testing Local Snapshot API Mock Server</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>POC App End-to-End Testing Local Snapshot API Mock Server</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1693234407" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 28, 2023 </em> </span> <span> Updated <em class="" data-ts="1693837967" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 4, 2023 </em> </span><div class="mt-3 mb-3"> <a href="/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3813 words" > <em>21 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="poc-app-end-to-end-testing-local-snapshot-api-mock-server"><span class="me-2">[POC] App End-to-End Testing Local Snapshot API Mock Server</span><a href="#poc-app-end-to-end-testing-local-snapshot-api-mock-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Verification of the feasibility of implementing E2E Testing for existing apps and existing API architecture</p><p><a href="/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg" class="popup img-link "><img data-src="/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg" alt="Photo by [freestocks](https://unsplash.com/@freestocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p>Photo by <a href="https://unsplash.com/@freestocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">freestocks</a></p><h3 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As a project that has been operating online for many years, continuously improving stability is a highly challenging issue.</p><h4 id="unit-testing"><span class="me-2">Unit Testing</span><a href="#unit-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/5a5c4b25a83d/1*QAuldnLTydk33IgAdkXR-w.png" class="popup img-link "><img data-src="/assets/5a5c4b25a83d/1*QAuldnLTydk33IgAdkXR-w.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Due to the static + compiled + strongly typed nature of the development languages Swift/Kotlin or the dynamic to static transition from Objective-C to Swift, it is almost impossible to add Unit Testing later if testability was not considered during development to cleanly separate interface dependencies. However, the refactoring process can also introduce instability, leading to a chicken-and-egg problem.</p><h4 id="ui-testing"><span class="me-2">UI Testing</span><a href="#ui-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Testing UI interactions and buttons; it can be implemented by slightly decoupling data dependencies in new or existing screens.</p><h4 id="snapshot-testing"><span class="me-2">SnapShot Testing</span><a href="#snapshot-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Verifying whether the UI display content and style are consistent before and after adjustments; similar to UI Testing, it can be implemented by slightly decoupling data dependencies in new or existing screens.</p><p>It is very useful for transitioning from Storyboard/XIB to Code Layout or UIView from OC to Swift; you can directly import <a href="https://github.com/pointfreeco" target="_blank">pointfreeco</a> / <a href="https://github.com/pointfreeco/swift-snapshot-testing" target="_blank">swift-snapshot-testing</a> for quick implementation.</p><p><a href="https://github.com/pointfreeco/swift-snapshot-testing" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/918526e25a26dfe2fc97d8687c4ce4c7193149e766ac67e1fe702a2cf0880b15/pointfreeco/swift-snapshot-testing" alt="" class="lazyload" data-proofer-ignore></a></p><p>Although we can add UI Testing and SnapShot Testing later, the coverage of these tests is very limited; most errors are not UI style issues but process or logic problems that interrupt user operations. <strong>If this occurs during the checkout process, involving revenue, the issue becomes very serious</strong>.</p><h3 id="end-to-end-testing"><span class="me-2">End-to-End Testing</span><a href="#end-to-end-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As mentioned earlier, it is not feasible to easily add unit tests to the current project or to integrate units for integration testing. For logic and process protection, the remaining method is to perform End-to-End black-box testing from the outside, directly from the user‚Äôs perspective, to check whether important processes (registration/checkout, etc.) are functioning normally.</p><blockquote><p>For major function refactoring, you can also establish process tests before refactoring and re-verify after refactoring to ensure that the functionality works as expected.</p></blockquote><blockquote><p>Refactoring along with adding Unit Testing and Integration Testing to increase stability, breaking the chicken-and-egg problem.</p></blockquote><h4 id="qa-team"><span class="me-2">QA Team</span><a href="#qa-team" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The most direct and brute-force way of End-to-End Testing is to have a QA Team manually test according to the Test Plan, and then continuously optimize or introduce automated operations. Calculating the cost, it would require at least 2 engineers + 1 Leader spending at least half a year to a year to see results.</p><p>Evaluating the time and cost, is there anything we can do in the current situation or prepare for the future QA Team so that when there is a QA Team, we can directly jump to optimization and automation operations, or even introduce AI?</p><h4 id="automation"><span class="me-2">Automation</span><a href="#automation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>At this stage, the goal is to introduce automated End-to-End Testing, placed in the CI/CD process for automatic checks. The test content does not need to be too comprehensive; as long as it can prevent major process issues, it is already very valuable. Later, we can gradually iterate the Test Plan to cover more areas.</p><h3 id="end-to-end-testing--technical-challenges"><span class="me-2">End-to-End Testing ‚Äî Technical Challenges</span><a href="#end-to-end-testing--technical-challenges" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="ui-operation-issues"><span class="me-2">UI Operation Issues</span><a href="#ui-operation-issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The principle of the App is more like using another test App to operate our tested App, and then finding the target object from the View Hierarchy. During testing, we cannot obtain the Log or Output of the tested App because they are essentially two different Apps.</p><p>iOS needs to improve the View Accessibility Identifier to increase efficiency and accuracy and handle Alerts (e.g., push notification requests).</p><p>In previous implementations on Android, there was an issue where the target object could not be found when mixing Compose and Fragment, but according to a teammate, the new version of Compose has resolved this.</p><p>Besides the common traditional issues mentioned above, a bigger problem is the difficulty of integrating dual platforms (writing one test to run on two platforms). Currently, we are trying to use a new testing tool <a href="https://github.com/mobile-dev-inc" target="_blank">mobile-dev-inc</a> / <a href="https://github.com/mobile-dev-inc/maestro" target="_blank">maestro</a>:</p><p><a href="https://github.com/mobile-dev-inc/maestro" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/9ce9ec8ac81baa471c21b1c7229a5cae1033664cae5518275a125c1a6459e9a4/mobile-dev-inc/maestro" alt="" class="lazyload" data-proofer-ignore></a></p><p>You can write a Test Plan in YAML and then execute tests on dual platforms. For detailed usage and trial experiences, stay tuned for another teammate‚Äôs article sharing cc‚Äôed <a href="https://medium.com/u/1139df7a27f3" target="_blank">Alejandra Ts.</a> üòù.</p><h4 id="api-data-issues"><span class="me-2">API Data Issues</span><a href="#api-data-issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The biggest testing variable for App E2E Testing is API data. If we cannot provide guaranteed data, it will increase the instability of the tests, leading to false positives, and eventually, everyone will lose confidence in the Test Plan.</p><p>For example, in testing the checkout process, if the product might be taken off the shelf or disappear, and these status changes are not controllable by the App, the above situation is very likely to occur.</p><p>There are many ways to solve data issues, such as establishing a clean Staging or Testing environment, or an Auto-Gen Mock API Server based on Open API. However, these all rely on the backend and external factors of the API. Additionally, the backend API, like the App, is an online project that has been running for many years, and some specifications are still being restructured and migrated, making it temporarily impossible to have a Mock Server.</p><p>Given these factors, if we get stuck here, the problem will remain unchanged, and the chicken-and-egg problem cannot be broken. We really can only ‚Äútake the risk‚Äù and make changes first, dealing with issues as they arise.</p><h4 id="snapshot-api-local-mock-server"><span class="me-2">Snapshot API Local Mock Server</span><a href="#snapshot-api-local-mock-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>‚ÄúAs long as the mindset doesn‚Äôt slip, there are more solutions than difficulties.‚Äù</p></blockquote><p>We can think differently. If the UI can be snapshotted into images for replay verification testing, can the API do the same? Can we save the API Request &amp; Response and replay them for verification testing later?</p><p><strong>This introduces the main point of this article: establishing a ‚ÄúSnapshot API Local Mock Server‚Äù to record API Requests &amp; Replay Responses, removing the dependency on API data.</strong></p><blockquote><p>This article only provides a Proof of Concept (POC) and has not yet fully implemented high-coverage End-to-End Testing. Therefore, the approach is for reference only. <strong>I hope it provides new insights for everyone in the current environment.</strong></p></blockquote><h3 id="snapshot-api-local-mock-server-1"><span class="me-2">Snapshot API Local Mock Server</span><a href="#snapshot-api-local-mock-server-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="core-concept--record--replay-api-data"><span class="me-2">Core Concept ‚Äî Record &amp; Replay API Data</span><a href="#core-concept--record--replay-api-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>[Record]</strong> ‚Äî After completing the development of the End-to-End Testing Test Case, enable the recording parameter and execute the test once. During this process, all API Requests &amp; Responses will be saved in the respective Test Case directories.</p><p><strong>[Replay]</strong> ‚Äî When running the Test Case later, the corresponding recorded Response Data will be found from the Test Case directory according to the request to complete the testing process.</p><h4 id="illustration"><span class="me-2">Illustration</span><a href="#illustration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Suppose we want to test the purchase process. The user opens the App, clicks on the product card on the homepage to enter the product detail page, clicks the purchase button at the bottom, a login box pops up to complete the login, completes the purchase, and a purchase success prompt pops up:</p><p><a href="/assets/5a5c4b25a83d/1*VtCOkH7iply6RQPs9zxJrw.png" class="popup img-link "><img data-src="/assets/5a5c4b25a83d/1*VtCOkH7iply6RQPs9zxJrw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>How UI Testing controls button clicks, input box inputs, etc., is not the main focus of this article; you can refer to existing testing frameworks for direct use.</p><h4 id="regular-proxy-or-reverse-proxy"><span class="me-2">Regular Proxy or Reverse Proxy</span><a href="#regular-proxy-or-reverse-proxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To achieve Record &amp; Replay API, a Proxy needs to be added between the App and the API to perform a man-in-the-middle attack. You can refer to my earlier article ‚Äú<a href="../46410aaada00/">The APP uses HTTPS transmission, but the data is still stolen.</a>‚Äù</p><p>In simple terms, there is an additional proxy transmitter between the App and the API, like passing notes. The requests and responses exchanged between both parties will go through it. It can open the content of the notes and can also forge the content of the notes for both parties without them noticing.</p><p><strong>Regular Proxy:</strong></p><p>A regular proxy is when the client sends a request to the proxy server, the proxy server forwards the request to the target server, and then returns the response from the target server to the client. In a regular proxy mode, the proxy server initiates the request on behalf of the client. The client needs to explicitly specify the address and port number of the proxy server and send the request to the proxy server.</p><p><strong>Reverse Proxy:</strong></p><p>A reverse proxy is the opposite of a regular proxy. It sits between the target server and the client. The client sends a request to the reverse proxy server, which forwards the request to the backend target server according to certain rules and returns the response from the target server to the client. For the client, the target server appears to be the reverse proxy server, and the client does not need to know the real address of the target server.</p><p>For our needs, either regular or reverse proxy can achieve the goal. The only consideration is the method of proxy setup:</p><p><strong>Regular Proxy requires setting up a Proxy in the network settings on the computer, phone, or emulator:</strong></p><ul><li>Android can directly set up a Proxy in the emulator.<li>iOS Simulator shares the computer‚Äôs network environment and cannot individually set up a Proxy, requiring changes to the computer‚Äôs settings to set up a Proxy. All traffic on the computer will go through this Proxy, and if other network tools like Proxyman or Charles are also running, they might forcefully change the Proxy settings to their own, causing it to fail.</ul><p><strong>Reverse Proxy requires changing the API Host in the Codebase and declaring all API Domains to be proxied:</strong></p><ul><li>The API Host in the Codebase needs to be replaced with the Proxy Server IP during testing.<li>When enabling Reverse Proxy, declare which Domains need to be proxied.<li>Only declared Domains will go through the Proxy; undeclared ones will go directly out.</ul><blockquote><p>For iOS App, the following example uses iOS &amp; Reverse Proxy for POC. The same can be applied to Android.</p></blockquote><h4 id="letting-the-ios-app-know-its-running-end-to-end-testing"><span class="me-2">Letting the iOS App Know It‚Äôs Running End-to-End Testing</span><a href="#letting-the-ios-app-know-its-running-end-to-end-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We need to let the App know it‚Äôs running End-to-End Testing to add the API Host replacement logic in the App program:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>// UI Testing Target:
let app = XCUIApplication()
app.launchArguments = ["duringE2ETesting"]
app.launch()
</pre></table></code></div></div><p>We make the judgment and replacement in the Network layer.</p><blockquote><p>This is an unavoidable adjustment. Try to avoid changing the App‚Äôs Code just for testing.</p></blockquote><h3 id="using-mitmproxy-to-implement-reverse-proxy-server"><span class="me-2">Using MITMProxy to Implement Reverse Proxy Server</span><a href="#using-mitmproxy-to-implement-reverse-proxy-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>You can also use Swift to develop a Swift Server to achieve this. This article uses the MITMProxy tool for POC.</p></blockquote><h4 id="20230904-update-mitmproxy-rodo-is-now-open-source"><span class="me-2">[2023‚Äì09‚Äì04 Update] Mitmproxy-rodo is Now Open Source</span><a href="#20230904-update-mitmproxy-rodo-is-now-open-source" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The implementation content below has been open-sourced to the <a href="https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main" target="_blank">mitmproxy-rodo</a> project. Feel free to refer to and use it directly.</p><p><a href="https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main" target="_blank" class="img-link shimmer" ><img data-src="https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4" alt="" class="lazyload" data-proofer-ignore></a></p><p>Some structures and content of this article have been adjusted, and the following adjustments were made when open-sourced:</p><ul><li>Changed the storage directory structure to <code class="language-plaintext highlighter-rouge">host / requestPath / method / hash</code><li>Fixed Header information storage, should be Bytes Data instead of pure JSON String<li>Corrected some errors<li>Added automatic extension of Set-Cookie expiration functionality</ul><blockquote><p><strong>‚ö†Ô∏è The following script is for Demo reference only, subsequent script adjustments will be moved to the open-source project maintenance.</strong></p></blockquote><h4 id="mitmproxy"><span class="me-2"><a href="https://mitmproxy.org" target="_blank">MITMProxy</a></span><a href="#mitmproxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Follow the <a href="https://mitmproxy.org" target="_blank">MITMProxy official website</a> to complete the installation:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>brew <span class="nb">install </span>mitmproxy
</pre></table></code></div></div><p>For detailed usage of MITMProxy, you can refer to my earlier article ‚Äú<a href="../46410aaada00/">The APP uses HTTPS transmission, but the data is still stolen.</a>‚Äù</p><ul><li><code class="language-plaintext highlighter-rouge">mitmproxy</code> provides an interactive command-line interface.<li><code class="language-plaintext highlighter-rouge">mitmweb</code> provides a browser-based graphical user interface.<li><code class="language-plaintext highlighter-rouge">mitmdump</code> provides non-interactive terminal output.</ul><h4 id="implementing-record--replay"><span class="me-2">Implementing Record &amp; Replay</span><a href="#implementing-record--replay" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Since MITMProxy Reverse Proxy does not natively have the functionality to Record (or dump) requests &amp; Mapping Request Replay, we need to write scripts to achieve this functionality.</p><p><code class="language-plaintext highlighter-rouge">mock.py</code> :</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
</pre><td class="rouge-code"><pre><span class="s">"""
Example:
    Record: mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=loginFlow --set config_file=config.json
    Replay: mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=loginFlow --set config_file=config.json
"""</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">mitmproxy</span> <span class="kn">import</span> <span class="n">ctx</span>
<span class="kn">from</span> <span class="nn">mitmproxy</span> <span class="kn">import</span> <span class="n">http</span>

<span class="k">class</span> <span class="nc">MockServerHandler</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loader</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">readHistory</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">loader</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">"dumper_folder"</span><span class="p">,</span>
            <span class="n">typespec</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s">"dump"</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">"Response Dump directory, can be created by Test Case Name"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">loader</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">"network_restricted"</span><span class="p">,</span>
            <span class="n">typespec</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">"No Mapping data locally... setting true will return 404, false will make a real request to get data."</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">loader</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">"record"</span><span class="p">,</span>
            <span class="n">typespec</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">"Set true to record Request's Response"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">loader</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">"config_file"</span><span class="p">,</span>
            <span class="n">typespec</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s">""</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">"Set file path, example file below"</span><span class="p">,</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">updated</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">loadConfig</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">loadConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">configFile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">config_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">config_file</span> <span class="o">==</span> <span class="s">""</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">configFile</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">configFile</span><span class="p">,</span> <span class="s">"r"</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">query</span>
        <span class="n">requestPath</span> <span class="o">=</span> <span class="s">"-"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">path_components</span><span class="p">)</span>

        <span class="n">ignoredQueryParameterByPaths</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"ignored"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"paths"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">host</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">requestPath</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"queryParamters"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">ignoredQueryParameterGlobal</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"ignored"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"global"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"queryParamters"</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">filteredQuery</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">filteredQuery</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">query</span><span class="p">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignoredQueryParameterByPaths</span> <span class="o">+</span> <span class="n">ignoredQueryParameterGlobal</span><span class="p">]</span>
        
        <span class="n">formData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">get_content</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">request</span><span class="p">.</span><span class="n">get_content</span><span class="p">()</span> <span class="o">!=</span> <span class="sa">b</span><span class="s">''</span><span class="p">:</span>
            <span class="n">formData</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">get_content</span><span class="p">())</span>
        
        <span class="c1"># or just formData = request.urlencoded_form
</span>        <span class="c1"># or just formData = request.multipart_form
</span>        <span class="c1"># depends on your api design
</span>
        <span class="n">ignoredFormDataParametersByPaths</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"ignored"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"paths"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">host</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">requestPath</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"formDataParameters"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">ignoredFormDataParametersGlobal</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"ignored"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"global"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"formDataParameters"</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">filteredFormData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">formData</span><span class="p">:</span>
            <span class="n">filteredFormData</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">formData</span><span class="p">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignoredFormDataParametersByPaths</span> <span class="o">+</span> <span class="n">ignoredFormDataParametersGlobal</span><span class="p">]</span>
        
        <span class="c1"># Serialize the dictionary to a JSON string
</span>        <span class="n">hashData</span> <span class="o">=</span> <span class="p">{</span><span class="s">"query"</span><span class="p">:</span><span class="nb">sorted</span><span class="p">(</span><span class="n">filteredQuery</span><span class="p">),</span> <span class="s">"form"</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filteredFormData</span><span class="p">)}</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">hashData</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># Apply SHA-256 hash function
</span>        <span class="n">hash_object</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">json_str</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">hash_string</span> <span class="o">=</span> <span class="n">hash_object</span><span class="p">.</span><span class="n">hexdigest</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">hash_string</span>

    <span class="k">def</span> <span class="nf">readFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">host</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="nb">hash</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">requestPath</span> <span class="o">=</span> <span class="s">"-"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">path_components</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">dumper_folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">host</span> <span class="o">/</span> <span class="n">method</span> <span class="o">/</span> <span class="n">requestPath</span> <span class="o">/</span> <span class="nb">hash</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"content-type"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">";"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="p">.</span><span class="n">guess_extension</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span> <span class="ow">or</span> <span class="s">".json"</span>


        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">requestPath</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="mi">0</span>

        <span class="n">filepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"Content-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s">"</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">filepath</span><span class="p">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"Content-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s">"</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">[</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">get</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">get</span><span class="p">(</span><span class="n">method</span><span class="p">).</span><span class="n">get</span><span class="p">(</span><span class="n">requestPath</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="n">method</span><span class="p">][</span><span class="n">requestPath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">filepath</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">headerFilePath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"Header-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="si">}</span><span class="s">.json"</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerFilePath</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">headerFilePath</span> <span class="o">=</span> <span class="bp">None</span>
            
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="n">method</span><span class="p">][</span><span class="n">requestPath</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

            <span class="k">return</span> <span class="p">{</span><span class="s">"content"</span><span class="p">:</span> <span class="n">filepath</span><span class="p">,</span> <span class="s">"header"</span><span class="p">:</span> <span class="n">headerFilePath</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>


    <span class="k">def</span> <span class="nf">saveToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">host</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="nb">hash</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">requestPath</span> <span class="o">=</span> <span class="s">"-"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">path_components</span><span class="p">)</span>

        <span class="n">iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"ignored"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"paths"</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">host</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">requestPath</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span> <span class="p">{}).</span><span class="n">get</span><span class="p">(</span><span class="s">"iterable"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        
        <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">dumper_folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">host</span> <span class="o">/</span> <span class="n">method</span> <span class="o">/</span> <span class="n">requestPath</span> <span class="o">/</span> <span class="nb">hash</span>

        <span class="c1"># create dir if not exists
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"content-type"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s">";"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="p">.</span><span class="n">guess_extension</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span> <span class="ow">or</span> <span class="s">".json"</span>

        <span class="n">repeatNumber</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"Content-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">repeatNumber</span><span class="p">)</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s">"</span>
        <span class="k">while</span> <span class="n">filepath</span><span class="p">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iterable</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">repeatNumber</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"Content-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">repeatNumber</span><span class="p">)</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s">"</span>
        
        <span class="c1"># dump to file
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sa">b</span><span class="s">''</span><span class="p">)</span>
            
        
        <span class="n">headerFilepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="s">"Header-</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">repeatNumber</span><span class="p">)</span><span class="si">}</span><span class="s">.json"</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">headerFilepath</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">responseDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s">'_status_code'</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">responseDict</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span><span class="s">"content"</span><span class="p">:</span> <span class="n">filepath</span><span class="p">,</span> <span class="s">"header"</span><span class="p">:</span> <span class="n">headerFilepath</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">record</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">host</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">path</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">readFromFile</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">statusCode</span> <span class="o">=</span> <span class="mi">200</span>

                <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'content'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">'content'</span><span class="p">],</span> <span class="s">"r"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'header'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">'header'</span><span class="p">],</span> <span class="s">"r"</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
                    <span class="n">statusCode</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s">'_status_code'</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">headers</span><span class="p">[</span><span class="s">'_status_code'</span><span class="p">]</span>

                
                <span class="n">headers</span><span class="p">[</span><span class="s">'_responseFromMitmproxy'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'1'</span>
                <span class="n">flow</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">make</span><span class="p">(</span><span class="n">statusCode</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
                <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Fullfill response from local with "</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">'content'</span><span class="p">]))</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">network_restricted</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">flow</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">make</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="sa">b</span><span class="s">''</span><span class="p">,</span> <span class="p">{</span><span class="s">'_responseFromMitmproxy'</span><span class="p">:</span> <span class="s">'1'</span><span class="p">})</span>
        
    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">record</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">flow</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'_responseFromMitmproxy'</span><span class="p">)</span> <span class="o">!=</span> <span class="s">'1'</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">saveToFile</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="n">request</span><span class="p">,</span> <span class="n">flow</span><span class="p">.</span><span class="n">response</span><span class="p">)</span>
            <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Save response to local with "</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">'content'</span><span class="p">]))</span>

<span class="n">addons</span> <span class="o">=</span> <span class="p">[</span><span class="n">MockServerHandler</span><span class="p">()]</span>
</pre></table></code></div></div><p>You can refer to the <a href="https://docs.mitmproxy.org/stable/api/events.html" target="_blank">official documentation</a> and adjust the script content as needed.</p><p><strong>The design logic of this script is as follows:</strong></p><ul><li>File path logic: <code class="language-plaintext highlighter-rouge">dumper_folder(a.k.a Test Case Name)</code> / <code class="language-plaintext highlighter-rouge">Reverse's api host</code> / <code class="language-plaintext highlighter-rouge">HTTP Method</code> / <code class="language-plaintext highlighter-rouge">Path join with -</code> (e.g. <code class="language-plaintext highlighter-rouge">app/launch</code> -&gt; <code class="language-plaintext highlighter-rouge">app-launch</code>) / <code class="language-plaintext highlighter-rouge">Hash(Get Query &amp; Post Content)</code> /<li>File logic: Response content: <code class="language-plaintext highlighter-rouge">Content-0.xxx</code>, <code class="language-plaintext highlighter-rouge">Content-1.xxx</code> (the second request of the same request) ‚Ä¶ and so on; Response Header information: <code class="language-plaintext highlighter-rouge">Header-0.json</code> (same <code class="language-plaintext highlighter-rouge">Content-x</code> logic)</ul><p><a href="/assets/5a5c4b25a83d/1*Lud_shSJYv4LSUfpfALGFA.png" class="popup img-link "><img data-src="/assets/5a5c4b25a83d/1*Lud_shSJYv4LSUfpfALGFA.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li>When saving, it will be saved sequentially according to the path and file logic; during Replay, it will be retrieved in the same order.<li>If the number of times does not match, for example, the same path is hit 3 times during Replay, but the Record only saves data up to the 2nd time; it will still respond with the 2nd time, which is the last result.<li>When <code class="language-plaintext highlighter-rouge">record</code> is <code class="language-plaintext highlighter-rouge">True</code>, it will hit the target Server to get the response and save it according to the above logic; when <code class="language-plaintext highlighter-rouge">False</code>, it will only read data locally (equivalent to Replay Mode).<li>When <code class="language-plaintext highlighter-rouge">network_restricted</code> is <code class="language-plaintext highlighter-rouge">False</code>, if there is no Mapping data locally, it will directly respond with <code class="language-plaintext highlighter-rouge">404</code>; when <code class="language-plaintext highlighter-rouge">True</code>, it will hit the target Server to get the data.<li><code class="language-plaintext highlighter-rouge">_responseFromMitmproxy</code> is used to inform the Response Method that the current response is from Local and can be ignored, <code class="language-plaintext highlighter-rouge">_status_code</code> borrows the Header.json field to store the HTTP Response status code.</ul><p><code class="language-plaintext highlighter-rouge">config_file.json</code> <strong>configuration file logic design is as follows:</strong></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"ignored"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"paths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"yourapihost.com"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"add-to-cart"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"POST"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"queryParamters"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"created_timestamp"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"formDataParameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"api-status-checker"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"GET"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"iterable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"global"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"queryParamters"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"timestamp"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"formDataParameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">queryParamters</code> <strong>&amp; <code class="language-plaintext highlighter-rouge">formDataParameters</code>:</strong></p><p>Because some API parameters may change with each call, for example, some Endpoints will carry time parameters, at this time according to the Server‚Äôs design, the <code class="language-plaintext highlighter-rouge">Hash(Query Parameter &amp; Body Content)</code> value will be different during Replay Request, resulting in no Mapping to Local Response. Therefore, an additional <code class="language-plaintext highlighter-rouge">config.json</code> is used to handle this situation. You can set certain parameters to be excluded from the Hash by Endpoint Path or Global, so you can get the same Mapping result.</p><p><code class="language-plaintext highlighter-rouge">iterable</code> <strong>:</strong></p><p>Because some polling check APIs may be called repeatedly at regular intervals, according to the Server‚Äôs design, many <code class="language-plaintext highlighter-rouge">Content-x.xxx</code> &amp; <code class="language-plaintext highlighter-rouge">Header-x.json</code> files will be generated; but if we don‚Äôt care, we can set it to <code class="language-plaintext highlighter-rouge">True</code>, and the Response will continue to be saved and overwritten to the first file <code class="language-plaintext highlighter-rouge">Content-0.xxx</code> &amp; <code class="language-plaintext highlighter-rouge">Header-0.json</code>.</p><p><strong>Enable Reverse Proxy Record Mode:</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mitmdump <span class="nt">-m</span> reverse:https://yourapihost.com <span class="nt">-s</span> mock.py <span class="nt">--set</span> <span class="nv">record</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">dumper_folder</span><span class="o">=</span>loginFlow <span class="nt">--set</span> <span class="nv">config_file</span><span class="o">=</span>config.json
</pre></table></code></div></div><p><strong>Enable Reverse Proxy Replay Mode:</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mitmdump <span class="nt">-m</span> reverse:https://yourapihost.com <span class="nt">-s</span> mock.py <span class="nt">--set</span> <span class="nv">dumper_folder</span><span class="o">=</span>loginFlow <span class="nt">--set</span> <span class="nv">config_file</span><span class="o">=</span>config.json
</pre></table></code></div></div><h3 id="assembly--proof-of-concept"><span class="me-2">Assembly &amp; Proof Of Concept</span><a href="#assembly--proof-of-concept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="0-complete-the-host-replacement-in-the-codebase"><span class="me-2">0. Complete the Host replacement in the Codebase</span><a href="#0-complete-the-host-replacement-in-the-codebase" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>And ensure that during testing, the API is switched to <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080</code></p><h4 id="1-start-snapshot-api-local-mock-server-aka-reverse-proxy-server-record-mode"><span class="me-2">1. Start Snapshot API Local Mock Server (a.k.a Reverse Proxy Server) Record Mode</span><a href="#1-start-snapshot-api-local-mock-server-aka-reverse-proxy-server-record-mode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mitmdump <span class="nt">-m</span> reverse:https://yourapihost.com <span class="nt">-s</span> mock.py <span class="nt">--set</span> <span class="nv">record</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">dumper_folder</span><span class="o">=</span>addCart <span class="nt">--set</span> <span class="nv">config_file</span><span class="o">=</span>config.json
</pre></table></code></div></div><h4 id="2-perform-e2e-testing-ui-operations"><span class="me-2">2. Perform E2E Testing UI Operations</span><a href="#2-perform-e2e-testing-ui-operations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Using the <a href="https://apps.apple.com/tw/app/pinkoi-%E4%BA%9E%E6%B4%B2%E9%A0%98%E5%85%88%E8%B7%A8%E5%A2%83%E8%A8%AD%E8%A8%88%E8%B3%BC%E7%89%A9%E7%B6%B2%E7%AB%99/id557252416" target="_blank">Pinkoi iOS App</a> as an example, test the following flow:</p><blockquote><p>Launch App -&gt; Home -&gt; Scroll Down -&gt; Similar to Wish List Items Section -&gt; First Product -&gt; Click First Product -&gt; Enter Product Page -&gt; Click Add to Cart -&gt; UI Response Added to Cart -&gt; Test Successful ‚úÖ</p></blockquote><p><a href="/assets/5a5c4b25a83d/1*aLaMSaG-DFWzYy9RcwCfag.png" class="popup img-link "><img data-src="/assets/5a5c4b25a83d/1*aLaMSaG-DFWzYy9RcwCfag.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>The method of UI automation operation was mentioned earlier, here we manually test the same flow to verify the results.</p><h4 id="3-obtain-record-results"><span class="me-2">3. Obtain Record Results</span><a href="#3-obtain-record-results" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>After the operation is completed, you can press <code class="language-plaintext highlighter-rouge">^ + C</code> to terminate the Snapshot API Mock Server and check the recording results in the file directory:</p><p><a href="/assets/5a5c4b25a83d/1*YO957r5CGMOlsPrm26GbcA.png" class="popup img-link "><img data-src="/assets/5a5c4b25a83d/1*YO957r5CGMOlsPrm26GbcA.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="4-replay-to-verify-the-same-flow-start-the-server--using-replay-mode"><span class="me-2">4. Replay to verify the same flow, start the Server &amp; Using Replay Mode</span><a href="#4-replay-to-verify-the-same-flow-start-the-server--using-replay-mode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mitmdump <span class="nt">-m</span> reverse:https://yourapihost.com <span class="nt">-s</span> mock.py <span class="nt">--set</span> <span class="nv">dumper_folder</span><span class="o">=</span>addCart <span class="nt">--set</span> <span class="nv">config_file</span><span class="o">=</span>config.json
</pre></table></code></div></div><h4 id="5-perform-the-same-ui-operation-again-to-verify-the-results"><span class="me-2">5. Perform the same UI operation again to verify the results</span><a href="#5-perform-the-same-ui-operation-again-to-verify-the-results" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/5a5c4b25a83d/1*70qzxOiM9uJVcvyhKdosVg.png" class="popup img-link "><img data-src="/assets/5a5c4b25a83d/1*70qzxOiM9uJVcvyhKdosVg.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li>Left: Test Successful ‚úÖ<li>Right: Testing clicking on products other than the recorded ones will result in an Error (because there is no data locally + <code class="language-plaintext highlighter-rouge">network_restricted</code> is set to <code class="language-plaintext highlighter-rouge">False</code> by default, so it will directly return 404 without fetching data from the network)</ul><h4 id="6-proof-of-concept-"><span class="me-2">6. Proof Of Concept ‚úÖ</span><a href="#6-proof-of-concept-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The proof of concept is successful. We can indeed use the Reverse Proxy Server to store API Requests &amp; Responses and use it as a Mock API Server to respond with data to the App during testing üéâüéâüéâ.</p><h3 id="2023-09-04-mitmproxy-rodo-is-now-open-source"><span class="me-2">[2023-09-04] mitmproxy-rodo is now open source</span><a href="#2023-09-04-mitmproxy-rodo-is-now-open-source" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main" target="_blank" class="img-link shimmer" ><img data-src="https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="follow-up-and-miscellaneous"><span class="me-2">Follow-up and Miscellaneous</span><a href="#follow-up-and-miscellaneous" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This article only discusses the proof of concept. There are still many areas to be improved and more features to be implemented.</p><ol><li>Integration with <a href="https://github.com/mobile-dev-inc/maestro" target="_blank">maestro</a> UI Testing tool<li>CI/CD process integration design (How to automatically start the Reverse Proxy? Where to start it?)<li>How to package MITMProxy into development tools?<li>Verify more complex testing scenarios<li><strong>Verify the sent Tracking Requests, need to implement storing Request Body, then extract which Tracking Event Data was sent, and whether it matches the events that should be sent in the flow</strong></ol><h4 id="cookie-issues"><span class="me-2">Cookie Issues</span><a href="#cookie-issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1">#...
</span>    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="n">setCookies</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get_all</span><span class="p">(</span><span class="s">"set-cookie"</span><span class="p">)</span>
        <span class="c1"># setCookies = ['ad=0; Domain=.xxx.com; expires=Wed, 23 Aug 2023 04:59:07 GMT; Max-Age=1800; Path=/', 'sessionid=xxxx; Secure; HttpOnly; Domain=.xxx.com; expires=Wed, 23 Aug 2023 04:59:07 GMT; Max-Age=1800; Path=/']
</span>        
        <span class="c1"># OR Replace Cookie Domain From .xxx.com To 127.0.0.1
</span>        <span class="n">setCookies</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">"\s*\.xxx\.com\s*"</span><span class="p">,</span> <span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setCookies</span><span class="p">]</span>

        <span class="c1"># AND Remove Security-Related Restrictions
</span>        <span class="n">setCookies</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">";\s*Secure\s*"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setCookies</span><span class="p">]</span>
        <span class="n">setCookies</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">";\s*HttpOnly;\s*"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setCookies</span><span class="p">]</span>

        <span class="n">flow</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">set_all</span><span class="p">(</span><span class="s">"Set-Cookie"</span><span class="p">,</span> <span class="n">setCookies</span><span class="p">)</span>

        <span class="c1">#...
</span></pre></table></code></div></div><p>If you encounter issues with Cookies, such as the API responding with a Cookie but the App not receiving it, you can refer to the adjustments above.</p><h4 id="the-last-post-on-pinkoi"><span class="me-2">The Last Post on Pinkoi</span><a href="#the-last-post-on-pinkoi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>During my 900+ days at Pinkoi, I realized many of my career aspirations and imaginations regarding iOS/App development and processes. I am grateful to all my teammates for walking through the pandemic and weathering the storms together; the courage to say goodbye is akin to the courage to pursue dreams and join the company initially.</p><blockquote><p><a href="http://resume.zhgchg.li/" target="_blank"><strong>I am embarking on a new life challenge (including but not limited to engineering). If you have suitable opportunities (iOS or engineering management or startup products), please feel free to contact me.</strong></a> üôèüôèüôè</p></blockquote><p>If you have any questions or feedback, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>===</p><p><a href="https://zhgchg.li/posts/5a5c4b25a83d/" target="_blank">Êú¨Êñá‰∏≠ÊñáÁâàÊú¨</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ‚û°Ô∏è <a href="https://medium.com/p/5a5c4b25a83d" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=üç∫&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/zrealm/'>ZRealm</a>, <a href='/categories/dev/'>Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/end-to-end-testing/" class="post-tag no-text-decoration" >end-to-end-testing</a> <a href="/tags/ui-testing/" class="post-tag no-text-decoration" >ui-testing</a> <a href="/tags/automation-testing/" class="post-tag no-text-decoration" >automation-testing</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=POC%20App%20End-to-End%20Testing%20Local%20Snapshot%20API%20Mock%20Server%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F5a5c4b25a83d%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=POC%20App%20End-to-End%20Testing%20Local%20Snapshot%20API%20Mock%20Server%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F5a5c4b25a83d%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F5a5c4b25a83d%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ‚â• 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/e37d66ea1146/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1539454069" data-df="ll" > Oct 14, 2018 </em><h4 class="pt-0 my-2" data-toc-skip>iOS UITextView Text Wrapping Editor (Swift)</h4><div class="text-muted small"><p> iOS UITextView Text Wrapping Editor (Swift) Practical Route Target Functionality: The app has a discussion area where users can post articles. The interface for posting articles needs to support...</p></div></div></a></div><div class="col"> <a href="/posts/cb6eba52a342/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1539618241" data-df="ll" > Oct 15, 2018 </em><h4 class="pt-0 my-2" data-toc-skip>iOS ‚â• 10 Notification Service Extension Application (Swift)</h4><div class="text-muted small"><p> iOS ‚â• 10 Notification Service Extension Application (Swift) Image push notifications, push notification display statistics, pre-processing before push notification display Regarding the basics of...</p></div></div></a></div><div class="col"> <a href="/posts/9a9aa892f9a9/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1539705684" data-df="ll" > Oct 17, 2018 </em><h4 class="pt-0 my-2" data-toc-skip>Exploring Vision‚Ää‚Äî‚ÄäAutomatic Face Detection and Cropping for Profile Pictures (Swift)</h4><div class="text-muted small"><p> Exploring Vision‚Ää‚Äî‚ÄäAutomatic Face Detection and Cropping for Profile Pictures (Swift) Practical Application of Vision [2024/08/13 Update] Refer to the new article and API: ‚ÄúiOS Vision framewor...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/382218e15697/" class="btn btn-outline-primary" prompt="Older" ><p>Using Google Apps Script to Create a Free Github Repo Star Notifier in Three Steps</p></a> <a href="/posts/7b8a0563c157/" class="btn btn-outline-primary" prompt="Newer" ><p>Travelogue 9/11 Nagoya One-Day Flash Free Travel</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">‰∏≠ÊñáÁâàÁ∂≤Á´ô</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>¬© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
