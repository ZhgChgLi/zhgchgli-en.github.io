<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="iOS Deferred Deep Link Implementation (Swift)" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Build an app transition flow that adapts to all scenarios without interruption" /><meta property="og:description" content="Build an app transition flow that adapts to all scenarios without interruption" /><link rel="canonical" href="https://en.zhgchg.li/posts/b08ef940c196/" /><meta property="og:url" content="https://en.zhgchg.li/posts/b08ef940c196/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-11-11T22:34:57+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg" /><meta property="twitter:title" content="iOS Deferred Deep Link Implementation (Swift)" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2024-09-13T17:32:09+08:00","datePublished":"2019-11-11T22:34:57+08:00","description":"Build an app transition flow that adapts to all scenarios without interruption","headline":"iOS Deferred Deep Link Implementation (Swift)","image":"https://en.zhgchg.li/assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/b08ef940c196/"},"url":"https://en.zhgchg.li/posts/b08ef940c196/"}</script><title>iOS Deferred Deep Link Implementation (Swift) | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>iOS Deferred Deep Link Implementation (Swift)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>iOS Deferred Deep Link Implementation (Swift)</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1573482897" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Nov 11, 2019 </em> </span> <span> Updated <em class="" data-ts="1726219929" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 13, 2024 </em> </span><div class="mt-3 mb-3"> <a href="/assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2436 words" > <em>13 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="ios-deferred-deep-link-implementation-swift"><span class="me-2">iOS Deferred Deep Link Implementation (Swift)</span><a href="#ios-deferred-deep-link-implementation-swift" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Build an app transition flow that adapts to all scenarios without interruption</p><h3 id="20220722-update-on-ios-16-upcoming-changes"><span class="me-2">[2022/07/22] Update on iOS 16 Upcoming Changes</span><a href="#20220722-update-on-ios-16-upcoming-changes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Starting from iOS ≥ 16, when an app actively reads the clipboard without user-initiated action, a prompt will appear asking for permission. Users need to allow this for the app to access clipboard information.</p><p><a href="/assets/b08ef940c196/0*E8h6Fy0H9_5jxhjV.png" class="popup img-link "><img data-src="/assets/b08ef940c196/0*E8h6Fy0H9_5jxhjV.png" alt="UIPasteBoard’s privacy change in iOS 16" class="lazyload" data-proofer-ignore></a></p><p><a href="https://sarunw.com/posts/uipasteboard-privacy-change-ios16/">UIPasteBoard’s privacy change in iOS 16</a></p><h3 id="20200702-update"><span class="me-2">[2020/07/02] Update</span><a href="#20200702-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="../8a04443024e2/">In response to iOS 14 updates, a prompt will appear when reading the clipboard. For implementation details, please refer to this article.</a></ul><h4 id="irrelevant"><span class="me-2">Irrelevant</span><a href="#irrelevant" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>From graduating and completing military service to now working aimlessly for nearly three years, my growth has plateaued, and I have settled into a comfort zone. Fortunately, a decision to resign sparked a new beginning.</p><p>While reading “Designing Your Life” and reorganizing my life plan, I reflected on my work and life. Despite not having exceptional technical skills, sharing on Medium has allowed me to enter a state of “flow” and gain a lot of energy. Recently, a friend asked me about Deep Link issues, so I organized my research findings and replenished my energy in the process!</p><h3 id="scenarios"><span class="me-2">Scenarios</span><a href="#scenarios" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First, let’s explain the practical application scenarios.</p><ol><li>When a user with the app installed clicks on a URL link (from Google search, Facebook post, Line link, etc.), the app should directly display the target screen. If the app is not installed, it should redirect to the App Store for installation. <strong>After installing and opening the app, it should be able to reproduce the desired screen from before</strong>.</ol><p><a href="https://www.youtube.com/watch?v=sY6-Q7BFUOM" class="img-link shimmer" ><img data-src="/assets/b08ef940c196/249b_hqdefault.jpg" alt="iOS Deferred Deep Link Demo" title="iOS Deferred Deep Link Demo" class="lazyload" data-proofer-ignore></a></p><ol><li><p>Tracking data for app downloads and openings. We want to know how many people actually download and open the app through a promotional link.</p><li><p>Special event entrances, such as being able to receive rewards by downloading and opening through a specific URL.</p></ol><h4 id="support"><span class="me-2">Support:</span><a href="#support" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>iOS ≥ 9</p><h3 id="what-is-the-difference-between-deferred-deep-link-and-deep-link"><span class="me-2">What is the Difference Between Deferred Deep Link and Deep Link?</span><a href="#what-is-the-difference-between-deferred-deep-link-and-deep-link" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="pure-deep-link-itself"><span class="me-2">Pure Deep Link itself:</span><a href="#pure-deep-link-itself" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/b08ef940c196/1*15arO4L94ZoEyOLtFARtsA.jpeg" class="popup img-link "><img data-src="/assets/b08ef940c196/1*15arO4L94ZoEyOLtFARtsA.jpeg" alt="iOS Deep Link Mechanism" class="lazyload" data-proofer-ignore></a></p><p>As seen, the iOS Deep Link mechanism itself only determines if the app is installed. If it is, the app opens; if not, it does nothing.</p><h4 id="first-we-need-to-add-a-prompt-to-redirect-to-the-app-store-if-the-app-is-not-installed"><span class="me-2">First, we need to add a prompt to redirect to the App Store if the app is not installed:</span><a href="#first-we-need-to-add-a-prompt-to-redirect-to-the-app-store-if-the-app-is-not-installed" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The URL Scheme part is controlled by the system and is generally used for internal app calls and rarely exposed publicly. If the trigger point is in an area you cannot control (e.g., Line link), it cannot be handled.</p><p>If the trigger point is on your own webpage, you can use some tricks to handle it. Please refer to <a href="https://stackoverflow.com/questions/627916/check-if-url-scheme-is-supported-in-javascript"><strong>this link</strong></a>:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Redirect...<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Type"</span> <span class="na">content=</span><span class="s">"text/html; charset=UTF-8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;script&gt;</span>
    var appurl = 'marry://open';
    var appstore = 'https://apps.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E6%9C%80%E5%A4%A7%E5%A9%9A%E7%A6%AE%E7%B1%8C%E5%82%99app/id1356057329';

    var timeout;
    function start() {
      window.location = appurl;
      timeout = setTimeout(function(){
        if(confirm('Install Marry App now?')){
          document.location = appstore;
        }
      }, 1000);
    }

    window.onload = function() {
      start()
    }
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></table></code></div></div><p>The general logic is <strong>to call the URL Scheme, set a Timeout, and if the page has not redirected within the set time, assume that the Scheme cannot be called and redirect to the APP Store page</strong> (but the experience is still not good as there will still be a URL error prompt, just with added automatic redirection).</p><p><strong>Universal Link</strong> itself is a webpage. If there is no redirection, it defaults to being presented in a web browser. Websites with web services can choose to directly jump to the web browser for those services, or directly redirect to the APP Store page.</p><p>Websites with web services can add the following code within <code class="language-plaintext highlighter-rouge">&lt;head&gt;&lt;/head&gt;</code>:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"apple-itunes-app"</span> <span class="na">content=</span><span class="s">"app-id=APPID, app-argument=page parameter"</span><span class="nt">&gt;</span>
</pre></table></code></div></div><p><a href="/assets/b08ef940c196/1*nC1JytAwIwKU04EMBBvf0A.jpeg" class="popup img-link "><img data-src="/assets/b08ef940c196/1*nC1JytAwIwKU04EMBBvf0A.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>When browsing the webpage version on iPhone Safari, an APP installation prompt will appear at the top, along with a button to open the page using the APP; the <code class="language-plaintext highlighter-rouge">app-argument</code> parameter is used to pass in page values and transmit them to the APP.</p><p><a href="/assets/b08ef940c196/1*B-_5tIDWQpNO8NxpXQsEcA.jpeg" class="popup img-link "><img data-src="/assets/b08ef940c196/1*B-_5tIDWQpNO8NxpXQsEcA.jpeg" alt="Flowchart of adding &quot;redirect to APP Store if not available&quot;" class="lazyload" data-proofer-ignore></a></p><p>Flowchart of adding “redirect to APP Store if not available”</p><h4 id="enhancing-deep-link-app-side-processing"><span class="me-2">Enhancing Deep Link APP-side processing:</span><a href="#enhancing-deep-link-app-side-processing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Of course, what we want is not just “open the APP when the user has it installed,” but also to link the referral information with the APP, so that the APP automatically displays the target page when opened.</p><p>The <strong>URL Scheme</strong> method can be handled in the AppDelegate’s <code class="language-plaintext highlighter-rouge">func application(_ application: UIApplication, open url: URL, sourceApplication: String?, annotation: Any) -&gt; Bool</code>:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="kd">open</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">sourceApplication</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="nv">annotation</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s">"marry"</span><span class="p">,</span><span class="k">let</span> <span class="nv">params</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">queryParameters</span> <span class="p">{</span>
      <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"topic"</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">VC</span> <span class="o">=</span> <span class="kt">TopicViewController</span><span class="p">(</span><span class="nv">topicID</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s">"id"</span><span class="p">])</span>
        <span class="kt">UIApplication</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">keyWindow</span><span class="p">?</span><span class="o">.</span><span class="n">rootViewController</span><span class="p">?</span><span class="o">.</span><span class="nf">present</span><span class="p">(</span><span class="kt">VC</span><span class="p">,</span><span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
      <span class="p">}</span>    
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The <strong>Universal Link</strong> method is handled in the AppDelegate’s <code class="language-plaintext highlighter-rouge">func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([Any]?) -&gt; Void) -&gt; Bool</code>:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">URL</span> <span class="p">{</span>
    <span class="c1">/// test=1&amp;a=b&amp;c=d =&gt; ["test":"1","a":"b","c":"d"]</span>
    <span class="c1">/// Parse the URL query into a [String: String] array</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">queryParameters</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">true</span><span class="p">),</span> <span class="k">let</span> <span class="nv">queryItems</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">queryItems</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">var</span> <span class="nv">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">queryItems</span> <span class="p">{</span>
            <span class="n">parameters</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">parameters</span>
    <span class="p">}</span>
    
<span class="p">}</span>
</pre></table></code></div></div><p>First, an extension method queryParameters for URL is provided to easily convert URL Queries into a Swift Dictionary.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="k">continue</span> <span class="nv">userActivity</span><span class="p">:</span> <span class="kt">NSUserActivity</span><span class="p">,</span> <span class="nv">restorationHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">([</span><span class="kt">Any</span><span class="p">]?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        
  <span class="k">if</span> <span class="n">userActivity</span><span class="o">.</span><span class="n">activityType</span> <span class="o">==</span> <span class="kt">NSUserActivityTypeBrowsingWeb</span><span class="p">,</span> <span class="n">webpageURL</span> <span class="o">=</span> <span class="n">userActivity</span><span class="o">.</span><span class="n">webpageURL</span> <span class="p">{</span>
    <span class="c1">/// If it is a universal link URL source...</span>
    <span class="k">let</span> <span class="nv">params</span> <span class="o">=</span> <span class="n">webpageURL</span><span class="o">.</span><span class="n">queryParameters</span>
    
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"topic"</span> <span class="p">{</span>
      <span class="k">let</span> <span class="nv">VC</span> <span class="o">=</span> <span class="kt">TopicViewController</span><span class="p">(</span><span class="nv">topicID</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s">"id"</span><span class="p">])</span>
      <span class="kt">UIApplication</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">keyWindow</span><span class="p">?</span><span class="o">.</span><span class="n">rootViewController</span><span class="p">?</span><span class="o">.</span><span class="nf">present</span><span class="p">(</span><span class="kt">VC</span><span class="p">,</span><span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="kc">true</span>  
<span class="p">}</span>
</pre></table></code></div></div><p>Done!</p><h4 id="what-else-is-missing"><span class="me-2">What else is missing?</span><a href="#what-else-is-missing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>It looks perfect now, we’ve handled all the scenarios we might encounter, so what else is missing?</p><h4 id="entering-the-main-point-of-this-article"><span class="me-2">Entering the main point of this article</span><a href="#entering-the-main-point-of-this-article" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>What is a Deferred Deep Link? It is to extend our Deep Link to retain referral data even after installing from the APP Store.</p><p>According to Android engineers, Android itself has this feature, but it is not supported on iOS, and the method to achieve this is not user-friendly. Keep reading to find out more.</p><h3 id="deferred-deep-link"><span class="me-2">Deferred Deep Link</span><a href="#deferred-deep-link" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If you don’t want to spend time doing it yourself, you can directly use <a href="http://branch.io" target="_blank">branch.io</a> or <a href="https://firebase.google.com/docs/dynamic-links" target="_blank">Firebase Dynamic Links</a>. The method introduced in this article is the way Firebase uses.</p><p><strong>There are two ways to achieve the effect of Deferred Deep Link:</strong></p><p>One is to calculate a hash value based on user device, IP, environment, etc., store data on the server on the web side; when the APP is opened after installation, calculate in the same way, if the values are the same, retrieve the data (branch.io’s method).</p><p>The other is the method introduced in this article, similar to Firebase’s approach; using the iPhone clipboard and Safari and APP Cookie sharing mechanism, which means storing data in the clipboard or Cookie, and then reading it out for use after the APP is installed.</p><p>After clicking “Open,” your clipboard will be automatically overwritten with JavaScript to copy and redirect to relevant information: https://XXX.app.goo.gl/?link=https://XXX.net/topicID=1&amp;type=topic</p><p>Those who have used Firebase Dynamic Links must be familiar with this opening redirect page. Once you understand the principle, you will know that this page cannot be removed from the process!</p><p>Additionally, Firebase does not provide style modifications.</p><h4 id="support-1"><span class="me-2">Support</span><a href="#support-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>First, let’s talk about the support issue; as mentioned earlier, it is “not user-friendly”!</p><p>If the APP only considers iOS ≥ 10, it is much easier. The APP implements clipboard access, the Web uses JavaScript to overwrite information to the clipboard, and then redirects to the APP Store for download.</p><p>iOS = 9 does not support JavaScript automatic clipboard but supports <strong>Safari and APP SFSafariViewController “Cookie sharing method”</strong></p><p>Also, the APP needs to secretly add SFSafariViewController in the background to load the Web, and then obtain the Cookie information stored when clicking the link from the Web.</p><blockquote><p><em>The process is cumbersome &amp; link clicks are limited to Safari browser.</em></p></blockquote><p>According to the official documentation, iOS 11 can no longer access the user’s Safari Cookie. If you have such a requirement, you can use SFAuthenticationSession, but this method cannot be executed stealthily in the background, and a confirmation window will pop up each time before loading.</p><p><a href="/assets/b08ef940c196/1*eisreftWPWn9PTCbuLQqdw.jpeg" class="popup img-link "><img data-src="/assets/b08ef940c196/1*eisreftWPWn9PTCbuLQqdw.jpeg" alt="_SFAuthenticationSession Prompt_" class="lazyload" data-proofer-ignore></a></p><p><em>SFAuthenticationSession Prompt</em></p><blockquote><p><em>Also, App Review does not allow placing SFSafariViewController where users cannot see it. (It’s not easy to be noticed by triggering programmatically and then adding it as a subview.)</em></p></blockquote><h3 id="get-started"><span class="me-2">Get Started</span><a href="#get-started" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Let’s start with something simple, considering users with iOS ≥ 10, simply transfer information using the iPhone clipboard.</p><h4 id="web-end"><span class="me-2">Web End:</span><a href="#web-end" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg" class="popup img-link "><img data-src="/assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>We customized our own page similar to Firebase Dynamic Links, using the <code class="language-plaintext highlighter-rouge">clipboard.js</code> package to copy the information we want to bring to the app when users click “Go Now” to the clipboard <code class="language-plaintext highlighter-rouge">（marry://topicID=1&amp;type=topic）</code>, and then use <code class="language-plaintext highlighter-rouge">location.href</code> to redirect to the App Store page.</p><h4 id="app-end"><span class="me-2">App End:</span><a href="#app-end" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Read the clipboard value in AppDelegate or the main UIViewController:</p><p><code class="language-plaintext highlighter-rouge">let pasteData = UIPasteboard.general.string</code></p><p>It is recommended to wrap the information using the URL Scheme method here for easy identification and data decryption:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="k">let</span> <span class="nv">pasteData</span> <span class="o">=</span> <span class="kt">UIPasteboard</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">pasteData</span><span class="p">),</span> <span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s">"marry"</span><span class="p">,</span> <span class="k">let</span> <span class="nv">params</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">queryParameters</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s">"topic"</span> <span class="p">{</span>
      <span class="k">let</span> <span class="nv">VC</span> <span class="o">=</span> <span class="kt">TopicViewController</span><span class="p">(</span><span class="nv">topicID</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s">"id"</span><span class="p">])</span>
      <span class="kt">UIApplication</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">keyWindow</span><span class="p">?</span><span class="o">.</span><span class="n">rootViewController</span><span class="p">?</span><span class="o">.</span><span class="nf">present</span><span class="p">(</span><span class="kt">VC</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Finally, after completing the action, use <code class="language-plaintext highlighter-rouge">UIPasteboard.general.string = “”</code> to clear the information in the clipboard.</p><h3 id="get-started--support-for-ios-9-version"><span class="me-2">Get Started — Support for iOS 9 Version</span><a href="#get-started--support-for-ios-9-version" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Here comes the tricky part, supporting the iOS 9 version. As mentioned earlier, due to the lack of clipboard support, we need to use the <strong>Cookie Exchange Method</strong>.</p><h4 id="web-end-1"><span class="me-2">Web End:</span><a href="#web-end-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Handling the web end is relatively straightforward, just change it so that when the user clicks “Go Now,” the information we want to bring to the app is stored in a Cookie <code class="language-plaintext highlighter-rouge">（marry://topicID=1&amp;type=topic）</code>, and then use <code class="language-plaintext highlighter-rouge">location.href</code> to redirect to the App Store page.</p><p>Here are two pre-packaged JavaScript methods for handling Cookies to speed up development:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1">/// name: Cookie name</span>
<span class="c1">/// val: Cookie value</span>
<span class="c1">/// day: Cookie expiration period, default is 1 day</span>
<span class="c1">/// EX1: setcookie("iosDeepLinkData","marry://topicID=1&amp;type=topic")</span>
<span class="c1">/// EX2: setcookie("hey","hi",365) = valid for one year</span>
<span class="kd">function</span> <span class="nx">setcookie</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">day</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">exdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="nx">day</span> <span class="o">=</span> <span class="nx">day</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">exdate</span><span class="p">.</span><span class="nx">setDate</span><span class="p">(</span><span class="nx">exdate</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">+</span> <span class="nx">day</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="dl">""</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">val</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">;expires=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">exdate</span><span class="p">.</span><span class="nx">toGMTString</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">/// getCookie("iosDeepLinkData") =&gt; marry://topicID=1&amp;type=topic</span>
<span class="kd">function</span> <span class="nx">getCookie</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="dl">"</span><span class="s2">(^| )</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">=([^;]*)(;|$)</span><span class="dl">"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nb">decodeURI</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="app-end-1"><span class="me-2">App End:</span><a href="#app-end-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Here comes the most troublesome part of this document.</p><p>As mentioned earlier, we need to secretly load an SFSafariViewController in the background in the main UIViewController to implement the principle.</p><p><strong>Another pitfall:</strong> The issue of secretly loading is that if the size of the View of iOS ≥ 10 SFSafariViewController is set to less than 1, the opacity is less than 0.05, and it is set to isHidden, the SFSafariViewController will <strong>not load</strong>.</p><blockquote><p>p.s iOS = 10 supports both Cookies and Clipboard simultaneously.</p></blockquote><p><a href="/assets/b08ef940c196/1*ab-6ppwHU72AsKKLYBitbw.png" class="popup img-link "><img data-src="/assets/b08ef940c196/1*ab-6ppwHU72AsKKLYBitbw.png" alt="[https://stackoverflow.com/questions/39019352/ios10-sfsafariviewcontroller-not-working-when-alpha-is-set-to-0/39216788](https://stackoverflow.com/questions/39019352/ios10-sfsafariviewcontroller-not-working-when-alpha-is-set-to-0/39216788){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p><a href="https://stackoverflow.com/questions/39019352/ios10-sfsafariviewcontroller-not-working-when-alpha-is-set-to-0/39216788" target="_blank">https://stackoverflow.com/questions/39019352/ios10-sfsafariviewcontroller-not-working-when-alpha-is-set-to-0/39216788</a></p><p>My approach here is to place a UIView above the UIViewController of the main page with any height, align it to the bottom of the main UIView, then drag IBOutlet <code class="language-plaintext highlighter-rouge">(sharedCookieView)</code> to the Class; in <code class="language-plaintext highlighter-rouge">viewDidLoad()</code>, initialize the SFSafariViewController and add its View to <code class="language-plaintext highlighter-rouge">sharedCookieView</code>, so it actually displays and loads, just off-screen where the user can’t see 🌝.</p><p><strong>Where should the URL of SFSafariViewController point to?</strong></p><p>Similar to sharing a page on the web, we need to create a separate page for reading Cookies, and place both pages under the same domain to avoid cross-domain Cookie issues, the page content will be provided later.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">SharedCookieView</span><span class="p">:</span> <span class="kt">UIView</span><span class="o">!</span>

<span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
    
    <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span><span class="s">"http://app.marry.com.tw/loadCookie.html"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">sharedCookieViewController</span> <span class="o">=</span> <span class="kt">SFSafariViewController</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
    <span class="kt">VC</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">width</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">sharedCookieViewController</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
    
    <span class="k">self</span><span class="o">.</span><span class="nf">addChildViewController</span><span class="p">(</span><span class="n">sharedCookieViewController</span><span class="p">)</span>
    <span class="k">self</span><span class="o">.</span><span class="kt">SharedCookieView</span><span class="o">.</span><span class="nf">addSubview</span><span class="p">(</span><span class="n">sharedCookieViewController</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
    
    <span class="n">sharedCookieViewController</span><span class="o">.</span><span class="nf">beginAppearanceTransition</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
    <span class="n">sharedCookieViewController</span><span class="o">.</span><span class="nf">didMove</span><span class="p">(</span><span class="nv">toParentViewController</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
    <span class="n">sharedCookieViewController</span><span class="o">.</span><span class="nf">endAppearanceTransition</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">sharedCookieViewController.delegate = self</code></p><p><code class="language-plaintext highlighter-rouge">class HomeViewController: UIViewController, SFSafariViewControllerDelegate</code></p><p>This Delegate needs to be added to capture the callback after loading is complete.</p><p>We can use:</p><p><code class="language-plaintext highlighter-rouge">func safariViewController(_ controller: SFSafariViewController, didCompleteInitialLoad didLoadSuccessfully: Bool) {</code></p><p>Capture the load completion event in the method.</p><p>At this point, you might think that reading the cookies in <code class="language-plaintext highlighter-rouge">didCompleteInitialLoad</code> completes the process!</p><p>I couldn’t find a method to read SFSafariViewController cookies here, and using internet methods to read them always returns empty.</p><blockquote><p><em>Or you may need to interact with the page content using JavaScript, have JavaScript read the cookies and return them to the UIViewController.</em></p></blockquote><h4 id="tricky-url-scheme-method"><span class="me-2">Tricky URL Scheme Method</span><a href="#tricky-url-scheme-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Since iOS doesn’t know how to get shared cookies, we can directly let the “cookie-reading page” help us “read the cookies”.</p><p>The JavaScript method for handling cookies provided earlier with the getCookie() function is used here. Our “cookie-reading page” is a blank page (users can’t see it anyway), but in the JavaScript part, we need to read the cookies after the body onload event:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Load iOS Deep Link Saved Cookie...<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script&gt;</span>
  function checkCookie() {
    var iOSDeepLinkData = getCookie("iOSDeepLinkData");
    if (iOSDeepLinkData <span class="err">&amp;&amp;</span> iOSDeepLinkData != '') {
        setcookie("iOSDeepLinkData", "", -1);
        window.location.href = iOSDeepLinkData; /// marry://topicID=1<span class="err">&amp;</span>type=topic
    }
  }
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">"checkCookie();"</span><span class="nt">&gt;</span>

<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;/html&gt;</span>
</pre></table></code></div></div><p>The actual principle is summarized as follows: add an <code class="language-plaintext highlighter-rouge">SFSafariViewController</code> to <code class="language-plaintext highlighter-rouge">HomeViewController viewDidLoad</code> to secretly load the <code class="language-plaintext highlighter-rouge">loadCookie.html</code> page. The <code class="language-plaintext highlighter-rouge">loadCookie.html</code> page checks and reads the previously stored cookies, clears them if found, and then uses <code class="language-plaintext highlighter-rouge">window.location.href</code> to trigger the <code class="language-plaintext highlighter-rouge">URL Scheme</code> mechanism.</p><p>So the corresponding callback processing will return to <code class="language-plaintext highlighter-rouge">func application(_ application: UIApplication, open url: URL, sourceApplication: String?, annotation: Any)</code> in <code class="language-plaintext highlighter-rouge">AppDelegate</code>.</p><h3 id="done-summary"><span class="me-2">Done! Summary:</span><a href="#done-summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/b08ef940c196/1*kp26TdlJBW5sVxw4zYa9Rg.jpeg" class="popup img-link "><img data-src="/assets/b08ef940c196/1*kp26TdlJBW5sVxw4zYa9Rg.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>If you find it cumbersome, you can directly use <a href="http://branch.io" target="_blank">branch.io</a> or <a href="https://firebase.google.com/docs/dynamic-links" target="_blank">Firebase Dynamic</a> without reinventing the wheel. Here, it’s because of interface customization and some complex requirements that we have to build it ourselves.</p><p>iOS 9 users are already very rare, so you can ignore it if it’s not necessary; using the clipboard method is fast and efficient, and using the clipboard means you don’t have to limit the links to be opened in Safari!</p><p>If you have any questions or suggestions, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>===</p><p><a href="https://zhgchg.li/posts/b08ef940c196/" target="_blank">本文中文版本</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ➡️ <a href="https://medium.com/p/b08ef940c196" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=🍺&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/zrealm/'>ZRealm</a>, <a href='/categories/dev/'>Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/deeplink/" class="post-tag no-text-decoration" >deeplink</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/swift/" class="post-tag no-text-decoration" >swift</a> <a href="/tags/universal-links/" class="post-tag no-text-decoration" >universal-links</a> <a href="/tags/app-store/" class="post-tag no-text-decoration" >app-store</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS%20Deferred%20Deep%20Link%20Implementation%20(Swift)%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fb08ef940c196%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS%20Deferred%20Deep%20Link%20Implementation%20(Swift)%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fb08ef940c196%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fb08ef940c196%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/12c5026da33d/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1612411045" data-df="ll" > Feb 4, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>What's New with Universal Links</h4><div class="text-muted small"><p> What’s New with Universal Links iOS 13, iOS 14 What’s New with Universal Links &amp;amp; Setting Up a Local Testing Environment Photo by NASA Preface For a service that has both a website and an ...</p></div></div></a></div><div class="col"> <a href="/posts/e37d66ea1146/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1539454069" data-df="ll" > Oct 14, 2018 </em><h4 class="pt-0 my-2" data-toc-skip>iOS UITextView Text Wrapping Editor (Swift)</h4><div class="text-muted small"><p> iOS UITextView Text Wrapping Editor (Swift) Practical Route Target Functionality: The app has a discussion area where users can post articles. The interface for posting articles needs to support...</p></div></div></a></div><div class="col"> <a href="/posts/cb6eba52a342/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1539618241" data-df="ll" > Oct 15, 2018 </em><h4 class="pt-0 my-2" data-toc-skip>iOS ≥ 10 Notification Service Extension Application (Swift)</h4><div class="text-muted small"><p> iOS ≥ 10 Notification Service Extension Application (Swift) Image push notifications, push notification display statistics, pre-processing before push notification display Regarding the basics of...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/21119db777dd/" class="btn btn-outline-primary" prompt="Older" ><p>Using 'Shortcuts' Automation with Mi Home Smart Home on iOS ≥ 13.1</p></a> <a href="/posts/14cee137c565/" class="btn btn-outline-primary" prompt="Newer" ><p>iOS UIViewController Transition Techniques</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">中文版網站</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
