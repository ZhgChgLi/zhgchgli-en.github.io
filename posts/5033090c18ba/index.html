<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Research on Preloading and Caching Page and File Resources in iOS WKWebView" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Study on improving page loading speed by preloading and caching resources in iOS WKWebView." /><meta property="og:description" content="Study on improving page loading speed by preloading and caching resources in iOS WKWebView." /><link rel="canonical" href="https://en.zhgchg.li/posts/5033090c18ba/" /><meta property="og:url" content="https://en.zhgchg.li/posts/5033090c18ba/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/5033090c18ba/1*KACJYJkLfa2u5iKYJlJb2Q.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-07-28T17:53:05+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/5033090c18ba/1*KACJYJkLfa2u5iKYJlJb2Q.jpeg" /><meta property="twitter:title" content="Research on Preloading and Caching Page and File Resources in iOS WKWebView" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2024-08-10T17:11:41+08:00","datePublished":"2024-07-28T17:53:05+08:00","description":"Study on improving page loading speed by preloading and caching resources in iOS WKWebView.","headline":"Research on Preloading and Caching Page and File Resources in iOS WKWebView","image":"https://en.zhgchg.li/assets/5033090c18ba/1*KACJYJkLfa2u5iKYJlJb2Q.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/5033090c18ba/"},"url":"https://en.zhgchg.li/posts/5033090c18ba/"}</script><title>Research on Preloading and Caching Page and File Resources in iOS WKWebView | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Research on Preloading and Caching Page and File Resources in iOS WKWebView</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Research on Preloading and Caching Page and File Resources in iOS WKWebView</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1722160385" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jul 28, 2024 </em> </span> <span> Updated <em class="" data-ts="1723281101" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 10, 2024 </em> </span><div class="mt-3 mb-3"> <a href="/assets/5033090c18ba/1*KACJYJkLfa2u5iKYJlJb2Q.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/5033090c18ba/1*KACJYJkLfa2u5iKYJlJb2Q.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3344 words" > <em>18 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="research-on-preloading-and-caching-page-and-file-resources-in-ios-wkwebview"><span class="me-2">Research on Preloading and Caching Page and File Resources in iOS WKWebView</span><a href="#research-on-preloading-and-caching-page-and-file-resources-in-ios-wkwebview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Study on improving page loading speed by preloading and caching resources in iOS WKWebView.</p><p><a href="/assets/5033090c18ba/1*KACJYJkLfa2u5iKYJlJb2Q.jpeg" class="popup img-link "><img data-src="/assets/5033090c18ba/1*KACJYJkLfa2u5iKYJlJb2Q.jpeg" alt="Photo by [Antoine Gravier](https://unsplash.com/@antoine_gravphotos?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p>Photo by <a href="https://unsplash.com/@antoine_gravphotos?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" target="_blank">Antoine Gravier</a></p><h4 id="background"><span class="me-2">Background</span><a href="#background" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For some reason, I have always been quite connected to “Cache”. I have previously been responsible for researching and implementing the “ <a href="../d796bf8e661e/">iOS HLS Cache Implementation Journey</a> “ and “ <a href="../6ce488898003/">Comprehensive Guide to Implementing Local Cache Functionality in AVPlayer</a> “ for AVPlayer; Unlike streaming caching, which aims to reduce playback traffic, <strong>this time the main task is to improve the loading speed of In-app WKWebView</strong>, which also involves research on preloading and caching in WKWebView; However, to be honest, the scenario of WKWebView is more complex. Unlike AVPlayer, which streams audio and video as one or more continuous Chunk files, only file caching is needed, WKWebView not only has its own page files but also imported resource files ( .js, .css, font, image…) which are rendered by the Browser Engine to present the page to the user. There are too many aspects in between that the App cannot control, from network to frontend page JavaScript syntax performance, rendering methods, all of which require time.</p><p><strong>This article is only a study on the feasibility of iOS technology, and it may not be the final solution. In general, it is recommended that frontend developers start from the frontend to achieve a significant effect</strong>, please optimize the time it takes for the first content to appear on the screen (First Contentful Paint) and improve the HTTP Cache mechanism. On the one hand, it can speed up the Web/mWeb itself, affect the speed of Android/iOS in-app WebView, and also improve <a href="https://developers.google.com/search/blog/2018/01/using-page-speed-in-mobile-search?hl=zh-tw" target="_blank">Google SEO ranking</a>.</p><h3 id="technical-details"><span class="me-2">Technical Details</span><a href="#technical-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="ios-restrictions"><span class="me-2">iOS Restrictions</span><a href="#ios-restrictions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>According to <a href="https://developer.apple.com/app-store/review/guidelines/" target="_blank">Apple Review Guidelines 2.5.6</a>:</p><blockquote><p><em>Apps that browse the web must use the appropriate WebKit framework and WebKit JavaScript. You may apply for an entitlement to use an alternative web browser engine in your app. <a href="https://developer.apple.com/support/alternative-browser-engines/" target="_blank">Learn more about these entitlements</a>.</em></p></blockquote><p><strong>Apps can only use the WebKit framework provided by Apple (WKWebView) and are not allowed to use third-party or modified WebKit engines</strong>. Otherwise, they will not be allowed on the App Store; starting from iOS 17.4, to comply with regulations, the EU region can <a href="https://developer.apple.com/support/alternative-browser-engines/" target="_blank">use other Browser Engines</a> after <strong>obtaining special permission from Apple</strong>.</p><blockquote><p>If Apple doesn’t allow it, we can’t do it either.</p></blockquote><p>[Unverified] Information suggests that even the iOS versions of Chrome and Firefox can only use Apple WebKit (WKWebView).</p><p><strong>Another very important thing to note:</strong></p><blockquote><p><em>WKWebView runs on a separate thread outside the main app thread, so all requests and operations do not go through our app.</em></p></blockquote><h4 id="http-cache-flow"><span class="me-2">HTTP Cache Flow</span><a href="#http-cache-flow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/5033090c18ba/1*ozXaaWpTfw6IJOwt54EzsQ.jpeg" class="popup img-link "><img data-src="/assets/5033090c18ba/1*ozXaaWpTfw6IJOwt54EzsQ.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>The HTTP protocol includes a Cache protocol, and the system has already implemented a Cache mechanism in all components related to the network (URLSession, WKWebView…). Therefore, the Client App does not need to implement anything, and it is not recommended for anyone to create their own Cache mechanism. Directly following the HTTP protocol is the fastest, most stable, and most effective approach.</p><p><strong>The general operation process of HTTP Cache is as shown in the diagram above:</strong></p><ol><li>Client initiates a request.<li>Server responds with Cache strategy in the Response Header. The system URLSession, WKWebView, etc., will automatically cache the response based on the Cache Header, and subsequent requests will also automatically apply this strategy.<li>When requesting the same resource again, if the cache has not expired, the response will be directly retrieved from local cache in memory or disk and sent back to the app.<li>If the content has expired (expiration does not mean invalid), a real network request is made to the server. If the content has not changed (still valid even if expired), the server will respond with 304 Not Modified (Empty Body). Although a network request is made, it is basically a millisecond response with no Response Body, resulting in minimal traffic consumption.<li>If the content has changed, new data and Cache Header will be provided again.</ol><blockquote><p><em>In addition to local cache, there may also be network caches on Network Proxy Servers or along the way.</em></p></blockquote><p><strong>Common HTTP Response Cache Header parameters:</strong></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="na">expires</span><span class="pi">:</span> <span class="s">RFC 2822 date</span>
<span class="na">pragma</span><span class="pi">:</span> <span class="s">no-cache</span>
<span class="c1"># Newer parameters:</span>
<span class="na">cache-control</span><span class="pi">:</span> <span class="s">private/public/no-store/no-cache/max-age/s-max-age/must-revalidate/proxy-revalidate...</span>
<span class="na">etag</span><span class="pi">:</span> <span class="s">XXX</span>
</pre></table></code></div></div><p><strong>Common HTTP Request Cache Header parameters:</strong></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="na">If-Modified-Since</span><span class="pi">:</span> <span class="s">2024-07-18 13:00:00</span>
<span class="na">IF-None-Match</span><span class="pi">:</span> <span class="m">1234</span>
</pre></table></code></div></div><blockquote><p><strong><em>In iOS, network-related components (URLSession, WKWebView…) handle HTTP Request/Response Cache Headers automatically and manage caching, so we do not need to handle Cache Header parameters ourselves.</em></strong></p></blockquote><p>For more detailed information on how HTTP Cache works, refer to “<a href="https://blog.techbridge.cc/2017/06/17/cache-introduction/" target="_blank">Understanding the Progressive Understanding of HTTP Cache Mechanism by Huli</a>”.</p><h3 id="ios-wkwebview-overview"><span class="me-2">iOS WKWebView Overview</span><a href="#ios-wkwebview-overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/5033090c18ba/1*j9uw_OGpR-Lrq_4Gpj5beA.jpeg" class="popup img-link "><img data-src="/assets/5033090c18ba/1*j9uw_OGpR-Lrq_4Gpj5beA.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>Returning to iOS, since we can only use Apple WebKit, we can only explore ways to achieve preloading and caching through methods provided by Apple’s WebKit.</p><p>The image above provides an overview of all Apple iOS WebKit (WKWebView) related methods introduced by ChatGPT 4o, along with brief explanations. The green section pertains to methods related to data storage.</p><p><strong>Sharing a few interesting methods:</strong></p><ul><li>WKProcessPool: Allows sharing of resources, data, cookies, etc., among multiple WKWebViews.<li>WKHTTPCookieStore: Manages WKWebView Cookies, cookies between WKWebViews, or URLSession Cookies within the app.<li>WKWebsiteDataStore: Manages website cache files. (Read-only information and clearing)<li>WKURLSchemeHandler: Registers custom Handlers to process unrecognized URL Schemes by WKWebView.<li>WKContentWorld: Manages injected JavaScript (WKUserScript) scripts in groups.<li>WKFindXXX: Controls page search functionality.<li>WKContentRuleListStore: Implements content blockers within WKWebView (e.g., ad blocking).</ul><h3 id="feasibility-study-of-preloading-cache-for-ios-wkwebview"><span class="me-2">Feasibility Study of Preloading Cache for iOS WKWebView</span><a href="#feasibility-study-of-preloading-cache-for-ios-wkwebview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h3 id="improving-http-cache-"><span class="me-2">Improving HTTP Cache ✅</span><a href="#improving-http-cache-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As introduced in the previous section on the HTTP Cache mechanism, we can ask the Web Team to enhance the HTTP Cache settings for the activity pages. On the client iOS side, we only need to check the CachePolicy setting, as everything else has been taken care of by the system!</p><h4 id="cachepolicy-settings"><span class="me-2"><strong>CachePolicy Settings</strong></span><a href="#cachepolicy-settings" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>URLSession:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">configuration</span> <span class="o">=</span> <span class="kt">URLSessionConfiguration</span><span class="o">.</span><span class="k">default</span>
<span class="n">configuration</span><span class="o">.</span><span class="n">requestCachePolicy</span> <span class="o">=</span> <span class="o">.</span><span class="n">useProtocolCachePolicy</span>
<span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="n">configuration</span><span class="p">)</span>
</pre></table></code></div></div><p><strong>URLRequest/WKWebView:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="n">request</span><span class="o">.</span><span class="n">cachePolicy</span> <span class="o">=</span> <span class="o">.</span><span class="n">reloadRevalidatingCacheData</span>
<span class="c1">//</span>
<span class="n">wkWebView</span><span class="o">.</span><span class="nf">load</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</pre></table></code></div></div><ul><li><strong>useProtocolCachePolicy</strong>: Default, follows default HTTP Cache control.<li><strong>reloadIgnoringLocalCacheData</strong>: Does not use local cache, loads data from the network every time (but allows network, Proxy cache…).<li><strong>reloadIgnoringLocalAndRemoteCacheData</strong>: Always loads data from the network, regardless of local or remote cache.<li><strong>returnCacheDataElseLoad</strong>: Uses cached data if available, otherwise loads data from the network.<li><strong>returnCacheDataDontLoad</strong>: Only uses cached data, does not make a network request if no cached data is available.<li><strong>reloadRevalidatingCacheData</strong>: Sends a request to check if the local cache is expired, if not expired (304 Not Modified), uses cached data, otherwise reloads data from the network.</ul><h4 id="setting-cache-size"><span class="me-2"><strong>Setting Cache Size</strong></span><a href="#setting-cache-size" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>App-wide:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">memoryCapacity</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="c1">// 512 MB</span>
<span class="k">let</span> <span class="nv">diskCapacity</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="c1">// 10 GB</span>
<span class="k">let</span> <span class="nv">urlCache</span> <span class="o">=</span> <span class="kt">URLCache</span><span class="p">(</span><span class="nv">memoryCapacity</span><span class="p">:</span> <span class="n">memoryCapacity</span><span class="p">,</span> <span class="nv">diskCapacity</span><span class="p">:</span> <span class="n">diskCapacity</span><span class="p">,</span> <span class="nv">diskPath</span><span class="p">:</span> <span class="s">"myCache"</span><span class="p">)</span>
        
<span class="kt">URLCache</span><span class="o">.</span><span class="n">shared</span> <span class="o">=</span> <span class="n">urlCache</span>
</pre></table></code></div></div><p><strong>Individual URLSession:</strong></p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="n">memoryCapacity</span> <span class="p">=</span> <span class="m">512</span> <span class="p">*</span> <span class="m">1024</span> <span class="p">*</span> <span class="m">1024</span> <span class="c1">// 512 MB</span>
<span class="k">let</span> <span class="n">diskCapacity</span> <span class="p">=</span> <span class="m">10</span> <span class="p">*</span> <span class="m">1024</span> <span class="p">*</span> <span class="m">1024</span> <span class="p">*</span> <span class="m">1024</span> <span class="c1">// 10 GB</span>
<span class="k">let</span> <span class="n">cache</span> <span class="p">=</span> <span class="nf">URLCache</span><span class="p">(</span><span class="n">memoryCapacity</span><span class="p">:</span> <span class="n">memoryCapacity</span><span class="p">,</span> <span class="n">diskCapacity</span><span class="p">:</span> <span class="n">diskCapacity</span><span class="p">,</span> <span class="n">diskPath</span><span class="p">:</span> <span class="s">"myCache"</span><span class="p">)</span>
        
<span class="k">let</span> <span class="n">configuration</span> <span class="p">=</span> <span class="n">URLSessionConfiguration</span><span class="p">.</span><span class="k">default</span>
<span class="n">configuration</span><span class="p">.</span><span class="n">urlCache</span> <span class="p">=</span> <span class="n">cache</span>
</pre></table></code></div></div><blockquote><p><strong><em>Additionally, as mentioned earlier, WKWebView runs on a separate thread outside the main thread of the app, so the cache of URLRequest, URLSession is not shared with WKWebView.</em></strong></p></blockquote><h4 id="how-to-use-safari-developer-tools-in-wkwebview-"><span class="me-2"><strong>How to Use Safari Developer Tools in</strong> WKWebView <strong>?</strong></span><a href="#how-to-use-safari-developer-tools-in-wkwebview-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Check if local Cache is being used.</p><p><strong>Enable Developer Features in Safari:</strong></p><p><a href="/assets/5033090c18ba/1*6j4djW1IeD2n8FGX6FbOtw.png" class="popup img-link "><img data-src="/assets/5033090c18ba/1*6j4djW1IeD2n8FGX6FbOtw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><strong>Enable isInspectable in WKWebView:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">makeWKWebView</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">WKWebView</span> <span class="p">{</span>
 <span class="k">let</span> <span class="nv">webView</span> <span class="o">=</span> <span class="kt">WKWebView</span><span class="p">(</span><span class="nv">frame</span><span class="p">:</span> <span class="o">.</span><span class="n">zero</span><span class="p">)</span>
 <span class="n">webView</span><span class="o">.</span><span class="n">isInspectable</span> <span class="o">=</span> <span class="kc">true</span> <span class="c1">// is only available in ios 16.4 or newer</span>
 <span class="k">return</span> <span class="n">webView</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Add <code class="language-plaintext highlighter-rouge">webView.isInspectable = true</code> to WKWebView to use Safari Developer Tools in Debug Build versions.</p><div class="language-markdown highlighter-rouge"><div class="code-header"> <span data-label-text="Markdown"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="p">![</span><span class="nv">p.s. This is my test WKWebView project opened separately</span><span class="p">](</span><span class="sx">/assets/5033090c18ba/1*6E6AfdFW3w7nvO2VlbhRCA.png</span><span class="p">)</span>

p.s. This is my test WKWebView project opened separately

Set a breakpoint at <span class="sb">`webView.load`</span>.

<span class="gs">**Start Testing:**</span>

Build &amp; Run:

<span class="p">![](</span><span class="sx">/assets/5033090c18ba/1*8jCKl-UzSLrfjy9IAm26pA.png</span><span class="p">)</span>

When the execution reaches the breakpoint at <span class="sb">`webView.load`</span>, click "Step Over".

<span class="p">![](</span><span class="sx">/assets/5033090c18ba/1*LAX4hrwffthRAtK-_9Q42A.png</span><span class="p">)</span>

Go back to Safari, select "Develop" in the toolbar -&gt; "Simulator" -&gt; "Your Project" -&gt; "about:blank".
<span class="p">-</span> Since the page has not started loading, the URL will be about:blank.
<span class="p">-</span> If about:blank does not appear, go back to XCode and click the "Step Over" button again until it appears.

Developer tools corresponding to the page will appear:

<span class="p">![](</span><span class="sx">/assets/5033090c18ba/1*kde2nIvjC8CxFBIcoVhXqg.png</span><span class="p">)</span>

Return to XCode and click "Continue Execution":

<span class="p">![](</span><span class="sx">/assets/5033090c18ba/1*PtAMLX46fNwFDfF7lidyaA.png</span><span class="p">)</span>

Go back to Safari, and in the developer tools, you can see the resource loading status and full developer tools functionality (components, storage space debugging, etc.).

<span class="p">![](</span><span class="sx">/assets/5033090c18ba/1*l0vGOvT2UupVCvf4MrLgUA.png</span><span class="p">)</span>

<span class="gs">**If there is HTTP Cache for network resources, the transmitted size will display as "Disk":**</span>

<span class="p">![](</span><span class="sx">/assets/5033090c18ba/1*TMIPgtC2SVYzEmBD_xPQ_A.png</span><span class="p">)</span>

<span class="p">![](</span><span class="sx">/assets/5033090c18ba/1*KNbus1iFkCl4HjWThyYoew.png</span><span class="p">)</span>

You can also view cache information by clicking inside.

<span class="gu">#### Clear WKWebView Cache</span>
<span class="p">```</span><span class="nl">swift
</span><span class="c1">// Clean Cookies</span>
<span class="kt">HTTPCookieStorage</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">removeCookies</span><span class="p">(</span><span class="nv">since</span><span class="p">:</span> <span class="kt">Date</span><span class="o">.</span><span class="n">distantPast</span><span class="p">)</span>

<span class="c1">// Clean Stored Data, Cache Data</span>
<span class="k">let</span> <span class="nv">dataTypes</span> <span class="o">=</span> <span class="kt">WKWebsiteDataStore</span><span class="o">.</span><span class="nf">allWebsiteDataTypes</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">store</span> <span class="o">=</span> <span class="kt">WKWebsiteDataStore</span><span class="o">.</span><span class="nf">default</span><span class="p">()</span>
<span class="n">store</span><span class="o">.</span><span class="nf">fetchDataRecords</span><span class="p">(</span><span class="nv">ofTypes</span><span class="p">:</span> <span class="n">dataTypes</span><span class="p">)</span> <span class="p">{</span> <span class="n">records</span> <span class="k">in</span>
 <span class="n">records</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">record</span> <span class="k">in</span>
  <span class="n">store</span><span class="o">.</span><span class="nf">removeData</span><span class="p">(</span>
   <span class="nv">ofTypes</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">dataTypes</span><span class="p">,</span>
   <span class="nv">for</span><span class="p">:</span> <span class="n">records</span><span class="p">,</span>
   <span class="nv">completionHandler</span><span class="p">:</span> <span class="p">{</span>
          <span class="nf">print</span><span class="p">(</span><span class="s">"clearWebViewCache() - </span><span class="se">\(</span><span class="n">record</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>           
   <span class="p">}</span>
  <span class="p">)</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Use the above method to clear cached resources, local data, and cookie data in WKWebView.</p><blockquote><p><strong><em>However, improving HTTP Cache only achieves caching (faster on subsequent visits), and preloading (first visit) will not be affected.</em></strong> ✅</p></blockquote><h3 id="improve-http-cache--wkwebview-preload-entire-page-"><span class="me-2">Improve HTTP Cache + WKWebView Preload Entire Page 😕</span><a href="#improve-http-cache--wkwebview-preload-entire-page-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">WebViewPreloader</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">shared</span> <span class="o">=</span> <span class="kt">WebViewPreloader</span><span class="p">()</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_webview</span><span class="p">:</span> <span class="kt">WKWebView</span> <span class="o">=</span> <span class="kt">WKWebView</span><span class="p">()</span>

    <span class="kd">private</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">preload</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="kt">Task</span> <span class="p">{</span> <span class="kd">@MainActor</span> <span class="k">in</span>
            <span class="n">webview</span><span class="o">.</span><span class="nf">load</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">WebViewPreloader</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">preload</span><span class="p">(</span><span class="s">"https://zhgchg.li/campaign/summer"</span><span class="p">)</span>
</pre></table></code></div></div><p>After improving HTTP Cache, the second time loading WKWebView will be cached. We can preload all the URLs in the list or homepage in advance to have them cached, making it faster for users when they enter.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>
&gt; **_After testing, it is theoretically feasible; but the performance impact and network traffic loss are too significant_** _; Users may not even go to the detailed page, but we preload all pages to feel a bit like shooting in the dark._ 

&gt; _Personally, I think it is not feasible in reality, and the disadvantages outweigh the benefits, cutting off one's nose to spite one's face. 😕_ 

### Enhance HTTP Cache + WKWebView Preload Pure Resources 🎉

Based on the optimization method above, we can combine the HTML Link Preload method to preload only the resource files \(e.g. \.js, \.css, font, image...\) that will be used in the page, allowing users to directly use cached resources after entering without initiating network requests to fetch resource files.

&gt; **_This means I am not preloading everything on the entire page, I am only preloading the resource files that the page will use, which may also be shared across pages; the page file \.html is still fetched from the network and combined with the preloaded files to render the page._** 

Please note: We are still using HTTP Cache here, so these resources must also support HTTP Cache, otherwise, future requests will still go through the network.

```xml
&lt;!DOCTYPE html&gt;
&lt;html lang="zh-tw"&gt;
 &lt;head&gt;
    &lt;link rel="preload" href="https://cdn.zhgchg.li/dist/main.js" as="script"&gt;
    &lt;link rel="preload" href="https://image.zhgchg.li/v2/image/get/campaign.jpg" as="image"&gt;
    &lt;link rel="preload" href="https://cdn.zhgchg.li/assets/fonts/glyphicons-halflings-regular.woff2" as="font"&gt;
    &lt;link rel="preload" href="https://cdn.zhgchg.li/assets/fonts/Simple-Line-Icons.woff2?v=2.4.0" as="font"&gt;
  &lt;/head&gt;
&lt;/html&gt;
</pre></table></code></div></div><p><strong>Common supported file types:</strong></p><ul><li>.js script<li>.css style<li>font<li>image</ul><p>The Web Team will place the above HTML content in the path agreed upon with the App, and our <code class="language-plaintext highlighter-rouge">WebViewPreloader</code> will be modified to load this path, so that WKWebView will parse &lt;link&gt; preload resources and generate caches while loading.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kt">WebViewPreloader</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">preload</span><span class="p">(</span><span class="s">"https://zhgchg.li/campaign/summer/preload"</span><span class="p">)</span>
<span class="c1">// or all in one</span>
<span class="kt">WebViewPreloader</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">preload</span><span class="p">(</span><span class="s">"https://zhgchg.li/assets/preload"</span><span class="p">)</span>
</pre></table></code></div></div><blockquote><p><strong><em>After testing, a good balance between traffic loss and preloading can be achieved</em></strong> <em>.</em> 🎉</p></blockquote><blockquote><p><strong><em>The downside is that maintaining this cache resource list is necessary, and web optimization for page rendering and loading is still required; otherwise, the perceived time for the first page to appear will still be long.</em></strong></p></blockquote><h3 id="urlprotocol-"><span class="me-2">URLProtocol <em>❌</em></span><a href="#urlprotocol-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Additionally, considering our old friend <a href="https://developer.apple.com/documentation/foundation/urlprotocol" target="_blank">URLProtocol</a>, all requests based on <code class="language-plaintext highlighter-rouge">URL Loading System</code> (URLSession, openURL…) can be intercepted and manipulated.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">CustomURLProtocol</span><span class="p">:</span> <span class="kt">URLProtocol</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">class</span> <span class="kd">func</span> <span class="nf">canInit</span><span class="p">(</span><span class="n">with</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="c1">// Determine if this request should be handled</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s">"custom"</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="kd">class</span> <span class="kd">func</span> <span class="nf">canonicalRequest</span><span class="p">(</span><span class="k">for</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span> <span class="p">{</span>
        <span class="c1">// Return the request</span>
        <span class="k">return</span> <span class="n">request</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">startLoading</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Handle the request and load data</span>
        <span class="c1">// Change to a caching strategy, read files locally first</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="kt">URLResponse</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">mimeType</span><span class="p">:</span> <span class="s">"text/plain"</span><span class="p">,</span> <span class="nv">expectedContentLength</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">textEncodingName</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">client</span><span class="p">?</span><span class="o">.</span><span class="nf">urlProtocol</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="nv">didReceive</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span> <span class="nv">cacheStoragePolicy</span><span class="p">:</span> <span class="o">.</span><span class="n">notAllowed</span><span class="p">)</span>
            
            <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="s">"This is a custom response!"</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>
            <span class="k">self</span><span class="o">.</span><span class="n">client</span><span class="p">?</span><span class="o">.</span><span class="nf">urlProtocol</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="nv">didLoad</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">client</span><span class="p">?</span><span class="o">.</span><span class="nf">urlProtocolDidFinishLoading</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">stopLoading</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Stop loading data</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// AppDelegate.swift didFinishLaunchingWithOptions:</span>
<span class="kt">URLProtocol</span><span class="o">.</span><span class="nf">registerClass</span><span class="p">(</span><span class="kt">CustomURLProtocol</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
</pre></table></code></div></div><p>Abstract idea is to secretly send URLRequest -&gt; URLProtocol -&gt; download all resources by yourself in the background, user -&gt; WKWebView -&gt; Request -&gt; URLProtocol -&gt; respond with preloaded resources.</p><blockquote><p><strong><em>Same as mentioned earlier, WKWebView runs on a separate thread outside the main thread of the app, so URLProtocol cannot intercept requests from WKWebView.</em></strong></p></blockquote><blockquote><p><strong><em>But I heard that using dark magic seems possible, not recommended, it may lead to other issues (rejection during review).</em></strong></p></blockquote><blockquote><p><strong><em>This path is blocked</em></strong> ❌.</p></blockquote><h3 id="wkurlschemehandler-"><span class="me-2">WKURLSchemeHandler 😕</span><a href="#wkurlschemehandler-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Apple introduced a new method in iOS 11, which seems to compensate for the inability of WKWebView to use URLProtocol. However, this method is similar to <a href="../6ce488898003/">AVPlayer’s ResourceLoader</a>, <strong>only system-unrecognized schemes will be handed over to our custom WKURLSchemeHandler for processing</strong>.</p><p>The abstract idea remains the same in the background, where WKWebView secretly sends Request -&gt; WKURLSchemeHandler -&gt; download all resources by yourself, user -&gt; WKWebView -&gt; Request -&gt; WKURLSchemeHandler -&gt; respond with preloaded resources.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">WebKit</span>

<span class="kd">class</span> <span class="kt">CustomSchemeHandler</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">WKURLSchemeHandler</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">webView</span><span class="p">(</span><span class="n">_</span> <span class="nv">webView</span><span class="p">:</span> <span class="kt">WKWebView</span><span class="p">,</span> <span class="n">start</span> <span class="nv">urlSchemeTask</span><span class="p">:</span> <span class="kt">WKURLSchemeTask</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Custom handling</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">urlSchemeTask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">!</span>
        
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s">"custom-scheme"</span> <span class="p">{</span>
            <span class="c1">// Change to caching strategy, read file locally first</span>
            <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="kt">URLResponse</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">mimeType</span><span class="p">:</span> <span class="s">"text/html"</span><span class="p">,</span> <span class="nv">expectedContentLength</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">textEncodingName</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="n">urlSchemeTask</span><span class="o">.</span><span class="nf">didReceive</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            
            <span class="k">let</span> <span class="nv">html</span> <span class="o">=</span> <span class="s">"&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello from custom scheme!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;"</span>
            <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>
            <span class="n">urlSchemeTask</span><span class="o">.</span><span class="nf">didReceive</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">urlSchemeTask</span><span class="o">.</span><span class="nf">didFinish</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">webView</span><span class="p">(</span><span class="n">_</span> <span class="nv">webView</span><span class="p">:</span> <span class="kt">WKWebView</span><span class="p">,</span> <span class="n">stop</span> <span class="nv">urlSchemeTask</span><span class="p">:</span> <span class="kt">WKURLSchemeTask</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Stop</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">webViewConfiguration</span> <span class="o">=</span> <span class="kt">WKWebViewConfiguration</span><span class="p">()</span>
<span class="n">webViewConfiguration</span><span class="o">.</span><span class="nf">setURLSchemeHandler</span><span class="p">(</span><span class="kt">CustomSchemeHandler</span><span class="p">(),</span> <span class="nv">forURLScheme</span><span class="p">:</span> <span class="s">"mycacher"</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">customURL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"mycacher://zhgchg.li/campaign/summer"</span><span class="p">)</span><span class="o">!</span>
<span class="n">webView</span><span class="o">.</span><span class="nf">load</span><span class="p">(</span><span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">customURL</span><span class="p">))</span>
</pre></table></code></div></div><ul><li>Because http/https are schemes that the system can handle, we cannot customize the handling of http/https; you need to switch the scheme to one that the system does not recognize (e.g., <code class="language-plaintext highlighter-rouge">mycacher://</code>).<li>All paths in the page must use relative paths to automatically append <code class="language-plaintext highlighter-rouge">mycacher://</code> for our Handler to capture.<li>If you do not want to change http/https but still want to access http/https requests, you can only resort to dark magic, <strong>not recommended,</strong> as it may lead to other issues (rejection during review).<li>Cache page files and respond by yourself, Ajax, XMLHttpRequest, Fetch requests used in the page may be <strong>blocked</strong> by <a href="https://developer.mozilla.org/zh-TW/docs/Web/Security/Same-origin_policy" target="_blank"><strong>CORS Same-Origin Policy</strong></a> <strong>(because it will send requests from mycacher:// to http://zhgchg.li/xxx, different origins)</strong>, requiring a decrease in website security to use.<li>You may need to implement your own Cache Policy, such as when to update? How long is it valid? <strong>(similar to what HTTP Cache does)</strong>.</ul><blockquote><p><strong><em>Overall, while theoretically feasible, the implementation requires a huge investment; it is not cost-effective and difficult to scale and maintain stability</em></strong> <em>😕</em></p></blockquote><p>Feeling that the WKURLSchemeHandler method is more suitable for handling web pages with large resource files that need to be downloaded, declaring a custom scheme to be processed by the app to render the web page cooperatively.</p><h4 id="bridging-wkwebview-network-requests-to-be-sent-by-the-app-"><span class="me-2">Bridging WKWebView network requests to be sent by the app 🫥</span><a href="#bridging-wkwebview-network-requests-to-be-sent-by-the-app-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Change WKWebView to use the interface defined by the app (WkUserScript) instead of Ajax, XMLHttpRequest, Fetch, for the app to request resources.</p><blockquote><p><em>This example is not very helpful because the first screen appears too slow, not the subsequent loading; and this method will cause a deep and strange dependency relationship between Web and App 🫥</em></p></blockquote><h3 id="starting-from-service-worker-"><span class="me-2">Starting from Service Worker <em>❌</em></span><a href="#starting-from-service-worker-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p><em>Due to security issues, only Apple’s own Safari app supports it, WKWebView does not support it❌.</em></p></blockquote><h3 id="wkwebview-performance-optimization-"><span class="me-2">WKWebView Performance Optimization 🫥</span><a href="#wkwebview-performance-optimization-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Optimize to improve the performance of loading views in WKWebView.</p><blockquote><p><em>WKWebView itself is like a skeleton, and the web page is the flesh. After researching, optimizing the skeleton (e.g. reusing WKProcessPool) has limited effect, possibly a difference of 0.0003 -&gt; 0.000015 seconds.</em></p></blockquote><h3 id="local-html-local-resource-files-"><span class="me-2">Local HTML, Local Resource Files 🫥</span><a href="#local-html-local-resource-files-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Similar to the Preload method, but instead of putting the active page in the App Bundle or fetching it remotely at startup.</p><blockquote><p><em>Putting the entire HTML page may also encounter CORS same-origin issues; it feels like using the “Improve HTTP Cache + WKWebView Preload pure resources” method instead; putting it in the App Bundle only increases the App Size, fetching it remotely is WKWebView Preload 🫥</em></p></blockquote><h3 id="frontend-optimization-approach-"><span class="me-2">Frontend Optimization Approach 🎉🎉🎉</span><a href="#frontend-optimization-approach-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/5033090c18ba/1*Y3nDpbc4aEd0wg7Enk4k8A.png" class="popup img-link "><img data-src="/assets/5033090c18ba/1*Y3nDpbc4aEd0wg7Enk4k8A.png" alt="[Source: wedevs](https://wedevs.com/blog/348939/first-contentful-paint-largest-contentful-paint/){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p>Reference <a href="https://wedevs.com/blog/348939/first-contentful-paint-largest-contentful-paint/" target="_blank">wedevs optimization suggestions</a>, the frontend HTML page is expected to have four loading stages, from loading the page file (.html) at the beginning to First Paint (blank page), then to First Contentful Paint (rendering the page skeleton), then to First Meaningful Paint (adding page content), and finally to Time To Interactive (allowing user interaction).</p><p><a href="/assets/5033090c18ba/1*UirBj7nm_spU6knKbsyzxA.png" class="popup img-link "><img data-src="/assets/5033090c18ba/1*UirBj7nm_spU6knKbsyzxA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Using our page for testing; browsers, WKWebView will first request the page body .html and then load the required resources, while building the screen for the user according to the program instructions. Comparing with the article, it is found that the page stages only go from First Paint (blank) to Time To Interactive (First Contentful Paint only has the Navigation Bar, which should not count much…), missing the intermediate stages of rendering for the user, thus extending the overall waiting time for the user.</p><blockquote><p><em>And currently, only resource files have HTTP Cache settings, not the page body.</em></p></blockquote><p>Additionally, you can refer to <a href="https://pagespeed.web.dev/" target="_blank">Google PageSpeed Insights</a> for optimization suggestions, such as compression, reducing script size, etc.</p><p><a href="/assets/5033090c18ba/1*ihntq14ZIPCHnJvgBKAKDQ.png" class="popup img-link "><img data-src="/assets/5033090c18ba/1*ihntq14ZIPCHnJvgBKAKDQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p><em>Because the core of in-app WKWebView is still the web page itself; therefore, adjusting from the frontend web page is a very effective way to make a big difference with a small adjustment. 🎉🎉🎉</em></p></blockquote><h3 id="improving-user-experience-"><span class="me-2">Improving User Experience 🎉🎉🎉</span><a href="#improving-user-experience-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/5033090c18ba/1*lxEvkhODfhjmEqE21zLcRw.png" class="popup img-link "><img data-src="/assets/5033090c18ba/1*lxEvkhODfhjmEqE21zLcRw.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p><em>A simple implementation, starting from the user experience, adding a Loading Progress Bar, not just showing a blank page to confuse the user, let them know that the page is loading and where the progress is.🎉🎉🎉</em></p></blockquote><h3 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The above is some ideation research on feasible solutions for WKWebView preloading and caching. The technology is not the biggest issue, the key is still the choice, which ways are most effective for users with the lowest development cost. Choosing these ways may achieve the goal directly with minor changes; choosing the wrong way will result in a huge investment of resources and may be difficult to maintain and use in the future.</p><blockquote><p><em>There are always more solutions than difficulties, sometimes it’s just a lack of imagination.</em></p></blockquote><p>Maybe there are some legendary combinations that I haven’t thought of, welcome everyone to contribute.</p><h3 id="references"><span class="me-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="wkwebview-preload-pure-resource-solution-can-refer-to-the-following-video"><span class="me-2">WKWebView Preload Pure Resource🎉 Solution can refer to the following video</span><a href="#wkwebview-preload-pure-resource-solution-can-refer-to-the-following-video" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://www.youtube.com/watch?v=ZQvyfFieBfs" target="_blank" class="img-link shimmer" ><img data-src="/assets/5033090c18ba/bc6c_hqdefault.jpg" alt="&quot;Preload strategies using WKWebView&quot; by Jonatán Urquiza" title="&quot;Preload strategies using WKWebView&quot; by Jonatán Urquiza" class="lazyload" data-proofer-ignore></a></p><p>The author also mentioned the method of WKURLSchemeHandler.</p><p><strong>The complete Demo Repo in the video is as follows:</strong></p><p><a href="https://github.com/jonurq/preload-strategies-wkwebview" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/6789eaaf4d4f56f69df9d39e4abae4a910b10da24a14ff934a367da52fbde78c/jonurq/preload-strategies-wkwebview" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="ios-old-driver-weekly"><span class="me-2">iOS Old Driver Weekly</span><a href="#ios-old-driver-weekly" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/SwiftOldDriver/iOS-Weekly/issues?q=WkWebView" target="_blank" class="img-link shimmer" ><img data-src="https://repository-images.githubusercontent.com/115476023/2a31ab00-183a-11eb-889c-b9674f419108" alt="" class="lazyload" data-proofer-ignore></a></p><p>The sharing about WkWebView in the Old Driver Weekly is also worth a look.</p><h3 id="chat"><span class="me-2">Chat</span><a href="#chat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Long-awaited return to writing long articles related to iOS development.</p><p>If you have any questions or suggestions, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>===</p><p><a href="https://zhgchg.li/posts/5033090c18ba/" target="_blank">本文中文版本</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ➡️ <a href="https://medium.com/p/5033090c18ba" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=🍺&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/zrealm/'>ZRealm</a>, <a href='/categories/dev/'>Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/webview/" class="post-tag no-text-decoration" >webview</a> <a href="/tags/http-request/" class="post-tag no-text-decoration" >http-request</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Research%20on%20Preloading%20and%20Caching%20Page%20and%20File%20Resources%20in%20iOS%20WKWebView%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F5033090c18ba%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Research%20on%20Preloading%20and%20Caching%20Page%20and%20File%20Resources%20in%20iOS%20WKWebView%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F5033090c18ba%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F5033090c18ba%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/d796bf8e661e/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1586365937" data-df="ll" > Apr 9, 2020 </em><h4 class="pt-0 my-2" data-toc-skip>Exploring Methods for Implementing iOS HLS Cache</h4><div class="text-muted small"><p> Exploring Methods for Implementing iOS HLS Cache How to achieve caching while playing m3u8 streaming video files using AVPlayer photo by Mihis Alex [2023/03/12] Update The next article, “Com...</p></div></div></a></div><div class="col"> <a href="/posts/6ce488898003/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1612089702" data-df="ll" > Jan 31, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>Comprehensive Guide to Implementing Local Cache with AVPlayer</h4><div class="text-muted small"><p> Comprehensive Guide to Implementing Local Cache with AVPlayer AVPlayer/AVQueuePlayer with AVURLAsset implementing AVAssetResourceLoaderDelegate Photo by Tyler Lastovich [2023/03/12] Update I...</p></div></div></a></div><div class="col"> <a href="/posts/ee47f8f1e2d2/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1609856872" data-df="ll" > Jan 5, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>AVPlayer Real-time Cache Implementation</h4><div class="text-muted small"><p> [Old] AVPlayer Real-time Cache Implementation Understanding the implementation of AVPlayer/AVQueuePlayer with AVURLAsset using AVAssetResourceLoaderDelegate [2021–01–31] Article Announcement: Art...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/cb65fd5ab770/" class="btn btn-outline-primary" prompt="Older" ><p>Travelogue 2024 Second Visit to Kyushu 9-Day Free and Easy Trip, Entering Japan via Busan→Fukuoka Cruise</p></a> <a href="/posts/cefdf4d41746/" class="btn btn-outline-primary" prompt="Newer" ><p>Medium Partner Program is finally open to global (including Taiwan) writers!</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">中文版網站</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
