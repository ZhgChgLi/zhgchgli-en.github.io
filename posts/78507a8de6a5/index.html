<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Record of Practical Application of Design Patterns" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Record of problem scenarios encountered and solutions applied when encapsulating Socket.IO Client Library requirements using Design Patterns" /><meta property="og:description" content="Record of problem scenarios encountered and solutions applied when encapsulating Socket.IO Client Library requirements using Design Patterns" /><link rel="canonical" href="https://en.zhgchg.li/posts/78507a8de6a5/" /><meta property="og:url" content="https://en.zhgchg.li/posts/78507a8de6a5/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-07T22:49:17+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.jpeg" /><meta property="twitter:title" content="Record of Practical Application of Design Patterns" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2024-09-06T14:00:33+08:00","datePublished":"2022-04-07T22:49:17+08:00","description":"Record of problem scenarios encountered and solutions applied when encapsulating Socket.IO Client Library requirements using Design Patterns","headline":"Record of Practical Application of Design Patterns","image":"https://en.zhgchg.li/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/78507a8de6a5/"},"url":"https://en.zhgchg.li/posts/78507a8de6a5/"}</script><title>Record of Practical Application of Design Patterns | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Record of Practical Application of Design Patterns</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Record of Practical Application of Design Patterns</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1649342957" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 7, 2022 </em> </span> <span> Updated <em class="" data-ts="1725602433" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 6, 2024 </em> </span><div class="mt-3 mb-3"> <a href="/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3761 words" > <em>20 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="record-of-practical-application-of-design-patterns"><span class="me-2">Record of Practical Application of Design Patterns</span><a href="#record-of-practical-application-of-design-patterns" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Record of problem scenarios encountered and solutions applied when encapsulating Socket.IO Client Library requirements using Design Patterns</p><p><a href="/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.jpeg" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.jpeg" alt="Photo by [Daniel McCullough](https://unsplash.com/@d_mccullough?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p>Photo by <a href="https://unsplash.com/@d_mccullough?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Daniel McCullough</a></p><h3 id="preface"><span class="me-2">Preface</span><a href="#preface" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This article is a record of real-world development requirements, where Design Patterns were applied to solve problems. The content will cover the background of the requirements, the actual problem scenarios encountered (What?), why Design Patterns were applied to solve the problems (Why?), and how they were implemented (How?). It is recommended to read from the beginning for coherence.</p><blockquote><p><em>This article will introduce four scenarios encountered in developing this requirement and the application of seven Design Patterns to solve these scenarios.</em></p></blockquote><h3 id="background"><span class="me-2">Background</span><a href="#background" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="organizational-structure"><span class="me-2">Organizational Structure</span><a href="#organizational-structure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This year, the company split into Feature Teams (multiple) and Platform Team; the former mainly focuses on user-side requirements, while the Platform Team deals with internal members of the company. One of their tasks is to introduce technology, build infrastructure, and ensure systematic integration to pave the way for Feature Teams when developing requirements.</p><h4 id="current-requirement"><span class="me-2">Current Requirement</span><a href="#current-requirement" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The Feature Teams needed to change the original messaging feature (fetching message data by calling APIs on the page, requiring a refresh for the latest messages) to real-time communication (receiving the latest messages instantly, and sending messages).</p><h4 id="platform-teams-work"><span class="me-2">Platform Team’s Work</span><a href="#platform-teams-work" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The Platform Team’s focus was not only on the immediate real-time communication requirement but also on long-term development and reusability. After evaluation, it was deemed essential to have a WebSocket bidirectional communication mechanism in modern apps. Apart from the current requirement, there will be many future opportunities to use this mechanism. With the available resources, efforts were put into designing and developing the interface.</p><p><strong>Goals:</strong></p><ul><li>Encapsulate communication between Pinkoi Server Side and Socket.IO, including authentication logic<li>Simplify Socket.IO operations, providing an extensible and user-friendly interface based on Pinkoi’s business requirements<li>Standardize the interface for both platforms <strong>(Socket.IO’s Android and iOS Client Side Libraries have different functionalities and interfaces)</strong><li>Feature side does not need to understand Socket.IO mechanisms<li>Feature side does not need to manage complex connection states<li>Future bidirectional communication requirements using WebSocket can be directly implemented</ul><p><strong>Time and Resources:</strong></p><ul><li>One developer each for iOS and Android<li>Development timeline: 3 weeks</ul><h4 id="technical-details"><span class="me-2">Technical Details</span><a href="#technical-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This Feature will be supported on Web, iOS, and Android platforms. WebSocket bidirectional communication protocol will be introduced for implementation, with the backend expected to directly use <a href="http://socket.io/" target="_blank">Socket.io</a> service.</p><blockquote><p><strong><em>Firstly, Socket != WebSocket</em></strong></p></blockquote><p>For more information on Socket and WebSocket and technical details, refer to the following two articles:</p><ul><li><a href="https://leesonhsu.blogspot.com/2018/07/socketwebsocketsocketio.html" target="_blank">Difference between Socket, WebSocket, and Socket.io</a><li><a href="https://github.com/onlyliuxin/coding2017/issues/497" target="_blank">Why not use socket directly and define a new websocket?</a></ul><p>In short:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Socket is an abstract encapsulation interface for the TCP/UDP transport layer, while WebSocket is a transmission protocol at the application layer.
The relationship between Socket and WebSocket is like that of a dog and a hot dog, they are unrelated.
</pre></table></code></div></div><p><a href="/assets/78507a8de6a5/1*MC_nQC382khMeWggLejWOA.jpeg" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*MC_nQC382khMeWggLejWOA.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>Socket.IO is a layer of abstract operation encapsulation for Engine.IO, which encapsulates the use of WebSocket. Each layer is only responsible for communication between the upper and lower layers and does not allow operations to pass through (e.g. Socket.IO directly operating WebSocket connections).</p><p>In addition to basic WebSocket connections, Socket.IO/Engine.IO also implements many convenient and useful feature sets (e.g. offline event sending mechanism, similar to HTTP request mechanism, room/group mechanism, etc.).</p><p>The main responsibility of the Platform Team is to bridge the logic between Socket.IO and Pinkoi Server Side for use by the upper Feature Teams during development.</p><h4 id="socketio-swift-client-has-pitfalls"><span class="me-2"><a href="https://github.com/socketio/socket.io-client-swift" target="_blank">Socket.IO Swift Client</a> has pitfalls</span><a href="#socketio-swift-client-has-pitfalls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Has not been updated for a long time (latest version is still in 2019), unsure if it is still being maintained.<li>Client &amp; Server Side Socket IO Version must be aligned, Server Side can add <code class="language-plaintext highlighter-rouge">{allowEIO3: true}</code> / or Client Side specify the same version <code class="language-plaintext highlighter-rouge">.version</code> Otherwise, it won’t connect.<li>Naming conventions, interfaces, and many examples on the official website do not match.<li>Socket.IO official website examples are based on web, but in reality, the Swift Client <strong>may not fully support the functionalities</strong> written on the website. In this implementation, we found that the iOS library did not implement the offline event sending mechanism (we implemented it ourselves, please continue reading)</ul><blockquote><p><strong><em>It is recommended to experiment with the mechanisms you want to use before adopting Socket.IO.</em></strong></p></blockquote><blockquote><p><em>Socket.IO Swift Client is based on <strong><a href="https://github.com/daltoniam/Starscream" target="_blank">Starscream</a></strong> WebSocket Library, and can be downgraded to use Starscream if necessary.</em></p></blockquote><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Background information supplement ends here, let's move on to the main topic.
</pre></table></code></div></div><h3 id="design-patterns"><span class="me-2">Design Patterns</span><a href="#design-patterns" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Design patterns are simply solutions to common problems in software design. You don’t necessarily have to use design patterns to develop; design patterns may not be applicable to all scenarios, and there’s no rule against deriving new design patterns on your own.</p><p><a href="/assets/78507a8de6a5/1*MAm5WPynbv7M9tdmW2lNGQ.jpeg" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*MAm5WPynbv7M9tdmW2lNGQ.jpeg" alt="[The Catalog of Design Patterns](https://refactoring.guru/design-patterns/catalog){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p><a href="https://refactoring.guru/design-patterns/catalog" target="_blank">The Catalog of Design Patterns</a></p><p>However, existing design patterns (The 23 Gang of Four Design Patterns) are common knowledge in software design. Just mentioning an XXX Pattern will trigger a corresponding mental blueprint in everyone’s mind, without the need for much explanation. It is easier to understand the context for future maintenance, and these methods have been validated by the industry, so there’s no need to spend time examining object dependency issues. Choosing the right pattern for the right scenario can reduce communication and maintenance costs, and improve development efficiency.</p><blockquote><p><strong><em>Design patterns can be combined, but it is not recommended to modify existing design patterns, forcibly apply patterns that do not fit, or apply patterns that do not belong to the category (e.g. using the Chain of Responsibility pattern to create objects), as it may lose its meaning and potentially cause misunderstandings for future maintainers.</em></strong></p></blockquote><h4 id="design-patterns-mentioned-in-this-article"><span class="me-2">Design Patterns mentioned in this article:</span><a href="#design-patterns-mentioned-in-this-article" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://refactoring.guru/design-patterns/singleton" target="_blank">Singleton Pattern</a><li><a href="https://refactoring.guru/design-patterns/flyweight" target="_blank">Flyweight Pattern</a><li><a href="https://refactoring.guru/design-patterns/factory-method" target="_blank">Factory Pattern</a><li><a href="https://refactoring.guru/design-patterns/command" target="_blank">Command Pattern</a><li><a href="https://en.wikipedia.org/wiki/Finite-state_machine" target="_blank">Finite-State Machine</a> + <a href="https://refactoring.guru/design-patterns/state" target="_blank">State Pattern</a><li><a href="https://refactoring.guru/design-patterns/chain-of-responsibility" target="_blank">Chain Of Responsibility</a><li><a href="https://refactoring.guru/design-patterns/builder" target="_blank">Builder Pattern</a></ul><p>I will translate the content into English:</p><hr /><blockquote><p><em>This article focuses on the application of Design Patterns, not the operation of Socket.IO. Some examples may be simplified for descriptive purposes and <strong>may not be applicable to real Socket.IO encapsulation</strong>.</em></p></blockquote><blockquote><p><em>Due to space limitations, this article will not provide detailed introductions to the architecture of each design pattern. Please click on the links for each pattern to understand its architecture before continuing to read.</em></p></blockquote><blockquote><p><em>Demo Code will be written in Swift.</em></p></blockquote><h3 id="scenario-1"><span class="me-2">Scenario 1.</span><a href="#scenario-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what"><span class="me-2">What?</span><a href="#what" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Reuse the same Path to obtain the same object when requesting a Connection on different pages or Objects.<li>The Connection should be an abstract interface and should not directly depend on the Socket.IO Object.</ul><h4 id="why"><span class="me-2">Why?</span><a href="#why" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Reduce memory overhead and the time and cost of repeated connections.<li>Reserve space for future replacement with other frameworks.</ul><h4 id="how"><span class="me-2">How?</span><a href="#how" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://refactoring.guru/design-patterns/singleton" target="_blank">Singleton Pattern</a>: A creational pattern that ensures only one instance of an object.<li><a href="https://refactoring.guru/design-patterns/flyweight" target="_blank">Flyweight Pattern</a>: A structural pattern that shares the state of multiple objects and reuses them.<li><a href="https://refactoring.guru/design-patterns/factory-method" target="_blank">Factory Pattern</a>: A creational pattern that provides a method for creating abstract objects, allowing them to be swapped externally.</ul><p><strong>Real-world usage:</strong></p><p><a href="/assets/78507a8de6a5/1*flQa_EfErGBwbmEwpI7ZgQ.png" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*flQa_EfErGBwbmEwpI7ZgQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li><strong>Singleton Pattern:</strong> <code class="language-plaintext highlighter-rouge">ConnectionManager</code> exists as a single object in the App Lifecycle, used to manage <code class="language-plaintext highlighter-rouge">Connection</code> operations.<li><strong>Flyweight Pattern:</strong> <code class="language-plaintext highlighter-rouge">ConnectionPool</code> is a shared pool of Connections, where Connections are retrieved from this pool, and the logic includes providing an existing Connection when the URL Path matches. <code class="language-plaintext highlighter-rouge">ConnectionHandler</code> acts as an external operator and state manager for <code class="language-plaintext highlighter-rouge">Connection</code>.<li><strong>Factory Pattern:</strong> <code class="language-plaintext highlighter-rouge">ConnectionFactory</code> works with the Flyweight Pattern. When no reusable <code class="language-plaintext highlighter-rouge">Connection</code> is found in the pool, this factory interface is used to create one.</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Combine</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">protocol</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">ConnectionFactory</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Connection</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ConnectionPool</span> <span class="p">{</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">connectionFactory</span><span class="p">:</span> <span class="kt">ConnectionFactory</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">connections</span><span class="p">:</span> <span class="p">[</span><span class="kt">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">connectionFactory</span><span class="p">:</span> <span class="kt">ConnectionFactory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">connectionFactory</span> <span class="o">=</span> <span class="n">connectionFactory</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">getOrCreateConnection</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Connection</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="n">url</span> <span class="p">})</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">connection</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">connections</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">connection</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ConnectionHandler</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">connection</span><span class="p">:</span> <span class="kt">Connection</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">connection</span><span class="p">:</span> <span class="kt">Connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">getConnectionUUID</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">UUID</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">id</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ConnectionManager</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">shared</span> <span class="o">=</span> <span class="kt">ConnectionManager</span><span class="p">(</span><span class="nv">connectionPool</span><span class="p">:</span> <span class="kt">ConnectionPool</span><span class="p">(</span><span class="nv">connectionFactory</span><span class="p">:</span> <span class="kt">SIOConnectionFactory</span><span class="p">()))</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">connectionPool</span><span class="p">:</span> <span class="kt">ConnectionPool</span>
    <span class="kd">private</span> <span class="nf">init</span><span class="p">(</span><span class="nv">connectionPool</span><span class="p">:</span> <span class="kt">ConnectionPool</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">connectionPool</span> <span class="o">=</span> <span class="n">connectionPool</span>
    <span class="p">}</span>
    
    <span class="c1">//</span>
    <span class="kd">func</span> <span class="nf">requestConnectionHandler</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ConnectionHandler</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">connection</span> <span class="o">=</span> <span class="n">connectionPool</span><span class="o">.</span><span class="nf">getOrCreateConnection</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="kt">ConnectionHandler</span><span class="p">(</span><span class="nv">connection</span><span class="p">:</span> <span class="n">connection</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Socket.IO Implementation</span>
<span class="kd">class</span> <span class="kt">SIOConnection</span><span class="p">:</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">UUID</span><span class="p">()</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">//</span>
        <span class="k">return</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOConnectionFactory</span><span class="p">:</span> <span class="kt">ConnectionFactory</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Connection</span> <span class="p">{</span>
        <span class="c1">//</span>
        <span class="k">return</span> <span class="kt">SIOConnection</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//</span>

<span class="nf">print</span><span class="p">(</span><span class="kt">ConnectionManager</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">requestConnectionHandler</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com/1"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span><span class="o">.</span><span class="nf">getConnectionUUID</span><span class="p">()</span><span class="o">.</span><span class="n">uuidString</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="kt">ConnectionManager</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">requestConnectionHandler</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com/1"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span><span class="o">.</span><span class="nf">getConnectionUUID</span><span class="p">()</span><span class="o">.</span><span class="n">uuidString</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="kt">ConnectionManager</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">requestConnectionHandler</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com/2"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span><span class="o">.</span><span class="nf">getConnectionUUID</span><span class="p">()</span><span class="o">.</span><span class="n">uuidString</span><span class="p">)</span>

<span class="c1">// output:</span>
<span class="c1">// D99F5429-1C6D-4EB5-A56E-9373D6F37307</span>
<span class="c1">// D99F5429-1C6D-4EB5-A56E-9373D6F37307</span>
<span class="c1">// 599CF16F-3D7C-49CF-817B-5A57C119FE31</span>
</pre></table></code></div></div><h3 id="scenario-2"><span class="me-2">Scenario 2.</span><a href="#scenario-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what-1"><span class="me-2">What?</span><a href="#what-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>As mentioned in the background technical details, the <code class="language-plaintext highlighter-rouge">Send Event</code> of the Socket.IO Swift Client does not support offline sending (but the Web/Android versions of the library do), so iOS needs to implement this feature on its own.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Interestingly, the Socket.IO Swift Client - onEvent supports offline subscription.
</pre></table></code></div></div><h4 id="why-1"><span class="me-2">Why?</span><a href="#why-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Unified cross-platform functionality<li>Easy-to-understand code</ul><h4 id="how-1"><span class="me-2">How?</span><a href="#how-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://refactoring.guru/design-patterns/command" target="_blank">Command Pattern</a>: A behavioral pattern that encapsulates operations into objects, providing a collection of operations such as queuing, delaying, canceling, etc.</ul><p><a href="/assets/78507a8de6a5/1*O9zc28nMx64HDiDy4aiexA.png" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*O9zc28nMx64HDiDy4aiexA.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li><strong>Command Pattern:</strong> <code class="language-plaintext highlighter-rouge">SIOManager</code> is the lowest-level encapsulation for communicating with Socket.IO, where the <code class="language-plaintext highlighter-rouge">send</code> and <code class="language-plaintext highlighter-rouge">request</code> methods are operations for Socket.IO Send Event. When the current Socket.IO is found to be disconnected, the request parameters are placed in <code class="language-plaintext highlighter-rouge">bufferedCommands</code>, and when connected, they are processed one by one (First In First Out).</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">BufferedCommand</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">SendBufferedCommand</span><span class="p">:</span> <span class="kt">BufferedCommand</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">sioManager</span><span class="p">?</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">RequestBufferedCommand</span><span class="p">:</span> <span class="kt">BufferedCommand</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">callback</span><span class="p">:</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">sioManager</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">SIOManagerSpec</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="kt">ConnectionState</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">created</span>
    <span class="k">case</span> <span class="n">connected</span>
    <span class="k">case</span> <span class="n">disconnected</span>
    <span class="k">case</span> <span class="n">reconnecting</span>
    <span class="k">case</span> <span class="n">released</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span> <span class="p">{</span>
        
    <span class="k">var</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">disconnected</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="p">{</span>
                <span class="nf">executeBufferedCommands</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">bufferedCommands</span><span class="p">:</span> <span class="p">[</span><span class="kt">BufferedCommand</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">connected</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">disconnected</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">appendBufferedCommands</span><span class="p">(</span><span class="nv">connectionCommand</span><span class="p">:</span> <span class="kt">SendBufferedCommand</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="k">self</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"Send:</span><span class="se">\(</span><span class="n">event</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">appendBufferedCommands</span><span class="p">(</span><span class="nv">connectionCommand</span><span class="p">:</span> <span class="kt">RequestBufferedCommand</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">,</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="k">self</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"request:</span><span class="se">\(</span><span class="n">event</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">appendBufferedCommands</span><span class="p">(</span><span class="nv">connectionCommand</span><span class="p">:</span> <span class="kt">BufferedCommand</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">connectionCommand</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">executeBufferedCommands</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// First in, first out</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">connectionCommand</span> <span class="k">in</span>
            <span class="n">connectionCommand</span><span class="o">.</span><span class="nf">execute</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">removeAllBufferedCommands</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">manager</span> <span class="o">=</span> <span class="kt">SIOManager</span><span class="p">()</span>
<span class="n">manager</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="s">"send_event_1"</span><span class="p">)</span>
<span class="n">manager</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="s">"send_event_2"</span><span class="p">)</span>
<span class="n">manager</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="s">"request_event_1"</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
    <span class="c1">//</span>
<span class="p">}</span>
<span class="n">manager</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">connected</span>
</pre></table></code></div></div><p>Similarly, this can also be implemented on <code class="language-plaintext highlighter-rouge">onEvent</code>.</p><p>Extension: You can further apply the <a href="https://refactoring.guru/design-patterns/proxy" target="_blank">Proxy Pattern</a> to treat Buffer functionality as a type of Proxy.</p><h3 id="scenario-3"><span class="me-2">Scenario 3.</span><a href="#scenario-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what-2"><span class="me-2">What?</span><a href="#what-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The Connection has multiple states, with ordered states and transitions between states, allowing different operations in each state.</p><p><a href="/assets/78507a8de6a5/1*DBl6K1cPQc_cHOYXZ1VQ8A.jpeg" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*DBl6K1cPQc_cHOYXZ1VQ8A.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/78507a8de6a5/1*-Xk_TT6SMW5Jxd-c8iSCcw.jpeg" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*-Xk_TT6SMW5Jxd-c8iSCcw.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li>Created: Object is created, allowing transition to <code class="language-plaintext highlighter-rouge">Connected</code> or directly to <code class="language-plaintext highlighter-rouge">Disconnected</code><li>Connected: Connected to Socket.IO, allowing transition to <code class="language-plaintext highlighter-rouge">Disconnected</code><li>Disconnected: Disconnected from Socket.IO, allowing transition to <code class="language-plaintext highlighter-rouge">Reconnectiong</code> or <code class="language-plaintext highlighter-rouge">Released</code><li>Reconnectiong: Attempting to reconnect to Socket.IO, allowing transition to <code class="language-plaintext highlighter-rouge">Connected</code> or <code class="language-plaintext highlighter-rouge">Disconnected</code><li>Released: Object marked for pending memory release, no operations or state transitions allowed</ul><h4 id="why-2"><span class="me-2">Why?</span><a href="#why-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>The logic and representation of state transitions are not straightforward<li>Restricting operations in each state (e.g., State = Released cannot Call Send Event) using if…else directly makes the code hard to maintain and read</ul><h4 id="how-2"><span class="me-2">How?</span><a href="#how-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://en.wikipedia.org/wiki/Finite-state_machine" target="_blank">Finite State Machine</a>: Manages transitions between states<li><a href="https://refactoring.guru/design-patterns/state" target="_blank">State Pattern</a>: Behavioral Pattern, provides different responses when the object’s state changes</ul><p><a href="/assets/78507a8de6a5/1*NgehABZTiXL_fFEYQh63Hg.png" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*NgehABZTiXL_fFEYQh63Hg.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li><strong>Finite State Machine</strong>: <code class="language-plaintext highlighter-rouge">SIOConnectionStateMachine</code> implements the state machine, <code class="language-plaintext highlighter-rouge">currentSIOConnectionState</code> represents the current state, and <code class="language-plaintext highlighter-rouge">created, connected, disconnected, reconnecting, released</code> list the possible state transitions of this state machine. <code class="language-plaintext highlighter-rouge">enterXXXState() throws</code> implements the allowed and disallowed (throw error) actions when transitioning from the Current State to a specific state.<li><strong>State Pattern</strong>: <code class="language-plaintext highlighter-rouge">SIOConnectionState</code> is the interface abstraction for all operations that states may use.</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="c1">// Code block translated comments only, code remains in English</span>
</pre></table></code></div></div><p>Combining scenarios 1 and 2, with the <code class="language-plaintext highlighter-rouge">ConnectionPool</code> flyweight pool and State Pattern state management; we continue to extend as described in the background goals, the Feature side does not need to worry about the connection mechanism behind the Connection; therefore, we have created a poller (named <code class="language-plaintext highlighter-rouge">ConnectionKeeper</code>) that will periodically scan the <code class="language-plaintext highlighter-rouge">ConnectionPool</code> for actively held <code class="language-plaintext highlighter-rouge">Connection</code> and perform operations when the following conditions occur:</p><ul><li>If a <code class="language-plaintext highlighter-rouge">Connection</code> is in use and the state is not <code class="language-plaintext highlighter-rouge">Connected</code>: change the state to <code class="language-plaintext highlighter-rouge">Reconnecting</code> and attempt to reconnect.<li>If a <code class="language-plaintext highlighter-rouge">Connection</code> is not in use and the state is <code class="language-plaintext highlighter-rouge">Connected</code>: change the state to <code class="language-plaintext highlighter-rouge">Disconnected</code>.<li>If a <code class="language-plaintext highlighter-rouge">Connection</code> is not in use and the state is <code class="language-plaintext highlighter-rouge">Disconnected</code>: change the state to <code class="language-plaintext highlighter-rouge">Released</code> and remove it from the <code class="language-plaintext highlighter-rouge">ConnectionPool</code>.</ul><h4 id="why-3"><span class="me-2">Why?</span><a href="#why-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>The three operations have a logical order and are mutually exclusive (disconnected -&gt; released or reconnecting).<li>Flexibility to swap and add operational scenarios.<li>Without encapsulation, one would have to directly write the three checks and operations in a method (difficult to test the logic within).<li>e.g.:</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span><span class="n">connection</span><span class="o">.</span><span class="nf">isOccupied</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">connection</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="n">then</span>
<span class="o">...</span> <span class="n">connection</span><span class="o">.</span><span class="nf">disconnected</span><span class="p">()</span>
<span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="n">connection</span><span class="o">.</span><span class="nf">isOccupied</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">released</span> <span class="n">then</span>
<span class="o">...</span> <span class="n">connection</span><span class="o">.</span><span class="nf">release</span><span class="p">()</span>
<span class="k">else</span> <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="nf">isOccupied</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">disconnected</span> <span class="n">then</span>
<span class="o">...</span> <span class="n">connection</span><span class="o">.</span><span class="nf">reconnecting</span><span class="p">()</span>
<span class="n">end</span>
</pre></table></code></div></div><h4 id="how-3"><span class="me-2">How?</span><a href="#how-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://refactoring.guru/design-patterns/chain-of-responsibility" target="_blank">Chain Of Responsibility</a>: A behavioral pattern, as the name suggests, is a chain where each node has corresponding operations. After inputting data, a node can decide whether to operate or pass it to the next node for processing. Another real-world application is the <a href="https://swiftrocks.com/understanding-the-ios-responder-chain" target="_blank">iOS Responder Chain</a>.</ul><blockquote><p><em>By definition, the Chain of Responsibility Pattern does not allow a node to take over processing data and then pass it to the next node to continue processing. <strong>Either do it completely or don’t do it at all</strong>.</em></p></blockquote><blockquote><p><em>If the above scenario is more suitable, it should be the <a href="https://stackoverflow.com/questions/7951306/chain-of-responsibility-vs-interceptor" target="_blank">Interceptor Pattern</a>.</em></p></blockquote><p><a href="/assets/78507a8de6a5/1*e8jHpykN1m3Y66Ukf-5OJA.png" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*e8jHpykN1m3Y66Ukf-5OJA.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li><strong>Chain of responsibility:</strong> <code class="language-plaintext highlighter-rouge">ConnectionKeeperHandler</code> is an abstract node of the chain, specifically extracting the <code class="language-plaintext highlighter-rouge">canExecute</code> method to avoid the situation where this node takes over processing but then wants to call the next node to continue execution, <code class="language-plaintext highlighter-rouge">handle</code> connects the nodes in the chain, and <code class="language-plaintext highlighter-rouge">execute</code> is the logic of how to handle the processing. <code class="language-plaintext highlighter-rouge">ConnectionKeeperHandlerContext</code> is used to store data that will be used, <code class="language-plaintext highlighter-rouge">isOccupied</code> indicates whether the Connection is in use.</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
</pre><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">ConnectionState</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">created</span>
    <span class="k">case</span> <span class="n">connected</span>
    <span class="k">case</span> <span class="n">disconnected</span>
    <span class="k">case</span> <span class="n">reconnecting</span>
    <span class="k">case</span> <span class="n">released</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    <span class="k">var</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">reconnect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="c1">// Socket.IO Implementation</span>
<span class="kd">class</span> <span class="kt">SIOConnection</span><span class="p">:</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">created</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">UUID</span><span class="p">()</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">reconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">//</span>
        <span class="k">return</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>

<span class="kd">struct</span> <span class="kt">ConnectionKeeperHandlerContext</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">connection</span><span class="p">:</span> <span class="kt">Connection</span>
    <span class="k">let</span> <span class="nv">isOccupied</span><span class="p">:</span> <span class="kt">Bool</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">ConnectionKeeperHandler</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">canExecute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ConnectionKeeperHandler</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">canExecute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">execute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">nextHandler</span><span class="p">?</span><span class="o">.</span><span class="nf">handle</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">DisconnectedConnectionKeeperHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">canExecute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connectionState</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">context</span><span class="o">.</span><span class="n">isOccupied</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ReconnectConnectionKeeperHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="nf">reconnect</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">canExecute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connectionState</span> <span class="o">==</span> <span class="o">.</span><span class="n">disconnected</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="o">.</span><span class="n">isOccupied</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ReleasedConnectionKeeperHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">canExecute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connectionState</span> <span class="o">==</span> <span class="o">.</span><span class="n">disconnected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">context</span><span class="o">.</span><span class="n">isOccupied</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">let</span> <span class="nv">connection</span> <span class="o">=</span> <span class="kt">SIOConnection</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">disconnectedHandler</span> <span class="o">=</span> <span class="kt">DisconnectedConnectionKeeperHandler</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">reconnectHandler</span> <span class="o">=</span> <span class="kt">ReconnectConnectionKeeperHandler</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">releasedHandler</span> <span class="o">=</span> <span class="kt">ReleasedConnectionKeeperHandler</span><span class="p">()</span>
<span class="n">disconnectedHandler</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">reconnectHandler</span>
<span class="n">reconnectHandler</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">releasedHandler</span>

<span class="n">disconnectedHandler</span><span class="o">.</span><span class="nf">handle</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">(</span><span class="nv">connection</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="nv">isOccupied</span><span class="p">:</span> <span class="kc">false</span><span class="p">))</span>
</pre></table></code></div></div><h3 id="requirement-scenario-4"><span class="me-2">Requirement Scenario 4.</span><a href="#requirement-scenario-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what-3"><span class="me-2">What?</span><a href="#what-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We need to go through the setup of the <code class="language-plaintext highlighter-rouge">Connection</code> we encapsulated before using it, such as providing the URL Path, setting Config, etc.</p><h4 id="why-4"><span class="me-2">Why?</span><a href="#why-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Flexibility to add or remove building interfaces<li>Reusability of building logic<li>Without encapsulation, external entities can operate on classes unexpectedly<li>e.g.:</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>❌
let connection = Connection()
connection.send(event) // unexpected method call, should call .connect() first
✅
let connection = Connection()
connection.connect()
connection.send(event)
// but...who knows???
</pre></table></code></div></div><h4 id="how-4"><span class="me-2">How?</span><a href="#how-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://refactoring.guru/design-patterns/builder" target="_blank">Builder Pattern</a>: A creational pattern that allows step-by-step construction of objects and reuses construction methods.</ul><p><a href="/assets/78507a8de6a5/1*J5eKaks1-fT6u8FojeUkUQ.png" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*J5eKaks1-fT6u8FojeUkUQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li><strong>Builder Pattern:</strong> <code class="language-plaintext highlighter-rouge">SIOConnectionBuilder</code> is the builder for <code class="language-plaintext highlighter-rouge">Connection</code>, responsible for setting and storing data needed to build <code class="language-plaintext highlighter-rouge">Connection</code>; <code class="language-plaintext highlighter-rouge">ConnectionConfiguration</code> abstract interface ensures that <code class="language-plaintext highlighter-rouge">.connect()</code> must be called before using <code class="language-plaintext highlighter-rouge">Connection</code> to get the <code class="language-plaintext highlighter-rouge">Connection</code> instance.</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
</pre><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">ConnectionState</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">created</span>
    <span class="k">case</span> <span class="n">connected</span>
    <span class="k">case</span> <span class="n">disconnected</span>
    <span class="k">case</span> <span class="n">reconnecting</span>
    <span class="k">case</span> <span class="n">released</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    <span class="k">var</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">reconnect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="c1">// Socket.IO Implementation</span>
<span class="kd">class</span> <span class="kt">SIOConnection</span><span class="p">:</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">created</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">UUID</span><span class="p">()</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">reconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">//</span>
        <span class="k">return</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>
<span class="kd">class</span> <span class="kt">SIOConnectionClient</span><span class="p">:</span> <span class="kt">ConnectionConfiguration</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">config</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">config</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="k">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Connection</span> <span class="p">{</span>
        <span class="c1">// set config</span>
        <span class="k">return</span> <span class="kt">SIOConnection</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">ConnectionConfiguration</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Connection</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOConnectionBuilder</span> <span class="p">{</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">config</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
    
    <span class="kd">func</span> <span class="nf">setConfig</span><span class="p">(</span><span class="n">_</span> <span class="nv">config</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kt">SIOConnectionBuilder</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="c1">// url is required parameter</span>
    <span class="kd">func</span> <span class="nf">build</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ConnectionConfiguration</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">SIOConnectionClient</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">config</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">builder</span> <span class="o">=</span> <span class="kt">SIOConnectionBuilder</span><span class="p">()</span><span class="o">.</span><span class="nf">setConfig</span><span class="p">([</span><span class="s">"test"</span><span class="p">:</span><span class="mi">123</span><span class="p">])</span>


<span class="k">let</span> <span class="nv">connection1</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">build</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com/1"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span><span class="o">.</span><span class="nf">connect</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">connection2</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">build</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com/1"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span><span class="o">.</span><span class="nf">connect</span><span class="p">()</span>
</pre></table></code></div></div><p>Extension: Here you can also apply the <a href="https://refactoring.guru/design-patterns/factory-method" target="_blank">Factory Pattern</a>, to produce <code class="language-plaintext highlighter-rouge">SIOConnection</code> using a factory.</p><h3 id="end"><span class="me-2">End!</span><a href="#end" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The above are the four scenarios encountered in encapsulating Socket.IO and the seven Design Patterns used to solve the problems.</p><h4 id="finally-here-is-the-complete-design-blueprint-for-encapsulating-socketio"><span class="me-2">Finally, here is the complete design blueprint for encapsulating Socket.IO</span><a href="#finally-here-is-the-complete-design-blueprint-for-encapsulating-socketio" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/78507a8de6a5/1*DMfFpmF7aVCIIM1dskn97w.jpeg" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*DMfFpmF7aVCIIM1dskn97w.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>Contrary to the naming and demonstration in the text, this image represents the actual design architecture; there may be an opportunity for the original designer to share design concepts and open source the project.</p><h3 id="who"><span class="me-2">Who?</span><a href="#who" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Who designed these and is responsible for the Socket.IO encapsulation project?</p><h4 id="sean-zheng-android-engineer--pinkoi"><span class="me-2"><a href="https://www.linkedin.com/in/%E5%AE%87%E7%BF%94-%E9%84%AD-9b3409175/" target="_blank">Sean Zheng</a>, Android Engineer @ Pinkoi</span><a href="#sean-zheng-android-engineer--pinkoi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/78507a8de6a5/1*Q_35023LtcZbOtnfvSxv-A.jpeg" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*Q_35023LtcZbOtnfvSxv-A.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>Main architect, evaluation and application of Design Patterns, implementation of design in Kotlin on the Android side.</p><h4 id="zhgchgli-enginner-leadios-enginner--pinkoi"><span class="me-2"><a href="https://www.linkedin.com/in/zhgchgli/" target="_blank">ZhgChgLi</a>, Enginner Lead/iOS Enginner @ Pinkoi</span><a href="#zhgchgli-enginner-leadios-enginner--pinkoi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/78507a8de6a5/1*1NCE3Q7fO5Mh15NT2xoYlA.png" class="popup img-link "><img data-src="/assets/78507a8de6a5/1*1NCE3Q7fO5Mh15NT2xoYlA.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Project lead of the Platform Team, Pair programming, implementation of design in Swift on the iOS side, discussion and raising questions (a.k.a. speaking up), and finally writing this article to share with everyone.</p><h3 id="further-reading"><span class="me-2">Further Reading</span><a href="#further-reading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Practical application records of Design Patterns — In WKWebView with Builder, Strategy &amp; Chain of Responsibility Pattern<li><a href="../ba5773a7bfea/">Visitor Pattern in Swift (Share Object to XXX Example)</a><li><a href="../60473cb47550/">Visitor Pattern in TableView</a></ul><p>If you have any questions or suggestions, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>===</p><p><a href="https://zhgchg.li/posts/78507a8de6a5/" target="_blank">本文中文版本</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ➡️ <a href="https://medium.com/p/78507a8de6a5" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=🍺&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/pinkoi/'>Pinkoi</a>, <a href='/categories/engineering/'>Engineering</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/design-patterns/" class="post-tag no-text-decoration" >design-patterns</a> <a href="/tags/socketio/" class="post-tag no-text-decoration" >socketio</a> <a href="/tags/websocket/" class="post-tag no-text-decoration" >websocket</a> <a href="/tags/finite-state-machine/" class="post-tag no-text-decoration" >finite-state-machine</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Record%20of%20Practical%20Application%20of%20Design%20Patterns%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F78507a8de6a5%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Record%20of%20Practical%20Application%20of%20Design%20Patterns%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F78507a8de6a5%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F78507a8de6a5%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/ba5773a7bfea/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1623772716" data-df="ll" > Jun 15, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>Visitor Pattern in iOS (Swift)</h4><div class="text-muted small"><p> Visitor Pattern in Swift (Share Object to XXX Example) Analysis of the practical application scenarios of the Visitor Pattern (sharing items like products, songs, articles… to Facebook, Line, Link...</p></div></div></a></div><div class="col"> <a href="/posts/60473cb47550/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1657267110" data-df="ll" > Jul 8, 2022 </em><h4 class="pt-0 my-2" data-toc-skip>Visitor Pattern in TableView</h4><div class="text-muted small"><p> Visitor Pattern in TableView Enhancing the readability and extensibility of TableView using the Visitor Pattern Photo by Alex wong Introduction Following the previous article on “Visitor Patt...</p></div></div></a></div><div class="col"> <a href="/posts/f4b02ee342a4/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1725601667" data-df="ll" > Sep 6, 2024 </em><h4 class="pt-0 my-2" data-toc-skip>Practical Application Record of Design Patterns—In WKWebView with Builder, Strategy & Chain of Responsibility Pattern</h4><div class="text-muted small"><p> Practical Application Record of Design Patterns—In WKWebView with Builder, Strategy &amp;amp; Chain of Responsibility Pattern Scenarios of using Design Patterns (Strategy, Chain of Responsibility, Bui...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/793cb8f89b72/" class="btn btn-outline-primary" prompt="Older" ><p>Crashlytics + Google Analytics Automatically Query App Crash-Free Users Rate</p></a> <a href="/posts/ddd88a84e177/" class="btn btn-outline-primary" prompt="Newer" ><p>Converting Medium Posts to Markdown</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">中文版網站</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
