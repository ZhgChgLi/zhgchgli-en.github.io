<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="The Craft of Building a Handmade HTML Parser" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="The development log of ZMarkupParser HTML to NSAttributedString rendering engine" /><meta property="og:description" content="The development log of ZMarkupParser HTML to NSAttributedString rendering engine" /><link rel="canonical" href="https://en.zhgchg.li/posts/2724f02f6e7/" /><meta property="og:url" content="https://en.zhgchg.li/posts/2724f02f6e7/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-12T01:09:22+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg" /><meta property="twitter:title" content="The Craft of Building a Handmade HTML Parser" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2023-08-06T00:15:39+08:00","datePublished":"2023-03-12T01:09:22+08:00","description":"The development log of ZMarkupParser HTML to NSAttributedString rendering engine","headline":"The Craft of Building a Handmade HTML Parser","image":"https://en.zhgchg.li/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/2724f02f6e7/"},"url":"https://en.zhgchg.li/posts/2724f02f6e7/"}</script><title>The Craft of Building a Handmade HTML Parser | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>The Craft of Building a Handmade HTML Parser</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>The Craft of Building a Handmade HTML Parser</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1678554562" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 12, 2023 </em> </span> <span> Updated <em class="" data-ts="1691252139" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 5, 2023 </em> </span><div class="mt-3 mb-3"> <a href="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="9666 words" > <em>53 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="the-craft-of-building-a-handmade-html-parser"><span class="me-2">The Craft of Building a Handmade HTML Parser</span><a href="#the-craft-of-building-a-handmade-html-parser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The development log of ZMarkupParser HTML to NSAttributedString rendering engine</p><p>Tokenization conversion of HTML String, Normalization processing, generation of Abstract Syntax Tree, application of Visitor Pattern / Builder Pattern, and some miscellaneous discussions…</p><h4 id="continuation"><span class="me-2">Continuation</span><a href="#continuation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Last year, I published an article titled “[ <strong>TL;DR</strong> ] <a href="../a8c2d26cc734/">Implementing iOS NSAttributedString HTML Render</a>”, which briefly introduced how to use XMLParser to parse HTML and then convert it into NSAttributedString.Key. The structure and thought process in the article were quite disorganized, as it was a quick record of the issues encountered previously and I did not spend much time researching the topic.</p><h3 id="convert-html-string-to-nsattributedstring"><span class="me-2">Convert HTML String to NSAttributedString</span><a href="#convert-html-string-to-nsattributedstring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Revisiting this topic, we need to be able to convert the HTML string provided by the API into NSAttributedString and apply the corresponding styles to display it in UITextView/UILabel.</p><p>e.g. <code class="language-plaintext highlighter-rouge">&lt;b&gt;Test&lt;a&gt;Link&lt;/a&gt;&lt;/b&gt;</code> should be displayed as <strong>Test <a href="https://blog.zhgchg.li" target="_blank">Link</a></strong></p><ul><li>Note 1 It is not recommended to use HTML as a communication and rendering medium between the App and data, as the HTML specification is too flexible. The App cannot support all HTML styles, and there is no official HTML conversion rendering engine.<li>Note 2 Starting from iOS 14, you can use the native AttributedString to parse Markdown or introduce the apple/swift-markdown Swift Package to parse Markdown.<li>Note 3 Due to the large scale of our company’s project and the long-term use of HTML as a medium, it is temporarily impossible to fully switch to Markdown or other Markup.<li><strong>Note 4</strong> <strong>The HTML here is not intended to display the entire HTML webpage, but to use HTML as a style Markdown rendering string style.</strong> <strong>(To render a full page, complex HTML including images and tables, you still need to use WebView loadHTML)</strong></ul><blockquote><p>It is strongly recommended to use Markdown as the string rendering medium language. If your project has the same dilemma as mine and you have no elegant tool to convert HTML to NSAttributedString, please use it.</p></blockquote><blockquote><p>Friends who remember the previous article can directly jump to the ZhgChgLi / ZMarkupParser section.</p></blockquote><h4 id="nsattributedstringdocumenttypehtml"><span class="me-2">NSAttributedString.DocumentType.html</span><a href="#nsattributedstringdocumenttypehtml" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The methods for HTML to NSAttributedString found online all suggest directly using NSAttributedString’s built-in options to render HTML, as shown in the example below:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">htmlString</span> <span class="o">=</span> <span class="s">"&lt;b&gt;Test&lt;a&gt;Link&lt;/a&gt;&lt;/b&gt;"</span>
<span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">htmlString</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">attributedOptions</span><span class="p">:[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">DocumentReadingOptionKey</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="o">.</span><span class="nv">documentType</span> <span class="p">:</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">DocumentType</span><span class="o">.</span><span class="n">html</span><span class="p">,</span>
  <span class="o">.</span><span class="nv">characterEncoding</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="o">.</span><span class="n">rawValue</span>
<span class="p">]</span>
<span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">attributedOptions</span><span class="p">,</span> <span class="nv">documentAttributes</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</pre></table></code></div></div><p><strong>The problem with this approach:</strong></p><ul><li>Poor performance: This method uses WebView Core to render the style, then switches back to the Main Thread for UI display; rendering more than 300 characters takes 0.03 seconds.<li>Text loss: For example, marketing copy might use <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code> which will be treated as an HTML tag and removed.<li>Lack of customization: For example, you cannot specify the boldness level of HTML bold tags in NSAttributedString.<li><a href="https://developer.apple.com/forums/thread/115405" target="_blank">Intermittent crashes starting from iOS ≥ 12 with no official solution</a><li>Frequent crashes in iOS 15, testing found that it crashes 100% under low battery conditions (fixed in iOS ≥ 15.2)<li>Long strings cause crashes, testing shows that inputting strings longer than 54,600+ characters will crash 100% (EXC_BAD_ACCESS)</ul><p>The most painful issue for us is the crash problem. From the release of iOS 15 to the fix in 15.2, our app was plagued by this issue. From the data, between 2022/03/11 and 2022/06/08, it caused over 2.4K crashes, affecting over 1.4K users.</p><p>This crash issue has existed since iOS 12, and iOS 15 just made it worse. I guess the fix in iOS 15.2 is just a patch, and the official solution cannot completely eradicate it.</p><p>The second issue is performance. As a string style Markup Language, it is heavily used in the app’s UILabel/UITextView. As mentioned earlier, one label takes 0.03 seconds, and multiplying this by the number of UILabel/UITextView in a list will cause noticeable lag in user interactions.</p><h4 id="xmlparser"><span class="me-2">XMLParser</span><a href="#xmlparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The second solution is introduced in <a href="../a8c2d26cc734/">the previous article</a>, which uses XMLParser to parse into corresponding NSAttributedString keys and apply styles.</p><p>Refer to the implementation of <a href="https://github.com/malcommac/SwiftRichString" target="_blank">SwiftRichString</a> and <a href="../a8c2d26cc734/">the content of the previous article</a>.</p><blockquote><p>The previous article only explored using XMLParser to parse HTML and perform corresponding conversions, completing an experimental implementation, but it did not design it as a well-structured and extensible “tool.”</p></blockquote><p><strong>The problem with this approach:</strong></p><ul><li>Zero tolerance for errors: <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;b&gt;Bold&lt;i&gt;Bold+Italic&lt;/b&gt;Italic&lt;/i&gt;</code> These three possible HTML scenarios will cause XMLParser to throw an error and display blank.<li>Using XMLParser, the HTML string must fully comply with XML rules, unlike browsers or NSAttributedString.DocumentType.html which can tolerate and display correctly.</ul><h4 id="standing-on-the-shoulders-of-giants"><span class="me-2">Standing on the shoulders of giants</span><a href="#standing-on-the-shoulders-of-giants" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Neither of the above two solutions can perfectly and elegantly solve the HTML problem, so I started searching for existing solutions.</p><ul><li><a href="https://github.com/johnxnguyen" target="_blank">johnxnguyen</a> / <a href="https://github.com/johnxnguyen/Down" target="_blank">Down</a> Only supports converting Markdown to Any (XML/NSAttributedString…), but does not support converting HTML.<li><a href="https://github.com/malcommac" target="_blank">malcommac</a> / <a href="https://github.com/malcommac/SwiftRichString" target="_blank">SwiftRichString</a> Uses XMLParser at its core, and testing shows it has the same zero tolerance for errors as mentioned earlier.<li><a href="https://github.com/scinfu" target="_blank">scinfu</a> / <a href="https://github.com/scinfu/SwiftSoup" target="_blank">SwiftSoup</a> Only supports HTML Parser (Selector) <a href="https://github.com/scinfu/SwiftSoup/issues/127" target="_blank">does not support converting to NSAttributedString</a>.</ul><blockquote><p>After searching extensively, I found that the results are similar to the projects mentioned above. There are no giants’ shoulders to stand on.</p></blockquote><h3 id="zhgchglizmarkupparser"><span class="me-2">ZhgChgLi/ZMarkupParser</span><a href="#zhgchglizmarkupparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank" class="img-link shimmer" ><img data-src="https://repository-images.githubusercontent.com/602927147/57ce75c1-8548-449c-b44a-f4b0451ed5ea" alt="" class="lazyload" data-proofer-ignore></a></p><p>Without the shoulders of giants, I had to become a giant myself, so I developed an HTML String to NSAttributedString tool.</p><p>Developed purely in Swift, it parses HTML Tags using Regex and performs Tokenization, analyzing and correcting Tag accuracy (fixing tags without an end &amp; misplaced tags), then converts it into an abstract syntax tree. Finally, using the Visitor Pattern, it maps HTML Tags to abstract styles to get the final NSAttributedString result; it does not rely on any Parser Lib.</p><h4 id="features"><span class="me-2">Features</span><a href="#features" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Supports HTML Render (to NSAttributedString) / Stripper (removing HTML Tags) / Selector functions<li>Higher performance than <code class="language-plaintext highlighter-rouge">NSAttributedString.DocumentType.html</code><li>Automatically analyzes and corrects Tag accuracy (fixing tags without an end &amp; misplaced tags)<li>Supports dynamic style settings from <code class="language-plaintext highlighter-rouge">style="color:red..."</code><li>Supports custom style specifications, such as how <strong>bold</strong> bold should be<li>Supports flexible extensibility for tags or custom tags and attributes</ul><blockquote><p>For detailed introduction, installation, and usage, refer to this article: <a href="../a5643de271e4/"><strong>ZMarkupParser HTML String to NSAttributedString Tool</strong></a></p></blockquote><p>You can directly <a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">git clone the project</a>, then open the <code class="language-plaintext highlighter-rouge">ZMarkupParser.xcworkspace</code> Project, select the <code class="language-plaintext highlighter-rouge">ZMarkupParser-Demo</code> Target, and directly Build &amp; Run to try it out.</p><p><a href="/assets/2724f02f6e7/1*PzYcnSkW7qKeJBkaiNTKjQ.gif" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*PzYcnSkW7qKeJBkaiNTKjQ.gif" alt="[ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser</a></p><h3 id="technical-details"><span class="me-2">Technical Details</span><a href="#technical-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now, let’s dive into the technical details of developing this tool.</p><p><a href="/assets/2724f02f6e7/1*YF5L7gefMCMwU1wmnGgy6A.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*YF5L7gefMCMwU1wmnGgy6A.png" alt="Overview of the operation process" class="lazyload" data-proofer-ignore></a></p><p>Overview of the operation process</p><p>The above image shows the general operation process, and the following article will introduce it step by step with code examples.</p><blockquote><p>⚠️ This article will simplify Demo Code as much as possible, reduce abstraction and performance considerations, and focus on explaining the operation principles; for the final result, please refer to the project <a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">Source Code</a>.</p></blockquote><h3 id="code-implementation--tokenization"><span class="me-2">Code Implementation — Tokenization</span><a href="#code-implementation--tokenization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>a.k.a parser, parsing</p></blockquote><p>When it comes to HTML rendering, the most important part is parsing. In the past, HTML was parsed as XML using XMLParser; however, it couldn’t handle the fact that HTML usage is not 100% XML, causing parser errors and inability to dynamically correct them.</p><p>After ruling out the use of XMLParser, the only option left in Swift was to use Regex for matching and parsing.</p><p>Initially, the idea was to use Regex to extract “paired” HTML Tags and recursively find HTML Tags layer by layer until the end; however, this couldn’t solve the problem of nested HTML Tags or support for misplaced tags. Therefore, we changed the strategy to extract “single” HTML Tags, recording whether they are Start Tags, Close Tags, or Self-Closing Tags, and combining other strings into a parsed result array.</p><p><strong>Tokenization structure is as follows:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">HTMLParsedResult</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nf">start</span><span class="p">(</span><span class="kt">StartItem</span><span class="p">)</span> <span class="c1">// &lt;a&gt;</span>
    <span class="k">case</span> <span class="nf">close</span><span class="p">(</span><span class="kt">CloseItem</span><span class="p">)</span> <span class="c1">// &lt;/a&gt;</span>
    <span class="k">case</span> <span class="nf">selfClosing</span><span class="p">(</span><span class="kt">SelfClosingItem</span><span class="p">)</span> <span class="c1">// &lt;br/&gt;</span>
    <span class="k">case</span> <span class="nf">rawString</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">HTMLParsedResult</span> <span class="p">{</span>
    <span class="kd">class</span> <span class="kt">SelfClosingItem</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span>
        <span class="k">let</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
        <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>
        
        <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">String</span><span class="p">]?)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagAttributedString</span> <span class="o">=</span> <span class="n">tagAttributedString</span>
            <span class="k">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">class</span> <span class="kt">StartItem</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span>
        <span class="k">let</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
        <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>

        <span class="c1">// Start Tag may be an abnormal HTML Tag or normal text e.g. &lt;Congratulation!&gt;, if found to be an isolated Start Tag after subsequent Normalization, it will be marked as True.</span>
        <span class="k">var</span> <span class="nv">isIsolated</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
        
        <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">String</span><span class="p">]?)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagAttributedString</span> <span class="o">=</span> <span class="n">tagAttributedString</span>
            <span class="k">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span>
        <span class="p">}</span>
        
        <span class="c1">// Used for automatic padding correction in subsequent Normalization</span>
        <span class="kd">func</span> <span class="nf">convertToCloseParsedItem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">CloseItem</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">CloseItem</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1">// Used for automatic padding correction in subsequent Normalization</span>
        <span class="kd">func</span> <span class="nf">convertToSelfClosingParsedItem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">SelfClosingItem</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">SelfClosingItem</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">tagName</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">class</span> <span class="kt">CloseItem</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span>
        <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>The regex used is as follows:</strong></p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="p">(</span><span class="sc">?:</span><span class="p">(?</span><span class="o">&lt;</span><span class="n">closeTag</span><span class="o">&gt;</span><span class="p">\</span><span class="sr">/)?(?&lt;tagName&gt;[A-Za-z0-9]+)(?&lt;tagAttributes&gt;(?:\s*(\w+)\s*=\s*(["|']).*?\5)*)\s*(?&lt;selfClosingTag&gt;\/)?&gt;)
</span></pre></table></code></div></div><p>-&gt; <a href="https://regex101.com/r/aBrID8/1" target="_blank">Online Regex101 Playground</a></p><ul><li>closeTag: Matches &lt; <code class="language-plaintext highlighter-rouge">/</code> a&gt;<li>tagName: Matches &lt; <code class="language-plaintext highlighter-rouge">a</code> &gt; or , &lt;/ <code class="language-plaintext highlighter-rouge">a</code> &gt;<li>tagAttributes: Matches &lt;a <code class="language-plaintext highlighter-rouge">href=”https://zhgchg.li” style=”color:red”</code> &gt;<li>selfClosingTag: Matches &lt;br <code class="language-plaintext highlighter-rouge">/</code> &gt;</ul><blockquote><p>*This regex can still be optimized, will do it later.</p></blockquote><blockquote><p>Additional information about regex is provided in the latter part of the article, interested friends can refer to it.</p></blockquote><p><strong>Combining it all together:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">tokenizationResult</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">let</span> <span class="nv">expression</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">expressionOptions</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"&lt;a&gt;Li&lt;b&gt;nk&lt;/a&gt;Bold&lt;/b&gt;"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">totalLength</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span> <span class="c1">// utf-16 support emoji</span>
<span class="k">var</span> <span class="nv">lastMatch</span><span class="p">:</span> <span class="kt">NSTextCheckingResult</span><span class="p">?</span>

<span class="c1">// Start Tags Stack, First In Last Out (FILO)</span>
<span class="c1">// Check if the HTML string needs subsequent normalization to correct misalignment or add self-closing tags</span>
<span class="k">var</span> <span class="nv">stackStartItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">var</span> <span class="nv">needForamatter</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>

<span class="n">expression</span><span class="o">.</span><span class="nf">enumerateMatches</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">totoalLength</span><span class="p">))</span> <span class="p">{</span> <span class="n">match</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="k">in</span>
  <span class="k">if</span> <span class="k">let</span> <span class="nv">match</span> <span class="o">=</span> <span class="n">match</span> <span class="p">{</span>
    <span class="c1">// Check the string between tags or before the first tag</span>
    <span class="c1">// e.g. Test&lt;a&gt;Link&lt;/a&gt;zzz&lt;b&gt;bold&lt;/b&gt;Test2 - &gt; Test,zzz</span>
    <span class="k">let</span> <span class="nv">lastMatchEnd</span> <span class="o">=</span> <span class="n">lastMatch</span><span class="p">?</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">upperBound</span> <span class="p">??</span> <span class="mi">0</span>
    <span class="k">let</span> <span class="nv">currentMatchStart</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">lowerBound</span>
    <span class="k">if</span> <span class="n">currentMatchStart</span> <span class="o">&gt;</span> <span class="n">lastMatchEnd</span> <span class="p">{</span>
      <span class="k">let</span> <span class="nv">rawStringBetweenTag</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="n">lastMatchEnd</span><span class="p">,</span> <span class="p">(</span><span class="n">currentMatchStart</span> <span class="o">-</span> <span class="n">lastMatchEnd</span><span class="p">)))</span>
      <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">rawStringBetweenTag</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1">// &lt;a href="https://zhgchg.li"&gt;, &lt;/a&gt;</span>
    <span class="k">let</span> <span class="nv">matchAttributedString</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
    <span class="c1">// a, a</span>
    <span class="k">let</span> <span class="nv">matchTag</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"tagName"</span><span class="p">))?</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span><span class="o">.</span><span class="nf">lowercased</span><span class="p">()</span>
    <span class="c1">// false, true</span>
    <span class="k">let</span> <span class="nv">matchIsEndTag</span> <span class="o">=</span> <span class="n">matchResult</span><span class="o">.</span><span class="nf">attributedString</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"closeTag"</span><span class="p">))?</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span> <span class="o">==</span> <span class="s">"/"</span>
    <span class="c1">// href="https://zhgchg.li", nil</span>
    <span class="c1">// Use regex to further extract HTML attributes, to [String: String], refer to the source code</span>
    <span class="k">let</span> <span class="nv">matchTagAttributes</span> <span class="o">=</span> <span class="nf">parseAttributes</span><span class="p">(</span><span class="n">matchResult</span><span class="o">.</span><span class="nf">attributedString</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"tagAttributes"</span><span class="p">)))</span>
    <span class="c1">// false, false</span>
    <span class="k">let</span> <span class="nv">matchIsSelfClosingTag</span> <span class="o">=</span> <span class="n">matchResult</span><span class="o">.</span><span class="nf">attributedString</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"selfClosingTag"</span><span class="p">))?</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span> <span class="o">==</span> <span class="s">"/"</span>

    <span class="k">if</span> <span class="k">let</span> <span class="nv">matchAttributedString</span> <span class="o">=</span> <span class="n">matchAttributedString</span><span class="p">,</span>
       <span class="k">let</span> <span class="nv">matchTag</span> <span class="o">=</span> <span class="n">matchTag</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">matchIsSelfClosingTag</span> <span class="p">{</span>
          <span class="c1">// e.g. &lt;br/&gt;</span>
          <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">selfClosing</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">matchTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">matchAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">matchTagAttributes</span><span class="p">)))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// e.g. &lt;a&gt; or &lt;/a&gt;</span>
          <span class="k">if</span> <span class="n">matchIsEndTag</span> <span class="p">{</span>
            <span class="c1">// e.g. &lt;/a&gt;</span>
            <span class="c1">// Retrieve the position of the same tag name from the stack, starting from the last</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">stackStartItems</span><span class="o">.</span><span class="nf">lastIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">tagName</span> <span class="o">==</span> <span class="n">matchTag</span> <span class="p">})</span> <span class="p">{</span>
              <span class="c1">// If it's not the last one, it means there is a misalignment or a missing closing tag</span>
              <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">stackStartItems</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
                  <span class="n">needForamatter</span> <span class="o">=</span> <span class="kc">true</span>
              <span class="p">}</span>
              <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">matchTag</span><span class="p">)))</span>
              <span class="n">stackStartItems</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">// Extra close tag e.g &lt;/a&gt;</span>
              <span class="c1">// Does not affect subsequent processing, just ignore</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// e.g. &lt;a&gt;</span>
            <span class="k">let</span> <span class="nv">startItem</span><span class="p">:</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span> <span class="o">=</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">matchTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">matchAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">matchTagAttributes</span><span class="p">)</span>
            <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="n">startItem</span><span class="p">))</span>
            <span class="c1">// Add to stack</span>
            <span class="n">stackStartItems</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">startItem</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
     <span class="p">}</span>

    <span class="n">lastMatch</span> <span class="o">=</span> <span class="n">match</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Check the ending raw string</span>
<span class="c1">// e.g. Test&lt;a&gt;Link&lt;/a&gt;Test2 - &gt; Test2</span>
<span class="k">if</span> <span class="k">let</span> <span class="nv">lastMatch</span> <span class="o">=</span> <span class="n">lastMatch</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">currentIndex</span> <span class="o">=</span> <span class="n">lastMatch</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">upperBound</span>
  <span class="k">if</span> <span class="n">totoalLength</span> <span class="o">&gt;</span> <span class="n">currentIndex</span> <span class="p">{</span>
    <span class="c1">// There are remaining strings</span>
    <span class="k">let</span> <span class="nv">resetString</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="n">currentIndex</span><span class="p">,</span> <span class="p">(</span><span class="n">totoalLength</span> <span class="o">-</span> <span class="n">currentIndex</span><span class="p">)))</span>
    <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">resetString</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// lastMatch = nil, meaning no tags were found, all are plain text</span>
  <span class="k">let</span> <span class="nv">resetString</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">totoalLength</span><span class="p">))</span>
  <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">resetString</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// Check if the stack is empty, if not, it means there are start tags without corresponding end tags</span>
<span class="c1">// Mark as isolated start tags</span>
<span class="k">for</span> <span class="n">stackStartItem</span> <span class="k">in</span> <span class="n">stackStartItems</span> <span class="p">{</span>
  <span class="n">stackStartItem</span><span class="o">.</span><span class="n">isIsolated</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="n">needForamatter</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="n">tokenizationResult</span><span class="p">)</span>
<span class="c1">// [</span>
<span class="c1">//    .start("a",["href":"https://zhgchg.li"])</span>
<span class="c1">//    .rawString("Li")</span>
<span class="c1">//    .start("b",nil)</span>
<span class="c1">//    .rawString("nk")</span>
<span class="c1">//    .close("a")</span>
<span class="c1">//    .rawString("Bold")</span>
<span class="c1">//    .close("b")</span>
<span class="c1">// ]</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*U50CX56M_xy1EXZKb69YeA.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*U50CX56M_xy1EXZKb69YeA.png" alt="Operation flow as shown in the figure" class="lazyload" data-proofer-ignore></a></p><p>Operation flow as shown in the figure</p><p>The final result will be an array of Tokenization results.</p><blockquote><p>Corresponding source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLStringToParsedResultProcessor.swift" target="_blank">HTMLStringToParsedResultProcessor.swift</a> implementation</p></blockquote><h3 id="normalization"><span class="me-2">Normalization</span><a href="#normalization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>a.k.a Formatter, normalization</p></blockquote><p>After obtaining the preliminary parsing results in the previous step, if it is found during parsing that further normalization is needed, this step is required to automatically correct HTML Tag issues.</p><p><strong>There are three types of HTML Tag issues:</strong></p><ul><li>HTML Tag but missing Close Tag: e.g., <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code><li>General text mistaken as HTML Tag: e.g., <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code><li>HTML Tag misalignment issues: e.g., <code class="language-plaintext highlighter-rouge">&lt;a&gt;Li&lt;b&gt;nk&lt;/a&gt;Bold&lt;/b&gt;</code></ul><p>The correction method is also very simple. We need to traverse the elements of the Tokenization results and try to fill in the gaps.</p><p><a href="/assets/2724f02f6e7/1*Wk-U_sQuvLo1OJhcE1BQPQ.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*Wk-U_sQuvLo1OJhcE1BQPQ.png" alt="Operation flow as shown in the figure" class="lazyload" data-proofer-ignore></a></p><p>Operation flow as shown in the figure</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">normalizationResult</span> <span class="o">=</span> <span class="n">tokenizationResult</span>

<span class="c1">// Start Tags Stack, First In Last Out (FILO)</span>
<span class="k">var</span> <span class="nv">stackExpectedStartItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">var</span> <span class="nv">itemIndex</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">itemIndex</span> <span class="o">&lt;</span> <span class="n">newItems</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">newItems</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">isIsolated</span> <span class="p">{</span>
            <span class="c1">// If it is an isolated Start Tag</span>
            <span class="k">if</span> <span class="kt">WC3HTMLTagName</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">?</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">??</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// If it is not a WCS defined HTML Tag &amp; has no HTML Attribute</span>
                <span class="c1">// WC3HTMLTagName Enum can refer to Source Code</span>
                <span class="c1">// Determine as general text mistaken as HTML Tag</span>
                <span class="c1">// Change to raw string type</span>
                <span class="n">normalizationResult</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// Otherwise, change to self-closing tag, e.g., &lt;br&gt; -&gt; &lt;br/&gt;</span>
                <span class="n">normalizationResult</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="nf">selfClosing</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="nf">convertToSelfClosingParsedItem</span><span class="p">())</span>
            <span class="p">}</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Normal Start Tag, add to Stack</span>
            <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="c1">// Encounter Close Tag</span>
        <span class="c1">// Get the Tags between the Start Stack Tag and this Close Tag</span>
        <span class="c1">// e.g., &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/a&gt;&lt;/u&gt;&lt;/b&gt; -&gt; interval 0</span>
        <span class="c1">// e.g., &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/a&gt;&lt;/u&gt;&lt;/b&gt; -&gt; interval b,u</span>

        <span class="k">let</span> <span class="nv">reversedStackExpectedStartItems</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">reversed</span><span class="p">())</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">reversedStackExpectedStartItemsOccurredIndex</span> <span class="o">=</span> <span class="n">reversedStackExpectedStartItems</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">tagName</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">tagName</span> <span class="p">})</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">reversedStackExpectedStartItemsOccurred</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="n">reversedStackExpectedStartItems</span><span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="nv">upTo</span><span class="p">:</span> <span class="n">reversedStackExpectedStartItemsOccurredIndex</span><span class="p">))</span>
        
        <span class="c1">// Interval 0, means no tag misalignment</span>
        <span class="k">guard</span> <span class="n">reversedStackExpectedStartItemsOccurred</span><span class="o">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// is pair, pop</span>
            <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">removeLast</span><span class="p">()</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        
        <span class="c1">// There are other intervals, automatically fill in the interval Tags</span>
        <span class="c1">// e.g., &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/a&gt;&lt;/u&gt;&lt;/b&gt; -&gt;</span>
        <span class="c1">// e.g., &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/b&gt;&lt;/u&gt;&lt;/a&gt;&lt;b&gt;&lt;/u&gt;&lt;/u&gt;&lt;/b&gt;</span>
        <span class="k">let</span> <span class="nv">stackExpectedStartItemsOccurred</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="n">reversedStackExpectedStartItemsOccurred</span><span class="o">.</span><span class="nf">reversed</span><span class="p">())</span>
        <span class="k">let</span> <span class="nv">afterItems</span> <span class="o">=</span> <span class="n">stackExpectedStartItemsOccurred</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="k">let</span> <span class="nv">beforeItems</span> <span class="o">=</span> <span class="n">reversedStackExpectedStartItemsOccurred</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="nv">$0</span><span class="o">.</span><span class="nf">convertToCloseParsedItem</span><span class="p">())</span> <span class="p">})</span>
        <span class="n">normalizationResult</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">afterItems</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">newItems</span><span class="o">.</span><span class="nf">index</span><span class="p">(</span><span class="nv">after</span><span class="p">:</span> <span class="n">itemIndex</span><span class="p">))</span>
        <span class="n">normalizationResult</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">beforeItems</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">itemIndex</span><span class="p">)</span>
        
        <span class="n">itemIndex</span> <span class="o">=</span> <span class="n">newItems</span><span class="o">.</span><span class="nf">index</span><span class="p">(</span><span class="nv">after</span><span class="p">:</span> <span class="n">itemIndex</span><span class="p">)</span> <span class="o">+</span> <span class="n">stackExpectedStartItemsOccurred</span><span class="o">.</span><span class="n">count</span>
        
        <span class="c1">// Update Start Stack Tags</span>
        <span class="c1">// e.g., -&gt; b,u</span>
        <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="n">removeAll</span> <span class="p">{</span> <span class="n">startItem</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">reversedStackExpectedStartItems</span><span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="nv">through</span><span class="p">:</span> <span class="n">reversedStackExpectedStartItemsOccurredIndex</span><span class="p">)</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">===</span> <span class="n">startItem</span> <span class="p">})</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="o">.</span><span class="n">selfClosing</span><span class="p">,</span> <span class="o">.</span><span class="nv">rawString</span><span class="p">:</span>
        <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="n">normalizationResult</span><span class="p">)</span>
<span class="c1">// [</span>
<span class="c1">//    .start("a",["href":"https://zhgchg.li"])</span>
<span class="c1">//    .rawString("Li")</span>
<span class="c1">//    .start("b",nil)</span>
<span class="c1">//    .rawString("nk")</span>
<span class="c1">//    .close("b")</span>
<span class="c1">//    .close("a")</span>
<span class="c1">//    .start("b",nil)</span>
<span class="c1">//    .rawString("Bold")</span>
<span class="c1">//    .close("b")</span>
<span class="c1">// ]</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLParsedResultFormatterProcessor.swift" target="_blank">HTMLParsedResultFormatterProcessor.swift</a></p></blockquote><h3 id="abstract-syntax-tree"><span class="me-2">Abstract Syntax Tree</span><a href="#abstract-syntax-tree" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>a.k.a AST, Abstract Tree</p></blockquote><p>After the Tokenization &amp; Normalization data preprocessing is completed, the result needs to be converted into an abstract tree 🌲.</p><p><a href="/assets/2724f02f6e7/1*40z0o7R0OROURWCQVDmKrw.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*40z0o7R0OROURWCQVDmKrw.png" alt="As shown in the figure" class="lazyload" data-proofer-ignore></a></p><p>As shown in the figure</p><p>Converting into an abstract tree facilitates our future operations and extensions, such as implementing Selector functionality or other conversions like HTML to Markdown; or if we want to add Markdown to NSAttributedString in the future, we only need to implement Markdown’s Tokenization &amp; Normalization to complete it.</p><p><strong>First, we define a Markup Protocol with Child &amp; Parent properties to record the information of leaves and branches:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">Markup</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">prependChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span>
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="p">:</span> <span class="kt">MarkupVisitor</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="o">=</span> <span class="k">self</span>
        <span class="n">childMarkups</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">prependChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="o">=</span> <span class="k">self</span>
        <span class="n">childMarkups</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">markup</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Additionally, using the <a href="../ba5773a7bfea/">Visitor Pattern</a>, each style attribute is defined as an object Element, and different Visit strategies are used to obtain individual application results.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">Result</span>
        
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RootMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RawStringMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">BoldMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">LinkMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Basic Markup nodes:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c1">// Root node</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">RootMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Leaf node</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">RawStringMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">attributedString</span> <span class="o">=</span> <span class="n">attributedString</span>
    <span class="p">}</span>
    
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Define Markup Style Nodes:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">// Branch nodes:</span>

<span class="c1">// Link style</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">LinkMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Bold style</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">BoldMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/Core/Markup" target="_blank">Markup</a></p></blockquote><p>Before converting to an abstract tree, we also need…</p><h4 id="markupcomponent"><span class="me-2">MarkupComponent</span><a href="#markupcomponent" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>Because our tree structure does not depend on any data structure (for example, a node/LinkMarkup should have URL information to perform subsequent rendering).</strong> <strong>For this, we define a container to store tree nodes and related data information:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">T</span>
    <span class="k">var</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Sequence</span> <span class="k">where</span> <span class="kt">Iterator</span><span class="o">.</span><span class="kt">Element</span><span class="p">:</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Element</span><span class="o">.</span><span class="kt">T</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">markup</span> <span class="o">===</span> <span class="n">markup</span> <span class="p">})?</span><span class="o">.</span><span class="n">value</span> <span class="k">as?</span> <span class="kt">Element</span><span class="o">.</span><span class="kt">T</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/Core/MarkupComponent" target="_blank">MarkupComponent</a></p></blockquote><p>You can also declare Markup as <code class="language-plaintext highlighter-rouge">Hashable</code> and directly use Dictionary to store values <code class="language-plaintext highlighter-rouge">[Markup: Any]</code>, but in this way, Markup cannot be used as a general type and needs to be prefixed with <code class="language-plaintext highlighter-rouge">any Markup</code>.</p><h4 id="htmltag--htmltagname--htmltagnamevisitor"><span class="me-2">HTMLTag &amp; HTMLTagName &amp; HTMLTagNameVisitor</span><a href="#htmltag--htmltagname--htmltagnamevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We also abstracted the HTML Tag Name part, allowing users to decide which tags need to be processed and facilitating future extensions. For example, the <code class="language-plaintext highlighter-rouge">&lt;strong&gt;</code> Tag Name can correspond to <code class="language-plaintext highlighter-rouge">BoldMarkup</code>.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>public protocol HTMLTagName {
    var string: String { get }
    func accept&lt;V: HTMLTagNameVisitor&gt;(_ visitor: V) -&gt; V.Result
}

public struct A_HTMLTagName: HTMLTagName {
    public let string: String = WC3HTMLTagName.a.rawValue
    
    public init() {
        
    }
    
    public func accept&lt;V&gt;(_ visitor: V) -&gt; V.Result where V : HTMLTagNameVisitor {
        return visitor.visit(self)
    }
}

public struct B_HTMLTagName: HTMLTagName {
    public let string: String = WC3HTMLTagName.b.rawValue
    
    public init() {
        
    }
    
    public func accept&lt;V&gt;(_ visitor: V) -&gt; V.Result where V : HTMLTagNameVisitor {
        return visitor.visit(self)
    }
}
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/HTMLTag/HTMLTagNameVisitor.swift" target="_blank">HTMLTagNameVisitor</a></p></blockquote><blockquote><p>Additionally, refer to the W3C wiki which lists the HTML tag name enum: <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/HTMLTag/WC3HTMLTagName.swift" target="_blank">WC3HTMLTagName.swift</a></p></blockquote><p><strong>HTMLTag is simply a container object because we want to allow external specification of the style corresponding to the HTML Tag, so we declare a container to put them together:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLTag</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span>
    <span class="k">let</span> <span class="nv">customStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="c1">// Render will be explained later</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span><span class="p">,</span> <span class="nv">customStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
        <span class="k">self</span><span class="o">.</span><span class="n">customStyle</span> <span class="o">=</span> <span class="n">customStyle</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/HTMLTag/HTMLTag.swift3" target="_blank">HTMLTag</a></p></blockquote><h4 id="htmltagnametohtmlmarkupvisitor"><span class="me-2">HTMLTagNameToHTMLMarkupVisitor</span><a href="#htmltagnametohtmlmarkupvisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLTagNameToMarkupVisitor</span><span class="p">:</span> <span class="kt">HTMLTagNameVisitor</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">Markup</span>
    
    <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">A_HTMLTagName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">LinkMarkup</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">B_HTMLTagName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">BoldMarkup</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLTagNameToHTMLMarkupVisitor.swift" target="_blank">HTMLTagNameToHTMLMarkupVisitor</a></p></blockquote><h4 id="convert-to-abstract-tree-with-html-data"><span class="me-2">Convert to Abstract Tree with HTML Data</span><a href="#convert-to-abstract-tree-with-html-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We need to convert the result of the normalized HTML data into an abstract tree. First, declare a MarkupComponent data structure that can store HTML data:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLElementMarkupComponent</span><span class="p">:</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">HTMLElement</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tag</span><span class="p">:</span> <span class="kt">HTMLTag</span>
        <span class="k">let</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
        <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>
    <span class="p">}</span>
    
    <span class="kd">typealias</span> <span class="kt">T</span> <span class="o">=</span> <span class="kt">HTMLElement</span>
    
    <span class="k">let</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span>
    <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">HTMLElement</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">HTMLElement</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">markup</span> <span class="o">=</span> <span class="n">markup</span>
        <span class="k">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Convert to Markup Abstract Tree:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">htmlElementComponents</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">let</span> <span class="nv">rootMarkup</span> <span class="o">=</span> <span class="kt">RootMarkup</span><span class="p">()</span>
<span class="k">var</span> <span class="nv">currentMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="o">=</span> <span class="n">rootMarkup</span>

<span class="k">let</span> <span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">HTMLTag</span><span class="p">]</span>
<span class="nf">init</span><span class="p">(</span><span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTag</span><span class="p">])</span> <span class="p">{</span>
  <span class="k">self</span><span class="o">.</span><span class="n">htmlTags</span> <span class="o">=</span> <span class="kt">Dictionary</span><span class="p">(</span><span class="nv">uniqueKeysWithValues</span><span class="p">:</span> <span class="n">htmlTags</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="p">(</span><span class="nv">$0</span><span class="o">.</span><span class="n">tagName</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
<span class="p">}</span>

<span class="c1">// Start Tags Stack, ensure correct pop tag</span>
<span class="c1">// Normalization has already been done before, it should not go wrong, just to ensure</span>
<span class="k">var</span> <span class="nv">stackExpectedStartItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">thisItem</span> <span class="k">in</span> <span class="n">from</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">thisItem</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLTagNameToMarkupVisitor</span><span class="p">(</span><span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">htmlTag</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">htmlTags</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">]</span> <span class="p">??</span> <span class="kt">HTMLTag</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">ExtendTagName</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">))</span>
        <span class="c1">// Use Visitor to ask for the corresponding Markup</span>
        <span class="k">let</span> <span class="nv">markup</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">htmlTag</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span>
        
        <span class="c1">// Add itself to the current branch's leaf node</span>
        <span class="c1">// Itself becomes the current branch node</span>
        <span class="n">htmlElementComponents</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tag</span><span class="p">:</span> <span class="n">htmlTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)))</span>
        <span class="n">currentMarkup</span><span class="o">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span>
        <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">markup</span>
        
        <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">selfClosing</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="c1">// Directly add to the current branch's leaf node</span>
        <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLTagNameToMarkupVisitor</span><span class="p">(</span><span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">htmlTag</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">htmlTags</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">]</span> <span class="p">??</span> <span class="kt">HTMLTag</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">ExtendTagName</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">))</span>
        <span class="k">let</span> <span class="nv">markup</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">htmlTag</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span>
        <span class="n">htmlElementComponents</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tag</span><span class="p">:</span> <span class="n">htmlTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)))</span>
        <span class="n">currentMarkup</span><span class="o">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">lastTagName</span> <span class="o">=</span> <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">popLast</span><span class="p">()?</span><span class="o">.</span><span class="n">tagName</span><span class="p">,</span>
           <span class="n">lastTagName</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">tagName</span> <span class="p">{</span>
            <span class="c1">// When encountering Close Tag, return to the previous level</span>
            <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">currentMarkup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="p">??</span> <span class="n">currentMarkup</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="k">let</span> <span class="nv">attributedString</span><span class="p">):</span>
        <span class="c1">// Directly add to the current branch's leaf node</span>
        <span class="n">currentMarkup</span><span class="o">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">RawStringMarkup</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="n">attributedString</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// print(htmlElementComponents)</span>
<span class="c1">// [(markup: LinkMarkup, (tag: a, attributes: ["href":"zhgchg.li"]...)]</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*D-oMszCDzsBpUYnCEWGKHQ.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*D-oMszCDzsBpUYnCEWGKHQ.png" alt="Operation result as shown in the figure" class="lazyload" data-proofer-ignore></a></p><p>Operation result as shown in the figure</p><blockquote><p>Corresponding source code implementation in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLParsedResultToHTMLElementWithRootMarkupProcessor.swift" target="_blank">HTMLParsedResultToHTMLElementWithRootMarkupProcessor.swift</a></p></blockquote><h4 id="at-this-point-we-have-actually-completed-the-functionality-of-the-selector-"><span class="me-2">At this point, we have actually completed the functionality of the Selector 🎉</span><a href="#at-this-point-we-have-actually-completed-the-functionality-of-the-selector-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="kt">HTMLSelector</span><span class="p">:</span> <span class="kt">CustomStringConvertible</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span>
    <span class="k">let</span> <span class="nv">componets</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">componets</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">markup</span> <span class="o">=</span> <span class="n">markup</span>
        <span class="k">self</span><span class="o">.</span><span class="n">componets</span> <span class="o">=</span> <span class="n">componets</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">filter</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlTagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">HTMLSelector</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="n">componets</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)?</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">tagName</span><span class="o">.</span><span class="nf">isEqualTo</span><span class="p">(</span><span class="n">htmlTagName</span><span class="p">)</span> <span class="p">??</span> <span class="kc">false</span> <span class="p">})</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="nv">$0</span><span class="p">,</span> <span class="nv">componets</span><span class="p">:</span> <span class="n">componets</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="c1">//...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We can filter leaf node objects layer by layer.</p><blockquote><p>Corresponding source code implementation in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLSelector.swift" target="_blank">HTMLSelector</a></p></blockquote><h3 id="parser--html-to-markupstyle-abstract-of-nsattributedstringkey"><span class="me-2">Parser — HTML to MarkupStyle (Abstract of NSAttributedString.Key)</span><a href="#parser--html-to-markupstyle-abstract-of-nsattributedstringkey" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next, we need to complete the conversion of HTML to MarkupStyle (NSAttributedString.Key).</p><p>NSAttributedString sets the text style through NSAttributedString.Key Attributes. We abstract all fields of NSAttributedString.Key to correspond to MarkupStyle, MarkupStyleColor, MarkupStyleFont, MarkupStyleParagraphStyle.</p><p><strong>Purpose:</strong></p><ul><li>The original data structure of Attributes is <code class="language-plaintext highlighter-rouge">[NSAttributedString.Key: Any?]</code>. If exposed directly, it is difficult to control the values users input, and incorrect values may cause crashes, such as <code class="language-plaintext highlighter-rouge">.font: 123</code>.<li>Styles need to be inheritable, such as <code class="language-plaintext highlighter-rouge">&lt;a&gt;&lt;b&gt;test&lt;/b&gt;&lt;/a&gt;</code>, where the style of the test string inherits from the link’s bold (bold+link); if the Dictionary is exposed directly, it is difficult to control the inheritance rules.<li>Encapsulate iOS/macOS (UIKit/Appkit) related objects.</ul><h4 id="markupstyle-struct"><span class="me-2">MarkupStyle Struct</span><a href="#markupstyle-struct" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyle</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">font</span><span class="p">:</span><span class="kt">MarkupStyleFont</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">paragraphStyle</span><span class="p">:</span><span class="kt">MarkupStyleParagraphStyle</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">foregroundColor</span><span class="p">:</span><span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">backgroundColor</span><span class="p">:</span><span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">ligature</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">kern</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">tracking</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strikethroughStyle</span><span class="p">:</span><span class="kt">NSUnderlineStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">underlineStyle</span><span class="p">:</span><span class="kt">NSUnderlineStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strokeColor</span><span class="p">:</span><span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strokeWidth</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">shadow</span><span class="p">:</span><span class="kt">NSShadow</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">textEffect</span><span class="p">:</span><span class="kt">String</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">attachment</span><span class="p">:</span><span class="kt">NSTextAttachment</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">link</span><span class="p">:</span><span class="kt">URL</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">baselineOffset</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">underlineColor</span><span class="p">:</span><span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strikethroughColor</span><span class="p">:</span><span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">obliqueness</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">expansion</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">writingDirection</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">verticalGlyphForm</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="c1">//...</span>

    <span class="c1">// Inherited from...</span>
    <span class="c1">// Default: When the field is nil, fill in the current data object from 'from'</span>
    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">from</span> <span class="o">=</span> <span class="n">from</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="k">var</span> <span class="nv">currentFont</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">font</span>
        <span class="n">currentFont</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="n">font</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">currentFont</span>
        
        <span class="k">var</span> <span class="nv">currentParagraphStyle</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">paragraphStyle</span>
        <span class="n">currentParagraphStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="n">paragraphStyle</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">paragraphStyle</span> <span class="o">=</span> <span class="n">currentParagraphStyle</span>
        <span class="c1">//..</span>
    <span class="p">}</span>

    <span class="c1">// MarkupStyle to NSAttributedString.Key: Any</span>
    <span class="kd">func</span> <span class="nf">render</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">data</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">font</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="nf">getFont</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="o">.</span><span class="n">font</span><span class="p">]</span> <span class="o">=</span> <span class="n">font</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">ligature</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">ligature</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="o">.</span><span class="n">ligature</span><span class="p">]</span> <span class="o">=</span> <span class="n">ligature</span>
        <span class="p">}</span>
        <span class="c1">//...</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyleFont</span><span class="p">:</span> <span class="kt">MarkupStyleItem</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="kt">FontWeight</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nf">style</span><span class="p">(</span><span class="kt">FontWeightStyle</span><span class="p">)</span>
        <span class="k">case</span> <span class="nf">rawValue</span><span class="p">(</span><span class="kt">CGFloat</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="kt">FontWeightStyle</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">ultraLight</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">thin</span><span class="p">,</span> <span class="n">regular</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">semibold</span><span class="p">,</span> <span class="n">bold</span><span class="p">,</span> <span class="n">heavy</span><span class="p">,</span> <span class="n">black</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">size</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">weight</span><span class="p">:</span> <span class="kt">FontWeight</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">italic</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">?</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyleParagraphStyle</span><span class="p">:</span> <span class="kt">MarkupStyleItem</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineSpacing</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">paragraphSpacing</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">alignment</span><span class="p">:</span><span class="kt">NSTextAlignment</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">headIndent</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">tailIndent</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">firstLineHeadIndent</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">minimumLineHeight</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">maximumLineHeight</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineBreakMode</span><span class="p">:</span><span class="kt">NSLineBreakMode</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">baseWritingDirection</span><span class="p">:</span><span class="kt">NSWritingDirection</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineHeightMultiple</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">paragraphSpacingBefore</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">hyphenationFactor</span><span class="p">:</span><span class="kt">Float</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">usesDefaultHyphenation</span><span class="p">:</span><span class="kt">Bool</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">tabStops</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSTextTab</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">defaultTabInterval</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">textLists</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSTextList</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">allowsDefaultTighteningForTruncation</span><span class="p">:</span><span class="kt">Bool</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineBreakStrategy</span><span class="p">:</span> <span class="kt">NSParagraphStyle</span><span class="o">.</span><span class="kt">LineBreakStrategy</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyleColor</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">red</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="k">let</span> <span class="nv">green</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="k">let</span> <span class="nv">blue</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="k">let</span> <span class="nv">alpha</span><span class="p">:</span> <span class="kt">CGFloat</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/Core/MarkupStyle" target="_blank">MarkupStyle</a></p></blockquote><blockquote><p>Additionally, refer to the W3c wiki, browser predefined color name enumerates the corresponding color name text &amp; color R,G,B enum: <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/MarkupStyle/MarkupStyleColorName.swift" target="_blank">MarkupStyleColorName.swift</a></p></blockquote><h4 id="htmltagstyleattribute--htmltagstyleattributevisitor"><span class="me-2">HTMLTagStyleAttribute &amp; HTMLTagStyleAttributeVisitor</span><a href="#htmltagstyleattribute--htmltagstyleattributevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Let’s talk a bit more about these two objects because HTML Tags are allowed to be styled using CSS settings; for this, we abstract the HTMLTagName and apply it once again to the HTML Style Attribute.</p><p>For example, HTML might provide: <code class="language-plaintext highlighter-rouge">&lt;a style=”color:red;font-size:14px”&gt;RedLink&lt;/a&gt;</code>, which means this link should be set to red and size 14px.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>public protocol HTMLTagStyleAttribute {
    var styleName: String { get }
    
    func accept&lt;V: HTMLTagStyleAttributeVisitor&gt;(_ visitor: V) -&gt; V.Result
}

public protocol HTMLTagStyleAttributeVisitor {
    associatedtype Result
    
    func visit(styleAttribute: HTMLTagStyleAttribute) -&gt; Result
    func visit(_ styleAttribute: ColorHTMLTagStyleAttribute) -&gt; Result
    func visit(_ styleAttribute: FontSizeHTMLTagStyleAttribute) -&gt; Result
    //...
}

public extension HTMLTagStyleAttributeVisitor {
    func visit(styleAttribute: HTMLTagStyleAttribute) -&gt; Result {
        return styleAttribute.accept(self)
    }
}
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/HTML/HTMLTag/HTMLTagStyleAttribute" target="_blank">HTMLTagStyleAttribute</a></p></blockquote><h4 id="htmltagstyleattributetomarkupstylevisitor"><span class="me-2">HTMLTagStyleAttributeToMarkupStyleVisitor</span><a href="#htmltagstyleattributetomarkupstylevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLTagStyleAttributeToMarkupStyleVisitor</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttributeVisitor</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    
    <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">ColorHTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Regex to extract Color Hex or Mapping from HTML Pre-defined Color Name, please refer to the Source Code</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="kt">MarkupStyleColor</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">return</span> <span class="kt">MarkupStyle</span><span class="p">(</span><span class="nv">foregroundColor</span><span class="p">:</span> <span class="n">color</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">FontSizeHTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Regex to extract 10px -&gt; 10, please refer to the Source Code</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">convert</span><span class="p">(</span><span class="nv">fromPX</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">return</span> <span class="kt">MarkupStyle</span><span class="p">(</span><span class="nv">font</span><span class="p">:</span> <span class="kt">MarkupStyleFont</span><span class="p">(</span><span class="nv">size</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLTagAttributeToMarkupStyleVisitor.swift" target="_blank">HTMLTagAttributeToMarkupStyleVisitor.swift</a></p></blockquote><p>init’s value = attribute’s value, converted to the corresponding MarkupStyle field according to the visit type.</p><h4 id="htmlelementmarkupcomponentmarkupstylevisitor"><span class="me-2">HTMLElementMarkupComponentMarkupStyleVisitor</span><a href="#htmlelementmarkupcomponentmarkupstylevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>After introducing the MarkupStyle object, we need to convert the result of Normalization’s HTMLElementComponents into MarkupStyle.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre><td class="rouge-code"><pre><span class="c1">// MarkupStyle policy</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="kt">MarkupStylePolicy</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">respectMarkupStyleFromCode</span> <span class="c1">// Prioritize from Code, fill in with HTML Style Attribute</span>
    <span class="k">case</span> <span class="n">respectMarkupStyleFromHTMLStyleAttribute</span> <span class="c1">// Prioritize from HTML Style Attribute, fill in with Code</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span><span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>

    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    
    <span class="k">let</span> <span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span>
    <span class="k">let</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span>

    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">BoldMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// .bold is just a default style defined in MarkupStyle, please refer to the Source Code</span>
        <span class="k">return</span> <span class="nf">defaultVisit</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">),</span> <span class="n">defaultStyle</span><span class="p">:</span> <span class="o">.</span><span class="n">bold</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">LinkMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// .link is just a default style defined in MarkupStyle, please refer to the Source Code</span>
        <span class="k">var</span> <span class="nv">markupStyle</span> <span class="o">=</span> <span class="nf">defaultVisit</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">),</span> <span class="n">defaultStyle</span><span class="p">:</span> <span class="o">.</span><span class="n">link</span><span class="p">)</span> <span class="p">??</span> <span class="o">.</span><span class="n">link</span>
        
        <span class="c1">// Get the HtmlElement corresponding to LinkMarkup from HtmlElementComponents</span>
        <span class="c1">// Find the href parameter from the attributes of HtmlElement (HTML carries URL String)</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">href</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)?</span><span class="o">.</span><span class="n">attributes</span><span class="p">?[</span><span class="s">"href"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">href</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">markupStyle</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">url</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">markupStyle</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span> <span class="p">{</span>
    <span class="c1">// Get the custom MarkupStyle specified in the HTMLTag container</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">customStyle</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlElement</span><span class="p">:</span> <span class="kt">HTMLElementMarkupComponent</span><span class="o">.</span><span class="kt">HTMLElement</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">customStyle</span> <span class="o">=</span> <span class="n">htmlElement</span><span class="p">?</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">customStyle</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">customStyle</span>
    <span class="p">}</span>
    
    <span class="c1">// Default action</span>
    <span class="kd">func</span> <span class="nf">defaultVisit</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlElement</span><span class="p">:</span> <span class="kt">HTMLElementMarkupComponent</span><span class="o">.</span><span class="kt">HTMLElement</span><span class="p">?,</span> <span class="n">defaultStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="nf">customStyle</span><span class="p">(</span><span class="n">htmlElement</span><span class="p">)</span> <span class="p">??</span> <span class="n">defaultStyle</span>
        <span class="c1">// Get the HtmlElement corresponding to LinkMarkup from HtmlElementComponents</span>
        <span class="c1">// Check if the attributes of HtmlElement have a `Style` Attribute</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">styleString</span> <span class="o">=</span> <span class="n">htmlElement</span><span class="p">?</span><span class="o">.</span><span class="n">attributes</span><span class="p">?[</span><span class="s">"style"</span><span class="p">],</span>
              <span class="n">styleAttributes</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// No</span>
            <span class="k">return</span> <span class="n">markupStyle</span>
        <span class="p">}</span>

        <span class="c1">// Has Style Attributes</span>
        <span class="c1">// Split the Style Value string into an array</span>
        <span class="c1">// font-size:14px;color:red -&gt; ["font-size":"14px","color":"red"]</span>
        <span class="k">let</span> <span class="nv">styles</span> <span class="o">=</span> <span class="n">styleString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">";"</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">}</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">":"</span><span class="p">)</span> <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">style</span> <span class="k">in</span> <span class="n">styles</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="n">style</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">continue</span>
            <span class="p">}</span>
            <span class="c1">// e.g font-size</span>
            <span class="k">let</span> <span class="nv">key</span> <span class="o">=</span> <span class="n">style</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span>
            <span class="c1">// e.g. 14px</span>
            <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">style</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="k">let</span> <span class="nv">styleAttribute</span> <span class="o">=</span> <span class="n">styleAttributes</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">isEqualTo</span><span class="p">(</span><span class="nv">styleName</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>
                <span class="c1">// Use the HTMLTagStyleAttributeToMarkupStyleVisitor mentioned above to convert back to MarkupStyle</span>
                <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLTagStyleAttributeToMarkupStyleVisitor</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="k">var</span> <span class="nv">thisMarkupStyle</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">styleAttribute</span><span class="p">:</span> <span class="n">styleAttribute</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// When Style Attribute has a return value..</span>
                    <span class="c1">// Merge the result of the previous MarkupStyle</span>
                    <span class="n">thisMarkupStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">)</span>
                    <span class="n">markupStyle</span> <span class="o">=</span> <span class="n">thisMarkupStyle</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// If there is a default Style</span>
        <span class="k">if</span> <span class="k">var</span> <span class="nv">defaultStyle</span> <span class="o">=</span> <span class="n">defaultStyle</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="n">policy</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">.</span><span class="nv">respectMarkupStyleFromHTMLStyleAttribute</span><span class="p">:</span>
                  <span class="c1">// Prioritize Style Attribute MarkupStyle, then</span>
                  <span class="c1">// Merge the result of defaultStyle</span>
                    <span class="n">markupStyle</span><span class="p">?</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">defaultStyle</span><span class="p">)</span>
                <span class="k">case</span> <span class="o">.</span><span class="nv">respectMarkupStyleFromCode</span><span class="p">:</span>
                  <span class="c1">// Prioritize defaultStyle, then</span>
                  <span class="c1">// Merge the result of Style Attribute MarkupStyle</span>
                  <span class="n">defaultStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">)</span>
                  <span class="n">markupStyle</span> <span class="o">=</span> <span class="n">defaultStyle</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">markupStyle</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLTagAttributeToMarkupStyleVisitor.swift" target="_blank">HTMLTagAttributeToMarkupStyleVisitor.swift</a></p></blockquote><p>We will define some default styles in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/MarkupStyle/MarkupStyle%2BExtension.swift" target="_blank">MarkupStyle</a>. Some Markup will use the default style if the desired style is not specified from outside the code.</p><p><strong>There are two style inheritance strategies:</strong></p><ul><li>respectMarkupStyleFromCode: Use the default style as the primary; then see what styles can be supplemented from the Style Attributes, ignoring if there is already a value.<li>respectMarkupStyleFromHTMLStyleAttribute: Use the Style Attributes as the primary; then see what styles can be supplemented from the default style, ignoring if there is already a value.</ul><h4 id="htmlelementwithmarkuptomarkupstyleprocessor"><span class="me-2">HTMLElementWithMarkupToMarkupStyleProcessor</span><a href="#htmlelementwithmarkuptomarkupstyleprocessor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Convert the Normalization result into AST &amp; MarkupStyleComponent.</p><p><strong>Declare a new MarkupComponent to store the corresponding MarkupStyle:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">MarkupStyleComponent</span><span class="p">:</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">T</span> <span class="o">=</span> <span class="kt">MarkupStyle</span>
    
    <span class="k">let</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span>
    <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">MarkupStyle</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">markup</span> <span class="o">=</span> <span class="n">markup</span>
        <span class="k">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Simple traversal of the Markup Tree &amp; HTMLElementMarkupComponent structure:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span>
    
<span class="kd">func</span> <span class="nf">process</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="p">(</span><span class="kt">Markup</span><span class="p">,</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]))</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span><span class="p">(</span><span class="nv">policy</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="n">styleAttributes</span><span class="p">)</span>
  <span class="nf">walk</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="nv">visitor</span><span class="p">:</span> <span class="n">visitor</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">components</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">components</span>
<span class="p">}</span>
    
<span class="kd">func</span> <span class="nf">walk</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="k">inout</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">])</span> <span class="p">{</span>
        
  <span class="k">if</span> <span class="k">let</span> <span class="nv">markupStyle</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">components</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">))</span>
  <span class="p">}</span>
        
  <span class="k">for</span> <span class="n">markup</span> <span class="k">in</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span> <span class="p">{</span>
    <span class="nf">walk</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">visitor</span><span class="p">:</span> <span class="n">visitor</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">components</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// print(components)</span>
<span class="c1">// [(markup: LinkMarkup, MarkupStyle(link: https://zhgchg.li, color: .blue)]</span>
<span class="c1">// [(markup: BoldMarkup, MarkupStyle(font: .init(weight: .bold))]</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the original code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLElementWithMarkupToMarkupStyleProcessor.swift" target="_blank">HTMLElementWithMarkupToMarkupStyleProcessor.swift</a></p></blockquote><p><a href="/assets/2724f02f6e7/1*JEMBNdbQcBgDQ49jFw4ePQ.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*JEMBNdbQcBgDQ49jFw4ePQ.png" alt="The process result is shown in the above image" class="lazyload" data-proofer-ignore></a></p><p>The process result is shown in the above image</p><h3 id="render--convert-to-nsattributedstring"><span class="me-2">Render — Convert To NSAttributedString</span><a href="#render--convert-to-nsattributedstring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now that we have the HTML Tag abstract tree structure and the MarkupStyle corresponding to the HTML Tag, the final step is to produce the final NSAttributedString rendering result.</p><h4 id="markupnsattributedstringvisitor"><span class="me-2">MarkupNSAttributedStringVisitor</span><a href="#markupnsattributedstringvisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>visit markup to NSAttributedString</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">MarkupNSAttributedStringVisitor</span><span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">NSAttributedString</span>
    
    <span class="k">let</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">]</span>
    <span class="c1">// root / base MarkupStyle, specified externally, for example, the size of the entire string</span>
    <span class="k">let</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RootMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Look down to the RawString object</span>
        <span class="k">return</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RawStringMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Return Raw String</span>
        <span class="c1">// Collect all MarkupStyles in the chain</span>
        <span class="c1">// Apply Style to NSAttributedString</span>
        <span class="k">return</span> <span class="nf">applyMarkupStyle</span><span class="p">(</span><span class="n">markup</span><span class="o">.</span><span class="n">attributedString</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="nf">collectMarkupStyle</span><span class="p">(</span><span class="n">markup</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">BoldMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Look down to the RawString object</span>
        <span class="k">return</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">LinkMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Look down to the RawString object</span>
        <span class="k">return</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">extension</span> <span class="kt">MarkupNSAttributedStringVisitor</span> <span class="p">{</span>
    <span class="c1">// Apply Style to NSAttributedString</span>
    <span class="kd">func</span> <span class="nf">applyMarkupStyle</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="n">with</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">markupStyle</span> <span class="o">=</span> <span class="n">markupStyle</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">attributedString</span> <span class="p">}</span>
        <span class="k">let</span> <span class="nv">mutableAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="n">attributedString</span><span class="p">)</span>
        <span class="n">mutableAttributedString</span><span class="o">.</span><span class="nf">addAttributes</span><span class="p">(</span><span class="n">markupStyle</span><span class="o">.</span><span class="nf">render</span><span class="p">(),</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mutableAttributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mutableAttributedString</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSMutableAttributedString</span> <span class="p">{</span>
        <span class="c1">// collect from downstream</span>
        <span class="c1">// Root -&gt; Bold -&gt; String("Bold")</span>
        <span class="c1">//      \</span>
        <span class="c1">//       &gt; String("Test")</span>
        <span class="c1">// Result: Bold Test</span>
        <span class="c1">// Recursively visit and combine the final NSAttributedString by looking down layer by layer for raw strings</span>
        <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">compactMap</span><span class="p">({</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span><span class="o">.</span><span class="nf">reduce</span><span class="p">(</span><span class="kt">NSMutableAttributedString</span><span class="p">())</span> <span class="p">{</span> <span class="n">partialResult</span><span class="p">,</span> <span class="n">attributedString</span> <span class="k">in</span>
            <span class="n">partialResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">attributedString</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">partialResult</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">collectMarkupStyle</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="p">{</span>
        <span class="c1">// collect from upstream</span>
        <span class="c1">// String("Test") -&gt; Bold -&gt; Italic -&gt; Root</span>
        <span class="c1">// Result: style: Bold+Italic</span>
        <span class="c1">// Inherit styles layer by layer by looking up for parent tag's markupstyle</span>
        <span class="k">var</span> <span class="nv">currentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span>
        <span class="k">var</span> <span class="nv">currentStyle</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span>
        <span class="k">while</span> <span class="k">let</span> <span class="nv">thisMarkup</span> <span class="o">=</span> <span class="n">currentMarkup</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">thisMarkupStyle</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">thisMarkup</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">thisMarkup</span><span class="o">.</span><span class="n">parentMarkup</span>
                <span class="k">continue</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="k">var</span> <span class="nv">thisCurrentStyle</span> <span class="o">=</span> <span class="n">currentStyle</span> <span class="p">{</span>
                <span class="n">thisCurrentStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">thisMarkupStyle</span><span class="p">)</span>
                <span class="n">currentStyle</span> <span class="o">=</span> <span class="n">thisCurrentStyle</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">currentStyle</span> <span class="o">=</span> <span class="n">thisMarkupStyle</span>
            <span class="p">}</span>

            <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">thisMarkup</span><span class="o">.</span><span class="n">parentMarkup</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">var</span> <span class="nv">currentStyle</span> <span class="o">=</span> <span class="n">currentStyle</span> <span class="p">{</span>
            <span class="n">currentStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">rootStyle</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">currentStyle</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">rootStyle</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/Processor/MarkupNSAttributedStringVisitor.swift" target="_blank">MarkupNSAttributedStringVisitor.swift</a></p></blockquote><p><a href="/assets/2724f02f6e7/1*gJA_6uM5tQw2kUJsqIssuw.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*gJA_6uM5tQw2kUJsqIssuw.png" alt="Operation process and result as shown in the figure" class="lazyload" data-proofer-ignore></a></p><p>Operation process and result as shown in the figure</p><p><strong>Finally, we can get:</strong></p><p><a href="/assets/2724f02f6e7/1*LOXfC8yYg2JCeoCH5m7kGA.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*LOXfC8yYg2JCeoCH5m7kGA.png" alt="" class="lazyload" data-proofer-ignore></a></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kt">Li</span><span class="p">{</span>
    <span class="kt">NSColor</span> <span class="o">=</span> <span class="s">"Blue"</span><span class="p">;</span>
    <span class="kt">NSFont</span> <span class="o">=</span> <span class="s">"&lt;UICTFont: 0x145d17600&gt; font-family: </span><span class="se">\"</span><span class="s">.SFUI-Regular</span><span class="se">\"</span><span class="s">; font-weight: normal; font-style: normal; font-size: 13.00pt"</span><span class="p">;</span>
    <span class="kt">NSLink</span> <span class="o">=</span> <span class="s">"https://zhgchg.li"</span><span class="p">;</span>
<span class="p">}</span><span class="n">nk</span><span class="p">{</span>
    <span class="kt">NSColor</span> <span class="o">=</span> <span class="s">"Blue"</span><span class="p">;</span>
    <span class="kt">NSFont</span> <span class="o">=</span> <span class="s">"&lt;UICTFont: 0x145d18710&gt; font-family: </span><span class="se">\"</span><span class="s">.SFUI-Semibold</span><span class="se">\"</span><span class="s">; font-weight: bold; font-style: normal; font-size: 13.00pt"</span><span class="p">;</span>
    <span class="kt">NSLink</span> <span class="o">=</span> <span class="s">"https://zhgchg.li"</span><span class="p">;</span>
<span class="p">}</span><span class="kt">Bold</span><span class="p">{</span>
    <span class="kt">NSFont</span> <span class="o">=</span> <span class="s">"&lt;UICTFont: 0x145d18710&gt; font-family: </span><span class="se">\"</span><span class="s">.SFUI-Semibold</span><span class="se">\"</span><span class="s">; font-weight: bold; font-style: normal; font-size: 13.00pt"</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>🎉🎉🎉🎉Completed🎉🎉🎉🎉</p></blockquote><p>At this point, we have completed the entire conversion process from HTML String to NSAttributedString.</p><h4 id="stripper--stripping-html-tags"><span class="me-2">Stripper — Stripping HTML Tags</span><a href="#stripper--stripping-html-tags" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Stripping HTML tags is relatively simple, just need to:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">attributedString</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
  <span class="k">if</span> <span class="k">let</span> <span class="nv">rawStringMarkup</span> <span class="o">=</span> <span class="n">markup</span> <span class="k">as?</span> <span class="kt">RawStringMarkup</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">rawStringMarkup</span><span class="o">.</span><span class="n">attributedString</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">compactMap</span><span class="p">({</span> <span class="nf">attributedString</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span><span class="o">.</span><span class="nf">reduce</span><span class="p">(</span><span class="kt">NSMutableAttributedString</span><span class="p">())</span> <span class="p">{</span> <span class="n">partialResult</span><span class="p">,</span> <span class="n">attributedString</span> <span class="k">in</span>
      <span class="n">partialResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">attributedString</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">partialResult</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/Processor/MarkupStripperProcessor.swift" target="_blank">MarkupStripperProcessor.swift</a></p></blockquote><p>Similar to Render, but purely returns the content after finding RawStringMarkup.</p><h4 id="extend--dynamic-extension"><span class="me-2">Extend — Dynamic Extension</span><a href="#extend--dynamic-extension" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To extend and cover all HTMLTag/Style Attributes, a dynamic extension port is opened, making it convenient to dynamically extend objects directly from the code.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">ExtendTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">w3cHTMLTagName</span><span class="p">:</span> <span class="kt">WC3HTMLTagName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">w3cHTMLTagName</span><span class="o">.</span><span class="n">rawValue</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span><span class="o">.</span><span class="nf">lowercased</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">HTMLTagNameVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// to</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">ExtendMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//----</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">ExtendHTMLTagStyleAttribute</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttribute</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">styleName</span><span class="p">:</span> <span class="kt">String</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">render</span><span class="p">:</span> <span class="p">((</span><span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">MarkupStyle</span><span class="p">?))</span> <span class="c1">// Dynamically change MarkupStyle using closure</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">styleName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">render</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">((</span><span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">MarkupStyle</span><span class="p">?)))</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">styleName</span> <span class="o">=</span> <span class="n">styleName</span>
        <span class="k">self</span><span class="o">.</span><span class="n">render</span> <span class="o">=</span> <span class="n">render</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">HTMLTagStyleAttributeVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="zhtmlparserbuilder"><span class="me-2">ZHTMLParserBuilder</span><a href="#zhtmlparserbuilder" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Finally, we use the Builder Pattern to allow external Modules to quickly construct the objects required by ZMarkupParser and ensure Access Level Control.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">ZHTMLParserBuilder</span> <span class="p">{</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span> <span class="o">=</span> <span class="o">.</span><span class="n">respectMarkupStyleFromCode</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">func</span> <span class="nf">initWithDefault</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">builder</span> <span class="o">=</span> <span class="k">Self</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">htmlTagName</span> <span class="k">in</span> <span class="kt">ZHTMLParserBuilder</span><span class="o">.</span><span class="n">htmlTagNames</span> <span class="p">{</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">htmlTagName</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">styleAttribute</span> <span class="k">in</span> <span class="kt">ZHTMLParserBuilder</span><span class="o">.</span><span class="n">styleAttributes</span> <span class="p">{</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">styleAttribute</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">builder</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span><span class="p">,</span> <span class="n">withCustomStyle</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">htmlTagName</span><span class="p">,</span> <span class="nv">withCustomStyle</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">add</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span><span class="p">,</span> <span class="n">withCustomStyle</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="c1">// Only one tagName can exist</span>
        <span class="n">htmlTags</span><span class="o">.</span><span class="n">removeAll</span> <span class="p">{</span> <span class="n">htmlTag</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">htmlTag</span><span class="o">.</span><span class="n">tagName</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="n">htmlTagName</span><span class="o">.</span><span class="n">string</span>
        <span class="p">}</span>
        
        <span class="n">htmlTags</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="kt">HTMLTag</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">htmlTagName</span><span class="p">,</span> <span class="nv">customStyle</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">add</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">styleAttributes</span><span class="o">.</span><span class="n">removeAll</span> <span class="p">{</span> <span class="n">thisStyleAttribute</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">thisStyleAttribute</span><span class="o">.</span><span class="n">styleName</span> <span class="o">==</span> <span class="n">styleAttribute</span><span class="o">.</span><span class="n">styleName</span>
        <span class="p">}</span>
        
        <span class="n">styleAttributes</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">styleAttribute</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">rootStyle</span> <span class="o">=</span> <span class="n">rootStyle</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">build</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">ZHTMLParser</span> <span class="p">{</span>
        <span class="c1">// ZHTMLParser init is only open for internal use, external cannot directly init</span>
        <span class="c1">// Can only be initialized through ZHTMLParserBuilder</span>
        <span class="k">return</span> <span class="kt">ZHTMLParser</span><span class="p">(</span><span class="nv">htmlTags</span><span class="p">:</span> <span class="n">htmlTags</span><span class="p">,</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="n">styleAttributes</span><span class="p">,</span> <span class="nv">policy</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="n">rootStyle</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/ZHTMLParserBuilder.swift" target="_blank">ZHTMLParserBuilder.swift</a></p></blockquote><p><strong>initWithDefault will add all implemented HTMLTagName/Style Attribute by default</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">extension</span> <span class="kt">ZHTMLParserBuilder</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">htmlTagNames</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagName</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="kt">A_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">B_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">BR_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">DIV_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">HR_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">I_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">LI_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">OL_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">P_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">SPAN_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">STRONG_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">U_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">UL_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">DEL_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TR_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TD_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TH_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TABLE_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">IMG_HTMLTagName</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">),</span>
            <span class="c1">// ...</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">extension</span> <span class="kt">ZHTMLParserBuilder</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="kt">ColorHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">BackgroundColorHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">FontSizeHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">FontWeightHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">LineHeightHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">WordSpacingHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="c1">// ...</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>ZHTMLParser init is only open internally, external cannot directly init, can only init through ZHTMLParserBuilder.</p><p><strong>ZHTMLParser encapsulates Render/Selector/Stripper operations:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">ZHTMLParser</span><span class="p">:</span> <span class="kt">ZMarkupParser</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTag</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span>

    <span class="kd">internal</span> <span class="nf">init</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    
    <span class="c1">// Get link style attributes</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">linkTextAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">selector</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">HTMLSelector</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">selector</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">HTMLSelector</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="c1">// Allow rendering of NSAttributedString within nodes using HTMLSelector results</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="n">_</span> <span class="nv">selector</span><span class="p">:</span> <span class="kt">HTMLSelector</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">stripper</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">stripper</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
  <span class="c1">// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the original code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/ZHTMLParser.swift" target="_blank">ZHTMLParser.swift</a></p></blockquote><h4 id="uikit-issues"><span class="me-2">UIKit Issues</span><a href="#uikit-issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The result of NSAttributedString is most commonly displayed in a UITextView, but note:</p><ul><li>The link style in UITextView is uniformly determined by the <code class="language-plaintext highlighter-rouge">linkTextAttributes</code> setting, not by the NSAttributedString.Key setting, and individual styles cannot be set; hence the <code class="language-plaintext highlighter-rouge">ZMarkupParser.linkTextAttributes</code> opening.<li>UILabel currently has no way to change the link style, and since UILabel does not have TextStorage, if you want to load NSTextAttachment images, you need to handle UILabel separately.</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">extension</span> <span class="kt">UITextView</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">setHtmlString</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">string</span><span class="p">),</span> <span class="nv">with</span><span class="p">:</span> <span class="n">parser</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">linkTextAttributes</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">linkTextAttributes</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">public</span> <span class="kd">extension</span> <span class="kt">UILabel</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">setHtmlString</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">string</span><span class="p">),</span> <span class="nv">with</span><span class="p">:</span> <span class="n">parser</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="n">attributedString</span><span class="o">.</span><span class="nf">enumerateAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">attachment</span><span class="p">,</span> <span class="nv">in</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span><span class="p">),</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[])</span> <span class="p">{</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">effectiveRange</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">attachment</span> <span class="o">=</span> <span class="n">value</span> <span class="k">as?</span> <span class="kt">ZNSTextAttachment</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            
            <span class="n">attachment</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="n">attributedString</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Therefore, by extending UIKit, external users only need to use <code class="language-plaintext highlighter-rouge">setHTMLString()</code> to complete the binding.</p><h4 id="complex-rendering-items-list-items"><span class="me-2">Complex Rendering Items— List Items</span><a href="#complex-rendering-items-list-items" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Record of implementing list items.</p><p><strong>Using <code class="language-plaintext highlighter-rouge">&lt;ol&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;ul&gt;</code> to wrap <code class="language-plaintext highlighter-rouge">&lt;li&gt;</code> in HTML to represent list items:</strong></p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li&gt;</span>ItemA<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>ItemB<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>ItemC<span class="nt">&lt;/li&gt;</span>
    //...
<span class="nt">&lt;/ul&gt;</span>
</pre></table></code></div></div><p>Using the same parsing method as before, we can get other list items in <code class="language-plaintext highlighter-rouge">visit(_ markup: ListItemMarkup)</code> to know the current list index (thanks to converting to AST).</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">ListItemMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">siblingListItems</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span><span class="p">?</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">ListItemMarkup</span> <span class="p">})</span> <span class="p">??</span> <span class="p">[]</span>
  <span class="k">let</span> <span class="nv">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">siblingListItems</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">===</span> <span class="n">markup</span> <span class="p">})</span> <span class="p">??</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>NSParagraphStyle has an NSTextList object that can be used to display list items, but in practice, it cannot customize the width of the whitespace (personally, I think the whitespace is too large). If there is whitespace between the bullet and the string, it will trigger a line break here, making the display look a bit odd, as shown in the image below:</p><p><a href="/assets/2724f02f6e7/1*jvIgDjO4DNAKpPZF1balmw.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*jvIgDjO4DNAKpPZF1balmw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>The Better part can potentially be achieved by <a href="https://www.objc.io/issues/9-strings/string-rendering/" target="_blank">setting headIndent, firstLineHeadIndent, NSTextTab</a>, but testing shows that if the string is too long or the size changes, it still cannot perfectly present the result.</p><p>Currently, it is only Acceptable, combining the list item string and inserting it before the string.</p><p>We only use NSTextList.MarkerFormat to generate list item symbols, rather than directly using NSTextList.</p><p><strong>For a list of supported list symbols, refer to:</strong> <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/MarkupStyle/MarkupStyleList.swift" target="_blank">MarkupStyleList.swift</a></p><p><strong>Final display result:</strong> <code class="language-plaintext highlighter-rouge">&lt;ol&gt;&lt;li&gt;</code></p><p><a href="/assets/2724f02f6e7/1*yM3VROfUNgnEBfIYwYwPnQ.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*yM3VROfUNgnEBfIYwYwPnQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="complex-rendering-items--table"><span class="me-2">Complex Rendering Items — Table</span><a href="#complex-rendering-items--table" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Similar to the implementation of list items, but for tables.</p><p><strong>Using <code class="language-plaintext highlighter-rouge">&lt;table&gt;</code> in HTML to create a table -&gt; wrapping <code class="language-plaintext highlighter-rouge">&lt;tr&gt;</code> table rows -&gt; wrapping <code class="language-plaintext highlighter-rouge">&lt;td&gt;/&lt;th&gt;</code> to represent table cells:</strong></p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;th&gt;</span>Company<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Contact<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Country<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>Alfreds Futterkiste<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Maria Anders<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Germany<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>Centro comercial Moctezuma<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Francisco Chang<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Mexico<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></table></code></div></div><p>Testing shows that the native <code class="language-plaintext highlighter-rouge">NSAttributedString.DocumentType.html</code> uses the Private macOS API <code class="language-plaintext highlighter-rouge">NSTextBlock</code> to complete the display, thus it can fully display the HTML table style and content.</p><blockquote><p>A bit of cheating! We can’t use Private API 🥲</p></blockquote><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre>    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">TableColumnMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">siblingColumns</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span><span class="p">?</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">TableColumnMarkup</span> <span class="p">})</span> <span class="p">??</span> <span class="p">[]</span>
        <span class="k">let</span> <span class="nv">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">siblingColumns</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">===</span> <span class="n">markup</span> <span class="p">})</span> <span class="p">??</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1">// Whether to specify the desired width externally, can set .max to not truncate string</span>
        <span class="k">var</span> <span class="nv">maxLength</span><span class="p">:</span> <span class="kt">Int</span><span class="p">?</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">fixedMaxLength</span>
        <span class="k">if</span> <span class="n">maxLength</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="c1">// If not specified, find the string length of the same column in the first row as the max length</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">tableRowMarkup</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="k">as?</span> <span class="kt">TableRowMarkup</span><span class="p">,</span>
               <span class="k">let</span> <span class="nv">firstTableRow</span> <span class="o">=</span> <span class="n">tableRowMarkup</span><span class="o">.</span><span class="n">parentMarkup</span><span class="p">?</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">TableRowMarkup</span> <span class="p">})</span> <span class="k">as?</span> <span class="kt">TableRowMarkup</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">firstTableRowColumns</span> <span class="o">=</span> <span class="n">firstTableRow</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">TableColumnMarkup</span> <span class="p">})</span>
                <span class="k">if</span> <span class="n">firstTableRowColumns</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">position</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">firstTableRowColumnAttributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">firstTableRowColumns</span><span class="p">[</span><span class="n">position</span><span class="p">])</span>
                    <span class="k">let</span> <span class="nv">length</span> <span class="o">=</span> <span class="n">firstTableRowColumnAttributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span>
                    <span class="n">maxLength</span> <span class="o">=</span> <span class="n">length</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">maxLength</span> <span class="o">=</span> <span class="n">maxLength</span> <span class="p">{</span>
            <span class="c1">// If the field exceeds maxLength, truncate the string</span>
            <span class="k">if</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">maxLength</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="n">mutableString</span><span class="o">.</span><span class="nf">setString</span><span class="p">(</span><span class="kt">String</span><span class="p">(</span><span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="n">maxLength</span><span class="p">))</span><span class="o">+</span><span class="s">"..."</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="n">mutableString</span><span class="o">.</span><span class="nf">setString</span><span class="p">(</span><span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">padding</span><span class="p">(</span><span class="nv">toLength</span><span class="p">:</span> <span class="n">maxLength</span><span class="p">,</span> <span class="nv">withPad</span><span class="p">:</span> <span class="s">" "</span><span class="p">,</span> <span class="nv">startingAt</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">siblingColumns</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="c1">// Add spaces as spacing, the width of the spacing can be specified externally</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">makeString</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="s">" "</span><span class="p">,</span> <span class="nv">count</span><span class="p">:</span> <span class="n">markup</span><span class="o">.</span><span class="n">spacing</span><span class="p">)))</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">attributedString</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">TableRowMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
        <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">makeBreakLine</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">))</span> <span class="c1">// Add line break, for details refer to Source Code</span>
        <span class="k">return</span> <span class="n">attributedString</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">TableMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
        <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">makeBreakLine</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">))</span> <span class="c1">// Add line break, for details refer to Source Code</span>
        <span class="n">attributedString</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="nf">makeBreakLine</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">),</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// Add line break, for details refer to Source Code</span>
        <span class="k">return</span> <span class="n">attributedString</span>
    <span class="p">}</span>
</pre></table></code></div></div><p><strong>The final presentation effect is as follows:</strong></p><p><a href="/assets/2724f02f6e7/1*Dft7H2BbeyWIO-dH4QpuSw.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*Dft7H2BbeyWIO-dH4QpuSw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>not perfect, but acceptable.</p><h4 id="complex-rendering-items--image"><span class="me-2">Complex Rendering Items — Image</span><a href="#complex-rendering-items--image" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Finally, let’s talk about the biggest challenge, loading remote images into NSAttributedString.</p><p><strong>Use <code class="language-plaintext highlighter-rouge">&lt;img&gt;</code> to represent images in HTML:</strong></p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"https://user-images.githubusercontent.com/33706588/219608966-20e0c017-d05c-433a-9a52-091bc0cfd403.jpg"</span> <span class="na">width=</span><span class="s">"300"</span> <span class="na">height=</span><span class="s">"125"</span><span class="nt">/&gt;</span>
</pre></table></code></div></div><p>You can specify the desired display size through the <code class="language-plaintext highlighter-rouge">width</code> / <code class="language-plaintext highlighter-rouge">height</code> HTML attributes.</p><p>Displaying images in NSAttributedString is much more complicated than imagined; and there is no good implementation. Previously, when doing <a href="../e37d66ea1146/">UITextView text wrapping</a>, I encountered some pitfalls, but after researching again, I found that there is still no perfect solution.</p><p>For now, let’s ignore the issue that NSTextAttachment natively cannot reuse and release memory. We will first implement downloading images from remote and placing them into NSTextAttachment, then into NSAttributedString, and achieve automatic content updates.</p><p><strong>This series of operations is split into another small project for better optimization and reuse in other projects in the future:</strong></p><p><a href="https://github.com/ZhgChgLi/ZNSTextAttachment" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/8c6e5c65e1680e6f15b82933cd4644097aa50e057ee17f392aa6a68f442be71b/ZhgChgLi/ZNSTextAttachment" alt="" class="lazyload" data-proofer-ignore></a></p><p>Mainly referring to <a href="https://www.cocoanetics.com/2016/09/asynchronous-nstextattachment-1/" target="_blank">Asynchronous NSTextAttachments</a> series of articles for implementation, but replacing the final content update part (refreshing the UI after downloading) and adding Delegate/DataSource for external extension use.</p><p><a href="/assets/2724f02f6e7/1*JZ8IVVNj9B2l-UBemGbAig.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*JZ8IVVNj9B2l-UBemGbAig.png" alt="Operation flow and relationship as shown in the figure above" class="lazyload" data-proofer-ignore></a></p><p>Operation flow and relationship as shown in the figure above:</p><ul><li>Declare ZNSTextAttachmentable object, encapsulating NSTextStorage object (UITextView built-in) and UILabel itself (UILabel has no NSTextStorage) The operation method is only to implement replace attributedString from NSRange. (<code class="language-plaintext highlighter-rouge">func replace(attachment: ZNSTextAttachment, to: ZResizableNSTextAttachment)</code>)<li>The principle is to use <code class="language-plaintext highlighter-rouge">ZNSTextAttachment</code> to package imageURL, PlaceholderImage, and the size information to be displayed, then directly display the image with placeHolder<li>When the system needs this image on the screen, it will call the <code class="language-plaintext highlighter-rouge">image(forBounds…</code> method, at which point we start downloading the Image Data<li>DataSource goes out to let the external decide how to download or implement the Image Cache Policy, by default directly using URLSession to request image Data<li>After downloading, create a new <code class="language-plaintext highlighter-rouge">ZResizableNSTextAttachment</code> and implement the custom image size logic in <code class="language-plaintext highlighter-rouge">attachmentBounds(for…</code><li>Call the <code class="language-plaintext highlighter-rouge">replace(attachment: ZNSTextAttachment, to: ZResizableNSTextAttachment)</code> method to replace the <code class="language-plaintext highlighter-rouge">ZNSTextAttachment</code> position with <code class="language-plaintext highlighter-rouge">ZResizableNSTextAttachment</code><li>Issue didLoad Delegate notification, allowing external connection if needed<li>Complete</ul><blockquote><p><strong>For detailed code, refer to <a href="https://github.com/ZhgChgLi/ZNSTextAttachment" target="_blank">Source Code</a></strong>.</p></blockquote><p>The reason for not using <code class="language-plaintext highlighter-rouge">NSLayoutManager.invalidateLayout(forCharacterRange: range, actualCharacterRange: nil)</code> or <code class="language-plaintext highlighter-rouge">NSLayoutManager.invalidateDisplay(forCharacterRange: range)</code> to refresh the UI is that the UI did not correctly display the update; since the Range is known, directly triggering the replacement of NSAttributedString ensures the UI is correctly updated.</p><p>The final display result is as follows:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">"color:red"</span><span class="nt">&gt;</span>こんにちは<span class="nt">&lt;/span&gt;</span>こんにちはこんにちは <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"https://user-images.githubusercontent.com/33706588/219608966-20e0c017-d05c-433a-9a52-091bc0cfd403.jpg"</span><span class="nt">/&gt;</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*bl65v-SVOK3H9ajR-Ksg6w.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*bl65v-SVOK3H9ajR-Ksg6w.png" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="testing--continuous-integration"><span class="me-2">Testing &amp; Continuous Integration</span><a href="#testing--continuous-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this project, in addition to writing Unit Tests, Snapshot Tests were also established for integration testing to facilitate comprehensive testing and comparison of the final NSAttributedString.</p><p>The main functional logic has UnitTests and integration tests. The final <a href="https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser" target="_blank">Test Coverage</a> is around <strong>85%</strong>.</p><p><a href="/assets/2724f02f6e7/1*wV6BZcEGYuT9B9Xy4QzI0w.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*wV6BZcEGYuT9B9Xy4QzI0w.png" alt="[ZMarkupParser — codecov](https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p><a href="https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser — codecov</a></p><h4 id="snapshot-test"><span class="me-2">Snapshot Test</span><a href="#snapshot-test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/pointfreeco/swift-snapshot-testing" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/7c5a38af06926868299786524e9d13ef41313a1a2dbcacfc896aaa95eb49e4b5/pointfreeco/swift-snapshot-testing" alt="" class="lazyload" data-proofer-ignore></a></p><p><strong>Directly use the framework:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">SnapshotTesting</span>
<span class="c1">// ...</span>
<span class="kd">func</span> <span class="nf">testShouldKeppNSAttributedString</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">parser</span> <span class="o">=</span> <span class="kt">ZHTMLParserBuilder</span><span class="o">.</span><span class="nf">initWithDefault</span><span class="p">()</span><span class="o">.</span><span class="nf">build</span><span class="p">()</span>
  <span class="k">let</span> <span class="nv">textView</span> <span class="o">=</span> <span class="kt">UITextView</span><span class="p">()</span>
  <span class="n">textView</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">390</span>
  <span class="n">textView</span><span class="o">.</span><span class="n">isScrollEnabled</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="n">textView</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="o">.</span><span class="n">white</span>
  <span class="n">textView</span><span class="o">.</span><span class="nf">setHtmlString</span><span class="p">(</span><span class="s">"html string..."</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">parser</span><span class="p">)</span>
  <span class="n">textView</span><span class="o">.</span><span class="nf">layoutIfNeeded</span><span class="p">()</span>
  <span class="nf">assertSnapshot</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="n">textView</span><span class="p">,</span> <span class="nv">as</span><span class="p">:</span> <span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="nv">record</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*hLPeaOTOviA0jTPNOPu1hg.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*hLPeaOTOviA0jTPNOPu1hg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Directly compare the final result to see if it meets expectations, ensuring that the integration adjustments are not abnormal.</p><h4 id="codecov-test-coverage"><span class="me-2">Codecov Test Coverage</span><a href="#codecov-test-coverage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Integrate <a href="https://about.codecov.io" target="_blank">Codecov.io</a> (free for Public Repo) to evaluate Test Coverage. Just install the Codecov Github App &amp; configure it.</p><p><a href="https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser" target="_blank" class="img-link shimmer" ><img data-src="https://storage.googleapis.com/codecov-cdn/static/Codecov-icon-600x600.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>After setting up Codecov &lt;-&gt; Github Repo, you can also add <code class="language-plaintext highlighter-rouge">codecov.yml</code> to the root directory of the project</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="na">comment</span><span class="pi">:</span>                  <span class="c1"># this is a top-level key</span>
  <span class="na">layout</span><span class="pi">:</span> <span class="s2">"</span><span class="s">reach,</span><span class="nv"> </span><span class="s">diff,</span><span class="nv"> </span><span class="s">flags,</span><span class="nv"> </span><span class="s">files"</span>
  <span class="na">behavior</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">require_changes</span><span class="pi">:</span> <span class="no">false</span>  <span class="c1"># if true: only post the comment if coverage changes</span>
  <span class="na">require_base</span><span class="pi">:</span> <span class="s">no</span>        <span class="c1"># [yes :: must have a base report to post]</span>
  <span class="na">require_head</span><span class="pi">:</span> <span class="s">yes</span>       <span class="c1"># [yes :: must have a head report to post]</span>
</pre></table></code></div></div><p>Configuration file, this can enable the CI results to be automatically commented on the content after each PR is issued.</p><p><a href="/assets/2724f02f6e7/1*AcKpF4dijglahV-iVYLvvA.png" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*AcKpF4dijglahV-iVYLvvA.png" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="continuous-integration"><span class="me-2">Continuous Integration</span><a href="#continuous-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Github Action, CI integration: <code class="language-plaintext highlighter-rouge">ci.yml</code></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">CI</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">types</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">opened</span><span class="pi">,</span> <span class="nv">reopened</span><span class="pi">]</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">main</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">self-hosted</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">spm build and test</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">set -o pipefail</span>
          <span class="s">xcodebuild test -workspace ZMarkupParser.xcworkspace -testPlan ZMarkupParser -scheme ZMarkupParser -enableCodeCoverage YES -resultBundlePath './scripts/TestResult.xcresult' -destination 'platform=iOS Simulator,name=iPhone 14,OS=16.1' build test | xcpretty</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Codecov</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">codecov/codecov-action@v3.1.1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">xcode</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">xcode_archive_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">./scripts/TestResult.xcresult'</span>
</pre></table></code></div></div><p>This configuration runs build and test when PR is opened/reopened or push to the main branch, and finally uploads the test coverage report to codecov.</p><h4 id="regex"><span class="me-2">Regex</span><a href="#regex" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Regarding regular expressions, each use improves it further; this time, not much was used, but because I originally wanted to use a regex to extract paired HTML Tags, I also studied how to write it.</p><p>Some new cheat sheet notes learned this time…</p><ul><li><code class="language-plaintext highlighter-rouge">?:</code> allows ( ) to match group results but not capture them e.g. <code class="language-plaintext highlighter-rouge">(?:https?:\/\/)?(?:www\.)?example\.com</code> will return the entire URL in <code class="language-plaintext highlighter-rouge">https://www.example.com</code> instead of <code class="language-plaintext highlighter-rouge">https://</code>, <code class="language-plaintext highlighter-rouge">www</code><li><code class="language-plaintext highlighter-rouge">.+?</code> non-greedy match (returns the nearest) e.g. <code class="language-plaintext highlighter-rouge">&lt;.+?&gt;</code> will return <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;/a&gt;</code> in <code class="language-plaintext highlighter-rouge">&lt;a&gt;test&lt;/a&gt;</code> instead of the entire string<li><code class="language-plaintext highlighter-rouge">(?=XYZ)</code> any string until the <code class="language-plaintext highlighter-rouge">XYZ</code> string appears; note that another similar one <code class="language-plaintext highlighter-rouge">[^XYZ]</code> means any string until <code class="language-plaintext highlighter-rouge">X or Y or Z</code> character appears e.g. <code class="language-plaintext highlighter-rouge">(?:__)(.+?(?=__))(?:__)</code> (any string until <code class="language-plaintext highlighter-rouge">__</code>) will match <code class="language-plaintext highlighter-rouge">test</code><li><code class="language-plaintext highlighter-rouge">?R</code> recursively finds values with the same rule e.g. <code class="language-plaintext highlighter-rouge">\((?:[^()]|((?R)))+\)</code> will match <code class="language-plaintext highlighter-rouge">(simple)</code>, <code class="language-plaintext highlighter-rouge">(and(nested))</code>, <code class="language-plaintext highlighter-rouge">(nested)</code> in <code class="language-plaintext highlighter-rouge">(simple) (and(nested))</code><li><code class="language-plaintext highlighter-rouge">?&lt;GroupName&gt;</code> … <code class="language-plaintext highlighter-rouge">\k&lt;GroupName&gt;</code> matches the previous Group Name e.g. <code class="language-plaintext highlighter-rouge">(?&lt;tagName&gt;&lt;a&gt;).*(\k&lt;GroupName&gt;)</code><li><code class="language-plaintext highlighter-rouge">(?(X)yes|no)</code> matches the condition <code class="language-plaintext highlighter-rouge">yes</code> if the <code class="language-plaintext highlighter-rouge">X</code> match result has a value (can also use Group Name), otherwise matches <code class="language-plaintext highlighter-rouge">no</code> <strong>Swift does not support this yet</strong></ul><p><strong>Other good articles on Regex:</strong></p><ul><li><a href="https://onevcat.com/2022/11/swift-regex/" target="_blank">Swift Regex Quick Reference</a><li><a href="https://mp.weixin.qq.com/s/i_C4ATnajxRDGlTA8dJDHg" target="_blank">How do regular expressions work?</a> -&gt; <strong>Can refer to this when optimizing the regex performance of this project later</strong><li><a href="https://juejin.cn/post/6850418120390082574" target="_blank">Case of Regex error causing infinite search, eventually leading to server failure</a><li><a href="https://regex101.com" target="_blank">Regex101 bottom right corner can query all regex rules</a></ul><h4 id="swift-package-manager--cocoapods"><span class="me-2">Swift Package Manager &amp; Cocoapods</span><a href="#swift-package-manager--cocoapods" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This is also my first time developing with SPM &amp; Cocoapods… It’s quite interesting, SPM is really convenient; but if you encounter a situation where two projects depend on the same package, opening both projects at the same time will result in one of them not finding the package and failing to build…</p><p>Cocoapods has uploaded ZMarkupParser but hasn’t tested if it’s working properly, because I’m using SPM 😝.</p><h4 id="chatgpt"><span class="me-2">ChatGPT</span><a href="#chatgpt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>From the actual development experience, I found it most useful only when assisting in editing the Readme; in development, I haven’t felt any significant impact yet. When asking mid-senior level questions, it couldn’t provide a definite answer or even gave incorrect answers (I encountered some incorrect regex rules). So, in the end, I still turned to Google for the correct answers.</p><p>Not to mention asking it to write code, unless it’s simple Code Gen Object; otherwise, don’t expect it to complete the entire tool architecture directly. <em>(At least for now, it seems that Copilot might be more helpful for writing code)</em></p><p>However, it can provide a general direction for knowledge blind spots, allowing us to quickly get a rough idea of how certain things should be done. Sometimes, when the understanding is too low, it’s hard to quickly pinpoint the correct direction on Google, and that’s when ChatGPT is quite helpful.</p><h3 id="disclaimer"><span class="me-2">Disclaimer</span><a href="#disclaimer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After more than three months of research and development, I am exhausted, but I still need to declare that this approach is only a feasible result obtained after my research. It is not necessarily the best solution, and there may still be areas for optimization. This project is more like a starting point, hoping to get a perfect solution for Markup Language to NSAttributedString. <strong>Everyone is very welcome to contribute; many things still need the power of the community to be perfected</strong>.</p><h3 id="contributing"><span class="me-2">Contributing</span><a href="#contributing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/2724f02f6e7/1*kXjJQnSIJ7x-lSIYtacRrQ.jpeg" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*kXjJQnSIJ7x-lSIYtacRrQ.jpeg" alt="[ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;} [⭐](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser</a> <a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">⭐</a></p><p>Here are some areas that I think can be improved as of now (2023/03/12), and will be recorded in the Repo later:</p><ol><li>Optimization of performance/algorithm, although it is faster and more stable than the native <code class="language-plaintext highlighter-rouge">NSAttributedString.DocumentType.html</code>; there is still much room for optimization. I believe the performance is definitely not as good as XMLParser; I hope one day it can have the same performance while maintaining customization and automatic error correction.<li>Support for more HTML Tag, Style Attribute conversion parsing<li>Further optimization of <a href="https://github.com/ZhgChgLi/ZNSTextAttachment" target="_blank">ZNSTextAttachment</a>, implementing reuse capability, releasing memory; may need to research CoreText<li>Support for Markdown parsing, as the underlying abstraction is not limited to HTML; so as long as the front-end Markdown to Markup object is built, Markdown parsing can be completed; hence I named it ZMarkupParser, not ZHTMLParser, hoping that one day it can also support Markdown to NSAttributedString<li>Support for Any to Any, e.g. HTML To Markdown, Markdown To HTML, as we have the original AST tree (Markup object), so achieving conversion between any Markup is possible<li>Implement css <code class="language-plaintext highlighter-rouge">!important</code> functionality, enhancing the inheritance strategy of abstract MarkupStyle<li>Enhance HTML Selector functionality, currently, it is just the most basic filter functionality<li>Many more, welcome to open <a href="https://github.com/ZhgChgLi/ZMarkupParser/issues" target="_blank">issue</a></ol><blockquote><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">If you are willing but unable to contribute, you can also give me a ⭐ to make the Repo more visible, so that GitHub experts have the opportunity to help contribute!</a></p></blockquote><h3 id="summary"><span class="me-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg" class="popup img-link "><img data-src="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg" alt="[ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser</a></p><p>Here are all the technical details and the journey of developing ZMarkupParser. It took me almost three months of after-work and weekend time, countless research and practice, writing tests, improving Test Coverage, and setting up CI; finally, there is a somewhat decent result. I hope this tool solves the same problems for others and that everyone can help make this tool even better.</p><p><a href="/assets/2724f02f6e7/0*9YdJaNSQXlAfmT21.jpg" class="popup img-link "><img data-src="/assets/2724f02f6e7/0*9YdJaNSQXlAfmT21.jpg" alt="[pinkoi.com](https://www.pinkoi.com){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p><a href="https://www.pinkoi.com" target="_blank">pinkoi.com</a></p><p>It is currently applied in our company’s <a href="https://www.pinkoi.com" target="_blank">pinkoi.com</a> iOS App version, and no issues have been found. 😄</p><h4 id="further-reading"><span class="me-2">Further Reading</span><a href="#further-reading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="../a5643de271e4/">ZMarkupParser HTML String to NSAttributedString Tool</a><li><a href="https://www.objc.io/issues/9-strings/string-rendering/" target="_blank">String Rendering</a><li><a href="https://www.cocoanetics.com/2016/09/asynchronous-nstextattachment-1/" target="_blank">Asynchronous NSTextAttachments</a></ul><p>If you have any questions or feedback, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>===</p><p><a href="https://zhgchg.li/posts/2724f02f6e7/" target="_blank">本文中文版本</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ➡️ <a href="https://medium.com/p/2724f02f6e7" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=🍺&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/zrealm/'>ZRealm</a>, <a href='/categories/dev/'>Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/html-parsing/" class="post-tag no-text-decoration" >html-parsing</a> <a href="/tags/nsattributedstring/" class="post-tag no-text-decoration" >nsattributedstring</a> <a href="/tags/html/" class="post-tag no-text-decoration" >html</a> <a href="/tags/rendering/" class="post-tag no-text-decoration" >rendering</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=The%20Craft%20of%20Building%20a%20Handmade%20HTML%20Parser%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F2724f02f6e7%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=The%20Craft%20of%20Building%20a%20Handmade%20HTML%20Parser%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F2724f02f6e7%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F2724f02f6e7%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/a8c2d26cc734/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1654791119" data-df="ll" > Jun 10, 2022 </em><h4 class="pt-0 my-2" data-toc-skip>Implementing iOS NSAttributedString HTML Render Yourself</h4><div class="text-muted small"><p> Implementing iOS NSAttributedString HTML Render Yourself An alternative to iOS NSAttributedString DocumentType.html Photo by Florian Olivo [TL;DR] 2023/03/12 Re-developed using another method ...</p></div></div></a></div><div class="col"> <a href="/posts/a5643de271e4/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1677402187" data-df="ll" > Feb 26, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>ZMarkupParser HTML String to NSAttributedString Tool</h4><div class="text-muted small"><p> ZMarkupParser HTML String to NSAttributedString Tool Convert HTML String to NSAttributedString with corresponding Key style settings ZhgChgLi / ZMarkupParser ZhgChgLi / ZMarkupParser Featur...</p></div></div></a></div><div class="col"> <a href="/posts/2981dc0fcd58/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1717253029" data-df="ll" > Jun 1, 2024 </em><h4 class="pt-0 my-2" data-toc-skip>Exploring the Use of NSTextList or NSTextTab for List Indentation with NSAttributedString in iOS</h4><div class="text-muted small"><p> [iOS] Exploring the Use of NSTextList or NSTextTab for List Indentation with NSAttributedString Implementing list indentation similar to HTML List OL/UL/LI using NSTextList or NSTextTab with NSAtt...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/a5643de271e4/" class="btn btn-outline-primary" prompt="Older" ><p>ZMarkupParser HTML String to NSAttributedString Tool</p></a> <a href="/posts/e7c547a5be22/" class="btn btn-outline-primary" prompt="Newer" ><p>ZMediumToJekyll</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">中文版網站</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
