<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Exploring Methods for Implementing iOS HLS Cache" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="How to achieve caching while playing m3u8 streaming video files using AVPlayer" /><meta property="og:description" content="How to achieve caching while playing m3u8 streaming video files using AVPlayer" /><link rel="canonical" href="https://en.zhgchg.li/posts/d796bf8e661e/" /><meta property="og:url" content="https://en.zhgchg.li/posts/d796bf8e661e/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-09T01:12:17+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.jpeg" /><meta property="twitter:title" content="Exploring Methods for Implementing iOS HLS Cache" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2024-04-13T16:09:26+08:00","datePublished":"2020-04-09T01:12:17+08:00","description":"How to achieve caching while playing m3u8 streaming video files using AVPlayer","headline":"Exploring Methods for Implementing iOS HLS Cache","image":"https://en.zhgchg.li/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/d796bf8e661e/"},"url":"https://en.zhgchg.li/posts/d796bf8e661e/"}</script><title>Exploring Methods for Implementing iOS HLS Cache | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Exploring Methods for Implementing iOS HLS Cache</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Exploring Methods for Implementing iOS HLS Cache</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1586365937" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 9, 2020 </em> </span> <span> Updated <em class="" data-ts="1712995766" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 13, 2024 </em> </span><div class="mt-3 mb-3"> <a href="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1923 words" > <em>10 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="exploring-methods-for-implementing-ios-hls-cache"><span class="me-2">Exploring Methods for Implementing iOS HLS Cache</span><a href="#exploring-methods-for-implementing-ios-hls-cache" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>How to achieve caching while playing m3u8 streaming video files using AVPlayer</p><p><a href="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.jpeg" class="popup img-link "><img data-src="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.jpeg" alt="photo by [Mihis Alex](https://www.pexels.com/zh-tw/@mcraftpix?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p>photo by <a href="https://www.pexels.com/zh-tw/@mcraftpix?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" target="_blank">Mihis Alex</a></p><h4 id="20230312-update"><span class="me-2">[2023/03/12] Update</span><a href="#20230312-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>The next article, “<a href="../6ce488898003/">Comprehensive Guide to Implementing Local Cache with AVPlayer</a>”, teaches you how to achieve AVPlayer caching</ul><p><a href="https://github.com/ZhgChgLi/ZPlayerCacher" target="_blank" class="img-link shimmer" ><img data-src="https://repository-images.githubusercontent.com/612890185/346ae563-7278-4518-a19b-f5d367e60adc" alt="" class="lazyload" data-proofer-ignore></a></p><p>I have open-sourced my previous implementation, and those in need can use it directly.</p><ul><li>Customizable cache strategy, you can use PINCache or others…<li>Externally, you only need to call the make AVAsset factory, input the URL, and the AVAsset will support caching<li>Implemented data flow strategy using Combine<li>Wrote some tests</ul><h3 id="about"><span class="me-2">About</span><a href="#about" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>HTTP Live Streaming (HLS) is a streaming media network transmission protocol based on HTTP proposed by Apple.</p><p>For example, when playing music, in a non-streaming situation, we use mp3 as the music file. The larger the file, the longer it takes to download completely before it can be played. HLS, on the other hand, splits a file into multiple small files, playing as it reads. So, once the first segment is received, playback can start without downloading the entire file!</p><p>The <code class="language-plaintext highlighter-rouge">.m3u8</code> file records the bitrate, playback order, time, and other information of these segmented <code class="language-plaintext highlighter-rouge">.ts</code> small files. It can also provide encryption and decryption protection, low-latency live streaming, etc.</p><p>Example of an <code class="language-plaintext highlighter-rouge">.m3u8</code> file (aviciiwakemeup.m3u8):</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>#EXTM3U
#EXT-X-VERSION:3
#EXT-X-ALLOW-CACHE:YES
#EXT-X-TARGETDURATION:10
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:9.900411,
aviciiwakemeup–00001.ts
#EXTINF:9.900400,
aviciiwakemeup–00002.ts
#EXTINF:9.900411,
aviciiwakemeup–00003.ts
#EXTINF:9.900411,
.
.
.
#EXTINF:6.269389,
aviciiwakemeup-00028.ts
#EXT-X-ENDLIST
</pre></table></code></div></div><p><em>*EXT-X-ALLOW-CACHE has been <a href="https://developer.apple.com/documentation/http_live_streaming/about_the_ext-x-version_tag?language=objc" target="_blank">deprecated in iOS≥ 8/Protocol Ver.7</a>. Whether this line is present or not is meaningless.</em></p><h3 id="goal"><span class="me-2">Goal</span><a href="#goal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>For a streaming media service, <strong>Cache is extremely important</strong>; because each audio file can range from a few MBs to several GBs. If every replay requires fetching the file from the server again, it would be very taxing on the server’s loading, and the traffic costs are \(\). Having a Cache layer can save a lot of money for the service, and users won’t have to waste bandwidth and time re-downloading; it’s a win-win mechanism (but remember to set limits/clear periodically to avoid filling up the user’s device).</p><h3 id="problem"><span class="me-2">Problem</span><a href="#problem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In the past, when not dealing with streaming, handling mp3/mp4 was straightforward: download the file to the device before playing, and start playback only after the download is complete. Since the file has to be fully downloaded before playback anyway, we might as well use URLSession to download the file and then feed the local file path (file://) to AVPlayer for playback. Alternatively, the formal way is to use AVAssetResourceLoaderDelegate to cache the downloaded data in the delegate methods.</p><p>For streaming, the idea is also quite straightforward: first read the <code class="language-plaintext highlighter-rouge">.m3u8</code> file, then parse the information inside, and cache each <code class="language-plaintext highlighter-rouge">.ts</code> file. However, implementing this turned out to be more complicated than I imagined, which is why this article exists!</p><p>For playback, we still use iOS AVFoundation’s AVPlayer directly. There is no difference in operation between streaming and non-streaming files.</p><p><strong>Example:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://zhgchg.li/aviciiwakemeup.m3u8"</span><span class="p">)</span>
<span class="k">var</span> <span class="nv">player</span><span class="p">:</span> <span class="kt">AVPlayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="n">player</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
</pre></table></code></div></div><h3 id="20210105-update"><span class="me-2"><strong>2021–01–05 Update:</strong></span><a href="#20210105-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We decided to revert to using mp3 files, so we can directly use <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> for implementation. For detailed implementation, refer to “<a href="../ee47f8f1e2d2/">AVPlayer Streaming Cache Implementation</a>”.</p><h3 id="implementation-solutions"><span class="me-2">Implementation Solutions</span><a href="#implementation-solutions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Several solutions to achieve our goal and the issues encountered during implementation.</p><h4 id="solution-1-avassetresourceloaderdelegate-"><span class="me-2">Solution 1. AVAssetResourceLoaderDelegate ❌</span><a href="#solution-1-avassetresourceloaderdelegate-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The first thought was to follow the same approach as with mp3/mp4 files: use AVAssetResourceLoaderDelegate to cache <code class="language-plaintext highlighter-rouge">.ts</code> files in the delegate methods.</p><p>Unfortunately, this approach doesn’t work because we can’t intercept the download request information for <code class="language-plaintext highlighter-rouge">.ts</code> files in the delegate. This is confirmed in this <a href="https://stackoverflow.com/questions/29752028/unknown-error-12881-when-using-avassetresourceloader/30239876#30239876" target="_blank">Q&amp;A</a> and the <a href="https://developer.apple.com/library/archive/technotes/tn2232/_index.html#//apple_ref/doc/uid/DTS40012884-CH1-SECHTTPLIVESTREAMING" target="_blank">official documentation</a>.</p><p>For AVAssetResourceLoaderDelegate implementation, refer to “<a href="../ee47f8f1e2d2/">AVPlayer Streaming Cache Implementation</a>”.</p><h4 id="solution-21-urlprotocol-intercept-requests-"><span class="me-2">Solution 2.1 URLProtocol Intercept Requests ❌</span><a href="#solution-21-urlprotocol-intercept-requests-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>URLProtocol is a method I recently learned. All requests based on the <code class="language-plaintext highlighter-rouge">URL Loading System</code> (URLSession, API calls, image downloads, etc.) can be intercepted to modify the Request and Response before returning them, making it seem like nothing happened. For more on URLProtocol, refer to <a href="https://www.jianshu.com/p/fbe57730d3e1" target="_blank">this article</a>.</p><p>Using this method, we planned to intercept AVFoundation AVPlayer’s requests for <code class="language-plaintext highlighter-rouge">.m3u8</code> and <code class="language-plaintext highlighter-rouge">.ts</code> files. If there is a local cache, return the cached data directly; otherwise, send the request out. This would achieve our goal.</p><p>Again, unfortunately, this approach doesn’t work either because AVFoundation AVPlayer’s requests are not on the <code class="language-plaintext highlighter-rouge">URL Loading System</code>, so we can’t intercept them. <em>*Some say it works on the simulator but not on the actual device</em></p><h4 id="solution-22-force-it-into-urlprotocol-"><span class="me-2">Solution 2.2 Force it into URLProtocol ❌</span><a href="#solution-22-force-it-into-urlprotocol-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Based on Solution 2.1, a brute-force method: if I change the request URL to a custom scheme (e.g., streetVoiceCache://), AVFoundation won’t be able to handle this request and will throw it out, allowing our URLProtocol to intercept and do what we want.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"streetVoiceCache://zhgchg.li/aviciiwakemeup.m3u8?originScheme=https"</span><span class="p">)</span>
<span class="k">var</span> <span class="nv">player</span><span class="p">:</span> <span class="kt">AVPlayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="n">player</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
</pre></table></code></div></div><p>URLProtocol will intercept <code class="language-plaintext highlighter-rouge">streetVoiceCache://zhgchg.li/aviciiwakemeup.m3u8?originSchme=https</code>, at this point, we just need to restore it to the original URL, then send a URLSession request to fetch the data and handle the cache ourselves here; the <code class="language-plaintext highlighter-rouge">.ts</code> file requests in the m3u8 will also be intercepted by URLProtocol, and similarly, we can handle the cache ourselves here.</p><p>Everything seemed perfect, but when I excitedly Build-Run the APP, Apple slapped me in the face:</p><p><code class="language-plaintext highlighter-rouge">Error: 12881 “CoreMediaErrorDomain custom url not redirect”</code></p><p>It doesn’t accept the Response Data for the <code class="language-plaintext highlighter-rouge">.ts</code> file Request I provided. I can only use the <code class="language-plaintext highlighter-rouge">urlProtocol:wasRedirectedTo</code> method to redirect to the original Https request to play normally, even if I download the <code class="language-plaintext highlighter-rouge">.ts</code> file locally and then redirectTo that file:// file; it still doesn’t accept it. Checking the <a href="https://forums.developer.apple.com/thread/30833" target="_blank">official forum</a> revealed that this approach is not allowed; <code class="language-plaintext highlighter-rouge">.m3u8</code> can only originate from Http/Https (so even if you put the entire <code class="language-plaintext highlighter-rouge">.m3u8</code> and all segmented files <code class="language-plaintext highlighter-rouge">.ts</code> locally, you can’t use file:// to play with AVPlayer), and <code class="language-plaintext highlighter-rouge">.ts</code> cannot use URLProtocol to provide Data.</p><p><code class="language-plaintext highlighter-rouge">fxxk…</code></p><h4 id="solution-222-same-as-solution-22-but-with-solution-1-avassetresourceloaderdelegate-to-implement-"><span class="me-2">Solution 2.2–2 Same as Solution 2.2 but with Solution 1 AVAssetResourceLoaderDelegate to implement ❌</span><a href="#solution-222-same-as-solution-22-but-with-solution-1-avassetresourceloaderdelegate-to-implement-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Implementation is the same as Solution 2.2, feeding AVPlayer a custom Scheme to enter AVAssetResourceLoaderDelegate; then we handle it ourselves.</p><p>Same result as 2.2:</p><p><code class="language-plaintext highlighter-rouge">Error: 12881 “CoreMediaErrorDomain custom url not redirect”</code></p><p><a href="https://forums.developer.apple.com/thread/113063" target="_blank">Official forum</a> gave the same answer.</p><p>It can be used for decryption processing (refer to <a href="https://medium.com/@marslin_dev/how-to-play-aes-encrypted-video-with-airplay-2-82a353044f40" target="_blank">this article</a> or <a href="https://www.jianshu.com/p/2c2cbe173e99" target="_blank">this example</a>) but still cannot achieve Cache functionality.</p><h4 id="solution-3-reverse-proxy-server--feasible-but-not-perfect"><span class="me-2">Solution 3. Reverse Proxy Server ⍻ (Feasible, but not perfect)</span><a href="#solution-3-reverse-proxy-server--feasible-but-not-perfect" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This method is the most commonly suggested solution when looking for ways to handle HLS Cache; it involves setting up an HTTP Server on the APP to act as a Reverse Proxy Server.</p><p>The principle is simple, set up an HTTP Server on the APP, assuming it’s on port 8080, the URL would be <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/</code>; then we can handle the incoming Requests and provide Responses.</p><p>Applying this to our case, change the request URL to: <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/aviciiwakemeup.m3u8?origin=http://zhgchg.li/</code></p><p>In the HTTP Server’s Handler, intercept and handle <code class="language-plaintext highlighter-rouge">*.m3u8</code>, when a Request comes in, it will enter our Handler, and we can do whatever we want, control what Data to Response, and the <code class="language-plaintext highlighter-rouge">.ts</code> files will also come in; here we can implement our desired Cache mechanism.</p><p>For AVPlayer, it’s just a standard http://.m3u8 streaming audio file, so there won’t be any issues.</p><p><strong>For a complete implementation example, refer to:</strong></p><p><a href="https://github.com/StyleShare/HLSCachingReverseProxyServer/blob/master/Sources/HLSCachingReverseProxyServer/HLSCachingReverseProxyServer.swift" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/93ed7435de85f7acaacb173be8dd5f687b50677259f34879d84bdd4aee6468db/StyleShare/HLSCachingReverseProxyServer" alt="" class="lazyload" data-proofer-ignore></a></p><p>Because I also referred to this example, I also used <a href="https://github.com/swisspol/GCDWebServer" target="_blank">GCDWebServer</a> for the Local HTTP Server part. Additionally, there is a newer <a href="https://github.com/Building42/Telegraph" target="_blank">Telegraph</a> available for use. ( <a href="https://github.com/robbiehanson/CocoaHTTPServer" target="_blank">CocoaHttpServer</a> hasn’t been updated for a long time, so it’s not recommended anymore)</p><p><strong>Looks good! But there’s a problem:</strong></p><p>Our service is music streaming rather than a video playback platform. In many cases, users switch music in the background; will the Local HTTP Server still be there then?</p><p>GCDWebServer’s documentation states that it will automatically disconnect when entering the background and automatically resume when returning to the foreground. However, you can disable this mechanism by setting the parameter <code class="language-plaintext highlighter-rouge">GCDWebServerOption_AutomaticallySuspendInBackground:false</code>.</p><p>But in practice, if no requests are sent for a period of time, the server will still disconnect (and the status will be incorrect, still showing as isRunning), which feels like it was killed by the system. After delving into the <a href="https://izeeshan.wordpress.com/2014/08/25/local-http-server-for-ios/" target="_blank">HTTP Server approach</a>, I found that the underlying layer is based on sockets. According to the <a href="https://developer.apple.com/library/archive/technotes/tn2277/_index.html" target="_blank">official documentation on socket services</a>, this issue cannot be resolved. The system will suspend it when there are no new connections in the background.</p><p><em>*There are some convoluted methods found online… like sending a long request or continuously sending empty requests to ensure the server is not suspended by the system in the background.</em></p><p>All of the above applies to the app being in the background. When in the foreground, the server is very stable and won’t be suspended due to idleness, so there’s no such issue!</p><p><strong>Since it relies on other services, even if there are no issues in the development environment, it is recommended to implement a rollback mechanism in actual applications (AVPlayer.AVPlayerItemFailedToPlayToEndTimeErrorKey notification); otherwise, if the service crashes, the user will be stuck.</strong></p><p><code class="language-plaintext highlighter-rouge">So it's not perfect...</code></p><h4 id="solution-4-use-the-http-clients-caching-mechanism-"><span class="me-2">Solution 4. Use the HTTP Client’s caching mechanism ❌</span><a href="#solution-4-use-the-http-clients-caching-mechanism-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Our <code class="language-plaintext highlighter-rouge">.m3u8/.ts</code> files’ Response Headers all provide <code class="language-plaintext highlighter-rouge">Cache-Control</code>, <code class="language-plaintext highlighter-rouge">Age</code>, <code class="language-plaintext highlighter-rouge">eTag</code>… these HTTP Client Cache information. Our website’s cache mechanism works perfectly on Chrome, and the new official <a href="https://developer.apple.com/documentation/http_live_streaming/protocol_extension_for_low-latency_hls_preliminary_specification" target="_blank">Protocol Extension for Low-Latency HLS</a> preliminary specification also mentions that cache-control headers can be set for caching.</p><p><a href="/assets/d796bf8e661e/1*vyvVp1sf9Hbtb_nWiLXYEg.png" class="popup img-link "><img data-src="/assets/d796bf8e661e/1*vyvVp1sf9Hbtb_nWiLXYEg.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>But in practice, AVFoundation AVPlayer does not have any HTTP Client Caching effect, so this route is also a dead end! Pure wishful thinking.</p><h4 id="solution-5-do-not-use-avfoundation-avplayer-to-play-audio-files-"><span class="me-2">Solution 5. Do not use AVFoundation AVPlayer to play audio files ✔</span><a href="#solution-5-do-not-use-avfoundation-avplayer-to-play-audio-files-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Implement audio file parsing, caching, encoding, and playback functionality yourself.</p><p><strong>This is too hardcore, requiring very deep technical skills and a lot of time; not researched.</strong></p><p>Here is an open-source player for reference: <a href="https://github.com/muhku/FreeStreamer" target="_blank">FreeStreamer</a>. If you really choose this solution, it’s better to stand on the shoulders of giants and directly use third-party libraries.</p><h4 id="solution-5-1-do-not-use-hls"><span class="me-2">Solution 5-1. Do not use HLS</span><a href="#solution-5-1-do-not-use-hls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Same as Solution 5, <strong>too hardcore, requiring very deep technical skills and a lot of time; not researched.</strong></p><h4 id="solution-6-convert-ts-segment-files-to-mp3mp4-files-"><span class="me-2">Solution 6. Convert .ts segment files to .mp3/.mp4 files ✔</span><a href="#solution-6-convert-ts-segment-files-to-mp3mp4-files-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Not researched, but indeed feasible. However, it sounds complicated, having to process the downloaded <code class="language-plaintext highlighter-rouge">.ts</code> files, convert them individually to .mp3 or .mp4 files, and then play them in order or compress them into one file or something. It just doesn’t sound easy to do.</p><p>Interested parties can refer to <a href="https://github.com/xyqjay/m3u8ToMP4" target="_blank">this article</a>.</p><h4 id="solution-7-download-the-complete-file-before-playing-"><span class="me-2">Solution 7. Download the complete file before playing ⍻</span><a href="#solution-7-download-the-complete-file-before-playing-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This method cannot be precisely called “caching while playing.” It actually involves downloading the entire audio file content before starting playback. If it is <code class="language-plaintext highlighter-rouge">.m3u8</code>, as mentioned in Solution 2.2, it cannot be directly downloaded and played locally.</p><p>To implement this, you need to use the iOS ≥ 10 API <code class="language-plaintext highlighter-rouge">AVAssetDownloadTask.makeAssetDownloadTask</code>, which will actually package the <code class="language-plaintext highlighter-rouge">.m3u8</code> into <strong><code class="language-plaintext highlighter-rouge">.movpkg</code></strong> and store it locally for user playback.</p><p><strong>This is more like offline playback rather than caching.</strong></p><p>Additionally, users can view and manage the downloaded packaged audio files from “Settings” -&gt; “General” -&gt; “iPhone Storage” -&gt; APP.</p><p><a href="/assets/d796bf8e661e/1*_YNIdy8NRkhVdeDTNvXzxA.jpeg" class="popup img-link "><img data-src="/assets/d796bf8e661e/1*_YNIdy8NRkhVdeDTNvXzxA.jpeg" alt="Below is the downloaded video section" class="lazyload" data-proofer-ignore></a></p><p>Below is the downloaded video section</p><p><strong>For detailed implementation, refer to this example:</strong></p><p><a href="https://github.com/zhonglaoban/HLS-Stream" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/a2ceae202336428494e5cd51b78cfbba3d139c135eaf232b4d2dffd2a7673eba/zhonglaoban/HLS-Stream" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The exploration journey above took almost a whole week, going around in circles, almost driving me crazy. Currently, there is no reliable and easy-to-deploy method.</p><p>If there are new ideas, I will update!</p><h4 id="references"><span class="me-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="http://msching.github.io/blog/2016/05/24/audio-in-ios-9/" target="_blank">iOS Audio Playback (Nine): Caching While Playing</a><li><a href="https://github.com/StyleShare/HLSCachingReverseProxyServer" target="_blank">StyleShare/HLSCachingReverseProxyServer</a></ul><p>If you have any questions or comments, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>===</p><p><a href="https://zhgchg.li/posts/d796bf8e661e/" target="_blank">本文中文版本</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ➡️ <a href="https://medium.com/p/d796bf8e661e" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=🍺&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/zrealm/'>ZRealm</a>, <a href='/categories/dev/'>Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/hls/" class="post-tag no-text-decoration" >hls</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/reverse-proxy/" class="post-tag no-text-decoration" >reverse-proxy</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Exploring%20Methods%20for%20Implementing%20iOS%20HLS%20Cache%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fd796bf8e661e%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Exploring%20Methods%20for%20Implementing%20iOS%20HLS%20Cache%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fd796bf8e661e%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fd796bf8e661e%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/5033090c18ba/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1722160385" data-df="ll" > Jul 28, 2024 </em><h4 class="pt-0 my-2" data-toc-skip>Research on Preloading and Caching Page and File Resources in iOS WKWebView</h4><div class="text-muted small"><p> Research on Preloading and Caching Page and File Resources in iOS WKWebView Study on improving page loading speed by preloading and caching resources in iOS WKWebView. Photo by Antoine Gravier ...</p></div></div></a></div><div class="col"> <a href="/posts/6ce488898003/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1612089702" data-df="ll" > Jan 31, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>Comprehensive Guide to Implementing Local Cache with AVPlayer</h4><div class="text-muted small"><p> Comprehensive Guide to Implementing Local Cache with AVPlayer AVPlayer/AVQueuePlayer with AVURLAsset implementing AVAssetResourceLoaderDelegate Photo by Tyler Lastovich [2023/03/12] Update I...</p></div></div></a></div><div class="col"> <a href="/posts/ee47f8f1e2d2/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1609856872" data-df="ll" > Jan 5, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>AVPlayer Real-time Cache Implementation</h4><div class="text-muted small"><p> [Old] AVPlayer Real-time Cache Implementation Understanding the implementation of AVPlayer/AVQueuePlayer with AVURLAsset using AVAssetResourceLoaderDelegate [2021–01–31] Article Announcement: Art...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/7498e1ff93ce/" class="btn btn-outline-primary" prompt="Older" ><p>First Experience with iOS Reverse Engineering</p></a> <a href="/posts/99db2a1fbfe5/" class="btn btn-outline-primary" prompt="Newer" ><p>Creating a Comfortable WFH Smart Home Environment, Control Appliances at Your Fingertips</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">中文版網站</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
