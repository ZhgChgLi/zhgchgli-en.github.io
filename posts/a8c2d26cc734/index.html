<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Implementing iOS NSAttributedString HTML Render Yourself" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="An alternative to iOS NSAttributedString DocumentType.html" /><meta property="og:description" content="An alternative to iOS NSAttributedString DocumentType.html" /><link rel="canonical" href="https://en.zhgchg.li/posts/a8c2d26cc734/" /><meta property="og:url" content="https://en.zhgchg.li/posts/a8c2d26cc734/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-10T00:11:59+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.jpeg" /><meta property="twitter:title" content="Implementing iOS NSAttributedString HTML Render Yourself" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2024-04-14T10:07:40+08:00","datePublished":"2022-06-10T00:11:59+08:00","description":"An alternative to iOS NSAttributedString DocumentType.html","headline":"Implementing iOS NSAttributedString HTML Render Yourself","image":"https://en.zhgchg.li/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/a8c2d26cc734/"},"url":"https://en.zhgchg.li/posts/a8c2d26cc734/"}</script><title>Implementing iOS NSAttributedString HTML Render Yourself | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Implementing iOS NSAttributedString HTML Render Yourself</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Implementing iOS NSAttributedString HTML Render Yourself</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1654791119" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jun 10, 2022 </em> </span> <span> Updated <em class="" data-ts="1713060460" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 14, 2024 </em> </span><div class="mt-3 mb-3"> <a href="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="4851 words" > <em>26 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="implementing-ios-nsattributedstring-html-render-yourself"><span class="me-2">Implementing iOS NSAttributedString HTML Render Yourself</span><a href="#implementing-ios-nsattributedstring-html-render-yourself" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>An alternative to iOS NSAttributedString DocumentType.html</p><p><a href="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.jpeg" class="popup img-link "><img data-src="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.jpeg" alt="Photo by [Florian Olivo](https://unsplash.com/@florianolv?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p>Photo by <a href="https://unsplash.com/@florianolv?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Florian Olivo</a></p><h3 id="tldr-20230312"><span class="me-2">[TL;DR] 2023/03/12</span><a href="#tldr-20230312" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Re-developed using another method <em>「 <a href="../a5643de271e4/"><strong>ZMarkupParser HTML String to NSAttributedString Tool</strong></a> 」</em> , for technical details and development stories, please visit 「 <a href="../2724f02f6e7/">The Story of Handcrafting an HTML Parser</a> 」</p><h3 id="origin"><span class="me-2">Origin</span><a href="#origin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Since the release of iOS 15 last year, the app has been plagued by a crash issue that has topped the charts for a long time. According to the data, in the past 90 days (2022/03/11~2022/06/08), it caused over 2.4K crashes, affecting over 1.4K users.</p><p><a href="/assets/a8c2d26cc734/1*r--z0J1P6t5ECfVyb5_OxQ.png" class="popup img-link "><img data-src="/assets/a8c2d26cc734/1*r--z0J1P6t5ECfVyb5_OxQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p>From the data, it appears that this massive crash issue has been fixed (or the occurrence rate has been reduced) in subsequent versions of iOS ≥ 15.2, as the trend is showing a decline.</p></blockquote><p><strong>Most affected versions:</strong> iOS 15.0.X ~ iOS 15.X.X</p><p>Additionally, there were sporadic crashes found in iOS 12 and iOS 13, indicating that this issue has existed for a long time, but the occurrence rate in the early versions of iOS 15 was almost 100%.</p><h4 id="crash-cause"><span class="me-2">Crash Cause:</span><a href="#crash-cause" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/a8c2d26cc734/1*vKmvralAmDrhWrXYLHpspw.png" class="popup img-link "><img data-src="/assets/a8c2d26cc734/1*vKmvralAmDrhWrXYLHpspw.png" alt="" class="lazyload" data-proofer-ignore></a></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>&lt;compiler-generated&gt; line 2147483647 specialized @nonobjc NSAttributedString.init(data:options:documentAttributes:)
</pre></table></code></div></div><p>NSAttributedString crashes during init with <code class="language-plaintext highlighter-rouge">Crashed: com.apple.main-thread EXC_BREAKPOINT 0x00000001de9d4e44</code>.</p><blockquote><p>It is also possible that the operation was not on the Main Thread.</p></blockquote><h4 id="reproduction-method"><span class="me-2">Reproduction Method:</span><a href="#reproduction-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>When this issue first appeared massively, it puzzled the development team; re-testing the crash points in the Crash Log showed no problems, and it was unclear under what circumstances the users encountered the issue. Until one day, by chance, I switched to “Low Power Mode” and triggered the issue! <strong>WTF!!!</strong></p><p><a href="/assets/a8c2d26cc734/1*gVfmnCN7QcHO90Y7HyntbA.gif" class="popup img-link "><img data-src="/assets/a8c2d26cc734/1*gVfmnCN7QcHO90Y7HyntbA.gif" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="solution"><span class="me-2">Solution</span><a href="#solution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After some searching, I found many similar cases online and also found the earliest similar <a href="https://developer.apple.com/forums/thread/115405" target="_blank">crash issue question</a> on the App Developer Forums, with an official response:</p><p><a href="/assets/a8c2d26cc734/1*XmZuJf4Rtk4chiBx8_yMXw.png" class="popup img-link "><img data-src="/assets/a8c2d26cc734/1*XmZuJf4Rtk4chiBx8_yMXw.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li>This is a known iOS Foundation Bug: It has existed since iOS 12<li>To render complex HTML without rendering constraints: use WKWebView<li><strong>With rendering constraints: you can write your own HTML Parser &amp; Renderer</strong><li>Directly use Markdown as rendering constraints: iOS ≥ 15 NSAttributedString can <a href="https://developer.apple.com/documentation/foundation/nsattributedstring/3796598-init" target="_blank">directly render text using Markdown format</a></ul><blockquote><p><strong>Rendering constraints</strong> means limiting the rendering formats that the app can support, such as only supporting <strong>bold</strong>, italic, <a href="https://zhgchg.li" target="_blank">hyperlinks</a>.</p></blockquote><h4 id="supplement-rendering-complex-html--aiming-to-create-text-wrapping-effects"><span class="me-2">Supplement. Rendering complex HTML — aiming to create text wrapping effects</span><a href="#supplement-rendering-complex-html--aiming-to-create-text-wrapping-effects" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>You can coordinate with the backend to create an interface:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"content"</span><span class="p">:[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"Paragraph 1 plain text"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"Paragraph 2 plain text"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"Paragraph 3 plain text"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"Paragraph 4 plain text"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"image"</span><span class="p">,</span><span class="nl">"src"</span><span class="p">:</span><span class="s2">"https://zhgchg.li/logo.png"</span><span class="p">,</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"ZhgChgLi"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"Paragraph 5 plain text"</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>You can combine it with Markdown to support text rendering, or refer to Medium’s approach:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nl">"Paragraph"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"code in text, and link in text, and ZhgChgLi, and bold, and I, only i"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"markups"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CODE"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w">
        </span><span class="nl">"href"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://zhgchg.li"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LINK"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"STRONG"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">63</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EM"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">69</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>This means that for the text <code class="language-plaintext highlighter-rouge">code in text, and link in text, and ZhgChgLi, and bold, and I, only i</code>:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>- Characters 5 to 7 should be marked as code (wrapped in `Text` format)
- Characters 18 to 22 should be marked as a link (wrapped in [Text](URL) format)
- Characters 50 to 63 should be marked as bold (wrapped in *Text* format)
- Characters 55 to 69 should be marked as italic (wrapped in _Text_ format)
</pre></table></code></div></div><p>With a standardized and describable structure, the app can use native methods to render, achieving optimal performance and user experience.</p><blockquote><p>For the pitfalls of using UITextView for text wrapping, you can refer to my previous article: <a href="../e37d66ea1146/">iOS UITextView Text Wrapping Editor (Swift)</a></p></blockquote><h3 id="why"><span class="me-2">Why?</span><a href="#why" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before implementing the solution, let’s first explore the problem itself. Personally, I believe the main cause of this issue is not from Apple; the official bug is just the trigger point.</p><p>The main problem comes from <strong>treating the app as a web renderer</strong>. The advantage is that web development is fast, the same API endpoint can provide HTML to all clients without distinction, and it can flexibly render any content. The disadvantage is that HTML is not a common interface for apps, you can’t expect app engineers to understand HTML, <strong>performance is extremely poor</strong>, it can only run on the main thread, the development stage cannot predict the result, and it is difficult to confirm the supported specifications.</p><p>Looking further into the problem, it often stems from unclear original requirements, uncertainty about which specifications the app needs to support, and the pursuit of speed, leading to the direct use of HTML as the interface between the app and the web.</p><h4 id="extremely-poor-performance"><span class="me-2"><strong>Extremely poor performance</strong></span><a href="#extremely-poor-performance" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Supplementing the performance part, actual tests show that directly using <code class="language-plaintext highlighter-rouge">NSAttributedString DocumentType.html</code> and implementing the rendering method yourself has a speed difference of 5 to 20 times.</p><h4 id="better"><span class="me-2">Better</span><a href="#better" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Since it is for App use, a better approach should be based on App development methods. For Apps, the cost of adjusting requirements is much higher than for the Web; effective App development should be based on iterative adjustments with specifications. At the moment, we need to confirm the specifications that can be supported. If we need to change them later, we will schedule time to expand the specifications. We cannot quickly change them as we wish, which can reduce communication costs and increase work efficiency.</p><ul><li>Confirm the scope of requirements<li>Confirm the supported specifications<li>Confirm the interface specifications (Markdown/BBCode/… can continue to use HTML, but it must be constrained, such as only using <code class="language-plaintext highlighter-rouge">&lt;b&gt;/&lt;i&gt;/&lt;a&gt;/&lt;u&gt;</code>, and it must be <strong>explicitly informed</strong> to the developers in the program)<li>Implement the rendering mechanism yourself<li>Maintain and iteratively support the specifications</ul><h3 id="20230227-updated-tldr"><span class="me-2">[2023/02/27 Updated] [TL;DR]:</span><a href="#20230227-updated-tldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Updated approach, no longer using XMLParser, due to zero tolerance for errors:</p><p><code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;b&gt;Bold&lt;i&gt;Bold+Italic&lt;/b&gt;Italic&lt;/i&gt;</code> The above three possible scenarios will all cause XMLParser to throw an error and display blank. Using XMLParser, the HTML string must fully comply with XML rules, unlike browsers or NSAttributedString.DocumentType.html which can tolerate errors and display normally.</p><p><a href="https://medium.com/zrealm-ios-dev/zmarkupparser-html-string-%E8%BD%89%E6%8F%9B-nsattributedstring-%E5%B7%A5%E5%85%B7-a5643de271e4" target="_blank" class="img-link shimmer" ><img data-src="https://miro.medium.com/v2/resize:fit:1200/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>Switch to pure Swift development, parsing HTML tags through Regex and Tokenization, analyzing and correcting tag correctness (correcting tags without end &amp; misplaced tags), then converting them into an abstract syntax tree, and finally using the Visitor Pattern to map HTML tags to abstract styles, obtaining the final NSAttributedString result; without relying on any Parser Lib.</p><p>— —</p><h3 id="how"><span class="me-2">How?</span><a href="#how" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The die is cast, back to the main topic. Currently, we are using HTML to render <code class="language-plaintext highlighter-rouge">NSAttributedString</code>, so how do we solve the above crash and performance issues?</p><h4 id="inspired-by"><span class="me-2">Inspired by</span><a href="#inspired-by" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/malcommac/SwiftRichString" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/b56d0fc90ef4faed72873ca671bd7410777f857181c21be94bfdbda5aa5fa1f0/malcommac/SwiftRichString" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="strip-html"><span class="me-2">Strip HTML</span><a href="#strip-html" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before talking about HTML Render, let’s talk about Strip HTML again. As mentioned in the <code class="language-plaintext highlighter-rouge">Why?</code> section, where the App will get HTML and what kind of HTML it will get should be specified in the specifications; rather than the App “ <strong>possibly</strong> “ getting HTML and needing to strip it.</p><blockquote><p>As a former supervisor said: Isn’t this too crazy?</p></blockquote><h4 id="option-1-nsattributedstring"><span class="me-2">Option 1. NSAttributedString</span><a href="#option-1-nsattributedstring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="s">"&lt;div&gt;Text&lt;/div&gt;"</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">unicode</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">attributed</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="nv">documentType</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">DocumentType</span><span class="o">.</span><span class="n">html</span><span class="p">,</span> <span class="o">.</span><span class="nv">characterEncoding</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="o">.</span><span class="n">rawValue</span><span class="p">],</span> <span class="nv">documentAttributes</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="n">attributed</span><span class="o">.</span><span class="n">string</span>
</pre></table></code></div></div><ul><li>Use NSAttributedString to render HTML and then extract the string to get a clean String<li>The same issues as in this chapter, iOS 15 is prone to crashes, poor performance, and can only be operated on the Main Thread</ul><h4 id="option-2-regex"><span class="me-2">Option 2. Regex</span><a href="#option-2-regex" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">htmlString</span> <span class="o">=</span> <span class="s">"&lt;div&gt;Test&lt;/div&gt;"</span>
<span class="n">htmlString</span><span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"&lt;[^&gt;]+&gt;"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="o">.</span><span class="n">regularExpression</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</pre></table></code></div></div><ul><li>The simplest and most effective way<li>Regex cannot guarantee complete correctness e.g. <code class="language-plaintext highlighter-rouge">&lt;p foo="&gt;now what?"&gt;Paragraph&lt;/p&gt;</code> is valid HTML but will be stripped incorrectly</ul><h4 id="option-3-xmlparser"><span class="me-2">Option 3. XMLParser</span><a href="#option-3-xmlparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Refer to the approach of <a href="https://github.com/malcommac/SwiftRichString" target="_blank">SwiftRichString</a>, using <strong><a href="https://developer.apple.com/documentation/foundation/xmlparser" target="_blank">XMLParser</a></strong> from Foundation to parse HTML as XML and implement HTML Parser &amp; Strip functionality.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="c1">// Ref: https://github.com/malcommac/SwiftRichString</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">HTMLStripper</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">XMLParserDelegate</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="k">let</span> <span class="nv">topTag</span> <span class="o">=</span> <span class="s">"source"</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">xmlParser</span><span class="p">:</span> <span class="kt">XMLParser</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">storedString</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="c1">// The XML parser sometimes splits strings, which can break localization-sensitive</span>
    <span class="c1">// string transforms. Work around this by using the currentString variable to</span>
    <span class="c1">// accumulate partial strings, and then reading them back out as a single string</span>
    <span class="c1">// when the current element ends, or when a new one is started.</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">currentString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    
    <span class="c1">// MARK: - Initialization</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">xmlString</span> <span class="o">=</span> <span class="kt">HTMLStripper</span><span class="o">.</span><span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">xml</span> <span class="o">=</span> <span class="s">"&lt;</span><span class="se">\(</span><span class="kt">HTMLStripper</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;</span><span class="se">\(</span><span class="n">xmlString</span><span class="se">)</span><span class="s">&lt;/</span><span class="se">\(</span><span class="kt">HTMLStripper</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;"</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">XMLParserInitError</span><span class="p">(</span><span class="s">"Unable to convert to UTF8"</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">xmlParser</span> <span class="o">=</span> <span class="kt">XMLParser</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">storedString</span> <span class="o">=</span> <span class="s">""</span>
        
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldProcessNamespaces</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldReportNamespacePrefixes</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldResolveExternalEntities</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="c1">/// Parse and generate attributed string.</span>
    <span class="kd">func</span> <span class="nf">parse</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">xmlParser</span><span class="o">.</span><span class="nf">parse</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">line</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">lineNumber</span>
            <span class="k">let</span> <span class="nv">shiftColumn</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">shiftSize</span> <span class="o">=</span> <span class="kt">HTMLStripper</span><span class="o">.</span><span class="n">topTag</span><span class="o">.</span><span class="nf">lengthOfBytes</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">let</span> <span class="nv">column</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">columnNumber</span> <span class="o">-</span> <span class="p">(</span><span class="n">shiftColumn</span> <span class="p">?</span> <span class="nv">shiftSize</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">throw</span> <span class="kt">XMLParserError</span><span class="p">(</span><span class="nv">parserError</span><span class="p">:</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">parserError</span><span class="p">,</span> <span class="nv">line</span><span class="p">:</span> <span class="n">line</span><span class="p">,</span> <span class="nv">column</span><span class="p">:</span> <span class="n">column</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">storedString</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: XMLParserDelegate</span>
    
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didStartElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">attributes</span> <span class="nv">attributeDict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didEndElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">foundCharacters</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">currentString</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentString</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: Support Private Methods</span>
    
    <span class="kd">func</span> <span class="nf">foundNewString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">currentString</span> <span class="o">=</span> <span class="n">currentString</span> <span class="p">{</span>
            <span class="n">storedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">currentString</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">currentString</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// handle html entity / html hex</span>
    <span class="c1">// Perform string escaping to replace all characters which is not supported by NSXMLParser</span>
    <span class="c1">// into the specified encoding with decimal entity.</span>
    <span class="c1">// For example if your string contains '&amp;' character parser will break the style.</span>
    <span class="c1">// This option is active by default.</span>
    <span class="c1">// ref: https://github.com/malcommac/SwiftRichString/blob/e0b72d5c96968d7802856d2be096202c9798e8d1/Sources/SwiftRichString/Support/XMLStringBuilder.swift</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">escapeAmpRegExp</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="s">"&amp;(?!(#[0-9]{2,4}|[A-z]{2,6});)"</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">Options</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">string</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">escapeAmpRegExp</span><span class="o">.</span><span class="nf">stringByReplacingMatches</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span>
                                                        <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">MatchingOptions</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">),</span>
                                                        <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span>
                                                        <span class="nv">withTemplate</span><span class="p">:</span> <span class="s">"&amp;amp;"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">let</span> <span class="nv">test</span> <span class="o">=</span> <span class="s">"我&lt;br/&gt;&lt;a href=</span><span class="se">\"</span><span class="s">http://google.com</span><span class="se">\"</span><span class="s">&gt;同意&lt;/a&gt;提供&lt;b&gt;&lt;i&gt;個&lt;/i&gt;人&lt;/b&gt;身分證字號／護照／居留&lt;span style=</span><span class="se">\"</span><span class="s">color:#FF0000;font-size:20px;word-spacing:10px;line-height:10px</span><span class="se">\"</span><span class="s">&gt;證號碼&lt;/span&gt;，以供&lt;i&gt;跨境物流&lt;/i&gt;方通關&lt;span style=</span><span class="se">\"</span><span class="s">background-color:#00FF00;</span><span class="se">\"</span><span class="s">&gt;使用&lt;/span&gt;，並已&lt;img src=</span><span class="se">\"</span><span class="s">g.png</span><span class="se">\"</span><span class="s">/&gt;了解跨境&lt;br/&gt;商品之物&lt;p&gt;流需&lt;/p&gt;求"</span>

<span class="k">let</span> <span class="nv">stripper</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">HTMLStripper</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">test</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="k">try!</span> <span class="n">stripper</span><span class="o">.</span><span class="nf">parse</span><span class="p">())</span>

<span class="c1">// I agree to provide personal ID number/passport/residence permit number for cross-border logistics customs clearance, and have understood the logistics requirements of cross-border goods.</span>
</pre></table></code></div></div><p>Using Foundation XML Parser to handle String, implement <code class="language-plaintext highlighter-rouge">XMLParserDelegate</code> using <code class="language-plaintext highlighter-rouge">currentString</code> to store String, since String may sometimes be split into multiple Strings, <code class="language-plaintext highlighter-rouge">foundCharacters</code> might be called repeatedly. <code class="language-plaintext highlighter-rouge">didStartElement</code> and <code class="language-plaintext highlighter-rouge">didEndElement</code> are used to find the start and end of the string, storing the current result and clearing <code class="language-plaintext highlighter-rouge">currentString</code>.</p><ul><li>The advantage is that it also converts HTML Entity to actual characters e.g. <code class="language-plaintext highlighter-rouge">&amp;#103; -&gt; g</code><li>The disadvantage is that it is complex to implement and will fail with XMLParser when encountering non-compliant HTML e.g. <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> should be written as <code class="language-plaintext highlighter-rouge">&lt;br/&gt;</code></ul><blockquote><p>Personally, I think <strong>Option 2 is a better method</strong> for simply stripping HTML. This method is introduced because rendering HTML also uses the same principle. Let’s use this as a simple example :)</p></blockquote><h3 id="html-render-wxmlparser"><span class="me-2">HTML Render w/XMLParser</span><a href="#html-render-wxmlparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Using XMLParser to implement it yourself, following the same principle as stripping, we can add corresponding rendering methods when parsing certain tags.</p><p>Requirements:</p><ul><li>Support for extending the tags to be parsed<li>Support for setting Tag Default Style e.g. applying link style to <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> Tag<li>Support for parsing <code class="language-plaintext highlighter-rouge">style</code> attributes, as HTML will explicitly indicate the style to be displayed in <code class="language-plaintext highlighter-rouge">style="color:red"</code><li>Style support for changing text weight, size, underline, line spacing, letter spacing, background color, text color<li>Does not support Image Tag, Table Tag, etc., more complex TAGs</ul><blockquote><p>You can reduce functionality according to your own requirements, for example, if you don’t need to support background color adjustment, you don’t need to open the setting for background color.</p></blockquote><blockquote><p>This article is just a conceptual implementation, <strong>not the best practice in architecture</strong>; if you have clear specifications and usage, you can consider applying some Design Patterns to achieve good maintainability and extensibility.</p></blockquote><h3 id="️️️-attention-️️️"><span class="me-2">⚠️⚠️⚠️ Attention ⚠️⚠️⚠️</span><a href="#️️️-attention-️️️" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Again, <strong>if your App is new or has the opportunity to switch entirely to Markdown format, it is recommended to adopt the above method. Writing your own renderer is too complex and will not perform better than Markdown</strong>.</p><blockquote><p>Even if you are on iOS &lt; 15 and do not support native Markdown, you can still find <a href="https://github.com/chockenberry/MarkdownAttributedString" target="_blank">a great Markdown Parser solution on Github</a>.</p></blockquote><h4 id="htmltagparser"><span class="me-2">HTMLTagParser</span><a href="#htmltagparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">HTMLTagParser</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">tag</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span> <span class="c1">// Declare the Tag Name to be parsed, e.g. a</span>
    <span class="k">var</span> <span class="nv">storedHTMLAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span> <span class="c1">// The parsed attributes will be stored here, e.g. href, style</span>
    <span class="k">var</span> <span class="nv">style</span><span class="p">:</span> <span class="kt">AttributedStringStyle</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span> <span class="c1">// The style to be applied to this Tag</span>
    
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="c1">// Implement the logic to render HTML to attributedString</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Declare the analyzable HTML Tag entity for easy extension and management.</p><h4 id="attributedstringstyle"><span class="me-2">AttributedStringStyle</span><a href="#attributedstringstyle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">AttributedStringStyle</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">font</span><span class="p">:</span> <span class="kt">UIFont</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">color</span><span class="p">:</span> <span class="kt">UIColor</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">backgroundColor</span><span class="p">:</span> <span class="kt">UIColor</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">wordSpacing</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">paragraphStyle</span><span class="p">:</span> <span class="kt">NSParagraphStyle</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">customs</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span> <span class="c1">// Universal setting, it is recommended to abstract it out after confirming the supported specifications and close this opening</span>
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// abstract implement</span>
<span class="kd">extension</span> <span class="kt">AttributedStringStyle</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">font</span> <span class="o">=</span> <span class="n">font</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">font</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">font</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="n">color</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">foregroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">backgroundColor</span> <span class="o">=</span> <span class="n">backgroundColor</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">backgroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">backgroundColor</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">wordSpacing</span> <span class="o">=</span> <span class="n">wordSpacing</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">kern</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">wordSpacing</span> <span class="k">as</span> <span class="kt">Any</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">paragraphStyle</span> <span class="o">=</span> <span class="n">paragraphStyle</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">customAttributes</span> <span class="o">=</span> <span class="n">customs</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttributes</span><span class="p">(</span><span class="n">customAttributes</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Declare the styles that can be set for the Tag.</p><h4 id="htmlstyleattributedparser"><span class="me-2">HTMLStyleAttributedParser</span><a href="#htmlstyleattributedparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre><span class="c1">// only support tag attributed down below</span>
<span class="c1">// can set color,font size,line height,word spacing,background color</span>

<span class="kd">enum</span> <span class="kt">HTMLStyleAttributedParser</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">color</span> <span class="o">=</span> <span class="s">"color"</span>
    <span class="k">case</span> <span class="n">fontSize</span> <span class="o">=</span> <span class="s">"font-size"</span>
    <span class="k">case</span> <span class="n">lineHeight</span> <span class="o">=</span> <span class="s">"line-height"</span>
    <span class="k">case</span> <span class="n">wordSpacing</span> <span class="o">=</span> <span class="s">"word-spacing"</span>
    <span class="k">case</span> <span class="n">backgroundColor</span> <span class="o">=</span> <span class="s">"background-color"</span>
    
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">color</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="nf">convertToiOSColor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">foregroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">backgroundColor</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="nf">convertToiOSColor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">backgroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">fontSize</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">font</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">UIFont</span><span class="o">.</span><span class="nf">systemFont</span><span class="p">(</span><span class="nv">ofSize</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">size</span><span class="p">)),</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">lineHeight</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">paragraphStyle</span> <span class="o">=</span> <span class="kt">NSMutableParagraphStyle</span><span class="p">()</span>
                <span class="n">paragraphStyle</span><span class="o">.</span><span class="n">lineSpacing</span> <span class="o">=</span> <span class="n">size</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">wordSpacing</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">kern</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    
    <span class="c1">// convert 36px -&gt; 36</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">regex</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="s">"^([0-9]+)"</span><span class="p">),</span>
              <span class="k">let</span> <span class="nv">firstMatch</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="nf">firstMatch</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span><span class="p">)),</span>
              <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">Range</span><span class="p">(</span><span class="n">firstMatch</span><span class="o">.</span><span class="n">range</span><span class="p">,</span> <span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">),</span>
              <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="kt">Float</span><span class="p">(</span><span class="kt">String</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">range</span><span class="p">]))</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">// convert html hex color #ffffff to UIKit Color</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">convertToiOSColor</span><span class="p">(</span><span class="n">_</span> <span class="nv">hexString</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UIColor</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">cString</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">hexString</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span><span class="o">.</span><span class="nf">uppercased</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cString</span><span class="o">.</span><span class="nf">hasPrefix</span><span class="p">(</span><span class="s">"#"</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cString</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">cString</span><span class="o">.</span><span class="n">startIndex</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cString</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>

        <span class="k">var</span> <span class="nv">rgbValue</span><span class="p">:</span> <span class="kt">UInt64</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="kt">Scanner</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">cString</span><span class="p">)</span><span class="o">.</span><span class="nf">scanHexInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rgbValue</span><span class="p">)</span>

        <span class="k">return</span> <span class="kt">UIColor</span><span class="p">(</span>
            <span class="nv">red</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">((</span><span class="n">rgbValue</span> <span class="o">&amp;</span> <span class="mh">0xFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
            <span class="nv">green</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">((</span><span class="n">rgbValue</span> <span class="o">&amp;</span> <span class="mh">0x00FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
            <span class="nv">blue</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">rgbValue</span> <span class="o">&amp;</span> <span class="mh">0x0000FF</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
            <span class="nv">alpha</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Implement Style Attributed Parser to parse <code class="language-plaintext highlighter-rouge">style="color:red;font-size:16px"</code> but CSS Style has many configurable styles, so it is necessary to enumerate the supported range.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">HTMLTagParser</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">defaultStyleRender</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">attributedString</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">defaultStyleRender</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// setup default style to NSMutableAttributedString</span>
        <span class="n">style</span><span class="p">?</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">attributedString</span><span class="p">)</span>
        
        <span class="c1">// setup &amp; override HTML style (style="color:red;background-color:black") to NSMutableAttributedString if is exists</span>
        <span class="c1">// any html tag can have style attribute</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">style</span> <span class="o">=</span> <span class="n">storedHTMLAttributes</span><span class="p">?[</span><span class="s">"style"</span><span class="p">]</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">styles</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">";"</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">":"</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">}</span>
            <span class="k">for</span> <span class="n">style</span> <span class="k">in</span> <span class="n">styles</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">key</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">style</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">style</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">styleAttributed</span> <span class="o">=</span> <span class="kt">HTMLStyleAttributedParser</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">key</span><span class="p">),</span> <span class="n">styleAttributed</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">attributedString</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Unsupported style attributed or value[</span><span class="se">\(</span><span class="n">key</span><span class="se">)</span><span class="s">:</span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">]"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Apply HTMLStyleAttributedParser &amp; HTMLStyleAttributedParser abstract implementation.</p><h4 id="some-examples-of-tag-parser--attributedstringstyle-implementation"><span class="me-2">Some examples of Tag Parser &amp; AttributedStringStyle implementation</span><a href="#some-examples-of-tag-parser--attributedstringstyle-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre>struct LinkStyle: AttributedStringStyle {
   var font: UIFont? = UIFont.systemFont(ofSize: 14)
   var color: UIColor? = UIColor.blue
   var backgroundColor: UIColor? = nil
   var wordSpacing: CGFloat? = nil
   var paragraphStyle: NSParagraphStyle?
   var customs: [NSAttributedString.Key: Any]? = [.underlineStyle: NSUnderlineStyle.single.rawValue]
}

struct ATagParser: HTMLTagParser {
    // &lt;a&gt;&lt;/a&gt;
    static let tag: String = "a"
    var storedHTMLAttributes: [String: String]? = nil
    let style: AttributedStringStyle? = LinkStyle()
    
    func render(attributedString: inout NSMutableAttributedString) {
        defaultStyleRender(attributedString: &amp;attributedString)
        if let href = storedHTMLAttributes?["href"], let url = URL(string: href) {
            let range = NSMakeRange(0, attributedString.length)
            attributedString.addAttribute(NSAttributedString.Key.link, value: url, range: range)
        }
    }
}
struct BoldStyle: AttributedStringStyle {
   var font: UIFont? = UIFont.systemFont(ofSize: 14, weight: .bold)
   var color: UIColor? = UIColor.black
   var backgroundColor: UIColor? = nil
   var wordSpacing: CGFloat? = nil
   var paragraphStyle: NSParagraphStyle?
   var customs: [NSAttributedString.Key: Any]? = [.underlineStyle: NSUnderlineStyle.single.rawValue]
}

struct BoldTagParser: HTMLTagParser {
    // &lt;b&gt;&lt;/b&gt;
    static let tag: String = "b"
    var storedHTMLAttributes: [String: String]? = nil
    let style: AttributedStringStyle? = BoldStyle()
}
</pre></table></code></div></div><h4 id="htmltoattributedstringparser-xmlparserdelegate-core-implementation"><span class="me-2">HTMLToAttributedStringParser: XMLParserDelegate core implementation</span><a href="#htmltoattributedstringparser-xmlparserdelegate-core-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
</pre><td class="rouge-code"><pre><span class="c1">// Ref: https://github.com/malcommac/SwiftRichString</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">HTMLToAttributedStringParser</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="k">let</span> <span class="nv">topTag</span> <span class="o">=</span> <span class="s">"source"</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">xmlParser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">?</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSMutableAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">()</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">supportedTagRenders</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagParser</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">defaultStyle</span><span class="p">:</span> <span class="kt">AttributedStringStyle</span>
    
    <span class="c1">/// Styles applied at each fragment.</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">renderingTagRenders</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagParser</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">// The XML parser sometimes splits strings, which can break localization-sensitive</span>
    <span class="c1">// string transforms. Work around this by using the currentString variable to</span>
    <span class="c1">// accumulate partial strings, and then reading them back out as a single string</span>
    <span class="c1">// when the current element ends, or when a new one is started.</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">currentString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    
    <span class="c1">// MARK: - Initialization</span>

    <span class="nf">init</span><span class="p">(</span><span class="n">defaultStyle</span><span class="p">:</span> <span class="kt">AttributedStringStyle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">defaultStyle</span> <span class="o">=</span> <span class="n">defaultStyle</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">register</span><span class="p">(</span><span class="n">_</span> <span class="nv">tagRender</span><span class="p">:</span> <span class="kt">HTMLTagParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">tagRender</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="p">})</span> <span class="p">{</span>
            <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tagRender</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">/// Parse and generate attributed string.</span>
    <span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">xmlString</span> <span class="o">=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        
        <span class="c1">// make sure &lt;br/&gt; format is correct XML</span>
        <span class="c1">// because Web may use &lt;br&gt; to present &lt;br/&gt;, but &lt;br&gt; is not a valid XML</span>
        <span class="n">xmlString</span> <span class="o">=</span> <span class="n">xmlString</span><span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"&lt;br&gt;"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">xml</span> <span class="o">=</span> <span class="s">"&lt;</span><span class="se">\(</span><span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;</span><span class="se">\(</span><span class="n">xmlString</span><span class="se">)</span><span class="s">&lt;/</span><span class="se">\(</span><span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;"</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">XMLParserInitError</span><span class="p">(</span><span class="s">"Unable to convert to UTF8"</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">xmlParser</span> <span class="o">=</span> <span class="kt">XMLParser</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldProcessNamespaces</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldReportNamespacePrefixes</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldResolveExternalEntities</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="k">self</span><span class="o">.</span><span class="n">xmlParser</span> <span class="o">=</span> <span class="n">xmlParser</span>
        
        <span class="n">attributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">()</span>
        
        <span class="k">guard</span> <span class="n">xmlParser</span><span class="o">.</span><span class="nf">parse</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">line</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">lineNumber</span>
            <span class="k">let</span> <span class="nv">shiftColumn</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">shiftSize</span> <span class="o">=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span><span class="o">.</span><span class="nf">lengthOfBytes</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">let</span> <span class="nv">column</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">columnNumber</span> <span class="o">-</span> <span class="p">(</span><span class="n">shiftColumn</span> <span class="p">?</span> <span class="nv">shiftSize</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">throw</span> <span class="kt">XMLParserError</span><span class="p">(</span><span class="nv">parserError</span><span class="p">:</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">parserError</span><span class="p">,</span> <span class="nv">line</span><span class="p">:</span> <span class="n">line</span><span class="p">,</span> <span class="nv">column</span><span class="p">:</span> <span class="n">column</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">attributedString</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: Private Method</span>

<span class="kd">private</span> <span class="kd">extension</span> <span class="kt">HTMLToAttributedStringParser</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">enter</span><span class="p">(</span><span class="n">element</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// elementName = tagName, EX: a,span,div...</span>
        <span class="k">guard</span> <span class="n">elementName</span> <span class="o">!=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">elementName</span> <span class="p">})</span> <span class="p">{</span>
            <span class="k">var</span> <span class="nv">tagRender</span> <span class="o">=</span> <span class="n">supportedTagRenders</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">tagRender</span><span class="o">.</span><span class="n">storedHTMLAttributes</span> <span class="o">=</span> <span class="n">attributes</span>
            <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tagRender</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">exit</span><span class="p">(</span><span class="n">element</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">renderingTagRenders</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">{</span>
            <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">removeLast</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">foundNewString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">currentString</span> <span class="o">=</span> <span class="n">currentString</span> <span class="p">{</span>
            <span class="c1">// currentString != nil ,ex: &lt;i&gt;currentString&lt;/i&gt;</span>
            <span class="k">var</span> <span class="nv">newAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">currentString</span><span class="p">)</span>
            <span class="k">if</span> <span class="o">!</span><span class="n">renderingTagRenders</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tagRender</span><span class="p">)</span> <span class="k">in</span> <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">enumerated</span><span class="p">()</span> <span class="p">{</span>
                    <span class="c1">// Render Style</span>
                    <span class="n">tagRender</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">newAttributedString</span><span class="p">)</span>
                    <span class="n">renderingTagRenders</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">storedHTMLAttributes</span> <span class="o">=</span> <span class="kc">nil</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">defaultStyle</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">newAttributedString</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">newAttributedString</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">currentString</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// currentString == nil ,ex: &lt;br/&gt;</span>
            <span class="k">var</span> <span class="nv">newAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">()</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tagRender</span><span class="p">)</span> <span class="k">in</span> <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">enumerated</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// Render Style</span>
                <span class="n">tagRender</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">newAttributedString</span><span class="p">)</span>
                <span class="n">renderingTagRenders</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">storedHTMLAttributes</span> <span class="o">=</span> <span class="kc">nil</span>
            <span class="p">}</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">newAttributedString</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: Helper</span>

<span class="kd">extension</span> <span class="kt">HTMLToAttributedStringParser</span> <span class="p">{</span>
    <span class="c1">// handle html entity / html hex</span>
    <span class="c1">// Perform string escaping to replace all characters which is not supported by NSXMLParser</span>
    <span class="c1">// into the specified encoding with decimal entity.</span>
    <span class="c1">// For example if your string contains '&amp;' character parser will break the style.</span>
    <span class="c1">// This option is active by default.</span>
    <span class="c1">// ref: https://github.com/malcommac/SwiftRichString/blob/e0b72d5c96968d7802856d2be096202c9798e8d1/Sources/SwiftRichString/Support/XMLStringBuilder.swift</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">escapeAmpRegExp</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="s">"&amp;(?!(#[0-9]{2,4}|[A-z]{2,6});)"</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">Options</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">string</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">escapeAmpRegExp</span><span class="o">.</span><span class="nf">stringByReplacingMatches</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span>
                                                        <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">MatchingOptions</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">),</span>
                                                        <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span>
                                                        <span class="nv">withTemplate</span><span class="p">:</span> <span class="s">"&amp;amp;"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: XMLParserDelegate</span>

<span class="kd">extension</span> <span class="kt">HTMLToAttributedStringParser</span><span class="p">:</span> <span class="kt">XMLParserDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didStartElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">attributes</span> <span class="nv">attributeDict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
        <span class="nf">enter</span><span class="p">(</span><span class="nv">element</span><span class="p">:</span> <span class="n">elementName</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">attributeDict</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didEndElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
        <span class="k">guard</span> <span class="n">elementName</span> <span class="o">!=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="nf">exit</span><span class="p">(</span><span class="nv">element</span><span class="p">:</span> <span class="n">elementName</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">foundCharacters</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">currentString</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentString</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Applying the logic of Strip, we can combine the parsed structure by knowing the current Tag from <code class="language-plaintext highlighter-rouge">elementName</code> and applying the corresponding Tag Parser and defined Style.</p><h4 id="test-result"><span class="me-2">Test Result</span><a href="#test-result" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">test</span> <span class="o">=</span> <span class="s">"我&lt;br/&gt;&lt;a href=</span><span class="se">\"</span><span class="s">http://google.com</span><span class="se">\"</span><span class="s">&gt;同意&lt;/a&gt;提供&lt;b&gt;&lt;i&gt;個&lt;/i&gt;人&lt;/b&gt;身分證字號／護照／居留&lt;span style=</span><span class="se">\"</span><span class="s">color:#FF0000;font-size:20px;word-spacing:10px;line-height:10px</span><span class="se">\"</span><span class="s">&gt;證號碼&lt;/span&gt;，以供&lt;i&gt;跨境物流&lt;/i&gt;方通關&lt;span style=</span><span class="se">\"</span><span class="s">background-color:#00FF00;</span><span class="se">\"</span><span class="s">&gt;使用&lt;/span&gt;，並已&lt;img src=</span><span class="se">\"</span><span class="s">g.png</span><span class="se">\"</span><span class="s">/&gt;了解跨境&lt;br/&gt;商品之物&lt;p&gt;流需&lt;/p&gt;求"</span>
<span class="k">let</span> <span class="nv">render</span> <span class="o">=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="p">(</span><span class="n">defaultStyle</span><span class="p">:</span> <span class="kt">DefaultTextStyle</span><span class="p">())</span>
<span class="n">render</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">ATagParser</span><span class="p">())</span>
<span class="n">render</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">BoldTagParser</span><span class="p">())</span>
<span class="n">render</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">SpanTagParser</span><span class="p">())</span>
<span class="c1">//...</span>
<span class="nf">print</span><span class="p">(</span><span class="k">try!</span> <span class="n">render</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">test</span><span class="p">))</span>

<span class="c1">// Result:</span>
<span class="c1">// 我{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }同意{</span>
<span class="c1">//     NSColor = "UIExtendedSRGBColorSpace 0 0 1 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSLink = "http://google.com";</span>
<span class="c1">//     NSUnderline = 1;</span>
<span class="c1">// }提供{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }個{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Bold 14.00 pt. P [] (0x13a013870) fobj=0x13a013870, spc=3.46\"";</span>
<span class="c1">//     NSUnderline = 1;</span>
<span class="c1">// }人身分證字號／護照／居留{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }證號碼{</span>
<span class="c1">//     NSColor = "UIExtendedSRGBColorSpace 1 0 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 20.00 pt. P [] (0x13a015fa0) fobj=0x13a015fa0, spc=4.82\"";</span>
<span class="c1">//     NSKern = 10;</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 10, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }，以供跨境物流方通關{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }使用{</span>
<span class="c1">//     NSBackgroundColor = "UIExtendedSRGBColorSpace 0 1 0 1";</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }，並已了解跨境商品之物流需求{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }</span>
</pre></table></code></div></div><p><strong>Display Result:</strong></p><p><a href="/assets/a8c2d26cc734/1*LaKhRLhHm2jfptG4h_jB5Q.png" class="popup img-link "><img data-src="/assets/a8c2d26cc734/1*LaKhRLhHm2jfptG4h_jB5Q.png" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="done"><span class="me-2">Done!</span><a href="#done" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We have now completed implementing the HTML Render function through XMLParser, maintaining both extensibility and specification. This allows us to manage and understand the types of string rendering supported by the current App from the code.</p><h3 id="complete-github-repo-as-follows"><span class="me-2">Complete Github Repo as follows</span><a href="#complete-github-repo-as-follows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/zhgchgli0718/HTMLToAttributedStringRednerExample" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/c021159c3da82c37ff65d210c7a64aa4e56e398964b824baf4f248bb25bdb805/zhgchgli0718/HTMLToAttributedStringRednerExample" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p><em>This article is also published on my personal Blog: <a href="../a8c2d26cc734/"><strong>[Click here to visit]</strong></a>.</em></p></blockquote><blockquote><p><em>For any questions or feedback, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</em></p></blockquote><p>===</p><p><a href="https://zhgchg.li/posts/a8c2d26cc734/" target="_blank">本文中文版本</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ➡️ <a href="https://medium.com/p/a8c2d26cc734" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=🍺&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/zrealm/'>ZRealm</a>, <a href='/categories/dev/'>Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/nsattributedstring/" class="post-tag no-text-decoration" >nsattributedstring</a> <a href="/tags/html-parsing/" class="post-tag no-text-decoration" >html-parsing</a> <a href="/tags/html/" class="post-tag no-text-decoration" >html</a> <a href="/tags/markdown/" class="post-tag no-text-decoration" >markdown</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Implementing%20iOS%20NSAttributedString%20HTML%20Render%20Yourself%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fa8c2d26cc734%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Implementing%20iOS%20NSAttributedString%20HTML%20Render%20Yourself%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fa8c2d26cc734%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Fa8c2d26cc734%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/a5643de271e4/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1677402187" data-df="ll" > Feb 26, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>ZMarkupParser HTML String to NSAttributedString Tool</h4><div class="text-muted small"><p> ZMarkupParser HTML String to NSAttributedString Tool Convert HTML String to NSAttributedString with corresponding Key style settings ZhgChgLi / ZMarkupParser ZhgChgLi / ZMarkupParser Featur...</p></div></div></a></div><div class="col"> <a href="/posts/2724f02f6e7/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1678554562" data-df="ll" > Mar 12, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>The Craft of Building a Handmade HTML Parser</h4><div class="text-muted small"><p> The Craft of Building a Handmade HTML Parser The development log of ZMarkupParser HTML to NSAttributedString rendering engine Tokenization conversion of HTML String, Normalization processing, gen...</p></div></div></a></div><div class="col"> <a href="/posts/e7c547a5be22/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1679078827" data-df="ll" > Mar 18, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>ZMediumToJekyll</h4><div class="text-muted small"><p> ZMediumToJekyll Move your Medium posts to a Jekyll blog and keep them in sync in the future. This tool can help you move your Medium posts to a Jekyll blog and keep them in sync in the future...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ddd88a84e177/" class="btn btn-outline-primary" prompt="Older" ><p>Converting Medium Posts to Markdown</p></a> <a href="/posts/60473cb47550/" class="btn btn-outline-primary" prompt="Newer" ><p>Visitor Pattern in TableView</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">中文版網站</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
