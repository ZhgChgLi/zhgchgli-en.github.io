<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Practical Application Record of Design Patterns—In WKWebView with Builder, Strategy &amp; Chain of Responsibility Pattern" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Scenarios of using Design Patterns (Strategy, Chain of Responsibility, Builder Pattern) when encapsulating iOS WKWebView." /><meta property="og:description" content="Scenarios of using Design Patterns (Strategy, Chain of Responsibility, Builder Pattern) when encapsulating iOS WKWebView." /><link rel="canonical" href="https://en.zhgchg.li/posts/f4b02ee342a4/" /><meta property="og:url" content="https://en.zhgchg.li/posts/f4b02ee342a4/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/f4b02ee342a4/1*pwh6uN0WQNWPa8zmSSyMXA.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-09-06T13:47:47+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/f4b02ee342a4/1*pwh6uN0WQNWPa8zmSSyMXA.jpeg" /><meta property="twitter:title" content="Practical Application Record of Design Patterns—In WKWebView with Builder, Strategy &amp; Chain of Responsibility Pattern" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2024-09-07T16:45:32+08:00","datePublished":"2024-09-06T13:47:47+08:00","description":"Scenarios of using Design Patterns (Strategy, Chain of Responsibility, Builder Pattern) when encapsulating iOS WKWebView.","headline":"Practical Application Record of Design Patterns—In WKWebView with Builder, Strategy &amp; Chain of Responsibility Pattern","image":"https://en.zhgchg.li/assets/f4b02ee342a4/1*pwh6uN0WQNWPa8zmSSyMXA.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/f4b02ee342a4/"},"url":"https://en.zhgchg.li/posts/f4b02ee342a4/"}</script><title>Practical Application Record of Design Patterns—In WKWebView with Builder, Strategy & Chain of Responsibility Pattern | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Practical Application Record of Design Patterns—In WKWebView with Builder, Strategy & Chain of Responsibility Pattern</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Practical Application Record of Design Patterns—In WKWebView with Builder, Strategy & Chain of Responsibility Pattern</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1725601667" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 6, 2024 </em> </span> <span> Updated <em class="" data-ts="1725698732" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 7, 2024 </em> </span><div class="mt-3 mb-3"> <a href="/assets/f4b02ee342a4/1*pwh6uN0WQNWPa8zmSSyMXA.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/f4b02ee342a4/1*pwh6uN0WQNWPa8zmSSyMXA.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3604 words" > <em>20 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="practical-application-record-of-design-patternsin-wkwebview-with-builder-strategy--chain-of-responsibility-pattern"><span class="me-2">Practical Application Record of Design Patterns—In WKWebView with Builder, Strategy &amp; Chain of Responsibility Pattern</span><a href="#practical-application-record-of-design-patternsin-wkwebview-with-builder-strategy--chain-of-responsibility-pattern" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Scenarios of using Design Patterns (Strategy, Chain of Responsibility, Builder Pattern) when encapsulating iOS WKWebView.</p><p><a href="/assets/f4b02ee342a4/1*pwh6uN0WQNWPa8zmSSyMXA.jpeg" class="popup img-link "><img data-src="/assets/f4b02ee342a4/1*pwh6uN0WQNWPa8zmSSyMXA.jpeg" alt="Photo by [Dean Pugh](https://unsplash.com/@wezlar11?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p>Photo by <a href="https://unsplash.com/@wezlar11?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" target="_blank">Dean Pugh</a></p><h3 id="about-design-patterns"><span class="me-2">About Design Patterns</span><a href="#about-design-patterns" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before discussing Design Patterns, it is worth mentioning that the most classic GoF 23 design patterns were published 30 years ago (in 1994). With changes in tools, languages, and software development patterns, many new design patterns have emerged in various fields. Design Patterns are not a universal solution or the only solution. Their existence is more like a “linguistic term” where the appropriate design pattern is applied in suitable scenarios, reducing obstacles in development collaboration. For example, applying the Strategy pattern here allows future maintainers to iterate directly according to the structure of the Strategy pattern, and design patterns mostly decouple well, providing significant assistance in scalability and testability.</p><h4 id="guidelines-for-using-design-patterns"><span class="me-2"><strong>Guidelines for Using Design Patterns</strong></span><a href="#guidelines-for-using-design-patterns" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Not the only solution<li>Not a universal solution<li>Avoid forcing patterns; choose the appropriate design pattern based on the type of problem to be solved (creation? behavior? structure?) and the purpose<li>Avoid arbitrary modifications, as this can lead to misunderstandings by future maintainers. Just like how everyone calls Apple “Apple,” if you define it as “Banana,” it becomes an additional development cost that needs special knowledge<li>Avoid using keywords unnecessarily; for example, if the Factory Pattern is conventionally named <code class="language-plaintext highlighter-rouge">XXXFactory</code>, it should not be used unless it is a factory pattern<li><strong>Be cautious about creating new patterns</strong>. Although there are only 23 classic patterns, the evolution in various fields over the years has introduced many new patterns. It is advisable to first refer to online resources to find suitable patterns (after all, three mediocre craftsmen surpass one Zhuge Liang). If no suitable pattern is found, propose a new design pattern and publish it for review and adjustment by people in different fields and contexts<li>Ultimately, code is written for human maintenance. As long as it is easy to maintain and extend, design patterns are not always necessary<li>Team consensus on Design Patterns is essential for their effective use<li>Design Patterns can be combined with other Design Patterns<li>Practical experience is crucial for mastering Design Patterns and understanding when to apply them appropriately</ul><h4 id="auxiliary-tool-chatgpt"><span class="me-2">Auxiliary Tool ChatGPT</span><a href="#auxiliary-tool-chatgpt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/f4b02ee342a4/1*gs1hW3YcAkpTgvzzz0lMkQ.png" class="popup img-link "><img data-src="/assets/f4b02ee342a4/1*gs1hW3YcAkpTgvzzz0lMkQ.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>With ChatGPT, learning the practical application of Design Patterns has become easier. Just provide a detailed description of your problem, ask which design patterns are suitable for the scenario, and it can suggest several potentially suitable patterns with explanations. While not every answer may be perfect, it provides viable directions. By delving into these patterns and combining them with your practical scenarios, you can ultimately choose a good solution!</p><h3 id="practical-application-scenarios-of-design-patterns-in-wkwebview"><span class="me-2">Practical Application Scenarios of Design Patterns in WKWebView</span><a href="#practical-application-scenarios-of-design-patterns-in-wkwebview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This Design Patterns practical application is to converge the functionality of the WKWebView object in the current Codebase and develop a unified WKWebView component. The experience of applying Design Patterns at appropriate logical abstraction points when developing the WKWebView component is shared.</p><blockquote><p><em>The complete demo project code will be attached at the end of the document.</em></p></blockquote><h3 id="original-unabstracted-implementation"><span class="me-2">Original Unabstracted Implementation</span><a href="#original-unabstracted-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">WKWebViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

    <span class="c1">// MARK - Define some variables and switches for injecting features during external initialization...</span>

    <span class="c1">// Simulate business logic: Switch to match special paths to open native pages</span>
    <span class="k">let</span> <span class="nv">noNeedNativePresent</span><span class="p">:</span> <span class="kt">Bool</span>
    <span class="c1">// Simulate business logic: Switch for DeeplinkManager check</span>
    <span class="k">let</span> <span class="nv">deeplinkCheck</span><span class="p">:</span> <span class="kt">Bool</span>
    <span class="c1">// Simulate business logic: Is it the homepage?</span>
    <span class="k">let</span> <span class="nv">isHomePage</span><span class="p">:</span> <span class="kt">Bool</span>
    <span class="c1">// Simulate business logic: Scripts to inject into WKWebView as WKUserScript</span>
    <span class="k">let</span> <span class="nv">userScripts</span><span class="p">:</span> <span class="p">[</span><span class="kt">WKUserScript</span><span class="p">]</span>
    <span class="c1">// Simulate business logic: Scripts to inject into WKWebView as WKScriptMessageHandler</span>
    <span class="k">let</span> <span class="nv">scriptMessageHandlers</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">WKScriptMessageHandler</span><span class="p">]</span>
    <span class="c1">// Override ViewController Title with Title obtained from WebView</span>
    <span class="k">let</span> <span class="nv">overrideTitleFromWebView</span><span class="p">:</span> <span class="kt">Bool</span>
    
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
    
    <span class="c1">// ... </span>
<span class="p">}</span>
<span class="c1">// ...</span>
<span class="kd">extension</span> <span class="kt">OldWKWebViewController</span><span class="p">:</span> <span class="kt">WKNavigationDelegate</span> <span class="p">{</span>
    <span class="c1">// MARK - iOS WKWebView's navigationAction Delegate, used to determine how to handle the upcoming link</span>
    <span class="c1">// Must call decisionHandler(.allow) or decisionHandler(.cancel) at the end</span>
    <span class="c1">// decisionHandler(.cancel) will interrupt loading the upcoming page</span>

    <span class="c1">// Different variables and switches have different logic processing here:</span>

    <span class="kd">func</span> <span class="nf">webView</span><span class="p">(</span><span class="n">_</span> <span class="nv">webView</span><span class="p">:</span> <span class="kt">WKWebView</span><span class="p">,</span> <span class="n">decidePolicyFor</span> <span class="nv">navigationAction</span><span class="p">:</span> <span class="kt">WKNavigationAction</span><span class="p">,</span> <span class="nv">decisionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">WKNavigationActionPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">navigationAction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="c1">// Simulate business logic: WebViewController deeplinkCheck == true (indicating the need to check with DeepLinkManager and open the page)</span>
        <span class="k">if</span> <span class="n">deeplinkCheck</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"DeepLinkManager.open(</span><span class="se">\(</span><span class="n">url</span><span class="o">.</span><span class="n">absoluteString</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="c1">// Simulate DeepLinkManager logic, open the URL if successful and end the process.</span>
            <span class="c1">// if DeepLinkManager.open(url) == true {</span>
                <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1">// }</span>
        <span class="p">}</span>
        
        <span class="c1">// Simulate business logic: WebViewController isHomePage == true (indicating the homepage) &amp; WebView is browsing the homepage, switch TabBar Index</span>
        <span class="k">if</span> <span class="n">isHomePage</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">absoluteString</span> <span class="o">==</span> <span class="s">"https://zhgchg.li"</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Switch UITabBarController to Index 0"</span><span class="p">)</span>
                <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// Simulate business logic: WebViewController noNeedNativePresent == false (indicating the need to match special paths to open native pages)</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">noNeedNativePresent</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">pathComponents</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">pathComponents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"product"</span> <span class="p">{</span>
                    <span class="c1">// match http://zhgchg.li/product/1234</span>
                    <span class="k">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">pathComponents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Present ProductViewController(</span><span class="se">\(</span><span class="n">id</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                    <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">pathComponents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"shop"</span> <span class="p">{</span>
                    <span class="c1">// match http://zhgchg.li/shop/1234</span>
                    <span class="k">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">pathComponents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Present ShopViewController(</span><span class="se">\(</span><span class="n">id</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                    <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="c1">// more...</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</pre></table></code></div></div><h4 id="issues"><span class="me-2">Issues</span><a href="#issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>Setting variables and switches in the Class makes it unclear which ones are for configuration.<li>Exposing WKUserScript variables directly to the outside, we want to control the injected JS and only allow injection of specific behaviors.<li>Unable to control the registration rules of WKScriptMessageHandler.<li>If you need to initialize a similar WebView, you need to repeatedly write the injection parameter rules, and the parameter rules cannot be reused.<li>The <code class="language-plaintext highlighter-rouge">navigationAction Delegate</code> controls the flow internally based on variables. If you need to delete or modify the flow or sequence, you have to modify the entire code, which may disrupt the originally normal flow.</ol><h3 id="builder-pattern"><span class="me-2">Builder Pattern</span><a href="#builder-pattern" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/f4b02ee342a4/1*NvnrtRMn05Wo45QeQ221LA.png" class="popup img-link "><img data-src="/assets/f4b02ee342a4/1*NvnrtRMn05Wo45QeQ221LA.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p><em>The Builder Pattern is a <strong>creational</strong> design pattern that separates the construction steps and logic of creating an object. The operator can set parameters step by step and reuse the settings, and finally create the target object. Additionally, the same construction steps can create different object implementations.</em></p></blockquote><p>Using the example of making a Pizza in the image above, the steps of making a Pizza are broken down into several methods and declared in the <code class="language-plaintext highlighter-rouge">PizzaBuilder</code> protocol (Interface). <code class="language-plaintext highlighter-rouge">ConcretePizzaBuilder</code> is the actual object that makes the Pizza, which could be <code class="language-plaintext highlighter-rouge">VegetarianPizzaBuilder</code> &amp; <code class="language-plaintext highlighter-rouge">MeatPizzaBuilder</code>; different builders may have different ingredients, but they all ultimately <code class="language-plaintext highlighter-rouge">build()</code> to produce a <code class="language-plaintext highlighter-rouge">Pizza</code> object.</p><h4 id="wkwebview-scenario"><span class="me-2">WKWebView Scenario</span><a href="#wkwebview-scenario" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>In the WKWebView scenario, our final output object is <code class="language-plaintext highlighter-rouge">MyWKWebViewConfiguration</code>. We consolidate all the variables that <code class="language-plaintext highlighter-rouge">WKWebView</code> needs to set into this object and use the Builder Pattern <code class="language-plaintext highlighter-rouge">MyWKWebViewConfigurator</code> to gradually complete the construction of the Configuration.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MyWKWebViewConfiguration</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">headNavigationHandler</span><span class="p">:</span> <span class="kt">NavigationActionHandler</span><span class="p">?</span>
    <span class="k">let</span> <span class="nv">scriptMessageStrategies</span><span class="p">:</span> <span class="p">[</span><span class="kt">ScriptMessageStrategy</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">userScripts</span><span class="p">:</span> <span class="p">[</span><span class="kt">WKUserScript</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">overrideTitleFromWebView</span><span class="p">:</span> <span class="kt">Bool</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
<span class="p">}</span>
<span class="c1">// All parameters are only exposed internally within the module</span>
</pre></table></code></div></div><h4 id="mywkwebviewconfigurator-builder-pattern"><span class="me-2">MyWKWebViewConfigurator (Builder Pattern)</span><a href="#mywkwebviewconfigurator-builder-pattern" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/f4b02ee342a4/1*ZKpTThUiS8ZkV3jbpmWylw.png" class="popup img-link "><img data-src="/assets/f4b02ee342a4/1*ZKpTThUiS8ZkV3jbpmWylw.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p><em>Since I only have the need to Build for MyWKWebView here, I did not further break down <code class="language-plaintext highlighter-rouge">MyWKWebViewConfigurator</code> into multiple Protocols (Interfaces).</em></p></blockquote><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">MyWKWebViewConfigurator</span> <span class="p">{</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">headNavigationHandler</span><span class="p">:</span> <span class="kt">NavigationActionHandler</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">overrideTitleFromWebView</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">disableZoom</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">scriptMessageStrategies</span><span class="p">:</span> <span class="p">[</span><span class="kt">ScriptMessageStrategy</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        
    <span class="p">}</span>
    
    <span class="c1">// Encapsulate parameters, internal control</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">disableZoom</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">disableZoom</span> <span class="o">=</span> <span class="n">disableZoom</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">overrideTitleFromWebView</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">overrideTitleFromWebView</span> <span class="o">=</span> <span class="n">overrideTitleFromWebView</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">headNavigationHandler</span><span class="p">:</span> <span class="kt">NavigationActionHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">headNavigationHandler</span> <span class="o">=</span> <span class="n">headNavigationHandler</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="c1">// Can encapsulate additional logic rules inside</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">add</span><span class="p">(</span><span class="nv">scriptMessageStrategy</span><span class="p">:</span> <span class="kt">ScriptMessageStrategy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">scriptMessageStrategies</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">scriptMessageStrategy</span><span class="p">)</span><span class="o">.</span><span class="n">identifier</span> <span class="p">})</span>
        <span class="n">scriptMessageStrategies</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">scriptMessageStrategy</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">build</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">MyWKWebViewConfiguration</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">userScripts</span><span class="p">:[</span><span class="kt">WKUserScript</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">// Attach only when generating</span>
        <span class="k">if</span> <span class="n">disableZoom</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">script</span> <span class="o">=</span> <span class="s">"var meta = document.createElement('meta'); meta.name='viewport'; meta.content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'; document.getElementsByTagName('head')[0].appendChild(meta);"</span>
            <span class="k">let</span> <span class="nv">disableZoomScript</span> <span class="o">=</span> <span class="kt">WKUserScript</span><span class="p">(</span><span class="nv">source</span><span class="p">:</span> <span class="n">script</span><span class="p">,</span> <span class="nv">injectionTime</span><span class="p">:</span> <span class="o">.</span><span class="n">atDocumentEnd</span><span class="p">,</span> <span class="nv">forMainFrameOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
            <span class="n">userScripts</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">disableZoomScript</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="kt">MyWKWebViewConfiguration</span><span class="p">(</span><span class="nv">headNavigationHandler</span><span class="p">:</span> <span class="n">headNavigationHandler</span><span class="p">,</span> <span class="nv">scriptMessageStrategies</span><span class="p">:</span> <span class="n">scriptMessageStrategies</span><span class="p">,</span> <span class="nv">userScripts</span><span class="p">:</span> <span class="n">userScripts</span><span class="p">,</span> <span class="nv">overrideTitleFromWebView</span><span class="p">:</span> <span class="n">overrideTitleFromWebView</span><span class="p">,</span> <span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><a href="/assets/f4b02ee342a4/1*nD3Dc6Gxksr6vS6t2TXH-A.png" class="popup img-link "><img data-src="/assets/f4b02ee342a4/1*nD3Dc6Gxksr6vS6t2TXH-A.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Adding an extra layer can also better control the usage permissions of Access Control for isolating parameters. In this scenario, we still want to be able to directly inject <code class="language-plaintext highlighter-rouge">WKUserScript</code> into <code class="language-plaintext highlighter-rouge">MyWKWebView</code>, but we don’t want to leave the door wide open for users to inject at will. Therefore, combining the Builder Pattern with Swift Access Control, after <code class="language-plaintext highlighter-rouge">MyWKWebView</code> has been placed in a Module, <code class="language-plaintext highlighter-rouge">MyWKWebViewConfigurator</code> encapsulates externally as an operation method <code class="language-plaintext highlighter-rouge">func set(disableZoom: Bool)</code>, internally generating <code class="language-plaintext highlighter-rouge">MyWKWebViewConfiguration</code> with attached <code class="language-plaintext highlighter-rouge">WKUserScript</code>. All parameters of <code class="language-plaintext highlighter-rouge">MyWKWebViewConfiguration</code> are immutable externally and can only be generated through <code class="language-plaintext highlighter-rouge">MyWKWebViewConfigurator</code>.</p><h4 id="mywkwebviewconfigurator--simple-factory-simple-factory"><span class="me-2">MyWKWebViewConfigurator + Simple Factory Simple Factory</span><a href="#mywkwebviewconfigurator--simple-factory-simple-factory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Once we have the <code class="language-plaintext highlighter-rouge">MyWKWebViewConfigurator</code> Builder, we can create a simple factory to encapsulate and reuse the construction steps.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">MyWKWebViewConfiguratorFactory</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="n">ForType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="err">`</span><span class="k">default</span><span class="err">`</span>
        <span class="k">case</span> <span class="n">productPage</span>
        <span class="k">case</span> <span class="n">payment</span>
    <span class="p">}</span>
    
    <span class="k">static</span> <span class="n">func</span> <span class="nf">make</span><span class="p">(</span><span class="k">for</span> <span class="n">type</span><span class="p">:</span> <span class="n">ForType</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">MyWKWebViewConfigurator</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">type</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="k">default</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">MyWKWebViewConfigurator</span><span class="p">()</span>
                <span class="p">.</span><span class="k">add</span><span class="p">(</span><span class="n">scriptMessageStrategy</span><span class="p">:</span> <span class="nf">PageScriptMessageStrategy</span><span class="p">())</span>
                <span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">overrideTitleFromWebView</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
                <span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">disableZoom</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">productPage</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Self</span><span class="p">.</span><span class="nf">make</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="p">.</span><span class="k">default</span><span class="p">).</span><span class="k">set</span><span class="p">(</span><span class="n">disableZoom</span><span class="p">:</span> <span class="k">true</span><span class="p">).</span><span class="k">set</span><span class="p">(</span><span class="n">overrideTitleFromWebView</span><span class="p">:</span> <span class="k">true</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">payment</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">MyWKWebViewConfigurator</span><span class="p">().</span><span class="k">set</span><span class="p">(</span><span class="n">headNavigationHandler</span><span class="p">:</span> <span class="n">paymentNavigationActionHandler</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="chain-of-responsibility-pattern"><span class="me-2">Chain of Responsibility Pattern</span><a href="#chain-of-responsibility-pattern" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/f4b02ee342a4/1*C0nmAQ9UzwMQ0vnAr8p2Ag.png" class="popup img-link "><img data-src="/assets/f4b02ee342a4/1*C0nmAQ9UzwMQ0vnAr8p2Ag.png" alt="" class="lazyload" data-proofer-ignore></a></p><blockquote><p><em>The Chain of Responsibility Pattern belongs to the <strong>behavioral</strong> design pattern, encapsulating object handling operations and chaining them together in a linked structure. The request operation will be passed along the chain until it is handled; the chained encapsulated operations can be flexibly combined and the order changed.</em></p></blockquote><blockquote><p><strong><em>The Chain of Responsibility focuses on whether you want to handle something that comes in, if not, then skip it</em></strong>, <em>so it cannot handle halfway or modify the input object and pass it to the next; if this is the requirement, it is another <a href="https://stackoverflow.com/questions/7951306/chain-of-responsibility-vs-interceptor" target="_blank">Interceptor Pattern</a>.</em></p></blockquote><p>The diagram above uses Tech Support (or OnCall…) as an example. When a problem object comes in, it first goes through <code class="language-plaintext highlighter-rouge">CustomerService</code>. If it cannot handle it, it is passed down to the next level, <code class="language-plaintext highlighter-rouge">Supervisor</code>. If it still cannot handle it, it continues down to <code class="language-plaintext highlighter-rouge">TechSupport</code>. Additionally, different responsibility chains can be formed for different issues. For example, if it is a problem from a major client, it will be handled directly from <code class="language-plaintext highlighter-rouge">Supervisor</code>. In the <a href="https://www.appcoda.com.tw/responder-chain/" target="_blank">Swift UIKit Responder Chain</a>, the Chain of Responsibility pattern is also used to respond to user operations on the UI.</p><h4 id="wkwebview-scenario-1"><span class="me-2">WKWebView Scenario</span><a href="#wkwebview-scenario-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>In our WKWebView scenario, it is mainly applied in the <code class="language-plaintext highlighter-rouge">func webView(_ webView: WKWebView, decidePolicyFor navigationAction: WKNavigationAction, decisionHandler: @escaping (WKNavigationActionPolicy) -&gt; Void)</code> delegate method.</p><blockquote><p><em>When the system receives a URL request, it will go through this method for us to decide whether to allow the redirection, and call <code class="language-plaintext highlighter-rouge">decisionHandler(.allow)</code> or <code class="language-plaintext highlighter-rouge">decisionHandler(.cancel)</code> at the end to inform the result.</em></p></blockquote><p><strong>In the implementation of WKWebView, there will be many judgments or page handling that are different from others and need to be bypassed:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="c1">// Original implementation...</span>
<span class="kd">func</span> <span class="nf">webView</span><span class="p">(</span><span class="n">_</span> <span class="nv">webView</span><span class="p">:</span> <span class="kt">WKWebView</span><span class="p">,</span> <span class="n">decidePolicyFor</span> <span class="nv">navigationAction</span><span class="p">:</span> <span class="kt">WKNavigationAction</span><span class="p">,</span> <span class="nv">decisionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">WKNavigationActionPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">navigationAction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="c1">// Simulated business logic: WebViewController deeplinkCheck == true (indicating the need to check and open the page through DeepLinkManager)</span>
        <span class="k">if</span> <span class="n">deeplinkCheck</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"DeepLinkManager.open(</span><span class="se">\(</span><span class="n">url</span><span class="o">.</span><span class="n">absoluteString</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="c1">// Simulated DeepLinkManager logic, open the URL if successful and end the process.</span>
            <span class="c1">// if DeepLinkManager.open(url) == true {</span>
                <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c1">// }</span>
        <span class="p">}</span>
        
        <span class="c1">// Simulated business logic: WebViewController isHomePage == true (indicating the home page is open) &amp; WebView is browsing the homepage, then switch TabBar Index</span>
        <span class="k">if</span> <span class="n">isHomePage</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">absoluteString</span> <span class="o">==</span> <span class="s">"https://zhgchg.li"</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Switch UITabBarController to Index 0"</span><span class="p">)</span>
                <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// Simulated business logic: WebViewController noNeedNativePresent == false (indicating the need to match special paths to open native pages)</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">noNeedNativePresent</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">pathComponents</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">pathComponents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"product"</span> <span class="p">{</span>
                    <span class="c1">// match http://zhgchg.li/product/1234</span>
                    <span class="k">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">pathComponents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Present ProductViewController(</span><span class="se">\(</span><span class="n">id</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                    <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">pathComponents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"shop"</span> <span class="p">{</span>
                    <span class="c1">// match http://zhgchg.li/shop/1234</span>
                    <span class="k">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">pathComponents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Present ShopViewController(</span><span class="se">\(</span><span class="n">id</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                    <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="c1">// more...</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// more...</span>
        <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>As time goes by, the functionality becomes more and more complex, and the logic here will also become more and more. If the processing order is different, it will become a disaster.</p><h4 id="navigationactionhandler-chain-of-responsibility-pattern"><span class="me-2">NavigationActionHandler (Chain of Responsibility Pattern)</span><a href="#navigationactionhandler-chain-of-responsibility-pattern" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/f4b02ee342a4/1*29n1VSQhXFc4qUZ50IULIw.png" class="popup img-link "><img data-src="/assets/f4b02ee342a4/1*29n1VSQhXFc4qUZ50IULIw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><strong>Define the Handler Protocol first:</strong></p><pre><code class="language-less">public protocol NavigationActionHandler: AnyObject {
    var nextHandler: NavigationActionHandler? { get set }

    /// Handles navigation actions for the web view. Returns true if the action was handled, otherwise false.
    func handle(webView: WKWebView, decidePolicyFor navigationAction: WKNavigationAction, decisionHandler: @escaping (WKNavigationActionPolicy) -&gt; Void) -&gt; Bool
    /// Executes the navigation action policy decision. If the current handler does not handle it, the next handler in the chain will be executed.
    func exeute(webView: WKWebView, decidePolicyFor navigationAction: WKNavigationAction, decisionHandler: @escaping (WKNavigationActionPolicy) -&gt; Void)
}

public extension NavigationActionHandler {
    func exeute(webView: WKWebView, decidePolicyFor navigationAction: WKNavigationAction, decisionHandler: @escaping (WKNavigationActionPolicy) -&gt; Void) {
        if !handle(webView: webView, decidePolicyFor: navigationAction, decisionHandler: decisionHandler) {
            self.nextHandler?.exeute(webView: webView, decidePolicyFor: navigationAction, decisionHandler: decisionHandler) ?? decisionHandler(.allow)
        }
    }
}
</code></pre><ul><li>The operation is implemented in <code class="language-plaintext highlighter-rouge">func handle()</code>, returning <code class="language-plaintext highlighter-rouge">true</code> if there is further processing, otherwise <code class="language-plaintext highlighter-rouge">false</code>.<li><code class="language-plaintext highlighter-rouge">func exeute()</code> is the default chain access implementation, which will traverse the entire operation chain from here. The default behavior is that when <code class="language-plaintext highlighter-rouge">func handle()</code> returns <code class="language-plaintext highlighter-rouge">false</code> (indicating that this node cannot handle it), it automatically calls the <code class="language-plaintext highlighter-rouge">execute()</code> of the next <code class="language-plaintext highlighter-rouge">nextHandler</code> to continue processing until the end.</ul><p><strong>Implementation:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="c1">// Default implementation, usually placed at the end</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">DefaultNavigationActionHandler</span><span class="p">:</span> <span class="kt">NavigationActionHandler</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">NavigationActionHandler</span><span class="p">?</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">webView</span><span class="p">:</span> <span class="kt">WKWebView</span><span class="p">,</span> <span class="n">decidePolicyFor</span> <span class="nv">navigationAction</span><span class="p">:</span> <span class="kt">WKNavigationAction</span><span class="p">,</span> <span class="nv">decisionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">WKNavigationActionPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">PaymentNavigationActionHandler</span><span class="p">:</span> <span class="kt">NavigationActionHandler</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">NavigationActionHandler</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">webView</span><span class="p">:</span> <span class="kt">WKWebView</span><span class="p">,</span> <span class="n">decidePolicyFor</span> <span class="nv">navigationAction</span><span class="p">:</span> <span class="kt">WKNavigationAction</span><span class="p">,</span> <span class="nv">decisionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">WKNavigationActionPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">navigationAction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        
        <span class="c1">// Simulate business logic: Payment related, two-step verification WebView...etc</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Present Payment Verify View Controller"</span><span class="p">)</span>
        <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">DeeplinkManagerNavigationActionHandler</span><span class="p">:</span> <span class="kt">NavigationActionHandler</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">NavigationActionHandler</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">webView</span><span class="p">:</span> <span class="kt">WKWebView</span><span class="p">,</span> <span class="n">decidePolicyFor</span> <span class="nv">navigationAction</span><span class="p">:</span> <span class="kt">WKNavigationAction</span><span class="p">,</span> <span class="nv">decisionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">WKNavigationActionPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">navigationAction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        
        
        <span class="c1">// Simulate DeepLinkManager logic, open the URL if successful and end the process.</span>
        <span class="c1">// if DeepLinkManager.open(url) == true {</span>
            <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="c1">// } else {</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="c1">//</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// More...</span>
</pre></table></code></div></div><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">MyWKWebViewController</span><span class="p">:</span> <span class="kt">WKNavigationDelegate</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">webView</span><span class="p">(</span><span class="n">_</span> <span class="nv">webView</span><span class="p">:</span> <span class="kt">WKWebView</span><span class="p">,</span> <span class="n">decidePolicyFor</span> <span class="nv">navigationAction</span><span class="p">:</span> <span class="kt">WKNavigationAction</span><span class="p">,</span> <span class="nv">decisionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">WKNavigationActionPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">let</span> <span class="nv">headNavigationActionHandler</span> <span class="o">=</span> <span class="kt">DeeplinkManagerNavigationActionHandler</span><span class="p">()</span>
       <span class="k">let</span> <span class="nv">defaultNavigationActionHandler</span> <span class="o">=</span> <span class="kt">DefaultNavigationActionHandler</span><span class="p">()</span>
       <span class="k">let</span> <span class="nv">paymentNavigationActionHandler</span> <span class="o">=</span> <span class="kt">PaymentNavigationActionHandler</span><span class="p">()</span>
       
       <span class="n">headNavigationActionHandler</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">paymentNavigationActionHandler</span>
       <span class="n">paymentNavigationActionHandler</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">defaultNavigationActionHandler</span>
       
       <span class="n">headNavigationActionHandler</span><span class="o">.</span><span class="nf">exeute</span><span class="p">(</span><span class="nv">webView</span><span class="p">:</span> <span class="n">webView</span><span class="p">,</span> <span class="nv">decidePolicyFor</span><span class="p">:</span> <span class="n">navigationAction</span><span class="p">,</span> <span class="nv">decisionHandler</span><span class="p">:</span> <span class="n">decisionHandler</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This way, when a request is received, it will be processed sequentially according to the handling chain we defined.</p><p><strong>Combining the previous Builder Pattern</strong> <code class="language-plaintext highlighter-rouge">MyWKWebViewConfigurator</code> <strong>by exposing <code class="language-plaintext highlighter-rouge">headNavigationActionHandler</code> as a parameter allows external control over the processing requirements and order of this WKWebView:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">MyWKWebViewController</span><span class="p">:</span> <span class="kt">WKNavigationDelegate</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">webView</span><span class="p">(</span><span class="n">_</span> <span class="nv">webView</span><span class="p">:</span> <span class="kt">WKWebView</span><span class="p">,</span> <span class="n">decidePolicyFor</span> <span class="nv">navigationAction</span><span class="p">:</span> <span class="kt">WKNavigationAction</span><span class="p">,</span> <span class="nv">decisionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">WKNavigationActionPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">headNavigationHandler</span><span class="p">?</span><span class="o">.</span><span class="nf">exeute</span><span class="p">(</span><span class="nv">webView</span><span class="p">:</span> <span class="n">webView</span><span class="p">,</span> <span class="nv">decidePolicyFor</span><span class="p">:</span> <span class="n">navigationAction</span><span class="p">,</span> <span class="nv">decisionHandler</span><span class="p">:</span> <span class="n">decisionHandler</span><span class="p">)</span> <span class="p">??</span> <span class="nf">decisionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//...</span>
<span class="kd">struct</span> <span class="kt">MyWKWebViewConfiguratorFactory</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="kt">ForType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">`</span><span class="nv">default</span><span class="p">`</span>
        <span class="k">case</span> <span class="n">productPage</span>
        <span class="k">case</span> <span class="n">payment</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">make</span><span class="p">(</span><span class="k">for</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">ForType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">MyWKWebViewConfigurator</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">type</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="k">default</span><span class="p">:</span>
            <span class="c1">// Simulating default scenario with these handlers</span>
            <span class="k">let</span> <span class="nv">deplinkManagerNavigationActionHandler</span> <span class="o">=</span> <span class="kt">DeeplinkManagerNavigationActionHandler</span><span class="p">()</span>
            <span class="k">let</span> <span class="nv">homePageTabSwitchNavigationActionHandler</span> <span class="o">=</span> <span class="kt">HomePageTabSwitchNavigationActionHandler</span><span class="p">()</span>
            <span class="k">let</span> <span class="nv">nativeViewControllerNavigationActionHandlera</span> <span class="o">=</span> <span class="kt">NativeViewControllerNavigationActionHandler</span><span class="p">()</span>
            <span class="k">let</span> <span class="nv">defaultNavigationActionHandler</span> <span class="o">=</span> <span class="kt">DefaultNavigationActionHandler</span><span class="p">()</span>
            
            <span class="n">deplinkManagerNavigationActionHandler</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">homePageTabSwitchNavigationActionHandler</span>
            <span class="n">homePageTabSwitchNavigationActionHandler</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">nativeViewControllerNavigationActionHandlera</span>
            <span class="n">nativeViewControllerNavigationActionHandlera</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">defaultNavigationActionHandler</span>
            
            <span class="k">return</span> <span class="kt">MyWKWebViewConfigurator</span><span class="p">()</span>
                <span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">scriptMessageStrategy</span><span class="p">:</span> <span class="kt">PageScriptMessageStrategy</span><span class="p">())</span>
                <span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="nv">scriptMessageStrategy</span><span class="p">:</span> <span class="kt">UserScriptMessageStrategy</span><span class="p">())</span>
                <span class="o">.</span><span class="nf">set</span><span class="p">(</span><span class="nv">headNavigationHandler</span><span class="p">:</span> <span class="n">deplinkManagerNavigationActionHandler</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">set</span><span class="p">(</span><span class="nv">overrideTitleFromWebView</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">set</span><span class="p">(</span><span class="nv">disableZoom</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">productPage</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">Self</span><span class="o">.</span><span class="nf">make</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">)</span><span class="o">.</span><span class="nf">set</span><span class="p">(</span><span class="nv">disableZoom</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span><span class="o">.</span><span class="nf">set</span><span class="p">(</span><span class="nv">overrideTitleFromWebView</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">payment</span><span class="p">:</span>
            <span class="c1">// Simulating payment page with only these handlers, and paymentNavigationActionHandler having the highest priority</span>
            <span class="k">let</span> <span class="nv">paymentNavigationActionHandler</span> <span class="o">=</span> <span class="kt">PaymentNavigationActionHandler</span><span class="p">()</span>
            <span class="k">let</span> <span class="nv">deplinkManagerNavigationActionHandler</span> <span class="o">=</span> <span class="kt">DeeplinkManagerNavigationActionHandler</span><span class="p">()</span>
            <span class="k">let</span> <span class="nv">defaultNavigationActionHandler</span> <span class="o">=</span> <span class="kt">DefaultNavigationActionHandler</span><span class="p">()</span>
            
            <span class="n">paymentNavigationActionHandler</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">deplinkManagerNavigationActionHandler</span>
            <span class="n">deplinkManagerNavigationActionHandler</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">defaultNavigationActionHandler</span>
            
            <span class="k">return</span> <span class="kt">MyWKWebViewConfigurator</span><span class="p">()</span><span class="o">.</span><span class="nf">set</span><span class="p">(</span><span class="nv">headNavigationHandler</span><span class="p">:</span> <span class="n">paymentNavigationActionHandler</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="strategy-pattern"><span class="me-2">Strategy Pattern</span><a href="#strategy-pattern" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>

![](/assets/f4b02ee342a4/1*RiMbrBGdFG6INBRCcE_WZw.png)

&gt; _The Strategy Pattern belongs to the **behavioral** design pattern, which abstracts the actual operation. We can implement various different operations, allowing flexibility to replace them according to different contexts._

The above diagram illustrates different payment methods. We abstract the payment as a `Payment` Protocol (Interface), and then each payment method implements its own implementation. When using `PaymentContext` (simulating external usage), based on the user's selected payment method, the corresponding Payment entity is generated and `pay()` is called to process the payment.

#### WKWebView Scenario

&gt; _Used in the interaction between WebView and frontend pages._

&gt; _When frontend JavaScript calls:_

&gt; _`window.webkit.messageHandlers.Name.postMessage(Parameters);`_

&gt; _It will go to WKWebView to find the corresponding `WKScriptMessageHandler` Class for `Name` and execute the operation._

The system already has defined Protocol and the corresponding `func add(_ scriptMessageHandler: any WKScriptMessageHandler, name: String)` method. We just need to define our own `WKScriptMessageHandler` implementation and add it to WKWebView. The system will dispatch to the corresponding concrete strategy to execute based on the received `name` following the Strategy Pattern strategy.

Here, we simply extend the Protocol with `WKScriptMessageHandler`, adding an `identifier: String` for `add(.. name:)` usage:

![](/assets/f4b02ee342a4/1*RLA13rSVDIG9cV3CsWtS3g.png)

```swift
public protocol ScriptMessageStrategy: NSObject, WKScriptMessageHandler {
    static var identifier: String { get }
}
</pre></table></code></div></div><p><strong>Implementation:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="kt">PageScriptMessageStrategy</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">ScriptMessageStrategy</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">identifier</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"page"</span>
    
    <span class="kd">func</span> <span class="nf">userContentController</span><span class="p">(</span><span class="n">_</span> <span class="nv">userContentController</span><span class="p">:</span> <span class="kt">WKUserContentController</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">message</span><span class="p">:</span> <span class="kt">WKScriptMessage</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Simulating called from js: window.webkit.messageHandlers.page.postMessage("Close");</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="k">Self</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s">: </span><span class="se">\(</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">UserScriptMessageStrategy</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">ScriptMessageStrategy</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">identifier</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"user"</span>
    
    <span class="kd">func</span> <span class="nf">userContentController</span><span class="p">(</span><span class="n">_</span> <span class="nv">userContentController</span><span class="p">:</span> <span class="kt">WKUserContentController</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">message</span><span class="p">:</span> <span class="kt">WKScriptMessage</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Simulating called from js: window.webkit.messageHandlers.user.postMessage("Hello");</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="k">Self</span><span class="o">.</span><span class="n">identifier</span><span class="se">)</span><span class="s">: </span><span class="se">\(</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>WKWebView Registration:</strong></p><div class="language-css highlighter-rouge"><div class="code-header"> <span data-label-text="CSS"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nt">var</span> <span class="nt">scriptMessageStrategies</span><span class="o">:</span> <span class="o">[</span><span class="nt">ScriptMessageStrategy</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span>
<span class="nt">scriptMessageStrategies</span><span class="nc">.forEach</span> <span class="p">{</span> <span class="err">scriptMessageStrategy</span> <span class="err">in</span>
  <span class="err">webView.configuration.userContentController.add(scriptMessageStrategy,</span> <span class="py">name</span><span class="p">:</span> <span class="n">type</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="n">scriptMessageStrategy</span><span class="p">).</span><span class="n">identifier</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Combining the Builder Pattern from the previous <code class="language-plaintext highlighter-rouge">MyWKWebViewConfigurator</code> to externally manage the registration of <code class="language-plaintext highlighter-rouge">ScriptMessageStrategy</code>:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">MyWKWebViewConfigurator</span> <span class="p">{</span>
    <span class="c1">//...</span>
    
    <span class="c1">// You can encapsulate the logic for adding rules inside</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">add</span><span class="p">(</span><span class="nv">scriptMessageStrategy</span><span class="p">:</span> <span class="kt">ScriptMessageStrategy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="c1">// Here, only the old logic will be deleted first when implementing duplicate identifiers</span>
        <span class="n">scriptMessageStrategies</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">scriptMessageStrategy</span><span class="p">)</span><span class="o">.</span><span class="n">identifier</span> <span class="p">})</span>
        <span class="n">scriptMessageStrategies</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">scriptMessageStrategy</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="c1">//...</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="kt">MyWKWebViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
    <span class="c1">//...</span>
    <span class="kd">public</span> <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
       
        <span class="c1">//...</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">scriptMessageStrategies</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">scriptMessageStrategy</span> <span class="k">in</span>
            <span class="n">webView</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">userContentController</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">scriptMessageStrategy</span><span class="p">,</span> <span class="nv">name</span><span class="p">:</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">scriptMessageStrategy</span><span class="p">)</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">//...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="question-can-this-scenario-also-be-replaced-with-the-chain-of-responsibility-pattern"><span class="me-2">Question: Can this scenario also be replaced with the Chain of Responsibility Pattern?</span><a href="#question-can-this-scenario-also-be-replaced-with-the-chain-of-responsibility-pattern" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>At this point, some friends may wonder if the Strategy Pattern here can be replaced with the Chain of Responsibility Pattern.</p><blockquote><p><em>Both of these design patterns are behavioral and can be replaced; however, the actual choice depends on the specific requirements. In this case, the Strategy Pattern is very typical, where WKWebView determines different strategies based on the Name. If our requirement involves chain dependencies between different strategies or recovery relationships, such as if AStrategy cannot handle it and needs to pass it to BStrategy, then we would consider using the Chain of Responsibility Pattern.</em></p></blockquote><p><a href="/assets/f4b02ee342a4/1*UWT-2lfzUyS7CARahfEN-A.png" class="popup img-link "><img data-src="/assets/f4b02ee342a4/1*UWT-2lfzUyS7CARahfEN-A.png" alt="Strategy v.s. Chain of Responsibility" class="lazyload" data-proofer-ignore></a></p><p>Strategy v.s. Chain of Responsibility</p><ul><li>Strategy Pattern: Clearly defined execution strategies without relationships between them.<li>Chain of Responsibility Pattern: Execution strategy is determined in individual implementations, passing to the next implementation if unable to handle.</ul><p>For complex scenarios, you can combine the Chain of Responsibility Pattern inside the Strategy Pattern to achieve the desired outcome.</p><h3 id="final-combination"><span class="me-2">Final Combination</span><a href="#final-combination" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/f4b02ee342a4/1*VgMVoIWfkuCPLn584Qv-xg.png" class="popup img-link "><img data-src="/assets/f4b02ee342a4/1*VgMVoIWfkuCPLn584Qv-xg.png" alt="" class="lazyload" data-proofer-ignore></a></p><ul><li><strong>Simple Factory Pattern</strong> <code class="language-plaintext highlighter-rouge">MyWKWebViewConfiguratorFactory</code> -&gt; Encapsulates the steps to generate <code class="language-plaintext highlighter-rouge">MyWKWebViewConfigurator</code><li><strong>Builder Pattern</strong> <code class="language-plaintext highlighter-rouge">MyWKWebViewConfigurator</code> -&gt; Encapsulates <code class="language-plaintext highlighter-rouge">MyWKWebViewConfiguration</code> parameters and construction steps<li>Injection of <code class="language-plaintext highlighter-rouge">MyWKWebViewConfiguration</code> -&gt; Used by <code class="language-plaintext highlighter-rouge">MyWKWebViewController</code><li><strong>Chain of Responsibility Pattern</strong> <code class="language-plaintext highlighter-rouge">MyWKWebViewController</code>’s <code class="language-plaintext highlighter-rouge">func webView(_ webView: WKWebView, decidePolicyFor navigationAction: WKNavigationAction, decisionHandler: @escaping (WKNavigationActionPolicy) -&gt; Void)</code> -&gt; Calls <code class="language-plaintext highlighter-rouge">headNavigationHandler?.execute(webView: webView, decidePolicyFor: navigationAction, decisionHandler: decisionHandler)</code> for chain execution handling<li><strong>Strategy Pattern</strong> <code class="language-plaintext highlighter-rouge">MyWKWebViewController</code>’s <code class="language-plaintext highlighter-rouge">webView.configuration.userContentController.addUserScript(XXX)</code> dispatches the corresponding JS Caller to the respective handling strategy.</ul><h4 id="complete-demo-repo"><span class="me-2">Complete Demo Repo</span><a href="#complete-demo-repo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/zhgchgli0718/DesignPatternsInWKWebViewDemo" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/dc74860bc0c53748213df85fb768a4317fe357347a630b6a75bdaf5b2e36acb1/zhgchgli0718/DesignPatternsInWKWebViewDemo" alt="" class="lazyload" data-proofer-ignore></a></p><h3 id="further-reading"><span class="me-2">Further Reading</span><a href="#further-reading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="../78507a8de6a5/">Record of Practical Applications of Design Patterns</a><li><a href="../ba5773a7bfea/">Visitor Pattern in Swift (Share Object to XXX Example)</a><li><a href="../60473cb47550/">Visitor Pattern in TableView</a></ul><p>If you have any questions or suggestions, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>===</p><p><a href="https://zhgchg.li/posts/f4b02ee342a4/" target="_blank">本文中文版本</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ➡️ <a href="https://medium.com/p/f4b02ee342a4" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=🍺&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/kkday/'>KKday</a>, <a href='/categories/tech/'>Tech</a>, <a href='/categories/blog/'>Blog</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/design-patterns/" class="post-tag no-text-decoration" >design-patterns</a> <a href="/tags/chain-of-responsibility/" class="post-tag no-text-decoration" >chain-of-responsibility</a> <a href="/tags/builder-pattern/" class="post-tag no-text-decoration" >builder-pattern</a> <a href="/tags/strategy-pattern/" class="post-tag no-text-decoration" >strategy-pattern</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Practical%20Application%20Record%20of%20Design%20Patterns%E2%80%94In%20WKWebView%20with%20Builder,%20Strategy%20&%20Chain%20of%20Responsibility%20Pattern%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Ff4b02ee342a4%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Practical%20Application%20Record%20of%20Design%20Patterns%E2%80%94In%20WKWebView%20with%20Builder,%20Strategy%20&%20Chain%20of%20Responsibility%20Pattern%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Ff4b02ee342a4%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2Ff4b02ee342a4%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/ba5773a7bfea/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1623772716" data-df="ll" > Jun 15, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>Visitor Pattern in iOS (Swift)</h4><div class="text-muted small"><p> Visitor Pattern in Swift (Share Object to XXX Example) Analysis of the practical application scenarios of the Visitor Pattern (sharing items like products, songs, articles… to Facebook, Line, Link...</p></div></div></a></div><div class="col"> <a href="/posts/78507a8de6a5/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1649342957" data-df="ll" > Apr 7, 2022 </em><h4 class="pt-0 my-2" data-toc-skip>Record of Practical Application of Design Patterns</h4><div class="text-muted small"><p> Record of Practical Application of Design Patterns Record of problem scenarios encountered and solutions applied when encapsulating Socket.IO Client Library requirements using Design Patterns P...</p></div></div></a></div><div class="col"> <a href="/posts/60473cb47550/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1657267110" data-df="ll" > Jul 8, 2022 </em><h4 class="pt-0 my-2" data-toc-skip>Visitor Pattern in TableView</h4><div class="text-muted small"><p> Visitor Pattern in TableView Enhancing the readability and extensibility of TableView using the Visitor Pattern Photo by Alex wong Introduction Following the previous article on “Visitor Patt...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/b7e7c0938985/" class="btn btn-outline-primary" prompt="Older" ><p>Travelogue 2024 Bangkok 🇹🇭 5-Day Free and Easy Trip</p></a> <a href="/posts/9e43897d99fc/" class="btn btn-outline-primary" prompt="Newer" ><p>Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">中文版網站</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
