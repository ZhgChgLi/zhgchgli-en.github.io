<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Comprehensive Guide to Implementing Local Cache with AVPlayer" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="AVPlayer/AVQueuePlayer with AVURLAsset implementing AVAssetResourceLoaderDelegate" /><meta property="og:description" content="AVPlayer/AVQueuePlayer with AVURLAsset implementing AVAssetResourceLoaderDelegate" /><link rel="canonical" href="https://en.zhgchg.li/posts/6ce488898003/" /><meta property="og:url" content="https://en.zhgchg.li/posts/6ce488898003/" /><meta property="og:site_name" content="ZhgChgLi" /><meta property="og:image" content="https://en.zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-31T18:41:42+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://en.zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.jpeg" /><meta property="twitter:title" content="Comprehensive Guide to Implementing Local Cache with AVPlayer" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@ZhgChgLi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi"},"dateModified":"2024-04-13T16:45:21+08:00","datePublished":"2021-01-31T18:41:42+08:00","description":"AVPlayer/AVQueuePlayer with AVURLAsset implementing AVAssetResourceLoaderDelegate","headline":"Comprehensive Guide to Implementing Local Cache with AVPlayer","image":"https://en.zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://en.zhgchg.li/posts/6ce488898003/"},"url":"https://en.zhgchg.li/posts/6ce488898003/"}</script><title>Comprehensive Guide to Implementing Local Cache with AVPlayer | ZhgChgLi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi"><meta name="application-name" content="ZhgChgLi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ZhgChgLi</a></div><div class="site-subtitle fst-italic">Live a life you will remember.</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/real/" class="nav-link"> <i class="fa-fw fa fa-camera-retro"></i> <span>REAL LIFE</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Comprehensive Guide to Implementing Local Cache with AVPlayer</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Comprehensive Guide to Implementing Local Cache with AVPlayer</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1612089702" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jan 31, 2021 </em> </span> <span> Updated <em class="" data-ts="1712997921" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 13, 2024 </em> </span><div class="mt-3 mb-3"> <a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.jpeg" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.jpeg" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="5673 words" > <em>31 min</em> read</span></div></div></div><div class="post-content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><h3 id="comprehensive-guide-to-implementing-local-cache-with-avplayer"><span class="me-2">Comprehensive Guide to Implementing Local Cache with AVPlayer</span><a href="#comprehensive-guide-to-implementing-local-cache-with-avplayer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>AVPlayer/AVQueuePlayer with AVURLAsset implementing AVAssetResourceLoaderDelegate</p><p><a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.jpeg" class="popup img-link "><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.jpeg" alt="Photo by [Tyler Lastovich](https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p>Photo by <a href="https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Tyler Lastovich</a></p><h4 id="20230312-update"><span class="me-2">[2023/03/12] Update</span><a href="#20230312-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/ZhgChgLi/ZPlayerCacher" target="_blank" class="img-link shimmer" ><img data-src="https://repository-images.githubusercontent.com/612890185/346ae563-7278-4518-a19b-f5d367e60adc" alt="" class="lazyload" data-proofer-ignore></a></p><p>I have open-sourced my previous implementation, and those in need can use it directly.</p><ul><li>Customizable Cache strategy, can use PINCache or others…<li>Externally, just call the make AVAsset factory, input the URL, and the AVAsset will support Caching<li>Implemented Data Flow strategy using Combine<li>Wrote some tests</ul><h3 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>It’s been more than half a year since the last post “<a href="../d796bf8e661e/">Exploring Methods for Implementing iOS HLS Cache</a>”, and the team has always wanted to implement the cache-while-playing feature because it greatly impacts costs. We are a music streaming platform, and if we have to fetch the entire file every time the same song is played, it would be a huge data drain for us and for users who don’t have unlimited data plans. Although music files are at most a few MB, it all adds up to significant costs!</p><p>Additionally, since the Android side has already implemented the cache-while-playing feature, we previously compared the costs and found that after launching on Android, there was a significant reduction in data usage. With relatively more users on iOS, we should see even better data savings.</p><p>Based on the experience from the <a href="../d796bf8e661e/">previous post</a>, if we continue to use HLS (.m3u8/.ts) to achieve our goal, things will become very complicated and possibly unachievable. So, we decided to revert to using mp3 files, which allows us to directly use <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> for implementation.</p><h3 id="goals"><span class="me-2">Goals</span><a href="#goals" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Music that has been played will generate a local Cache backup<li>When playing music, first check if there is a local Cache to read from; if so, do not request the file from the server again<li>Can set Cache strategies; total capacity limit, start deleting the oldest Cache files when exceeded<li>Do not interfere with the original AVPlayer playback mechanism (The fastest method would be to use URLSession to download the mp3 and feed it to AVPlayer, but this would lose the ability to play while downloading, making users wait longer and consuming more data)</ul><h3 id="preliminary-knowledge-1--http11-range-requests-connection-keep-alive"><span class="me-2">Preliminary Knowledge (1) — HTTP/1.1 Range Requests, Connection Keep-Alive</span><a href="#preliminary-knowledge-1--http11-range-requests-connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="http11-range-requests"><span class="me-2">HTTP/1.1 Range Requests</span><a href="#http11-range-requests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>First, we need to understand how data is requested from the server when playing videos or music. Generally, video and music files are very large, and it is not feasible to wait until the entire file is fetched before starting playback. The common approach is to fetch data as it plays, only needing the data for the currently playing segment.</p><p>The way to achieve this is through HTTP/1.1 Range, which only returns the specified byte range of data, for example, specifying 0–100 will only return the 100 bytes of data from 0–100. Using this method, data can be fetched in segments and then assembled into a complete file. This method can also be applied to resume interrupted downloads.</p><h4 id="how-to-apply"><span class="me-2">How to Apply?</span><a href="#how-to-apply" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We will first use HEAD to check the Response Header to understand if the server supports Range requests, the total length of the resource, and the file type:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> HEAD http://zhgchg.li/music.mp3
</pre></table></code></div></div><p><strong>Using HEAD, we can get the following information from the Response Header:</strong></p><ul><li><strong>Accept-Ranges: bytes</strong> indicates that the server supports Range requests. If this value is missing or is Accept-Ranges: none, it means it does not support it.<li><strong>Content-Length:</strong> The total length of the resource. We need to know the total length to request data in segments.<li><strong>Content-Type:</strong> The file type, which is information needed by AVPlayer when playing.</ul><p>However, sometimes we also use GET <code class="language-plaintext highlighter-rouge">Range: bytes=0–1</code>, which means we request data in the range of 0–1, but we don’t actually care about the content of 0–1. We just want to see the Response Header information; <strong>the native AVPlayer uses GET to check, so this article will also use it</strong>.</p><blockquote><p><em>But it is more recommended to use HEAD to check. One method is more correct, and if the server does not support the Range function, using GET will force the download of the entire file.</em></p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–1"</span>
</pre></table></code></div></div><p><strong>Using GET, we can get the following information from the Response Header:</strong></p><ul><li><strong>Accept-Ranges: bytes</strong> indicates that the server supports Range requests. If this value is missing or is Accept-Ranges: none, it means it does not support it.<li><strong>Content-Range: bytes 0–1/total length of the resource</strong>, the number after the “/” is the total length of the resource. We need to know the total length to request data in segments.<li><strong>Content-Type:</strong> The file type, which is information needed by AVPlayer when playing.</ul><p><a href="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.jpeg" class="popup img-link "><img data-src="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p><strong>Knowing that the server supports Range requests, we can initiate segmented Range requests:</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–100"</span>
</pre></table></code></div></div><p><strong>The server will return 206 Partial Content:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Content-Range: bytes 0-100/total length
Content-Length: 100
...
(binary content)
</pre></table></code></div></div><p>At this point, we get the data for Range 0–100 and can continue to make new requests for Range 100–200, 200–300, and so on until the end.</p><p>If the requested Range exceeds the total length of the resource, it will return 416 Range Not Satisfiable.</p><p>Additionally, to get the complete file data, you can request Range 0-total length or use 0-:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–"</span>
</pre></table></code></div></div><p>You can also request multiple Range data in the same request and set conditions, but we don’t need that. For more details, you can <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests" target="_blank">refer here</a>.</p><h4 id="connection-keep-alive"><span class="me-2">Connection Keep-Alive</span><a href="#connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>HTTP 1.1 is enabled by default. <strong>This feature allows real-time retrieval of downloaded data</strong>, for example, a 5 MB file can be retrieved in 16 KB, 16 KB, 16 KB… increments, without waiting for the entire 5 MB to be downloaded.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Connection: Keep-Alive
</pre></table></code></div></div><h4 id="what-if-the-server-does-not-support-range-or-keep-alive-"><span class="me-2"><strong><em>What if the server does not support Range or</em></strong> Keep-Alive <strong><em>?</em></strong></span><a href="#what-if-the-server-does-not-support-range-or-keep-alive-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><em>Then there’s no need to do so much. Just use URLSession to download the mp3 file and feed it to the player… But this is not the result we want, so you can ask the backend to modify the server settings.</em></p></blockquote><h3 id="preliminary-knowledge-2--how-does-the-native-avplayer-handle-avurlasset-resources"><span class="me-2">Preliminary Knowledge (2) — How does the native AVPlayer handle AVURLAsset resources?</span><a href="#preliminary-knowledge-2--how-does-the-native-avplayer-handle-avurlasset-resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.jpeg" class="popup img-link "><img data-src="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>When we use AVURLAsset to initialize with a URL resource and assign it to AVPlayer/AVQueuePlayer to start playing, as mentioned above, it will first use GET Range 0–1 to obtain whether it supports Range requests, the total length of the resource, and the file type.</p><p>With the file information, a second request will be initiated to request data from 0 to the total length.</p><blockquote><p><em>⚠️ <strong>AVPlayer will request data from 0 to the total length and will cancel the network request once it feels it has enough data (e.g., 16 kb, 16 kb, 16 kb…)</strong> (so it won’t actually fetch the entire file unless the file is very small).</em></p></blockquote><blockquote><p><em>It will continue to request data using Range after resuming playback.</em></p></blockquote><blockquote><p><em>(This part is different from what I previously thought; I assumed it would request 0–100, 100–200, etc.)</em></p></blockquote><p><strong>AVPlayer Request Example:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>1. GET Range 0-1 =&gt; Response: Total length 150000 / public.mp3 / true
2. GET 0-150000...
3. 16 kb receive
4. 16 kb receive...
5. cancel() // current offset is 700
6. Continue playback
7. GET 700-150000...
8. 16 kb receive
9. 16 kb receive...
10. cancel() // current offset is 1500
11. Continue playback
12. GET 1500-150000...
13. 16 kb receive
14. 16 kb receive...
16. If seek to...5000
17. cancel(12.) // current offset is 2000
18. GET 5000-150000...
19. 16 kb receive
20. 16 kb receive...
...
</pre></table></code></div></div><blockquote><p><em>⚠️ <strong>In iOS ≤12, it will first send a few shorter requests to test (?), and then send a request for the total length; in iOS ≥ 13, it will directly send a request for the total length.</strong></em></p></blockquote><p>Another side issue is that while observing how resources are fetched, I used the <a href="../46410aaada00/">mitmproxy</a> tool for sniffing. It showed errors, waiting for the entire response to come back before displaying it, instead of showing segments and using persistent connections for continued downloads. This scared me! I thought iOS was dumb enough to fetch the entire file each time! Next time, I need to be a bit skeptical when using tools Orz.</p><h4 id="timing-of-cancel-initiation"><span class="me-2">Timing of Cancel Initiation</span><a href="#timing-of-cancel-initiation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>As mentioned earlier, the second request, which requests resources from 0 to the total length, will initiate a Cancel request once there is enough data.<li>When seeking, it will first initiate a Cancel request for the previous request.</ol><blockquote><p><em>⚠️ Switching to the next resource in AVQueuePlayer or changing the playback resource in AVPlayer will not initiate a Cancel request for the previous track.</em></p></blockquote><h4 id="avqueue-pre-buffering"><span class="me-2">AVQueue Pre-buffering</span><a href="#avqueue-pre-buffering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>It also calls the Resource Loader to handle it, but the requested data range will be smaller.</p><h3 id="implementation"><span class="me-2">Implementation</span><a href="#implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>With the above preliminary knowledge, let’s look at how to implement the local cache function of AVPlayer.</p><p>As mentioned earlier, <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> allows us to <strong>implement the Resource Loader</strong> for the Asset.</p><p>The Resource Loader is essentially a worker. Whether the player needs file information or file data, and the range, it tells us, and we do it.</p><blockquote><p><em>I saw an example where a <strong>Resource Loader serves all AVURLAssets</strong>, which I think is wrong. It should be one Resource Loader serving one AVURLAsset, following the lifecycle of the AVURLAsset, as it belongs to the AVURLAsset.</em></p></blockquote><blockquote><p><em>A Resource Loader serving all AVURLAssets in AVQueuePlayer would become very complex and difficult to manage.</em></p></blockquote><h4 id="timing-of-entering-custom-resource-loader"><span class="me-2">Timing of Entering Custom Resource Loader</span><a href="#timing-of-entering-custom-resource-loader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Note that implementing your own Resource Loader doesn’t mean it will handle everything. It will only use your Resource Loader when the system cannot recognize or handle the resource.</p><p>Therefore, before giving the URL resource to AVURLAsset, we need to change the Scheme to our custom Scheme, not http/https… which the system can handle.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://zhgchg.li/music.mp3 =&gt; cacheable://zhgchg.li/music.mp3
</pre></table></code></div></div><h4 id="avassetresourceloaderdelegate"><span class="me-2"><code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code></span><a href="#avassetresourceloaderdelegate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>Only two methods need to be implemented:</strong></p><ul><li>func resourceLoader(_ resourceLoader: AVAssetResourceLoader, shouldWaitForLoadingOfRequestedResource <strong>loadingRequest</strong>: AVAssetResourceLoadingRequest) -&gt; Bool:</ul><p>This method asks us if we can handle this resource. Return true if we can, return false if we cannot (unsupported URL).</p><p>We can extract what is being requested from <code class="language-plaintext highlighter-rouge">loadingRequest</code> (whether it is the first request for file information or a data request, and if it is a data request, what the Range is). After knowing the request, we initiate our own request to fetch the data. <strong>Here we can decide whether to initiate a URLSession or return Data from local storage</strong>.</p><p>Additionally, we can perform Data encryption and decryption operations here to protect the original data.</p><ul><li>func resourceLoader(_ resourceLoader: AVAssetResourceLoader, didCancel <strong>loadingRequest</strong>: AVAssetResourceLoadingRequest):</ul><p>As mentioned earlier, <strong>Cancel initiation timing</strong> when Cancel is initiated…</p><p>We can cancel the ongoing URLSession request here.</p><p><a href="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.jpeg" class="popup img-link "><img data-src="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="local-cache-implementation"><span class="me-2">Local Cache Implementation</span><a href="#local-cache-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For the Cache part, I directly use <a href="https://github.com/pinterest/PINCache" target="_blank">PINCache</a>, delegating the Cache work to it, avoiding issues like Cache read/write DeadLock and implementing Cache LRU strategy.</p><blockquote><p><strong><em>️️⚠️️️️️️️️️️️OOM Warning!</em></strong></p></blockquote><blockquote><p><em>Since this is for caching music files with a size of around 10 MB, PINCache can be used as a local Cache tool. However, this method cannot be used for serving videos (which may require loading several GB of data into memory at once).</em></p></blockquote><p>For such requirements, you can refer to the approach of using FileHandle’s seek read/write features.</p><h3 id="lets-get-started"><span class="me-2">Let’s Get Started!</span><a href="#lets-get-started" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Without further ado, here is the complete project:</p><p><a href="https://github.com/zhgchgli0718/resourceLoaderDemo" target="_blank" class="img-link shimmer" ><img data-src="https://opengraph.githubassets.com/b43d0ddf4687cf5a04d6bbc68e4bfd24a9d5067fe04e2e198a676aff746de403/zhgchgli0718/resourceLoaderDemo" alt="" class="lazyload" data-proofer-ignore></a></p><h4 id="assetdata"><span class="me-2">AssetData</span><a href="#assetdata" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Local Cache data object mapping implements NSCoding, as PINCache relies on the archivedData method for encoding/decoding.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CryptoKit</span>

<span class="kd">class</span> <span class="kt">AssetDataContentInformation</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentLength</span><span class="p">:</span> <span class="kt">Int64</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentType</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">isByteRangeAccessSupported</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
    
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentLength</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetDataContentInformation.contentLength</span><span class="kd">)</span><span class="p">)</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentType</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetDataContentInformation.contentType</span><span class="kd">)</span><span class="p">)</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetDataContentInformation.isByteRangeAccessSupported</span><span class="kd">)</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeInt64</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetDataContentInformation.contentLength</span><span class="kd">)</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetDataContentInformation.contentType</span><span class="kd">)</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">??</span> <span class="s">""</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetDataContentInformation.isByteRangeAccessSupported</span><span class="kd">)</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">Bool</span> <span class="p">??</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">mediaData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetData.contentInformation</span><span class="kd">)</span><span class="p">)</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetData.mediaData</span><span class="kd">)</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetData.contentInformation</span><span class="kd">)</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">AssetDataContentInformation</span> <span class="p">??</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetData.mediaData</span><span class="kd">)</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">??</span> <span class="kt">Data</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">AssetData</code> <strong>contains:</strong></p><ul><li><code class="language-plaintext highlighter-rouge">contentInformation</code> : AssetDataContentInformation <code class="language-plaintext highlighter-rouge">AssetDataContentInformation</code>: Contains whether Range requests are supported (isByteRangeAccessSupported), total resource length (contentLength), file type (contentType)<li><code class="language-plaintext highlighter-rouge">mediaData</code> : Original audio Data <strong>(large files here may cause OOM)</strong></ul><h4 id="pincacheassetdatamanager"><span class="me-2">PINCacheAssetDataManager</span><a href="#pincacheassetdatamanager" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Encapsulates the logic for storing and retrieving Data in PINCache.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">PINCache</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">protocol</span> <span class="kt">AssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span>
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="n">offset</span>
            <span class="k">var</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">from</span>
            <span class="n">data</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">with</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">start</span><span class="o">..&lt;</span><span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>

<span class="kd">class</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">Cache</span><span class="p">:</span> <span class="kt">PINCache</span> <span class="o">=</span> <span class="kt">PINCache</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"ResourceLoader"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">cacheKey</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">AssetData</span><span class="p">()</span>
        <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">contentInformation</span>
        <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">mediaData</span>
            
            <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">object</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">AssetData</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">assetData</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Here, we extract the Protocol because we might use other storage methods to replace PINCache in the future. Therefore, other programs should rely on the Protocol rather than the Class instance when using it.</p><blockquote><p><em>⚠️ <code class="language-plaintext highlighter-rouge">mergeDownloadedDataIfIsContinuted</code> <strong>This method is extremely important.</strong></em></p></blockquote><p>For linear playback, you just need to keep appending new Data to the Cache Data, but the real situation is much more complicated. The user might play Range 0~100 and then directly Seek to Range 200–500 for playback. How to merge the existing 0-100 Data with the new 200–500 Data is a big problem.</p><blockquote><p><em>⚠️ Data merging issues can lead to terrible playback glitches…</em></p></blockquote><p>The answer here is, <strong>we do not handle non-continuous data</strong>; because our project is only for audio, and the files are just a few MB (≤ 10MB), considering the development cost, we didn’t do it. I only handle merging continuous data (for example, currently having 0~100, and the new data is 75~200, after merging it becomes 0~200; if the new data is 150~200, I will ignore it and not merge).</p><p><a href="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.jpeg" class="popup img-link "><img data-src="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.jpeg" alt="" class="lazyload" data-proofer-ignore></a></p><p>If you want to consider non-continuous merging, besides using other methods for storage (to identify the missing parts), you also need to be able to query which segment needs a network request and which segment is taken locally during the Request. Considering this situation, the implementation will be very complicated.</p><p><a href="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.png" class="popup img-link "><img data-src="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.png" alt="Image source: [iOS AVPlayer Video Cache Design and Implementation](http://chuquan.me/2019/12/03/ios-avplayer-support-cache/){:target=&quot;_blank&quot;}" class="lazyload" data-proofer-ignore></a></p><p>Image source: <a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">iOS AVPlayer Video Cache Design and Implementation</a></p><h4 id="cachingavurlasset"><span class="me-2">CachingAVURLAsset</span><a href="#cachingavurlasset" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>AVURLAsset weakly holds the ResourceLoader Delegate, so it is recommended to create an AVURLAsset Class that inherits from AVURLAsset, internally create, assign, and hold the ResourceLoader, allowing it to follow the lifecycle of AVURLAsset. Additionally, you can store information such as the original URL, CacheKey, etc.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">CachingAVURLAsset</span><span class="p">:</span> <span class="kt">AVURLAsset</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">customScheme</span> <span class="o">=</span> <span class="s">"cacheable"</span>
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_resourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoader</span><span class="p">?</span>
    
    <span class="k">var</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">lastPathComponent</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">_</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="s">"http"</span><span class="p">,</span> <span class="s">"https"</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">(</span><span class="n">url</span> <span class="kt">URL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="kt">URL</span>
        
        <span class="k">guard</span> <span class="k">var</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">components</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="n">customScheme</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">resourceLoader</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">resourceLoader</span><span class="o">.</span><span class="nf">setDelegate</span><span class="p">(</span><span class="n">resourceLoader</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="n">resourceLoader</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_resourceLoader</span> <span class="o">=</span> <span class="n">resourceLoader</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Usage:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">asset</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
  <span class="k">let</span> <span class="nv">avplayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
  <span class="n">avplayer</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Where <code class="language-plaintext highlighter-rouge">isSchemeSupport()</code> is used to determine if the URL supports our Resource Loader (excluding file://).</p><p><code class="language-plaintext highlighter-rouge">originalURL</code> stores the original resource URL.</p><p><code class="language-plaintext highlighter-rouge">cacheKey</code> stores the Cache Key for this resource, here we directly use the file name as the Cache Key.</p><p>Please adjust <code class="language-plaintext highlighter-rouge">cacheKey</code> according to real-world scenarios. If the file name is not hashed and may be duplicated, it is recommended to hash it first to avoid collisions; if you want to hash the entire URL as the key, also pay attention to whether the URL will change (e.g., using CDN).</p><p>Hashing can use md5…sha… iOS ≥ 13 can directly use Apple’s <a href="https://developer.apple.com/documentation/cryptokit/" target="_blank">CryptoKit</a>, for others, check Github!</p><h4 id="resourceloaderrequest"><span class="me-2">ResourceLoaderRequest</span><a href="#resourceloaderrequest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">protocol</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ResourceLoaderRequest</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">URLSessionDataDelegate</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">start</span><span class="p">:</span> <span class="kt">Int64</span>
        <span class="k">var</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">RequestRangeEnd</span>
        
        <span class="kd">enum</span> <span class="kt">RequestRangeEnd</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nf">requestTo</span><span class="p">(</span><span class="kt">Int64</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">requestToEnd</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">enum</span> <span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">contentInformation</span>
        <span class="k">case</span> <span class="n">dataRequest</span>
    <span class="p">}</span>
    
    <span class="kd">struct</span> <span class="kt">ResponseUnExpectedError</span><span class="p">:</span> <span class="kt">Error</span> <span class="p">{</span> <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span>
    
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isCancelled</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isCancelled</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">invalidateAndCancel</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isFinished</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isFinished</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">finishTasksAndInvalidate</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">?</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">originalURL</span>
        <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span> <span class="o">=</span> <span class="n">loaderQueue</span>
        <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span> <span class="o">=</span> <span class="n">assetDataManager</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">isCancelled</span> <span class="o">==</span> <span class="kc">false</span><span class="p">,</span> <span class="n">isFinished</span> <span class="o">==</span> <span class="kc">false</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            
            <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span> <span class="o">=</span> <span class="n">requestRange</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">requestRange</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">String</span>
            <span class="k">switch</span> <span class="n">requestRange</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">rangeEnd</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="s">""</span>
            <span class="p">}</span>
            
            <span class="k">let</span> <span class="nv">rangeHeader</span> <span class="o">=</span> <span class="s">"bytes=</span><span class="se">\(</span><span class="n">start</span><span class="se">)</span><span class="s">-</span><span class="se">\(</span><span class="n">end</span><span class="se">)</span><span class="s">"</span>
            <span class="n">request</span><span class="o">.</span><span class="nf">setValue</span><span class="p">(</span><span class="n">rangeHeader</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Range"</span><span class="p">)</span>
            
            <span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">delegateQueue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
            <span class="k">let</span> <span class="nv">dataTask</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span> <span class="o">=</span> <span class="n">dataTask</span>
            <span class="n">dataTask</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isCancelled</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">dataRequest</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">URLSession</span><span class="o">.</span><span class="kt">ResponseDisposition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="nf">completionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isFinished</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="k">guard</span> <span class="n">error</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span>
                      <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="k">as?</span> <span class="kt">HTTPURLResponse</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">responseError</span> <span class="o">=</span> <span class="n">error</span> <span class="p">??</span> <span class="kt">ResponseUnExpectedError</span><span class="p">()</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">responseError</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                
                <span class="k">let</span> <span class="nv">contentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Content-Range"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytesString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytes</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">bytesString</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">bytes</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Accept-Ranges"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="n">value</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">false</span>
                <span class="p">}</span>
                
                <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">))</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">offset</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span><span class="p">?</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveDownloadedData</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Encapsulation for Remote Request, mainly for data requests initiated by ResourceLoader.</p><p><code class="language-plaintext highlighter-rouge">RequestType</code>: Used to distinguish whether this Request is the first request for file information (contentInformation) or a data request (dataRequest).</p><p><code class="language-plaintext highlighter-rouge">RequestRange</code>: Request Range scope, end can specify to where (requestTo(Int64)) or all (requestToEnd).</p><p>File information can be obtained from:</p><pre><code class="language-less">func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse, completionHandler: @escaping (URLSession.ResponseDisposition) -&gt; Void)
</code></pre><p>Get the Response Header from it. Additionally, note that if you want to change to HEAD, it won’t enter here; you need to use other methods to receive it.</p><ul><li><code class="language-plaintext highlighter-rouge">isByteRangeAccessSupported</code>: Check <strong>Accept-Ranges == bytes</strong> in the Response Header.<li><code class="language-plaintext highlighter-rouge">contentType</code>: The file type information required by the player, formatted as a Uniform Type Identifier, not audio/mpeg, but written as public.mp3.<li><code class="language-plaintext highlighter-rouge">contentLength</code>: Check <strong>Content-Range</strong> in the Response Header: bytes 0–1/ <strong>total length of the resource</strong>.</ul><blockquote><p><em>⚠️ Note that the format given by the server may vary in case sensitivity. It may not be written as Accept-Ranges/Content-Range; some servers use lowercase accept-ranges, Accept-ranges…</em></p></blockquote><p><strong>Supplement: If you need to consider case sensitivity, you can write an HTTPURLResponse Extension</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">extension</span> <span class="kt">HTTPURLResponse</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">parseContentLengthFromContentRange</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Int64</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Content-Range"</span><span class="p">,</span>
            <span class="s">"content-range"</span><span class="p">,</span>
            <span class="s">"Content-range"</span><span class="p">,</span>
            <span class="s">"content-Range"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLengthString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLength</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">contentLengthString</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentLength</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parseAcceptRanges</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Accept-Ranges"</span><span class="p">,</span>
            <span class="s">"accept-ranges"</span><span class="p">,</span>
            <span class="s">"Accept-ranges"</span><span class="p">,</span>
            <span class="s">"accept-Ranges"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="o">||</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"Bytes"</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">mimeTypeUTI</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Usage:</p><ul><li>contentLength = response.parseContentLengthFromContentRange()<li>isByteRangeAccessSupported = response.parseAcceptRanges()<li>contentType = response.mimeTypeUTI()</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
</pre></table></code></div></div><p>As mentioned in the preliminary knowledge, the downloaded data will be obtained in real-time, so this method will keep getting called, receiving Data in fragments; we will append it to <code class="language-plaintext highlighter-rouge">downloadedData</code> for storage.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span>
</pre></table></code></div></div><p>This method is called when the task is canceled or completed, where the downloaded data will be saved.</p><p>As mentioned in the preliminary knowledge about the Cancel mechanism, since the player will initiate a Cancel Request after obtaining enough data, when this method is called, the actual <code class="language-plaintext highlighter-rouge">error = NSURLErrorCancelled</code> will be received. Therefore, regardless of the error, we will try to save the data if we have received it.</p><blockquote><p><em>⚠️ Since URLSession requests data concurrently, please ensure all operations are performed within DispatchQueue to avoid data corruption (data corruption can also result in playback issues).</em></p></blockquote><blockquote><p><em>⚠️ If URLSession does not call <code class="language-plaintext highlighter-rouge">finishTasksAndInvalidate</code> or <code class="language-plaintext highlighter-rouge">invalidateAndCancel</code>, it will strongly retain objects, causing a Memory Leak. Therefore, whether canceling or completing, we must call these methods to release the Request when the task ends.</em></p></blockquote><blockquote><p><em>⚠️ If you are concerned about <code class="language-plaintext highlighter-rouge">downloadedData</code> causing OOM, you can save it locally in didReceive Data.</em></p></blockquote><h4 id="resourceloader"><span class="me-2">ResourceLoader</span><a href="#resourceloader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">AVFoundation</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">class</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">loaderQueue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.resourceLoader.queue"</span><span class="p">)</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="kt">CachingAVURLAsset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">cacheKey</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">originalURL</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoaderDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="nv">type</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">assetDataManager</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="n">assetDataManager</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">Int64</span>
                    <span class="k">switch</span> <span class="n">range</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">rangeEnd</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                    <span class="p">}</span>
                    
                    <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="p">{</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="kt">Int</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                       <span class="k">return</span> <span class="kc">true</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">range</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
                        <span class="c1">// has cache data...but not enough</span>
                        <span class="k">let</span> <span class="nv">subEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">?</span> <span class="kt">Int</span><span class="p">((</span><span class="n">end</span><span class="p">))</span> <span class="p">:</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="n">subEnd</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="kt">ResourceLoaderRequest</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="n">type</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="n">assetDataManager</span><span class="p">)</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="o">=</span> <span class="n">resourceLoaderRequest</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">contentInformation</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">_</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">contentInformation</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">dataRequest</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">_</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span><span class="p">,</span> <span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestsAllDataToEndOfResource</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="n">requestToEnd</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">let</span> <span class="nv">length</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestedLength</span> <span class="p">??</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">let</span> <span class="nv">upperBound</span> <span class="o">=</span> <span class="n">lowerBound</span> <span class="o">+</span> <span class="n">length</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="n">upperBound</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest</code> != nil indicates the first request, where the player asks for file information.</p><p>When requesting file information, we need to provide these three pieces of information:</p><ul><li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.isByteRangeAccessSupported</code>: Whether Range access to Data is supported<li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentType</code>: Uniform type identifier<li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentLength</code>: Total file length Int64</ul><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedOffset</code> can get the starting offset of the requested Range.</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedLength</code> can get the length of the requested Range.</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestsAllDataToEndOfResource</code> == true means that regardless of the requested Range length, it will fetch until the end.</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.respond(with: Data)</code> returns the loaded Data to the player.</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.currentOffset</code> can get the current data offset, and <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code> will shift the <code class="language-plaintext highlighter-rouge">currentOffset</code>.</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.finishLoading()</code> indicates that all data has been loaded and informs the player.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
</pre></table></code></div></div><p>When the player requests data, we first check if there is data in the local Cache. If there is, we return it; if only part of the data is available, we return that part. For example, if we have 0–100 locally and the player requests 0–200, we return 0–100 first.</p><p>If there is no local Cache or the returned data is insufficient, a ResourceLoaderRequest will be initiated to fetch data from the network.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span>
</pre></table></code></div></div><p>The player cancels the request, canceling the ResourceLoaderRequest.</p><blockquote><p><em>You might have noticed</em> <code class="language-plaintext highlighter-rouge">resourceLoaderRequestRange</code> <em>offset is based on <code class="language-plaintext highlighter-rouge">currentOffset</code> because we first load the downloaded Data from the local <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code>; so we can directly look at the shifted offset.</em></p></blockquote><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
</pre></table></code></div></div><blockquote><p><em>⚠️ Some examples use <code class="language-plaintext highlighter-rouge">currentRequest: ResourceLoaderRequest</code> to store requests, which can be problematic. If the current request is fetching data and the user seeks, the old request will be canceled and a new one initiated. Since these actions may not occur in order, using a Dictionary for storage and operations is safer!</em></p></blockquote><blockquote><p><em>⚠️ Ensure all operations are on the same DispatchQueue to prevent data inconsistencies.</em></p></blockquote><p><strong>Cancel all ongoing requests during deinit</strong> Resource Loader Deinit indicates AVURLAsset Deinit, meaning the player no longer needs this resource. Therefore, we can cancel ongoing Requests, and the already loaded data will still be written to Cache.</p><h3 id="supplement-and-acknowledgments"><span class="me-2">Supplement and Acknowledgments</span><a href="#supplement-and-acknowledgments" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Thanks to <a href="https://medium.com/u/2d01a2439753" target="_blank">Lex 汤</a> for the guidance.</p><p>Thanks to <a href="https://medium.com/u/aab116fd9d4d" target="_blank">外孫女</a> for providing development advice and support.</p><h4 id="this-article-is-only-for-small-music-files"><span class="me-2">This article is only for small music files</span><a href="#this-article-is-only-for-small-music-files" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Large video files may encounter Out Of Memory issues in downloadedData, AssetData/PINCacheAssetDataManager.</p><p>As mentioned earlier, to solve this problem, use fileHandler seek read/write to operate local Cache read/write (replacing AssetData/PINCacheAssetDataManager); or look for projects on Github that handle large data write/read to file.</p><h4 id="cancel-downloading-items-when-switching-playback-items-in-avqueueplayer"><span class="me-2">Cancel downloading items when switching playback items in AVQueuePlayer</span><a href="#cancel-downloading-items-when-switching-playback-items-in-avqueueplayer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>As stated in the preliminary knowledge, changing the playback target will not trigger a Cancel; if it is AVPlayer, it will go through AVURLAsset Deinit, so the download will also be interrupted; but AVQueuePlayer will not, because it is still in the Queue, only the playback target has switched to the next one.</p><p>The only way here is to receive the notification of changing the playback target, and then cancel the loading of the previous AVURLAsset after receiving the notification.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">asset</span><span class="o">.</span><span class="nf">cancelLoading</span><span class="p">()</span>
</pre></table></code></div></div><h4 id="audio-data-encryption-and-decryption"><span class="me-2">Audio data encryption and decryption</span><a href="#audio-data-encryption-and-decryption" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Audio encryption and decryption can be performed in ResourceLoaderRequest when obtaining Data, and when storing, encryption and decryption can be performed on the Data stored locally in the encode/decode of AssetData.</p><p><strong>CryptoKit SHA usage example:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">encryptionKeyString</span> <span class="o">=</span> <span class="s">"encryptionKeyExzhgchgli"</span>
    <span class="o">...</span>
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetData.contentInformation</span><span class="kd">)</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="kd">#available(iOS 13.0, *)</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">encryptionData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">seal</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span><span class="o">.</span><span class="n">combined</span> <span class="p">{</span>
            <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">encryptionData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetData.mediaData</span><span class="kd">)</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="kd">#keyPath(</span><span class="nf">AssetData.mediaData</span><span class="kd">)</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">{</span>
            <span class="k">if</span> <span class="kd">#available(iOS 13.0, *)</span><span class="p">,</span>
               <span class="k">let</span> <span class="nv">sealedBox</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="kt">SealedBox</span><span class="p">(</span><span class="nv">combined</span><span class="p">:</span> <span class="n">mediaData</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">decryptedData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">open</span><span class="p">(</span><span class="n">sealedBox</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">decryptedData</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">//</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="pincache-related-operations"><span class="me-2">PINCache related operations</span><a href="#pincache-related-operations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>PINCache includes PINMemoryCache and PINDiskCache. PINCache will handle reading from file to Memory or writing from Memory to file for us. We only need to operate on PINCache.</p><p>To find the Cache file location in the simulator:</p><p><a href="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.png" class="popup img-link "><img data-src="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Use <code class="language-plaintext highlighter-rouge">NSHomeDirectory()</code> to get the simulator file path</p><p><a href="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.png" class="popup img-link "><img data-src="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Finder -&gt; Go -&gt; Paste the path</p><p><a href="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.png" class="popup img-link "><img data-src="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>In Library -&gt; Caches -&gt; com.pinterest.PINDiskCache.ResourceLoader is the Resource Loader Cache directory we created.</p><p><code class="language-plaintext highlighter-rouge">PINCache(name: “ResourceLoader”)</code> where the name is the directory name.</p><p>You can also specify the rootPath, and the directory can be moved under Documents (not afraid of being cleared by the system).</p><p><strong>Set the maximum limit for PINCache:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteCount</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="c1">// max: 300mb</span>
 <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteLimit</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="c1">// 90 days</span>
</pre></table></code></div></div><p><a href="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.png" class="popup img-link "><img data-src="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.png" alt="System default limit" class="lazyload" data-proofer-ignore></a></p><p>System default limit</p><p>Setting it to 0 will not proactively delete files.</p><h3 id="postscript"><span class="me-2">Postscript</span><a href="#postscript" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Initially underestimated the difficulty of this feature, thinking it could be handled quickly; ended up struggling and spent about two more weeks dealing with data storage issues. However, I thoroughly understood the entire Resource Loader operation mechanism, GCD, and Data.</p><h3 id="references"><span class="me-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Finally, here are the references for how to implement it:</p><ol><li><a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">iOS AVPlayer 视频缓存的设计与实现</a> Only explains the principle<li><a href="https://caisanze.com/post/swift-avplayer/" target="_blank">基于AVPlayer实现音视频播放和缓存，支持视频画面的同步输出</a> [ <a href="https://github.com/eroscai/SZAVPlayer" target="_blank">SZAVPlayer</a> ] Includes code (very complete but complex)<li><a href="https://github.com/neekeetab/CachingPlayerItem/blob/7d998b8561693cf51077f0891ed240e92bec415e/CachingPlayerItem.swift" target="_blank">CachingPlayerItem</a> (Simple implementation, easier to understand but not complete)<li><a href="https://www.jianshu.com/p/28157247d6a7" target="_blank">可能是目前最好的 AVPlayer 音视频缓存方案 AVAssetResourceLoaderDelegate</a><li><a href="https://sshiqiao.github.io/document/douyin-swift.html#1" target="_blank">仿抖音 Swift 版</a> [ <a href="https://github.com/sshiqiao/douyin-ios-swift" target="_blank">Github</a> ] (Interesting project, a replica of the Douyin APP; also uses Resource Loader)<li><a href="../d796bf8e661e/">iOS HLS Cache 實踐方法探究之旅</a></ol><h3 id="extension"><span class="me-2">Extension</span><a href="#extension" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://github.com/dminoror/DLCachePlayer" target="_blank">DLCachePlayer</a> (Objective-C version)</ul><p>If you have any questions or comments, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>===</p><p><a href="https://zhgchg.li/posts/6ce488898003/" target="_blank">本文中文版本</a></p><p>===</p><p>This article was first published in Traditional Chinese on Medium ➡️ <a href="https://medium.com/p/6ce488898003" target="_blank"><strong>View Here</strong></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill" width="560" height="60" autoscale="on" adaptive="414"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script></div><hr/> <a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer!&emoji=🍺&slug=zhgchgli&button_colour=FFDD00&font_colour=000000&font_family=Bree&outline_colour=000000&coffee_colour=ffffff" class="lazyload" data-proofer-ignore></a> <br/> <a href="https://medium.com/@zhgchgli" target="_blank" class="img-link shimmer" ><img data-src="/assets/images/followmymedium.png" class="lazyload" data-proofer-ignore></a> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-3184248473087645" data-ad-slot="7555148040"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/zrealm/'>ZRealm</a>, <a href='/categories/dev/'>Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/avplayer/" class="post-tag no-text-decoration" >avplayer</a> <a href="/tags/music-player-app/" class="post-tag no-text-decoration" >music-player-app</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Comprehensive%20Guide%20to%20Implementing%20Local%20Cache%20with%20AVPlayer%20-%20ZhgChgLi&url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F6ce488898003%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Comprehensive%20Guide%20to%20Implementing%20Local%20Cache%20with%20AVPlayer%20-%20ZhgChgLi&u=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F6ce488898003%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fen.zhgchg.li%2Fposts%2F6ce488898003%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/d9a95d4224ea/">Medium Custom Domain Feature Returns</a><li class="text-truncate lh-lg"> <a href="/posts/483af5d93297/">Custom Domain Tutorial for Github Pages</a><li class="text-truncate lh-lg"> <a href="/posts/9e43897d99fc/">Behavior Change in Merging NSAttributedString Attributes Range in iOS ≥ 18</a><li class="text-truncate lh-lg"> <a href="/posts/b08ef940c196/">iOS Deferred Deep Link Implementation (Swift)</a><li class="text-truncate lh-lg"> <a href="/posts/12c5026da33d/">What's New with Universal Links</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/ee47f8f1e2d2/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1609856872" data-df="ll" > Jan 5, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>AVPlayer Real-time Cache Implementation</h4><div class="text-muted small"><p> [Old] AVPlayer Real-time Cache Implementation Understanding the implementation of AVPlayer/AVQueuePlayer with AVURLAsset using AVAssetResourceLoaderDelegate [2021–01–31] Article Announcement: Art...</p></div></div></a></div><div class="col"> <a href="/posts/5033090c18ba/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1722160385" data-df="ll" > Jul 28, 2024 </em><h4 class="pt-0 my-2" data-toc-skip>Research on Preloading and Caching Page and File Resources in iOS WKWebView</h4><div class="text-muted small"><p> Research on Preloading and Caching Page and File Resources in iOS WKWebView Study on improving page loading speed by preloading and caching resources in iOS WKWebView. Photo by Antoine Gravier ...</p></div></div></a></div><div class="col"> <a href="/posts/d796bf8e661e/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1586365937" data-df="ll" > Apr 9, 2020 </em><h4 class="pt-0 my-2" data-toc-skip>Exploring Methods for Implementing iOS HLS Cache</h4><div class="text-muted small"><p> Exploring Methods for Implementing iOS HLS Cache How to achieve caching while playing m3u8 streaming video files using AVPlayer photo by Mihis Alex [2023/03/12] Update The next article, “Com...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ee47f8f1e2d2/" class="btn btn-outline-primary" prompt="Older" ><p>AVPlayer Real-time Cache Implementation</p></a> <a href="/posts/948ed34efa09/" class="btn btn-outline-primary" prompt="Newer" ><p>iOS Cross-Platform Account and Password Integration to Enhance Login Experience</p></a></div><script type="text/javascript"> (function () { const origin = 'https://giscus.app'; const iframe = 'iframe.giscus-frame'; const lightTheme = 'light'; const darkTheme = 'dark_dimmed'; let initTheme = lightTheme; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = darkTheme; } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': 'en', crossorigin: 'anonymous', async: '' }; let giscusScript = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value) ); document.getElementById('tail-wrapper').appendChild(giscusScript); addEventListener('message', (event) => { if ( event.source === window && event.data && event.data.direction === ModeToggle.ID ) { /* global theme mode changed */ const mode = event.data.message; const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme; const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); })(); </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">life</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/unboxing/">unboxing</a> <a class="post-tag btn btn-outline-primary" href="/tags/life/">Life</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/nsattributedstring/">nsattributedstring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> <br/> <a href="https://zhgchg.li" target="_blank">中文版網站</a><br/> Powered by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</p><p>© 2024 <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JSGN97L56L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSGN97L56L'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
